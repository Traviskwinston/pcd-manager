<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - Dashboard</title>
    <!-- Immediate theme application to prevent flash -->
    <script th:src="@{/js/theme-instant.js}"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/components/data-table.css}">
    <style>
        .scrollable-list {
            flex: 1 1 0;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0; /* Important for flex shrinking */
            height: 0; /* Force flex to control height */
        }
        .tool-item {
            padding: 8px 120x;
            font-size: 1rem;
            max-width: 95%;
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
        }
        .tool-item.assigned {
            background-color: #e6f7ff; /* Light blue background for assigned tools */
            border-left: 3px solid #8400ac; /* Blue left border indicator */
        }
        .tool-assigned-icon {
            color: #0d6efd;
            margin-left: 4px;
            cursor: help;
        }
        .assigned-user-tooltip {
            position: absolute;
            background-color: #343a40;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap;
            pointer-events: none;
            display: none;
        }
        .passdown-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .filter-icon {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        
        .filter-icon:hover {
            background-color: rgba(0,0,0,.1);
        }
        
        .tool-hidden {
            display: none !important;
        }
        
        .list-group-item-link {
            display: block;
            color: #212529;
            text-decoration: none;
            padding: 0.5rem 0.5rem;
            margin: -0.5rem -0.5rem;
        }
        
        .list-group-item-link:hover {
            background-color: rgba(0,0,0,.03);
            color: #0d6efd;
        }
        
        /* Dark mode hover styles for tool items */
        [data-bs-theme="dark"] .list-group-item-link:hover {
            background-color: rgba(110, 168, 254, 0.2);
            color: #ffffff;
        }
        
        [data-bs-theme="dark"] .tool-item:hover {
            background-color: rgba(110, 168, 254, 0.15);
        }
        
        [data-bs-theme="dark"] .tool-item {
            background-color: #495057;
        }
        
        [data-bs-theme="dark"] .tool-item.assigned {
            background-color: #1e3a5f;
            border-left: 3px solid #6ea8fe;
        }
        /* Ensure full-height layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .dashboard-container {
            height: calc(100vh - 76px); /* Account for navbar (56px) + top margin (20px) */
            max-height: calc(100vh - 76px);
            overflow: hidden;
            padding: 0;
        }
        .full-height-card {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin-bottom: 0;
        }
        .full-height-card .card-body {
            display: flex;
            flex: 1 1 auto;
            flex-direction: column;
            overflow: hidden; /* Prevent content from breaking card layout */
            padding: 0 !important; /* Remove all padding */
            min-height: 0; /* Essential for flex children to shrink */
        }
        
        /* Add minimal internal padding only where needed */
        .full-height-card .card-body > * {
            padding: 0.25rem;
        }
        
        /* Override Bootstrap card padding */
        .card-body {
            padding: 0 !important;
        }
        
        /* Remove padding from flex column elements */
        .d-flex.flex-column {
            padding: 0 !important;
        }
        
        /* Specifically target tools and main columns */
        .tools-col, .main-col {
            padding: 0 !important;
        }
        
        /* Add bottom padding to sections touching the bottom */
        .tools-col {
            padding-bottom: 2px !important;
        }
        
        .bottom-half {
            padding-bottom: 2px !important;
        }
        /* Clamp passdown comments */
        .clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Column widths */
        .tools-col {
            flex: 0 0 calc(30% - 0.5px);
            max-width: calc(30% - 0.5px);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .main-col {
            flex: 0 0 calc(70% - 0.5px);
            max-width: calc(70% - 0.5px);
            display: flex;
            flex-direction: column;
            padding: 2px;
            height: 100%;
        }
        /* Tool card takes full height */
        .tools-card {
            flex: 1 1 100%;
            display: flex;
            flex-direction: column;
        }
        /* Restore grid elements */
        #grid-canvas, #grid-controls {
            display: block !important;
        }
        .top-half {
            display: flex !important;
            flex: 1 1 calc(50% - 0.5px);
            position: relative;
            overflow: hidden;
            margin-bottom: 1px;
        }
        /* Make passdowns section take 50% of the height */
        .bottom-half {
             flex: 1 1 calc(50% - 0.5px);
             display: flex; 
             flex-direction: column;
             overflow: hidden;
        }
        
        /* Grid specific styles */
        #grid-canvas {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        #grid-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 100;
            background-color: #6f42c1;
            border-radius: 0.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        #grid-controls-header {
            background-color: #6f42c1;
            color: white;
            padding: 8px 12px;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #grid-controls-body {
            padding: 10px;
            background-color: white;
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }
        .grid-control-btn {
            border: 1px solid #ced4da;
            background-color: white;
            padding: 8px 10px;
            border-radius: 0.25rem;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.875rem;
        }
        .grid-control-btn:hover {
            background-color: #f8f9fa;
        }
        .grid-control-btn.active {
            background-color: #e9ecef;
        }
        
        /* Dashboard passdown table styles */
        .dashboard-date-divider-row {
            background-color: var(--bs-primary, #0d6efd) !important;
            color: white !important;
            font-weight: 600;
            border-top: 2px solid var(--bs-border-color, #dee2e6);
        }
        
        .dashboard-comment-cell {
            max-width: 300px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            text-align: left !important;
            vertical-align: top;
            overflow-wrap: break-word;
        }
        
        .dashboard-comment-cell span {
            text-align: left !important;
            display: block;
            width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .dashboard-passdown-row {
            height: auto !important;
            cursor: pointer;
        }
        
        .dashboard-passdown-row:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }
        
        .dashboard-passdown-row td {
            height: auto !important;
            vertical-align: top !important;
            text-align: left !important;
        }
        
        .dashboard-passdown-table-container .table td,
        .dashboard-passdown-table-container .table th {
            text-align: left !important;
        }
        
        .dashboard-passdown-table-container .table td span,
        .dashboard-passdown-table-container .table td div {
            text-align: left !important;
        }
        .grid-tool-icon {
            font-size: 1rem;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Tooltip styles */
        .tool-tooltip {
            position: absolute;
            background-color: #fff;
            color: #333;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 200px;
            white-space: normal;
            pointer-events: none;
            display: none;
        }
        /* Tool preview styles */
        .tool-preview {
            pointer-events: none;
            opacity: 0.7;
        }
        /* Tool and drawing styles */
        .tool-shape {
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tool-shape.highlight {
            box-shadow: 0 0 12px 4px rgba(13, 110, 253, 0.8);
            animation: highlight-pulse 1.5s infinite alternate;
        }
        @keyframes highlight-pulse {
            from {
                box-shadow: 0 0 8px 2px rgba(13, 110, 253, 0.7);
            }
            to {
                box-shadow: 0 0 15px 5px rgba(13, 110, 253, 0.9);
            }
        }
        .tool-shape.teal-tool {
            background-color: teal;
        }
        .tool-shape.purple-tool {
            background-color: purple;
        }
        
        /* Glow effect for selected items */
        .selected-glow {
            animation: glow-pulse 1.5s infinite alternate;
        }
        @keyframes glow-pulse {
            from {
                box-shadow: 0 0 8px 2px rgba(13, 110, 253, 0.5);
            }
            to {
                box-shadow: 0 0 15px 5px rgba(13, 110, 253, 0.7);
            }
        }
    </style>
</head>
<body>
    <!-- Include the navigation fragment -->
    <div th:replace="~{fragments/navigation :: navbar(activeTab='dashboard')}"></div>

    <!-- Tooltip element (added globally) -->
    <div class="assigned-user-tooltip" id="assigned-user-tooltip"></div>

    <div class="container-fluid dashboard-container h-100" style="padding: 32px 32px 0 32px;">
        <div class="row h-100" style="gap: 1px;">
            <!-- Left Column: Tools -->
            <div class="d-flex flex-column h-100 tools-col">
                <!-- Tools Section -->
                <div class="tools-card">
                    <div class="card full-height-card w-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <h5 class="mb-0">Tools</h5>
                            </div>
                            <div>
                                <input id="tool-search" type="text" class="form-control form-control-sm" placeholder="Search name, model, serial..." style="max-width:150px;">
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <!-- Filters Section -->
                            <div class="mb-3">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <select id="filter-type" class="form-select form-select-sm">
                                            <option value="">All Types</option>
                                            <option th:each="type : ${T(com.pcd.manager.model.Tool.ToolType).values()}"
                                                    th:value="${type}" th:text="${type}">CHEMBLEND</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="filter-status" class="form-select form-select-sm">
                                            <option value="">All Status</option>
                                            <option th:each="status : ${T(com.pcd.manager.model.Tool.ToolStatus).values()}"
                                                    th:value="${status}" th:text="${status}">NOT_STARTED</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="filter-issue" class="form-select form-select-sm">
                                            <option value="">All Track/Trends</option>
                                            <option th:each="tt : ${allTrackTrends}" 
                                                    th:value="${tt.id}" 
                                                    th:text="${tt.title}">Track/Trend Issue</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="text" id="filter-notes" class="form-control form-control-sm" placeholder="Search in notes...">
                                    </div>
                                </div>
                            </div>
                            <div class="scrollable-list flex-grow-1">
                                <!-- No tools message -->
                                <div th:if="${#lists.isEmpty(tools)}" class="text-center text-muted py-3">
                                    No tools found. <a th:href="@{/tools/new}">Add a new tool?</a>
                                </div>
                                
                                <!-- Tools list -->
                                <div th:unless="${#lists.isEmpty(tools)}">
                                    <!-- Debug: Total tools count -->
                                    <div class="small text-muted mb-2" th:text="${'Total tools: ' + #lists.size(tools)}"></div>
                                    
                                    <!-- All tools in a single loop -->
                                    <div th:each="toolMap : ${tools}" 
                                         th:classappend="${toolMap.tool.currentTechnicians != null and !#lists.isEmpty(toolMap.tool.currentTechnicians) ? 'assigned' : ''}"
                                         class="tool-item position-relative p-0" 
                                         th:attr="data-tool-id=${toolMap.tool.id}" 
                                         th:data-type="${toolMap.tool.toolType}" 
                                         th:data-serial="${toolMap.tool.serialNumber1}"
                                         th:data-model="${toolMap.tool.model1}"
                                         th:data-status="${toolMap.tool.status}"
                                         th:data-location="${toolMap.tool.location != null ? toolMap.tool.location.id : ''}"
                                         th:data-secondary-name="${toolMap.tool.secondaryName ?: ''}"
                                         th:data-notes="${toolMap.searchableNotes ?: ''}"
                                         th:data-assigned-users="${toolMap.tool.currentTechnicians != null and !#lists.isEmpty(toolMap.tool.currentTechnicians) ? #strings.listJoin(toolMap.tool.currentTechnicians.![name], ', ') : ''}">
                                        <div class="d-flex align-items-center">
                                            <a th:href="@{'/tools/' + ${toolMap.tool.id}}" 
                                               class="list-group-item-link flex-grow-1">
                                                <span th:text="${toolMap.tool.name}">Tool Name</span>
                                                <span th:if="${toolMap.tool.secondaryName != null && !toolMap.tool.secondaryName.isEmpty()}" 
                                                      th:text="${' (' + toolMap.tool.secondaryName + ')'}" 
                                                      class="text-muted small">Alt Name</span>
                                            </a>
                                            <span class="tool-assigned-icon" th:if="${toolMap.tool.currentTechnicians != null and !#lists.isEmpty(toolMap.tool.currentTechnicians)}">
                                                <i class="bi bi-person-check"></i>
                                            </span>
                                        </div>
                                        <div class="small text-muted ps-3">
                                            <div th:if="${toolMap.tool.location != null && toolMap.tool.location.name != null}" class="pb-2">
                                                Location: <span th:text="${toolMap.tool.location.name}">Location</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Column: Map + Passdowns -->
            <div class="main-col">
                <!-- Map Section (top-half) -->
                <div class="top-half">
                    <div id="grid-canvas"></div>
                    
                    <!-- Controls -->
                    <div id="grid-controls">
                        <div id="grid-controls-header">
                            <span>Controls</span>
                            <i class="bi bi-chevron-up toggle-grid-controls"></i>
                        </div>
                        <div id="grid-controls-body">
                            <div class="d-flex mb-2">
                                <button class="grid-control-btn active" data-mode="select" title="Select Mode">
                                    <i class="bi bi-cursor grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn" data-mode="edit" title="Edit Mode">
                                    <i class="bi bi-pencil grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn" data-mode="add-tool" title="Add Tool">
                                    <i class="bi bi-plus-square grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn" data-mode="draw" title="Draw">
                                    <i class="bi bi-square grid-tool-icon"></i>
                                </button>
                            </div>
                            <div class="d-flex">
                                <button class="grid-control-btn" data-action="zoom-in" title="Zoom In">
                                    <i class="bi bi-zoom-in grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn" data-action="zoom-out" title="Zoom Out">
                                    <i class="bi bi-zoom-out grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn disabled" data-action="delete" title="Delete" id="delete-btn">
                                    <i class="bi bi-trash grid-tool-icon"></i>
                                </button>
                                <button class="grid-control-btn disabled" data-action="save" title="Save" id="save-btn">
                                    <i class="bi bi-save grid-tool-icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tool tooltip container -->
                    <div class="tool-tooltip" id="tool-tooltip"></div>
                </div>
                
                <!-- Passdowns Section (bottom-half) -->
                <div class="bottom-half"> 
                    <div class="card full-height-card w-100">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Passdowns</h5>
                        </div>
                        <div class="card-body d-flex flex-column">

                        <!-- Filters Section -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select id="dashboard-filter-person" class="form-select form-select-sm">
                                    <option value="">All Technicians</option>
                                    <option th:each="u: ${passdownUsers}" th:value="${u}" th:text="${u}"></option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="dashboard-filter-tool" class="form-select form-select-sm">
                                    <option value="">All Tools</option>
                                    <option th:each="t: ${passdownTools}" th:value="${t}" th:text="${t}"></option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="dashboard-passdown-search"
                                        placeholder="Search comments, tools, technicians..."
                                        aria-label="Search">
                                    <button 
                                        class="btn btn-outline-secondary" 
                                        type="button" 
                                        id="dashboard-clear-search"
                                        title="Clear search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button id="dashboard-clear-filters" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="fas fa-broom me-1"></i>
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${#lists.isEmpty(recentPassdowns)}" class="text-center py-4 flex-grow-1 d-flex align-items-center justify-content-center">
                            <div>
                                <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No Recent Passdowns</h6>
                                <p class="text-muted small">Get started by creating your first passdown entry.</p>
                                <a th:href="@{/passdown/new}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i>
                                    Create Passdown
                                </a>
                            </div>
                        </div>

                            <!-- Table Container -->
                            <div th:if="${!#lists.isEmpty(recentPassdowns)}" class="flex-grow-1 overflow-hidden">
                                <div class="data-table-responsive table-responsive h-100 dashboard-passdown-table-container" id="dashboard-passdown-table-container">
                                    <table class="table table-striped data-table-compact table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 25%;">Tool</th>
                                                <th style="width: 50%;">Comment</th>
                                                <th style="width: 15%;">Technician</th>
                                                <th style="width: 10%;">Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Loop through passdowns and create date headers and passdown rows -->
                                            <th:block th:each="passdown, stat : ${recentPassdowns}">
                                                <!-- Date divider row - only show if first item or date changed -->
                                                <tr th:if="${stat.first || !passdown.date.equals(recentPassdowns[stat.index-1].date)}" 
                                                    class="dashboard-date-divider-row">
                                                    <td colspan="4" class="text-center">
                                                        <i class="fas fa-calendar-day me-2"></i>
                                                        <strong th:text="${#temporals.format(passdown.date, 'EEEE, MMMM d, yyyy')}">Monday, June 9, 2025</strong>
                                                    </td>
                                                </tr>
                                                
                                                <!-- Passdown row -->
                                                <tr class="data-table-row dashboard-passdown-row clickable-row"
                                                    th:attr="data-comment=${passdown.comment},
                                                             data-user=${passdown.user != null ? passdown.user.name : ''},
                                                             data-tool=${passdown.tool != null ? passdown.tool.name : ''},
                                                             data-technician=${passdown.user != null ? passdown.user.name : ''},
                                                             data-created-on=${passdown.createdDate != null ? #temporals.format(passdown.createdDate, 'yyyy-MM-dd') : ''},
                                                             data-date=${#temporals.format(passdown.date, 'yyyy-MM-dd')}"
                                                    th:onclick="'window.location.href=\'/passdown/' + ${passdown.id} + '/view\''">
                                                    <!-- Tool -->
                                                    <td>
                                                        <span th:if="${passdown.tool != null}" th:text="${passdown.tool.name}"></span>
                                                        <span th:if="${passdown.tool == null}" class="text-muted">No Tool Selected</span>
                                                    </td>
                                                    
                                                    <!-- Comment -->
                                                    <td class="dashboard-comment-cell">
                                                        <span th:text="${passdown.comment}">Comment text here...</span>
                                                    </td>
                                                    
                                                    <!-- Technician -->
                                                    <td>
                                                        <span th:text="${passdown.user != null ? passdown.user.name : 'Unknown User'}">User</span>
                                                    </td>
                                                    
                                                    <!-- Created On -->
                                                    <td>
                                                        <span th:if="${passdown.createdDate != null}" 
                                                              th:text="${#temporals.format(passdown.createdDate, 'MM/dd/yy')}">01/01/23</span>
                                                        <span th:if="${passdown.createdDate == null}" class="text-muted">-</span>
                                                    </td>
                                                </tr>
                                            </th:block>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
    
    <!-- Add Tool Modal -->
    <div class="modal fade" id="add-tool-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Tool to Map</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tool-search-modal" class="form-label">Search Tool</label>
                        <input type="text" class="form-control" id="tool-search-modal" placeholder="Search by name, model, or serial...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Available Tools</label>
                        <select class="form-select" id="tool-select" size="6">
                            <!-- Tools will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Size</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="tool-size" id="size-4x2" value="4x2" checked>
                            <label class="btn btn-outline-primary" for="size-4x2">4x2</label>
                            
                            <input type="radio" class="btn-check" name="tool-size" id="size-2x2" value="2x2">
                            <label class="btn btn-outline-primary" for="size-2x2">2x2</label>
                            
                            <input type="radio" class="btn-check" name="tool-size" id="size-2x4" value="2x4">
                            <label class="btn btn-outline-primary" for="size-2x4">2x4</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="place-tool-btn">Place Tool</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Draw Shape Modal -->
    <div class="modal fade" id="draw-shape-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Draw Shape</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="drawing-text" class="form-label">Text</label>
                        <input type="text" class="form-control" id="drawing-text" placeholder="Enter text to display (can be blank)...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Size</label>
                        <div class="row">
                            <div class="col">
                                <label for="drawing-width" class="form-label">Width (grid units)</label>
                                <input type="number" class="form-control" id="drawing-width" min="1" max="20" value="4">
                            </div>
                            <div class="col">
                                <label for="drawing-height" class="form-label">Height (grid units)</label>
                                <input type="number" class="form-control" id="drawing-height" min="1" max="20" value="3">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-dark color-btn active" data-color="black">Black</button>
                            <button type="button" class="btn btn-primary color-btn" data-color="blue">Blue</button>
                            <button type="button" class="btn btn-success color-btn" data-color="green">Green</button>
                            <button type="button" class="btn btn-danger color-btn" data-color="red">Red</button>
                            <button type="button" class="btn btn-warning color-btn" data-color="yellow">Yellow</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Style</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="drawing-style" id="style-hollow" value="hollow" checked>
                            <label class="btn btn-outline-primary" for="style-hollow">Hollow</label>
                            
                            <input type="radio" class="btn-check" name="drawing-style" id="style-solid" value="solid">
                            <label class="btn btn-outline-primary" for="style-solid">Solid</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="place-drawing-btn">Draw</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Text Modal -->
    <div class="modal fade" id="edit-text-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Drawing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-drawing-text" class="form-label">Text</label>
                        <input type="text" class="form-control" id="edit-drawing-text" placeholder="Enter text to display (can be blank)...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Size</label>
                        <div class="row">
                            <div class="col">
                                <label for="edit-drawing-width" class="form-label">Width (grid units)</label>
                                <input type="number" class="form-control" id="edit-drawing-width" min="1" max="20" value="4">
                            </div>
                            <div class="col">
                                <label for="edit-drawing-height" class="form-label">Height (grid units)</label>
                                <input type="number" class="form-control" id="edit-drawing-height" min="1" max="20" value="3">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-dark edit-color-btn" data-color="black">Black</button>
                            <button type="button" class="btn btn-primary edit-color-btn" data-color="blue">Blue</button>
                            <button type="button" class="btn btn-success edit-color-btn" data-color="green">Green</button>
                            <button type="button" class="btn btn-danger edit-color-btn" data-color="red">Red</button>
                            <button type="button" class="btn btn-warning edit-color-btn" data-color="yellow">Yellow</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Style</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="edit-drawing-style" id="edit-style-hollow" value="hollow">
                            <label class="btn btn-outline-primary" for="edit-style-hollow">Hollow</label>
                            
                            <input type="radio" class="btn-check" name="edit-drawing-style" id="edit-style-solid" value="solid">
                            <label class="btn btn-outline-primary" for="edit-style-solid">Solid</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="update-drawing-btn">Update Drawing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="delete-confirm-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this item from the map?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/konva@8.4.2/konva.min.js"></script>

    <!-- Data Embedding Script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.allToolsData = /*[[${allToolsData}]]*/ [];
        window.gridItems = /*[[${gridItems}]]*/ [];
        window.allTrackTrends = /*[[${allTrackTrends}]]*/ [];
        
        // Create a mapping of tool IDs to issue IDs for filtering
        window.toolIssueMap = {};
        
        // Initialize the tool-issue map when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // If we have track trend data with tool relationships
            if (window.allTrackTrends) {
                window.allTrackTrends.forEach(function(trackTrend) {
                    if (trackTrend.affectedTools && trackTrend.affectedTools.length > 0) {
                        trackTrend.affectedTools.forEach(function(toolId) {
                            if (!window.toolIssueMap[toolId]) {
                                window.toolIssueMap[toolId] = [];
                            }
                            if (!window.toolIssueMap[toolId].includes(trackTrend.id)) {
                                window.toolIssueMap[toolId].push(trackTrend.id);
                            }
                        });
                    }
                });
            }
            console.log('Tool-Issue map created:', window.toolIssueMap);
        });
        /*]]>*/
    </script>

    <!-- External Grid Logic Script Reference -->
    <script src="/js/dashboard-grid.js"></script>

    <!-- Toolbar Filter/Search Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toolSearchInput = document.getElementById('tool-search');
            const filterTypeSelect = document.getElementById('filter-type');
            const filterStatusSelect = document.getElementById('filter-status');
            const filterIssueSelect = document.getElementById('filter-issue');
            const filterNotesInput = document.getElementById('filter-notes');
            const toolItems = document.querySelectorAll('.tool-item');
            const noToolsMessage = document.querySelector('.scrollable-list > .text-center.text-muted'); 
            // Grid-related variables
            const visibleToolIds = new Set();
            let totalToolCount = 0;
            // Tooltip element
            const assignedUserTooltip = document.getElementById('assigned-user-tooltip');
            
            // Function for highlighting tools on the grid based on search/filters
            function updateGridShapesHighlight() {
                // Check if window.toolShapes exists (set by the grid.js)
                if (window.toolShapes && typeof window.toolShapes === 'object') {
                    totalToolCount = Object.keys(window.toolShapes).length;
                    
                    // Determine if any filter or search term is active
                    const searchTerm = toolSearchInput.value.toLowerCase();
                    const selectedType = filterTypeSelect.value;
                    const selectedStatus = filterStatusSelect.value;
                    const selectedIssue = filterIssueSelect.value;
                    const notesSearchTerm = filterNotesInput.value.trim().toLowerCase();
                    const anyFilterOrSearchActive = 
                        (searchTerm && searchTerm.length > 0) || 
                        (selectedType && selectedType.length > 0) || 
                        (selectedStatus && selectedStatus.length > 0) ||
                        (selectedIssue && selectedIssue.length > 0) ||
                        (notesSearchTerm && notesSearchTerm.length > 0);

                    // Reset all tools to normal state first
                    for (const id in window.toolShapes) {
                        const shape = window.toolShapes[id];
                        if (shape && shape.mainRect) {
                            const rect = shape.mainRect;
                            const textNode = shape.findOne('.text');
                            
                            rect.stroke('#333');
                            rect.strokeWidth(1);
                            rect.shadowColor('black');
                            rect.shadowBlur(5);
                            rect.shadowOffset({ x: 2, y: 2 });
                            rect.shadowOpacity(0.3);
                            shape.opacity(1); // Default to full opacity
                            
                            if (textNode) {
                                textNode.fill('black');
                                textNode.fontStyle('normal');
                            }
                        }
                    }
                    
                    // Apply dimming and highlighting if any filter or search is active
                    if (anyFilterOrSearchActive) {
                        for (const id in window.toolShapes) {
                            const shape = window.toolShapes[id];
                            if (shape && shape.mainRect) {
                                if (visibleToolIds.has(String(id))) { // Tool matches all filters
                                    const rect = shape.mainRect;
                                    const textNode = shape.findOne('.text');
                                    rect.stroke('#007bff');
                                    rect.strokeWidth(3);
                                    rect.shadowColor('#007bff');
                                    rect.shadowBlur(15);
                                    rect.shadowOffset({ x: 0, y: 0 });
                                    rect.shadowOpacity(0.9);
                                    shape.opacity(1); // Ensure it's fully opaque
                                    if (textNode) {
                                        textNode.fontStyle('bold');
                                    }
                                } else { // Tool does not match all filters
                                    shape.opacity(0.3); // Dim non-matching tools
                                }
                            }
                        }
                    }
                    
                    if (window.toolLayer) {
                        window.toolLayer.batchDraw();
                    }
                }
            }

            // Function to filter the list and update grid highlights
            function applyToolFiltersAndSearch() {
                const searchTerm = toolSearchInput.value.toLowerCase();
                const selectedType = filterTypeSelect.value;
                const selectedStatus = filterStatusSelect.value;
                const selectedIssue = filterIssueSelect.value;
                const notesSearchTerm = filterNotesInput.value.trim().toLowerCase();
                
                let visibleListCount = 0;
                visibleToolIds.clear(); // Reset the visible tools set
                
                // Check if any filters are active - empty strings count as no filter
                const hasActiveFilters = 
                    (searchTerm && searchTerm.length > 0) || 
                    (selectedType && selectedType.length > 0) || 
                    (selectedStatus && selectedStatus.length > 0) ||
                    (selectedIssue && selectedIssue.length > 0) ||
                    (notesSearchTerm && notesSearchTerm.length > 0);

                // --- Filter HTML List --- 
                toolItems.forEach(item => {
                    const toolType = item.dataset.type || '';
                    const toolStatus = item.dataset.status || '';
                    const toolName = item.querySelector('a')?.textContent?.toLowerCase() || '';
                    const toolSerial = item.dataset.serial?.toLowerCase() || '';
                    const toolModel = item.dataset.model?.toLowerCase() || '';
                    const toolSecondaryName = item.dataset.secondaryName?.toLowerCase() || '';
                    const toolNotes = item.dataset.notes ? item.dataset.notes.trim().toLowerCase() : '';
                    const toolId = item.dataset.toolId;
                    
                    // Basic filters
                    const typeMatch = !selectedType || toolType === selectedType;
                    const statusMatch = !selectedStatus || toolStatus === selectedStatus;
                    const searchMatch = !searchTerm || 
                                        toolName.includes(searchTerm) || 
                                        toolSerial.includes(searchTerm) || 
                                        toolSecondaryName.includes(searchTerm) || 
                                        toolModel.includes(searchTerm);
                    
                    // Note search
                    const notesMatch = !notesSearchTerm || toolNotes.includes(notesSearchTerm);
                    
                    // Issue filter
                    const issueMatch = !selectedIssue || (window.toolIssueMap && window.toolIssueMap[toolId] && 
                                      window.toolIssueMap[toolId].includes(parseInt(selectedIssue)));
                    
                    if (typeMatch && statusMatch && searchMatch && notesMatch && issueMatch) {
                        item.style.display = 'block'; 
                        item.classList.remove('tool-hidden');
                        visibleListCount++;
                        // Add to visibleToolIds if it matches all criteria and has a toolId
                        if (toolId) {
                            visibleToolIds.add(String(toolId)); // Ensure toolId is treated as string for Set comparison if needed
                        }
                    } else {
                        item.style.display = 'none';
                        item.classList.add('tool-hidden');
                    }
                });
                
                // Show/hide the "No tools found" message in the list
                if (noToolsMessage) {
                    noToolsMessage.style.display = visibleListCount === 0 ? 'block' : 'none';
                }
                
                // Update grid highlights
                updateGridShapesHighlight();
            }

            // --- Event Listeners --- 
            if (toolSearchInput) toolSearchInput.addEventListener('input', applyToolFiltersAndSearch);
            if (filterTypeSelect) filterTypeSelect.addEventListener('change', applyToolFiltersAndSearch);
            if (filterStatusSelect) filterStatusSelect.addEventListener('change', applyToolFiltersAndSearch);
            if (filterIssueSelect) filterIssueSelect.addEventListener('change', applyToolFiltersAndSearch);
            if (filterNotesInput) filterNotesInput.addEventListener('input', applyToolFiltersAndSearch);

            // Listen for grid ready event
            document.addEventListener('gridReady', function() {
                console.log('Grid ready - applying initial highlights');
                // Expose toolLayer for direct access
                window.toolLayer = toolLayer;
                // Set total tool count after grid is ready
                if (window.toolShapes) {
                    totalToolCount = Object.keys(window.toolShapes).length;
                }
                // Apply initial filter after grid is ready
                applyToolFiltersAndSearch();
            });
            
            // Initial filter application for the list
            applyToolFiltersAndSearch(); 
            
            // Toggle grid controls
            const toggleGridControls = document.querySelector('.toggle-grid-controls');
            const gridControlsBody = document.getElementById('grid-controls-body');
            
            if (toggleGridControls && gridControlsBody) {
                toggleGridControls.addEventListener('click', function() {
                    if (gridControlsBody.style.display === 'none') {
                        gridControlsBody.style.display = 'block';
                        this.classList.remove('bi-chevron-down');
                        this.classList.add('bi-chevron-up');
                    } else {
                        gridControlsBody.style.display = 'none';
                        this.classList.remove('bi-chevron-up');
                        this.classList.add('bi-chevron-down');
                    }
                });
            }
            
            // --- Tooltip Logic ---
            if (assignedUserTooltip) {
                document.querySelectorAll('.tool-assigned-icon').forEach(icon => {
                    icon.addEventListener('mouseover', (event) => {
                        const toolItem = event.target.closest('.tool-item');
                        const userNames = toolItem.dataset.assignedUsers;
                        if (userNames) {
                            assignedUserTooltip.textContent = userNames;
                            // Position tooltip near the icon
                            const iconRect = event.target.getBoundingClientRect();
                            assignedUserTooltip.style.left = `${window.scrollX + iconRect.left + iconRect.width / 2 - assignedUserTooltip.offsetWidth / 2}px`;
                            assignedUserTooltip.style.top = `${window.scrollY + iconRect.top - assignedUserTooltip.offsetHeight - 5}px`; // 5px above
                            assignedUserTooltip.style.display = 'block';
                        }
                    });

                    icon.addEventListener('mouseout', () => {
                        assignedUserTooltip.style.display = 'none';
                    });
                });
            }
        });
    </script>

    <!-- Dashboard passdown table script -->
    <script th:src="@{/js/components/data-table.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get filter elements
            const filterPerson = document.getElementById('dashboard-filter-person');
            const filterTool = document.getElementById('dashboard-filter-tool');
            const searchInput = document.getElementById('dashboard-passdown-search');
            const clearSearchBtn = document.getElementById('dashboard-clear-search');
            const clearFiltersBtn = document.getElementById('dashboard-clear-filters');
            const passdownRows = document.querySelectorAll('.dashboard-passdown-row');
            
            // Function to get date from passdown row
            function getPassdownDate(row) {
                return row.getAttribute('data-date') || '';
            }
            
            // Combined filter function
            function applyDashboardFilters() {
                const personFilter = filterPerson ? filterPerson.value : '';
                const toolFilter = filterTool ? filterTool.value : '';
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                
                passdownRows.forEach(row => {
                    const user = row.getAttribute('data-user') || '';
                    const tool = row.getAttribute('data-tool') || '';
                    const comment = row.getAttribute('data-comment') || '';
                    const technician = row.getAttribute('data-technician') || '';
                    
                    // Check filter conditions
                    const matchesPerson = !personFilter || user === personFilter;
                    const matchesTool = !toolFilter || tool === toolFilter;
                    const matchesSearch = !searchTerm || 
                                        comment.toLowerCase().includes(searchTerm) ||
                                        tool.toLowerCase().includes(searchTerm) ||
                                        technician.toLowerCase().includes(searchTerm);
                    
                    // Show row if it matches all criteria
                    if (matchesPerson && matchesTool && matchesSearch) {
                        row.classList.remove('data-table-hidden');
                        row.style.display = '';
                    } else {
                        row.classList.add('data-table-hidden');
                        row.style.display = 'none';
                    }
                });
                
                // Update date dividers visibility
                updateDateDividersVisibility();
            }
            
            // Hide date dividers with no visible items
            function updateDateDividersVisibility() {
                const dateDividers = document.querySelectorAll('.dashboard-date-divider-row');
                
                dateDividers.forEach(divider => {
                    // Get all passdown rows after this divider and before next divider
                    let nextElement = divider.nextElementSibling;
                    let hasVisibleItem = false;
                    
                    while (nextElement && !nextElement.classList.contains('dashboard-date-divider-row')) {
                        if (nextElement.classList.contains('dashboard-passdown-row') && 
                            !nextElement.classList.contains('data-table-hidden')) {
                            hasVisibleItem = true;
                            break;
                        }
                        nextElement = nextElement.nextElementSibling;
                    }
                    
                    // Hide divider if no visible items
                    if (hasVisibleItem) {
                        divider.style.display = '';
                    } else {
                        divider.style.display = 'none';
                    }
                });
            }
            
            // Add event listeners to filter inputs
            if (filterPerson) filterPerson.addEventListener('change', applyDashboardFilters);
            if (filterTool) filterTool.addEventListener('change', applyDashboardFilters);
            if (searchInput) searchInput.addEventListener('input', applyDashboardFilters);
            
            // Clear search functionality
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (searchInput) searchInput.value = '';
                    applyDashboardFilters();
                });
            }
            
            // Add clear filter button functionality
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function() {
                    if (filterPerson) filterPerson.value = '';
                    if (filterTool) filterTool.value = '';
                    if (searchInput) searchInput.value = '';
                    applyDashboardFilters();
                });
            }
            
            // Call initial filter application
            applyDashboardFilters();
        });
    </script>

    <!-- Dark Mode Theme Toggle Script -->
    <script th:src="@{/js/theme-toggle.js}"></script>

</body>
</html> 