<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <th:block th:replace="~{fragments/head-favicon :: favicon-links}"></th:block>
    <title>PCD Manager - New RMA</title>
    <!-- Immediate theme application to prevent flash -->
    <script th:src="@{/js/theme-instant.js}"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/dark-mode.css}">
    <style>
        /* Ensure select text is readable in both light and dark modes */
        #status,
        #priority {
            color: #212529; /* Bootstrap's standard dark text color for light mode */
        }
        
        [data-bs-theme="dark"] #status,
        [data-bs-theme="dark"] #priority {
            color: #f8f9fa; /* Light text for dark mode */
        }
        
        /* Ensure all other select elements also have proper dark mode colors */
        [data-bs-theme="dark"] select.form-select {
            color: #f8f9fa;
            background-color: #495057;
            border-color: #6c757d;
        }
        
        [data-bs-theme="dark"] select.form-select option {
            color: #f8f9fa;
            background-color: #495057;
        }
        
        .border-dashed {
            border-style: dashed !important; 
        }
        
        #drop-area, #excel-drop-area {
            transition: all 0.3s ease;
        }
        
        #drop-area.highlight, #excel-drop-area.highlight {
            border-color: #198754 !important;
            background-color: rgba(25, 135, 84, 0.1) !important;
        }

        /* Clear highlight for selected tool in compact list */
        .selected-tool-active {
            background-color: var(--bs-primary) !important;
            color: #fff !important;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container mt-4">
        <!-- Action Buttons (Above Card) -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" th:text="${rma.id != null ? 'Update RMA' : 'Create New RMA'}">RMA Form</h2>
            <div class="btn-group">
                <button type="button" id="uploadExcelBtn" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel me-1"></i>Upload & Parse Excel
                </button>
                <button type="button" id="uploadFilesBtn" class="btn btn-primary">
                    <i class="bi bi-cloud-upload me-1"></i>Upload Files
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <form th:action="@{/rma/save}" th:object="${rma}" method="post" enctype="multipart/form-data" id="rmaForm">
                    <input type="hidden" th:field="*{id}" />
                    
                    <!-- Hidden file inputs -->
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="d-none">
                    <input type="file" id="fileUploadInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" class="d-none">
                    
                    <!-- Hidden dummy for backward compatibility (will be removed eventually) -->
                    <div class="d-none">
                        <div class="row mb-3">
                            <!-- Excel Upload Placeholder -->
                            <div class="col-md-3">
                            <div class="card mb-0 h-100 border-success">
                                <div class="card-header bg-success text-white py-1">
                                    <h6 class="mb-0"><i class="bi bi-file-earmark-excel me-1"></i>Upload RMA Excel</h6>
                                </div>
                                <div class="card-body py-2">
                                    <input type="file" id="oldExcelFileInput" name="documentUploads" accept=".xlsx,.xls" class="d-none">
                                    <input type="hidden" id="excelFileIncluded" name="excelFileIncluded" value="false">
                                    <button type="button" id="oldUploadExcelBtn" class="btn btn-success btn-sm w-100">
                                        <i class="bi bi-upload me-1"></i>Upload & Parse Excel (Old)
                                    </button>
                                    <div id="excelUploadResult" class="small mt-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: File Upload -->
                        <div class="col-md-9">
                            <div class="card mb-0 h-100 border-primary">
                                <div class="card-header bg-primary text-white py-1">
                                    <h6 class="mb-0"><i class="bi bi-file-earmark-arrow-up me-1"></i>Upload Files</h6>
                                </div>
                                <div class="card-body py-2">
                                    <!-- Simple file inputs that actually work -->
                                    <div class="mb-2">
                                        <label for="imageUploads" class="form-label small">Images (jpg, png):</label>
                                        <input type="file" id="imageUploads" name="imageUploads" multiple="multiple" 
                                               class="form-control form-control-sm" 
                                               accept=".jpg,.jpeg,.png,.gif,.bmp">
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label for="documentUploads" class="form-label small">Documents (pdf, doc, xls):</label>
                                        <input type="file" id="documentUploads" name="documentUploads" multiple="multiple" 
                                               class="form-control form-control-sm" 
                                               accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv">
                                    </div>
                                    
                                    <div class="small text-muted">
                                        <i class="bi bi-info-circle"></i> Files will be uploaded when you save the RMA
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div><!-- End row -->
                    </div><!-- End old upload section (hidden) -->
                    
                    <!-- Main Layout Row -->
                    <div class="row">
                        <!-- Left Column: Tool Info -->
                        <div class="col-md-3 border-end">
                            <!-- Tool Selection -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label class="form-label mb-0">Affected Tools</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectToolsModal">
                                        <i class="bi bi-tools me-1"></i>Select Tools
                                    </button>
                                </div>
                                <!-- Compact selected tools list (click to view details) -->
                                <div id="affectedToolsChipsForm" class="list-group list-group-flush mt-2" style="max-height: 180px; overflow:auto;"></div>
                                <!-- Keep legacy single-tool field but hidden; will be synced if exactly one is chosen -->
                                <select id="toolSelect" class="form-select d-none" th:field="*{tool}">
                                    <option value="">-- Select Tool --</option>
                                    <option th:each="toolItem : ${tools}" th:value="${toolItem.id}" th:text="${toolItem.name}"></option>
                                </select>
                                <!-- Hidden CSV of affected tool IDs for controller -->
                                <input type="hidden" id="affectedToolIds" name="affectedToolIds" value="">
                            </div>
                            <hr />
                            
                            <!-- Moving Parts Preview Section - will only show after saving the RMA -->
                            <div class="mb-3" id="moving-parts-preview" style="display: none;">
                                <h6 class="border-bottom pb-2">Moving Parts</h6>
                                <div class="small text-muted mb-2">
                                    <i class="bi bi-info-circle me-1"></i> 
                                    Moving parts for this tool will be available after saving the RMA.
                                </div>
                                <div id="moving-parts-container" class="list-group small">
                                    <!-- Moving part entries will be shown here when a tool is selected and the RMA has an ID -->
                                </div>
                            </div>
                            
                            <!-- Tool Details -->
                            <ul class="list-unstyled" id="tool-details-list">
                                <li><strong>Type:</strong> <span id="tool-type"></span></li>
                                <li><strong>Location:</strong> <span id="tool-location"></span></li>
                                <li><strong>Serial #:</strong> <span id="tool-serial1"></span><span id="tool-serial2-display"></span></li>
                                <li><strong>Model #:</strong> <span id="tool-model1"></span><span id="tool-model2-display"></span></li>
                                <li>
                                    <strong><span id="chemical-gas-label">Chemical/Gas Service:</span></strong> 
                                    <span id="tool-chemical-gas-service"></span>
                                    <button type="button" id="btn-add-chemical" class="btn btn-sm btn-primary d-none" style="padding: 0 4px; font-size: 10px; line-height: 1.2">+</button>
                                    <div id="chemical-edit-container" class="d-none mt-1">
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="chemical-gas-service-input" class="form-control form-control-sm" placeholder="Enter value">
                                            <button class="btn btn-danger btn-sm" id="btn-cancel-chemical" type="button" style="padding: 0 4px; font-size: 10px;">-</button>
                                        </div>
                                        <input type="hidden" id="update-tool-chemical-gas-service" name="updateToolChemicalGasService" value="">
                                    </div>
                                </li> 
                                <li>
                                    <strong>Commission Date:</strong> 
                                    <span id="tool-commission-date"></span>
                                    <button type="button" id="btn-add-commission" class="btn btn-sm btn-primary d-none" style="padding: 0 4px; font-size: 10px; line-height: 1.2">+</button>
                                    <div id="commission-edit-container" class="d-none mt-1">
                                        <div class="input-group input-group-sm">
                                            <input type="date" id="commission-date-input" class="form-control form-control-sm">
                                            <button class="btn btn-danger btn-sm" id="btn-cancel-commission" type="button" style="padding: 0 4px; font-size: 10px;">-</button>
                                        </div>
                                        <input type="hidden" id="update-tool-commission-date" name="updateToolCommissionDate" value="">
                                    </div>
                                </li> 
                                <li>
                                    <strong>Start-Up/SL03 Date:</strong> 
                                    <span id="tool-startup-sl03-date"></span>
                                    <button type="button" id="btn-add-startup" class="btn btn-sm btn-primary d-none" style="padding: 0 4px; font-size: 10px; line-height: 1.2">+</button>
                                    <div id="startup-edit-container" class="d-none mt-1">
                                        <div class="input-group input-group-sm">
                                            <input type="date" id="startup-sl03-date-input" class="form-control form-control-sm">
                                            <button class="btn btn-danger btn-sm" id="btn-cancel-startup" type="button" style="padding: 0 4px; font-size: 10px;">-</button>
                                        </div>
                                        <input type="hidden" id="update-tool-startup-sl03-date" name="updateToolStartupSl03Date" value="">
                                    </div>
                                </li>
                                <li>
                                    <a id="tool-view-link" href="#" class="btn btn-sm btn-outline-secondary" title="View Tool Details" style="display: none;">
                                        <i class="bi bi-eye"></i> View Tool
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Right Column: RMA Info and Dropdowns -->
                        <div class="col-md-9">
                            <div class="row">
                                <!-- Left: Written Date and Return Materials To -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="writtenDate" class="form-label">Written Date</label>
                                        <input type="date" id="writtenDate" class="form-control" th:field="*{writtenDate}" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="returnMaterialsTo" class="form-label">Return Materials To:</label>
                                        <select id="returnMaterialsTo" class="form-select" th:field="*{returnMaterialsTo}">
                                            <option value="">(DSS Quality Use Only)</option>
                                            <option th:each="address : ${returnAddresses}" 
                                                    th:value="${address.name}" 
                                                    th:text="${address.name}"
                                                    th:attr="data-address=${address.address}">
                                                Address
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="returnAddressPreview" style="display:none;">
                                        <label class="form-label">Selected Address</label>
                                        <pre class="form-control" style="white-space:pre-wrap; height:auto; min-height: 70px;"></pre>
                                    </div>
                                    
                                    <!-- Purged and Double Bagged Goods Enclosed -->
                                    <div class="mb-3" id="purgedAndDoubleBaggedSection" th:style="${rma.returnMaterialsTo != null && !rma.returnMaterialsTo.isEmpty() ? 'display:block;' : 'display:none;'}">
                                        <div class="d-flex align-items-center mb-2">
                                            <label class="form-label mb-0 me-3">Purged and Double Bagged Goods Enclosed:</label>
                                            <!-- N/A inline to the right of label (no form-check wrapper to avoid block layout) -->
                                            <input class="form-check-input ms-1" type="checkbox" id="purgedAndDoubleBaggedNA">
                                            <label class="form-check-label mb-0 ms-2" for="purgedAndDoubleBaggedNA">N/A</label>
                                        </div>
                                        <!-- Hidden input to handle value ('' => null, 'true'/'false') -->
                                        <input type="hidden" id="purgedAndDoubleBaggedHidden" name="purgedAndDoubleBaggedGoodsEnclosed" value="false" />
                                        <div id="purgedAndDoubleBaggedOptions">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" 
                                                       id="purgedAndDoubleBaggedGoodsEnclosedYes" 
                                                       name="purgedAndDoubleBaggedOptionsGroup"
                                                       value="true"
                                                       th:checked="${rma.purgedAndDoubleBaggedGoodsEnclosed != null && rma.purgedAndDoubleBaggedGoodsEnclosed == true}">
                                                <label class="form-check-label" for="purgedAndDoubleBaggedGoodsEnclosedYes">
                                                    Yes
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" 
                                                       id="purgedAndDoubleBaggedGoodsEnclosedNo" 
                                                       name="purgedAndDoubleBaggedOptionsGroup"
                                                       value="false"
                                                       th:checked="${rma.purgedAndDoubleBaggedGoodsEnclosed == null || rma.purgedAndDoubleBaggedGoodsEnclosed == false}">
                                                <label class="form-check-label" for="purgedAndDoubleBaggedGoodsEnclosedNo">
                                                    No
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: RMA # and Service Order stacked -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="combinedRmaField" class="form-label">RMA/SAP Number</label>
                                        <input type="text" id="combinedRmaField" class="form-control" th:field="*{referenceNumber}" placeholder="Enter RMA or SAP number" />
                                        <input type="hidden" id="rmaNumber" th:field="*{rmaNumber}" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="serviceOrder" class="form-label">Service Order/Warranty #</label>
                                        <input type="text" id="serviceOrder" class="form-control" th:field="*{serviceOrder}" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="reasonForRequest" class="form-label">Reason For Request</label>
                                        <select id="reasonForRequest" class="form-select" th:field="*{reasonForRequest}">
                                            <option value="">-- Select Reason --</option>
                                            <option th:each="opt : ${T(com.pcd.manager.model.RmaReasonForRequest).values()}"
                                                    th:value="${opt}"
                                                    th:text="${opt.displayName}"></option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dssProductLine" class="form-label">DSS Product Line</label>
                                        <select id="dssProductLine" class="form-select" th:field="*{dssProductLine}">
                                            <option value="">-- Select Product Line --</option>
                                            <option th:each="opt : ${T(com.pcd.manager.model.DssProductLine).values()}"
                                                    th:value="${opt}"
                                                    th:text="${opt.displayName}"></option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="systemDescription" class="form-label">System Description</label>
                                        <select id="systemDescription" class="form-select" th:field="*{systemDescription}">
                                            <option value="">-- Select System Description --</option>
                                            <option th:each="opt : ${T(com.pcd.manager.model.SystemDescription).values()}"
                                                    th:value="${opt}"
                                                    th:text="${opt.displayName}"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Process Impact Information -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h5>Process Impact Information</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Interruption to Flow?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input interruption-radio" type="radio" name="interruptionToFlow" id="interruptionToFlowYes" th:field="*{interruptionToFlow}" value="true">
                                                <label class="form-check-label" for="interruptionToFlowYes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input interruption-radio" type="radio" name="interruptionToFlow" id="interruptionToFlowNo" th:field="*{interruptionToFlow}" value="false">
                                                <label class="form-check-label" for="interruptionToFlowNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Interruption to Production?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input interruption-radio" type="radio" name="interruptionToProduction" id="interruptionToProductionYes" th:field="*{interruptionToProduction}" value="true">
                                                <label class="form-check-label" for="interruptionToProductionYes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input interruption-radio" type="radio" name="interruptionToProduction" id="interruptionToProductionNo" th:field="*{interruptionToProduction}" value="false">
                                                <label class="form-check-label" for="interruptionToProductionNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="downtimeContainer" class="mb-3" style="display: none;">
                                        <label for="downtimeHours" class="form-label">Downtime (Hrs):</label>
                                        <input type="number" step="0.1" min="0" id="downtimeHours" class="form-control" th:field="*{downtimeHours}">
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Exposed to Process Gas or Chemicals?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="exposedToProcessGasOrChemicals" id="exposedYes" th:field="*{exposedToProcessGasOrChemicals}" value="true">
                                                <label class="form-check-label" for="exposedYes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="exposedToProcessGasOrChemicals" id="exposedNo" th:field="*{exposedToProcessGasOrChemicals}" value="false">
                                                <label class="form-check-label" for="exposedNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="exposedFieldsContainer" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">Purged?</label>
                                            <div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="purged" id="purgedYes" th:field="*{purged}" value="true">
                                                    <label class="form-check-label" for="purgedYes">Yes</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="purged" id="purgedNo" th:field="*{purged}" value="false">
                                                    <label class="form-check-label" for="purgedNo">No</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="instructionsForExposedComponent" class="form-label">Instructions for Exposed Component:</label>
                                            <textarea id="instructionsForExposedComponent" class="form-control" th:field="*{instructionsForExposedComponent}" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Start-up/SO3 Complete?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="startupSo3Complete" id="startupSo3CompleteYes" th:field="*{startupSo3Complete}" value="true">
                                                <label class="form-check-label" for="startupSo3CompleteYes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="startupSo3Complete" id="startupSo3CompleteNo" th:field="*{startupSo3Complete}" value="false">
                                                <label class="form-check-label" for="startupSo3CompleteNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Failed on Install?</label>
                                        <div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="failedOnInstall" id="failedOnInstallYes" th:field="*{failedOnInstall}" value="true">
                                                <label class="form-check-label" for="failedOnInstallYes">Yes</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="failedOnInstall" id="failedOnInstallNo" th:field="*{failedOnInstall}" value="false">
                                                <label class="form-check-label" for="failedOnInstallNo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    
                    <!-- Parts List Section -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h5>Parts List</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="partsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Part Name</th>
                                            <th style="width: 25%;">Part Number</th>
                                            <th style="width: 30%;">Item Description</th>
                                            <th style="width: 10%;">Qty</th>
                                            <th style="width: 10%;">Replace?</th>
                                            <th style="width: 5%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="partsTableBody">
                                        <!-- Existing Part Lines (Loop if editing) -->
                                        <tr th:each="item, itemStat : ${rma.partLineItems}" class="part-row">
                                            <td>
                                                <input type="text" class="form-control" th:name="|partLineItems[${itemStat.index}].partName|" th:value="${item.partName}" placeholder="Part Name">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" th:name="|partLineItems[${itemStat.index}].partNumber|" th:value="${item.partNumber}" placeholder="Part Number">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" th:name="|partLineItems[${itemStat.index}].productDescription|" th:value="${item.productDescription}" placeholder="Item Description">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control" th:name="|partLineItems[${itemStat.index}].quantity|" th:value="${item.quantity}" min="0" placeholder="Qty">
                                            </td>
                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" th:name="|partLineItems[${itemStat.index}].replacementRequired|" th:checked="${item.replacementRequired}">
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm remove-part-row">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <!-- Default empty row if no parts exist -->
                                        <tr th:if="${rma.partLineItems == null || rma.partLineItems.isEmpty()}" class="part-row">
                                            <td>
                                                <input type="text" class="form-control" name="partLineItems[0].partName" placeholder="Part Name">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" name="partLineItems[0].partNumber" placeholder="Part Number">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" name="partLineItems[0].productDescription" placeholder="Item Description">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control" name="partLineItems[0].quantity" value="1" min="1" placeholder="Qty">
                                            </td>
                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" name="partLineItems[0].replacementRequired">
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm remove-part-row" disabled>
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Add Part button -->
                            <div class="text-end mt-2">
                                <button type="button" id="addPartBtn" class="btn btn-success btn-sm">
                                    <i class="bi bi-plus-circle me-1"></i> Add Part
                                </button>
                            </div>
                        </div>
                    </div>
                    <hr />
                    
                    <!-- Associated Moving Parts (Read-only display) -->
                    <div class="row mb-3" th:if="${movingParts != null && !movingParts.empty}">
                        <div class="col-md-12">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0"><i class="bi bi-arrows-move me-2"></i>Associated Moving Parts</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Part Name</th>
                                                    <th>From Tool</th>
                                                    <th>To Tool</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="movingPart : ${movingParts}">
                                                    <td th:text="${movingPart.partName}">Part Name</td>
                                                    <td th:text="${movingPart.fromTool != null ? movingPart.fromTool.name : 'N/A'}"></td>
                                                    <td th:text="${movingPart.toTool != null ? movingPart.toTool.name : 'N/A'}"></td>
                                                    <td th:text="${movingPart.notes}">Notes</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-info unified-link-trigger-btn"
                                                                data-bs-toggle="modal" data-bs-target="#unifiedLinkFileModal" 
                                                                th:data-source-entity-id="${movingPart.id}"
                                                                th:data-source-entity-type="'MOVING_PART'"
                                                                th:data-file-name="${movingPart.partName + ' (Movement ID: ' + movingPart.id + ')'}"
                                                                th:data-file-type="'MOVING_PART_RECORD'"
                                                                title="Link this Moving Part record">
                                                            <i class="bi bi-link-45deg"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Associated Moving Parts -->
                    
                    <!-- Moving Parts Section -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h5>Moving Parts</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Part Name</th>
                                            <th>From Tool</th>
                                            <th>To Tool</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="moving-parts-table-body">
                                        <!-- Moving parts will be added here by JavaScript or rendered by server -->
                                    </tbody>
                                </table>
                                <div class="text-end mt-2">
                                    <button type="button" class="btn btn-sm btn-primary" id="add-moving-part-btn" data-bs-toggle="modal" data-bs-target="#addMovingPartModal">
                                        <i class="bi bi-plus-circle me-1"></i> Add Moving Part
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Transfer Preview section (only displayed when editing) -->
                    <div th:if="${rma.id != null}" class="mt-4" id="transferPreviewSection" style="display: none;">
                        <hr>
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-arrow-right-square me-2"></i>Files Staged for Transfer</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Files will be transferred when you click the "Update RMA" button. 
                                    <strong>Note:</strong> Files will be moved from this RMA to the selected destination.
                                </div>
                                
                                <div class="row" id="transferPreviewContainer">
                                    <!-- Transfer items will be added here by JavaScript -->
                                </div>
                                
                                <!-- Hidden inputs to track files for transfer -->
                                <div id="transferHiddenInputs">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <!-- Status, Priority, Location, Technician Row -->
                    <div class="row mb-3">
                        <!-- Left Column: Status and Priority -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select id="status" class="form-select" th:field="*{status}">
                                    <option value="">-- Select Status --</option>
                                    <option th:each="opt : ${T(com.pcd.manager.model.RmaStatus).values()}"
                                            th:value="${opt}"
                                            th:text="${opt.displayName}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select id="priority" class="form-select" th:field="*{priority}">
                                    <option value="">-- Select Priority --</option>
                                    <option th:each="opt : ${T(com.pcd.manager.model.RmaPriority).values()}"
                                            th:value="${opt}"
                                            th:text="${opt.displayName}"></option>
                                </select>
                            </div>
                        </div>
                        <!-- Right Column: Location and Technician -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <select id="location" class="form-select" th:field="*{location}">
                                    <option value="">-- Select Location --</option>
                                    <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc.displayName}" 
                                            th:selected="${(rma.location != null && loc.id == rma.location.id) || (rma.location == null && loc.isDefaultLocation())}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="technician" class="form-label">Technician</label>
                                <select id="technician" class="form-select" th:field="*{technician}">
                                    <option value="">-- Unassigned --</option>
                                    <option th:each="tech : ${technicians}" th:value="${tech.name}" th:text="${tech.name}"></option>
                                </select>
                                <!-- Hidden input with current user name -->
                                <input type="hidden" id="currentUserName" th:value="${currentUserName}">
                            </div>
                        </div>
                    </div>
                    <!-- End Status, Priority, Location, Technician Row -->

                    <!-- Dates Row 1 (RMA Provided, Memo Emailed) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rmaNumberProvidedDate" class="form-label">RMA # Provided Date</label>
                                <input type="date" id="rmaNumberProvidedDate" class="form-control" th:field="*{rmaNumberProvidedDate}" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="shippingMemoEmailedDate" class="form-label">Shipping Memo Emailed</label>
                                <input type="date" id="shippingMemoEmailedDate" class="form-control" th:field="*{shippingMemoEmailedDate}" />
                            </div>
                        </div>
                    </div>

                    <!-- Dates Row 2 (Parts Dates) -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="receivedPartsDate" class="form-label">Received Parts Date</label>
                                <input type="date" id="receivedPartsDate" class="form-control" th:field="*{partsReceivedDate}" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="installedPartsDate" class="form-label">Parts Installed Date</label>
                                <input type="date" id="installedPartsDate" class="form-control" th:field="*{installedPartsDate}" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="failedPartsPackedDate" class="form-label">Failed Parts Packed</label>
                                <input type="date" id="failedPartsPackedDate" class="form-control" th:field="*{failedPartsPackedDate}" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="failedPartsShippedDate" class="form-label">Failed Parts Shipped Out Date</label>
                                <input type="date" id="failedPartsShippedDate" class="form-control" th:field="*{failedPartsShippedDate}" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <!-- Technician Information -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h5 class="border-bottom pb-1 mb-3">Technician Information</h5>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fieldTechName" class="form-label">Technician Name</label>
                            <input type="text" id="fieldTechName" class="form-control" th:field="*{fieldTechName}" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fieldTechPhone" class="form-label">Technician Phone</label>
                            <input type="text" id="fieldTechPhone" class="form-control" th:field="*{fieldTechPhone}" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fieldTechEmail" class="form-label">Technician Email</label>
                            <input type="email" id="fieldTechEmail" class="form-control" th:field="*{fieldTechEmail}" />
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h5>Customer Information</h5>
                            <div class="row">
                                <!-- First Row: Customer and Company Ship To Name -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerName" class="form-label">Customer</label>
                                        <input type="text" id="customerName" class="form-control" th:field="*{customerName}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="companyShipToName" class="form-label">Company Ship To Name:</label>
                                        <input type="text" id="companyShipToName" class="form-control" th:field="*{companyShipToName}" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <!-- Second Row: Attn and Company Ship To Address -->
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="attn" class="form-label">Attn:</label>
                                        <input type="text" id="attn" class="form-control" th:field="*{attn}" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="companyShipToAddress" class="form-label">Company Ship To Address:</label>
                                        <input type="text" id="companyShipToAddress" class="form-control" th:field="*{companyShipToAddress}" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <!-- Third Row: City, State, Zip Code (aligned under Address side) -->
                                <div class="col-md-6">
                                    <!-- Intentionally empty to align City/State/Zip under the address block -->
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="city" class="form-label">City:</label>
                                                <input type="text" id="city" class="form-control" th:field="*{city}" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="state" class="form-label">State:</label>
                                                <input type="text" id="state" class="form-control" th:field="*{state}" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="zipCode" class="form-label">Zip Code:</label>
                                                <input type="text" id="zipCode" class="form-control" th:field="*{zipCode}" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <!-- Replace Description with Problem Information Fields -->
                    <div class="mb-3">
                        <h5>Problem Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="problemDiscoverer" class="form-label">1. Who Discovered the Problem:</label>
                                    <input type="text" id="problemDiscoverer" class="form-control" th:field="*{problemDiscoverer}" />
                                </div>
                                
                                <div class="mb-3">
                                    <label for="problemDiscoveryDate" class="form-label">2. When Was It Discovered:</label>
                                    <input type="date" id="problemDiscoveryDate" class="form-control" th:field="*{problemDiscoveryDate}" />
                                </div>
                                
                                <div class="mb-3">
                                    <label for="whatHappened" class="form-label">3. What Happened:</label>
                                    <textarea id="whatHappened" class="form-control" th:field="*{whatHappened}" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="whyAndHowItHappened" class="form-label">4. Why and How Did It Happen:</label>
                                    <textarea id="whyAndHowItHappened" class="form-control" th:field="*{whyAndHowItHappened}" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="howContained" class="form-label">5. How Was It Contained:</label>
                                    <textarea id="howContained" class="form-control" th:field="*{howContained}" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="whoContained" class="form-label">6. Who Contained It:</label>
                                    <input type="text" id="whoContained" class="form-control" th:field="*{whoContained}" />
                                </div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Labor Section -->
                    <h5 class="section-title">Labor</h5>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="laborTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Description</th>
                                            <th style="width: 15%;">Technician</th>
                                            <th style="width: 10%;">Hours</th>
                                            <th style="width: 15%;">Date</th>
                                            <th style="width: 12%;">Price/Hr</th>
                                            <th style="width: 13%;">Ext/Cost</th>
                                            <th style="width: 5%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laborTableBody">
                                        <!-- Existing labor entries -->
                                        <tr th:each="labor, iterStat : ${rma.laborEntries}" class="labor-row">
                                            <td>
                                                <input type="text" class="form-control" th:name="|laborEntries[${iterStat.index}].description|" th:value="${labor.description}" placeholder="Labor description">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" th:name="|laborEntries[${iterStat.index}].technician|" th:value="${labor.technician}" placeholder="Technician name">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control hours-input" th:name="|laborEntries[${iterStat.index}].hours|" th:value="${labor.hours}" step="0.01" min="0" placeholder="0.00">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control" th:name="|laborEntries[${iterStat.index}].laborDate|" th:value="${labor.laborDate}">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control price-input" th:name="|laborEntries[${iterStat.index}].pricePerHour|" th:value="${labor.pricePerHour}" step="0.01" min="0" placeholder="0.00">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control ext-cost" readonly th:value="${labor.extendedCost != null ? '$' + #numbers.formatDecimal(labor.extendedCost, 1, 2) : '$0.00'}">
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm remove-labor-row">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <!-- Default empty row if no entries exist -->
                                        <tr th:if="${rma.laborEntries == null || rma.laborEntries.isEmpty()}" class="labor-row">
                                            <td>
                                                <input type="text" class="form-control" name="laborEntries[0].description" placeholder="Labor description">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" name="laborEntries[0].technician" placeholder="Technician name">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control hours-input" name="laborEntries[0].hours" step="0.01" min="0" placeholder="0.00">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control" name="laborEntries[0].laborDate">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control price-input" name="laborEntries[0].pricePerHour" step="0.01" min="0" placeholder="0.00">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control ext-cost" readonly placeholder="$0.00">
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm remove-labor-row" disabled>
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-success btn-sm" id="addLaborRowBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Labor Row
                                </button>
                                <div class="fw-bold">
                                    Total Labor Cost: <span id="totalLaborCost">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uploaded Files Preview Section -->
                    <div class="card mt-4" id="filePreviewSection" style="display: none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-files me-2"></i>Uploaded Files</h6>
                        </div>
                        <div class="card-body">
                            <div id="filePreviewList" class="list-group">
                                <!-- Files will be added here dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Submit buttons -->
                    <div class="text-end mt-4">
                        <a th:href="@{/rma}" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-lg me-1"></i>
                            <span th:text="${rma.id != null ? 'Update RMA' : 'Create RMA'}">Submit</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Update the transfer modal to select destination without immediate transfer -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Select Transfer Destination</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="transferFileId" name="fileId" value="">
                    <input type="hidden" id="transferFileType" name="fileType" value="">
                    <input type="hidden" id="transferFileName" name="fileName" value="">
                    <input type="hidden" id="transferFilePath" name="filePath" value="">
                    <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id != null ? rma.id : ''}">
                    
                    <div class="mb-3">
                        <label for="targetRmaId" class="form-label">Select Target RMA</label>
                        <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                            <option value="">-- Select RMA --</option>
                            <option th:each="otherRma : ${allRmas}" 
                                    th:if="${otherRma.id != rma.id}" 
                                    th:value="${otherRma.id}" 
                                    th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA NOT PROVIDED') + 
                                              ' - ' + (otherRma.tool != null ? otherRma.tool.name : 'No Tool') + 
                                              ' - ' + (otherRma.customerName != null ? otherRma.customerName : 'No Customer')}">
                                RMA Number - Tool - Customer
                            </option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addToTransferPreviewBtn">Add to Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Replace the confirm handler with Bootstrap modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this file?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Moving Part Modal (Custom for Form Page - Client-side only) -->
    <div class="modal fade" id="addMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Moving Part</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="formMovingPartName" class="form-label">Part Name:</label>
                        <input type="text" class="form-control" id="formMovingPartName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Movement:</label>
                        <div class="mb-2">
                            <strong class="me-2 d-block mb-1">From:</strong>
                            <select class="form-select" id="formFromSelect" onchange="toggleFromCustomInput(this.value)">
                                <option value="">Select source...</option>
                                <option disabled>───── Custom Locations ─────</option>
                                <option th:each="entry : ${customLocations}" 
                                        th:value="'CL_' + ${entry.key.id}"
                                        th:text="${entry.key.name + ' (' + entry.value + ')'}">
                                    Custom Location
                                </option>
                                <option value="CUSTOM">-- New Custom Location --</option>
                                <!-- Session custom locations will be inserted here by JavaScript -->
                                <option disabled>───── Tools ─────</option>
                                <option th:each="t : ${tools}"
                                        th:value="${t.id}" 
                                        th:text="${t.toolType != null && t.toolType.name() == 'AMATGASGUARD' ? ((t.systemName != null ? t.systemName : 'GasGuard') + (t.equipmentLocation != null ? ' - ' + t.equipmentLocation : '')) : (t.name + (t.secondaryName != null ? ' (' + t.secondaryName + ')' : ''))}">
                                    Tool Name
                                </option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="formFromCustomInput" placeholder="e.g., Cabinet, Office, Storage...">
                        </div>
                        
                        <div class="mb-2">
                            <strong class="me-2 d-block mb-1">To:</strong>
                            <select class="form-select" id="formToSelect" onchange="toggleToCustomInputSimple(this.value)">
                                <option value="">Select destination...</option>
                                <option disabled>───── Custom Locations ─────</option>
                                <option th:each="entry : ${customLocations}" 
                                        th:value="'CL_' + ${entry.key.id}"
                                        th:text="${entry.key.name + ' (' + entry.value + ')'}">
                                    Custom Location
                                </option>
                                <option value="CUSTOM">-- New Custom Location --</option>
                                <!-- Session custom locations will be inserted here by JavaScript -->
                                <option disabled>───── Tools ─────</option>
                                <option th:each="t : ${tools}"
                                        th:value="${t.id}" 
                                        th:text="${t.toolType != null && t.toolType.name() == 'AMATGASGUARD' ? ((t.systemName != null ? t.systemName : 'GasGuard') + (t.equipmentLocation != null ? ' - ' + t.equipmentLocation : '')) : (t.name + (t.secondaryName != null ? ' (' + t.secondaryName + ')' : ''))}">
                                    Tool Name
                                </option>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="formToCustomInput" placeholder="e.g., Cabinet, Office, Storage...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="formMovingPartNotes" class="form-label">Notes:</label>
                        <textarea class="form-control" id="formMovingPartNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMovingPartToForm()">Add to RMA</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Validation Error Modal -->
    <div class="modal fade" id="validationErrorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Validation Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="validationErrorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Moving Part Modal JavaScript - Inline for Form Page -->
    <script>
        // Show validation error in modal instead of alert
        function showValidationError(message) {
            document.getElementById('validationErrorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('validationErrorModal'));
            modal.show();
        }
        
        // Toggle custom location input for "From" field (for the modal)
        function toggleFromCustomInput(value) {
            const customInput = document.getElementById('formFromCustomInput');
            
            if (value === 'CUSTOM') {
                customInput.classList.remove('d-none');
                customInput.required = true;
            } else {
                customInput.classList.add('d-none');
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Toggle custom location input for "To" field (for the modal)
        function toggleToCustomInputSimple(value) {
            const customInput = document.getElementById('formToCustomInput');
            
            if (value === 'CUSTOM') {
                customInput.classList.remove('d-none');
                customInput.required = true;
            } else {
                customInput.classList.add('d-none');
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Track custom locations created during this session
        const sessionCustomLocations = new Set();
        
        // Add custom location to dropdowns
        function addCustomLocationToDropdowns(locationName) {
            if (sessionCustomLocations.has(locationName)) {
                return; // Already added
            }
            sessionCustomLocations.add(locationName);
            
            console.log('Adding custom location to dropdowns:', locationName);
            
            const fromSelect = document.getElementById('formFromSelect');
            const toSelect = document.getElementById('formToSelect');
            
            // Create new options with (0) indicator
            const newFromOption = document.createElement('option');
            newFromOption.value = 'SESSION_' + locationName;
            newFromOption.textContent = locationName + ' (0)';
            
            const newToOption = document.createElement('option');
            newToOption.value = 'SESSION_' + locationName;
            newToOption.textContent = locationName + ' (0)';
            
            // Find where to insert - right AFTER the "-- New Custom Location --" option
            const fromCustomOption = fromSelect.querySelector('option[value="CUSTOM"]');
            const toCustomOption = toSelect.querySelector('option[value="CUSTOM"]');
            
            if (fromCustomOption && toCustomOption) {
                // Insert after the "-- New Custom Location --" option
                if (fromCustomOption.nextSibling) {
                    fromSelect.insertBefore(newFromOption, fromCustomOption.nextSibling);
                } else {
                    fromSelect.appendChild(newFromOption);
                }
                
                if (toCustomOption.nextSibling) {
                    toSelect.insertBefore(newToOption, toCustomOption.nextSibling);
                } else {
                    toSelect.appendChild(newToOption);
                }
                
                console.log('Successfully added custom location to both dropdowns');
            } else {
                console.error('Could not find CUSTOM option in dropdowns');
            }
        }
        
        // Add moving part to the form (client-side)
        function addMovingPartToForm() {
            const partName = document.getElementById('formMovingPartName').value.trim();
            const fromSelect = document.getElementById('formFromSelect');
            const fromCustomInput = document.getElementById('formFromCustomInput');
            const toSelect = document.getElementById('formToSelect');
            const toCustomInput = document.getElementById('formToCustomInput');
            const notes = document.getElementById('formMovingPartNotes').value.trim();
            
            // Validation
            if (!partName) {
                showValidationError('Please enter a part name');
                return;
            }
            
            const fromValue = fromSelect.value;
            const fromCustomValue = fromCustomInput.value.trim();
            const toValue = toSelect.value;
            const toCustomValue = toCustomInput.value.trim();
            
            if (!fromValue || (fromValue === 'CUSTOM' && !fromCustomValue)) {
                showValidationError('Please select or enter a source location');
                return;
            }
            
            if (!toValue || (toValue === 'CUSTOM' && !toCustomValue)) {
                showValidationError('Please select or enter a destination location');
                return;
            }
            
            // Determine display names and actual values
            let fromText, fromActualValue;
            if (fromValue === 'CUSTOM') {
                fromText = fromCustomValue;
                fromActualValue = 'CUSTOM:' + fromCustomValue;
                addCustomLocationToDropdowns(fromCustomValue);
            } else if (fromValue.startsWith('SESSION_')) {
                const locationName = fromValue.substring(8); // Remove 'SESSION_' prefix
                fromText = locationName;
                fromActualValue = 'CUSTOM:' + locationName;
            } else {
                fromText = fromSelect.options[fromSelect.selectedIndex].text;
                fromActualValue = fromValue;
            }
            
            let toText, toActualValue;
            if (toValue === 'CUSTOM') {
                toText = toCustomValue;
                toActualValue = 'CUSTOM:' + toCustomValue;
                addCustomLocationToDropdowns(toCustomValue);
            } else if (toValue.startsWith('SESSION_')) {
                const locationName = toValue.substring(8); // Remove 'SESSION_' prefix
                toText = locationName;
                toActualValue = 'CUSTOM:' + locationName;
            } else {
                toText = toSelect.options[toSelect.selectedIndex].text;
                toActualValue = toValue;
            }
            
            // Add row to table
            const tbody = document.getElementById('moving-parts-table-body');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${partName}</td>
                <td>${fromText}</td>
                <td>${toText}</td>
                <td>${notes || '-'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <input type="hidden" name="movingPartNames" value="${partName}">
                <input type="hidden" name="movingPartFroms" value="${fromActualValue}">
                <input type="hidden" name="movingPartTos" value="${toActualValue}">
                <input type="hidden" name="movingPartNotes" value="${notes}">
            `;
            
            // Clear modal and close
            document.getElementById('formMovingPartName').value = '';
            fromSelect.selectedIndex = 0;
            toSelect.selectedIndex = 0;
            document.getElementById('formMovingPartNotes').value = '';
            fromCustomInput.classList.add('d-none');
            fromCustomInput.value = '';
            toCustomInput.classList.add('d-none');
            toCustomInput.value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('addMovingPartModal')).hide();
        }
        
        // Toggle custom location input for "To" fields
        function toggleToCustomInput(selectElement) {
            const parentRow = selectElement.closest('.destination-row');
            const customInput = parentRow.querySelector('.to-custom-input');
            if (selectElement.value === 'CUSTOM') {
                customInput.classList.remove('d-none');
                customInput.required = true;
                selectElement.required = false;
            } else {
                customInput.classList.add('d-none');
                customInput.required = false;
                customInput.value = '';
                selectElement.required = true;
            }
        }
        
        // Add destination row functionality
        function addDestinationRow(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Container not found:', containerId);
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'destination-row mb-2';
            
            const firstSelect = container.querySelector('.destination-select');
            if (!firstSelect) {
                console.error('First select not found in container');
                return;
            }
            
            const toolOptions = firstSelect.innerHTML;
            
            newRow.innerHTML = `
                <div class="d-flex align-items-center mb-1">
                    <strong class="me-2">To:</strong>
                    <select class="form-select destination-select" name="destinationToolIds" onchange="toggleToCustomInput(this)" required>
                        ${toolOptions}
                    </select>
                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination">
                        <i class="bi bi-dash"></i>
                    </button>
                </div>
                <input type="text" class="form-control d-none to-custom-input" name="toCustomLocations" placeholder="e.g., Cabinet, Office, Storage...">
            `;
            
            container.appendChild(newRow);
            updateRemoveButtons(containerId);
        }
        
        function updateRemoveButtons(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const rows = container.querySelectorAll('.destination-row');
            
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-destination');
                if (removeBtn) {
                    removeBtn.style.display = rows.length > 1 ? 'block' : 'none';
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.debug('Moving part modal script loaded for form page');
            
            // Setup form submission handler
            const addForm = document.getElementById('add-moving-part-form');
            console.debug('Looking for add-moving-part-form:', addForm);
            if (addForm) {
                console.debug('Attaching submit handler to add-moving-part-form');
                addForm.addEventListener('submit', function(e) {
                    console.debug('Form submit handler triggered!');
                    const fromSelect = document.getElementById('fromToolIdSelect');
                    const hiddenInput = document.getElementById('fromToolId');
                    const customInput = document.getElementById('fromCustomInput');
                    
                    console.debug('fromSelect.value:', fromSelect ? fromSelect.value : 'NULL');
                    console.debug('customInput.value:', customInput ? customInput.value : 'NULL');
                    console.debug('hiddenInput.value:', hiddenInput ? hiddenInput.value : 'NULL');
                    
                    // Validate: must have either a tool selected OR custom location filled
                    if (fromSelect && hiddenInput) {
                        if (fromSelect.value === 'CUSTOM') {
                            console.debug('CUSTOM selected, checking customInput...');
                            if (!customInput.value || customInput.value.trim() === '') {
                                console.debug('Custom input is empty, preventing submission');
                                e.preventDefault();
                                showValidationError('Please enter a custom location.');
                                return false;
                            }
                            console.debug('Custom location is valid:', customInput.value);
                            hiddenInput.value = ''; // No tool ID for custom location
                        } else if (fromSelect.value) {
                            console.debug('Tool selected:', fromSelect.value);
                            hiddenInput.value = fromSelect.value;
                        } else {
                            // Neither tool nor custom location selected
                            console.debug('Nothing selected, preventing submission');
                            e.preventDefault();
                            showValidationError('Please select a source tool (From).');
                            return false;
                        }
                    }
                    
                    console.debug('Validation passed, allowing submission');
                    
                    // Handle destination selects - disable CUSTOM values so they don't submit
                    const destSelects = addForm.querySelectorAll('.destination-select');
                    destSelects.forEach(select => {
                        if (select.value === 'CUSTOM') {
                            select.disabled = true;
                        }
                    });
                });
            } else {
                console.debug('add-moving-part-form NOT FOUND!');
            }
            
            // Add destination functionality for add modal
            const addBtn = document.getElementById('addDestinationBtnForm');
            if (addBtn) {
                console.debug('Found addDestinationBtnForm button');
                addBtn.addEventListener('click', function() {
                    console.debug('Add destination button clicked');
                    addDestinationRow('destinationContainerForm');
                });
            } else {
                console.debug('addDestinationBtnForm button not found');
            }
            
            // Remove destination functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-destination')) {
                    e.target.closest('.destination-row').remove();
                    updateRemoveButtons('destinationContainerForm');
                }
            });
        });
    </script>
<script th:src="@{/js/theme-toggle.js}"></script>

<!-- Select Tools Modal (Form) -->
    <div class="modal fade" id="selectToolsModal" tabindex="-1" aria-labelledby="selectToolsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectToolsModalLabel">Select Tools</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <div class="d-flex align-items-center mb-2">
                            <label class="me-2">Sort by Location:</label>
                            <select id="toolLocationFilterForm" class="form-select form-select-sm" style="max-width: 280px;"></select>
                        </div>
                            <div class="mb-2">
                                <input id="toolSearchInputForm" type="text" class="form-control form-control-sm" placeholder="Search tools... (name or secondary)">
                            </div>
                        <div class="border rounded p-2" style="max-height: 360px; overflow:auto;">
                            <div id="toolPickerListForm" class="list-group list-group-flush small"></div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h6 class="mb-2">Affected Tools</h6>
                        <div id="affectedToolsChipsFormModal" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAffectedToolsFormBtn">Save</button>
            </div>
        </div>
    </div>
    </div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const formAllTools = /*[[${tools}]]*/ [];
    const formCurrentUser = /*[[${currentUser}]]*/ null;
    const formActiveSite = formCurrentUser && formCurrentUser.activeSite ? formCurrentUser.activeSite.displayName : null;
    const formSelected = new Set();

    function formBuildLocationOptions() {
        const select = document.getElementById('toolLocationFilterForm');
        if (!select) return;
        const locations = Array.from(new Set(formAllTools.map(t => t.locationName || 'Unknown'))).sort((a,b)=>a.localeCompare(b));
        select.innerHTML = '';
        for (const loc of locations) {
            const opt = document.createElement('option');
            opt.value = loc; opt.textContent = loc;
            if (formActiveSite && loc.toLowerCase() === formActiveSite.toLowerCase()) opt.selected = true;
            select.appendChild(opt);
        }
        select.addEventListener('change', formRenderToolPicker);
        const search = document.getElementById('toolSearchInputForm');
        if (search) search.addEventListener('input', formRenderToolPicker);
    }

    function formRenderToolPicker() {
        const listEl = document.getElementById('toolPickerListForm');
        const loc = document.getElementById('toolLocationFilterForm').value;
        const q = (document.getElementById('toolSearchInputForm')?.value || '').trim().toLowerCase();
        let tools = formAllTools
            .filter(t => (t.locationName || 'Unknown') === loc)
            .filter(t => !formSelected.has(t.id)) // hide already-selected; they appear on right
            .filter(t => {
                if (!q) return true;
                const n = (t.name || '').toLowerCase();
                const s = (t.secondaryName || '').toLowerCase();
                return n.includes(q) || s.includes(q);
            })
            .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        listEl.innerHTML = '';
        if (tools.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'text-muted small px-2';
            empty.textContent = 'No tools match.';
            listEl.appendChild(empty);
            return;
        }
        for (const t of tools) {
            const a = document.createElement('a'); a.href = '#';
            a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            a.textContent = t.name || 'Unnamed';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'form-check-input';
            chk.checked = false;
            // Prevent anchor click from toggling twice when clicking directly on the checkbox
            chk.addEventListener('click', (e) => { e.stopPropagation(); });
            chk.addEventListener('change', () => formToggleSelected(t));
            a.appendChild(chk);
            a.addEventListener('click', (e)=>{ e.preventDefault(); formToggleSelected(t); });
            listEl.appendChild(a);
        }
    }

    function formRenderChips() {
        const list = document.getElementById('affectedToolsChipsForm');
        const listModal = document.getElementById('affectedToolsChipsFormModal');
        list.innerHTML = ''; listModal.innerHTML = '';
        const selected = formAllTools.filter(t => formSelected.has(t.id));

        const buildListItem = (tool, includeDelete) => {
            const row = document.createElement('a');
            row.href = '#';
            row.className = 'list-group-item list-group-item-action py-1 px-2';
            row.textContent = tool.name || 'Unnamed';
            row.addEventListener('click', (e)=>{ e.preventDefault(); formSelectToolForDetails(tool.id, row); });
            if (includeDelete) {
                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'btn btn-danger btn-sm ms-2 float-end';
                del.innerHTML = '<i class="bi bi-trash"></i>';
                del.addEventListener('click', (e) => { e.stopPropagation(); formSelected.delete(tool.id); formRenderChips(); formRenderToolPicker(); });
                row.appendChild(del);
            }
            return row;
        };

        // Containers should appear as list groups
        list.classList.add('list-group');
        listModal.classList.add('list-group');

        if (selected.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'text-muted small';
            empty.textContent = 'No tools selected.';
            list.appendChild(empty.cloneNode(true));
            listModal.appendChild(empty);
        } else {
            for (let i = 0; i < selected.length; i++) {
                const t = selected[i];
                list.appendChild(buildListItem(t, false)); // outside modal: no delete button
                listModal.appendChild(buildListItem(t, true)); // inside modal: keep delete
            }
            // Default select first tool for details (deferred to ensure DOM is ready)
            if (selected.length > 0) {
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const firstRow = list.firstElementChild;
                        if (firstRow && firstRow.tagName === 'A') {
                            formSelectToolForDetails(selected[0].id, firstRow);
                        }
                    }, 50);
                });
            }
        }
        // Sync hidden CSV + legacy select if exactly one
        const ids = Array.from(formSelected);
        const csv = ids.join(',');
        const hidden = document.getElementById('affectedToolIds');
        if (hidden) hidden.value = csv;
        const legacySelect = document.getElementById('toolSelect');
        if (ids.length === 1) legacySelect.value = String(ids[0]); else legacySelect.value = '';
    }

    let formCurrentDetailsToolId = null;
    function formSelectToolForDetails(toolId, rowEl) {
        formCurrentDetailsToolId = toolId;
        // highlight selection
        const container = document.getElementById('affectedToolsChipsForm');
        Array.from(container.children).forEach(el => el.classList.remove('selected-tool-active'));
        if (rowEl) rowEl.classList.add('selected-tool-active');
        // update legacy select for downstream consumers (e.g., destination auto-populate)
        const legacySelect = document.getElementById('toolSelect');
        if (legacySelect) legacySelect.value = String(toolId);
        // fetch and display tool details
        renderSelectedToolDetails(toolId);
    }

    function renderSelectedToolDetails(toolId) {
        const t = formAllTools.find(x => String(x.id) === String(toolId));
        if (!t) return;
        const typeEl = document.getElementById('tool-type');
        if (typeEl) typeEl.textContent = (t.toolType && t.toolType.displayName) || t.toolType || '';
        const locEl = document.getElementById('tool-location');
        if (locEl) locEl.textContent = t.locationName || '';
        const s1El = document.getElementById('tool-serial1');
        if (s1El) s1El.textContent = t.serialNumber1 || '';
        const s2 = document.getElementById('tool-serial2-display'); 
        if (s2) s2.textContent = t.serialNumber2 ? '/' + t.serialNumber2 : '';
        const m1El = document.getElementById('tool-model1');
        if (m1El) m1El.textContent = t.model1 || '';
        const m2 = document.getElementById('tool-model2-display'); 
        if (m2) m2.textContent = t.model2 ? '/' + t.model2 : '';
        const chemEl = document.getElementById('tool-chemical-gas-service');
        if (chemEl) chemEl.textContent = t.chemicalGasService || '';
        const view = document.getElementById('tool-view-link'); 
        if (view) { 
            view.href = '/tools/' + t.id; 
            view.style.display = 'inline-block'; 
        }
    }

    function formToggleSelected(tool) {
        if (formSelected.has(tool.id)) {
            formSelected.delete(tool.id);
        } else {
            formSelected.add(tool.id);
        }
        // After change, re-render chips and the left list (which hides selected tools)
        formRenderChips();
        formRenderToolPicker();
    }

    document.getElementById('selectToolsModal')?.addEventListener('shown.bs.modal', ()=>{
        formBuildLocationOptions();
        formRenderToolPicker();
        formRenderChips();
    });

    document.getElementById('saveAffectedToolsFormBtn')?.addEventListener('click', ()=>{
        const modalEl = document.getElementById('selectToolsModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal?.hide();
    });
    // Expose to global so Excel parser can sync selections after parse
    window.formSelected = formSelected;
    window.formRenderChips = formRenderChips;
    window.formRenderToolPicker = formRenderToolPicker;
    window.formSelectToolForDetails = formSelectToolForDetails;
    // Address preview (pull from selected option data-address to avoid JSON needs)
    (function() {
        const selectEl = document.getElementById('returnMaterialsTo');
        const previewWrap = document.getElementById('returnAddressPreview');
        const previewPre = previewWrap ? previewWrap.querySelector('pre') : null;
        const purgedSection = document.getElementById('purgedAndDoubleBaggedSection');
        
        function updatePreview() {
            if (!selectEl || !previewWrap || !previewPre) return;
            const opt = selectEl.options[selectEl.selectedIndex];
            let addr = opt ? (opt.getAttribute('data-address') || '') : '';
            if (!addr) {
                try {
                    if (window && typeof window.nameToAddress === 'object' && window.nameToAddress !== null) {
                        addr = window.nameToAddress[selectEl.value] || '';
                    }
                } catch (e) { }
            }
            if (!addr) {
                previewWrap.style.display = 'none';
                previewPre.textContent = '';
            } else {
                previewPre.textContent = addr;
                previewWrap.style.display = '';
            }
            if (purgedSection) {
                const selectedValue = selectEl.value;
                if (selectedValue && selectedValue.trim()) {
                    purgedSection.style.display = 'block';
                    const na = document.getElementById('purgedAndDoubleBaggedNA');
                    const optionsDiv = document.getElementById('purgedAndDoubleBaggedOptions');
                    const hidden = document.getElementById('purgedAndDoubleBaggedHidden');
                    const yesRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedYes');
                    const noRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedNo');
                    if (na && optionsDiv && hidden) {
                        na.checked = true;
                        optionsDiv.classList.add('d-none');
                        optionsDiv.style.display = 'none';
                        optionsDiv.hidden = true;
                        hidden.value = '';
                        if (yesRadio) yesRadio.checked = false;
                        if (noRadio) noRadio.checked = false;
                        na.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    purgedSection.style.display = 'none';
                    const na = document.getElementById('purgedAndDoubleBaggedNA');
                    const optionsDiv = document.getElementById('purgedAndDoubleBaggedOptions');
                    const hidden = document.getElementById('purgedAndDoubleBaggedHidden');
                    const yesRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedYes');
                    const noRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedNo');
                    if (na && optionsDiv && hidden) {
                        na.checked = true;
                        optionsDiv.classList.add('d-none');
                        optionsDiv.style.display = 'none';
                        optionsDiv.hidden = true;
                        hidden.value = '';
                        if (yesRadio) yesRadio.checked = false;
                        if (noRadio) noRadio.checked = false;
                        na.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            }
        }
        
        if (selectEl) {
            selectEl.addEventListener('change', updatePreview);
            updatePreview();
        }
    })();
    
    // Purged and Double Bagged N/A checkbox handler (bind immediately)
    (function() {
        // Auto-set priority to NONE when status is set to COMPLETED (user can still change afterward)
        const statusSelect = document.getElementById('status');
        const prioritySelect = document.getElementById('priority');
        if (statusSelect && prioritySelect) {
            statusSelect.addEventListener('change', function() {
                if (this.value === 'COMPLETED') {
                    // Only set to NONE if user hasn't chosen something else in the same interaction
                    prioritySelect.value = 'NONE';
                }
            });
        }

        const naCheckbox = document.getElementById('purgedAndDoubleBaggedNA');
        const optionsDiv = document.getElementById('purgedAndDoubleBaggedOptions');
        const yesRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedYes');
        const noRadio = document.getElementById('purgedAndDoubleBaggedGoodsEnclosedNo');
        const hiddenInput = document.getElementById('purgedAndDoubleBaggedHidden');
        function forceHideOptions() {
            optionsDiv.classList.add('d-none');
            optionsDiv.style.display = 'none';
            optionsDiv.hidden = true;
            optionsDiv.setAttribute('aria-hidden', 'true');
        }
        function forceShowOptions() {
            optionsDiv.classList.remove('d-none');
            optionsDiv.hidden = false;
            optionsDiv.removeAttribute('aria-hidden');
            optionsDiv.style.display = '';
        }
        function updateVisibilityAndValue() {
            if (!naCheckbox || !optionsDiv || !hiddenInput) return;
            if (naCheckbox.checked) {
                forceHideOptions();
                hiddenInput.value = '';
                if (yesRadio) yesRadio.checked = false;
                if (noRadio) noRadio.checked = false;
            } else {
                forceShowOptions();
                if (yesRadio && yesRadio.checked) {
                    hiddenInput.value = 'true';
                } else if (noRadio && noRadio.checked) {
                    hiddenInput.value = 'false';
                } else {
                    hiddenInput.value = 'false';
                    if (noRadio) noRadio.checked = true;
                }
            }
        }
        if (naCheckbox && optionsDiv && hiddenInput) {
            const onNaToggle = function() { updateVisibilityAndValue(); };
            naCheckbox.addEventListener('change', onNaToggle);
            naCheckbox.addEventListener('input', onNaToggle);
            if (yesRadio) {
                yesRadio.addEventListener('change', function() {
                    if (this.checked) { naCheckbox.checked = false; updateVisibilityAndValue(); }
                });
            }
            if (noRadio) {
                noRadio.addEventListener('change', function() {
                    if (this.checked) { naCheckbox.checked = false; updateVisibilityAndValue(); }
                });
            }
            const returnSelect = document.getElementById('returnMaterialsTo');
            if (returnSelect) { returnSelect.addEventListener('change', updateVisibilityAndValue); }
            updateVisibilityAndValue();
        }
    })();
    /*]]>*/
</script>
<script>
        // Initialize RMA namespace
        window.RMA = window.RMA || {};
    </script>
    <script src="/js/rma.js"></script>
    <script src="/js/rma-excel.js"></script>
    <script src="/js/rma-excel-parser.js"></script>
    <script src="/js/rma-file-upload.js"></script>
    <script src="/js/rma-moving-parts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Excel upload functionality
            if (RMA.excel && typeof RMA.excel.init === 'function') {
                RMA.excel.init();
            }
            
            // Initialize other RMA functionality
            if (RMA.init && typeof RMA.init === 'function') {
                RMA.init();
            }
            
            // Auto-populate TO field in Moving Parts modal with selected tool from RMA form
            const addMovingPartModalEl = document.getElementById('addMovingPartModal');
            if (addMovingPartModalEl) {
                addMovingPartModalEl.addEventListener('show.bs.modal', function () {
                    const toolSelect = document.getElementById('toolSelect');
                    const destinationSelect = document.getElementById('formToSelect');
                    
                    console.log('[FORM PAGE] Modal opened, toolSelect value:', toolSelect ? toolSelect.value : 'NULL');
                    console.log('[FORM PAGE] destinationSelect found:', destinationSelect ? 'YES' : 'NO');
                    
                    if (toolSelect && destinationSelect && toolSelect.value) {
                        // Set the destination tool to the currently selected tool in the main form
                        console.log('[FORM PAGE] Setting destinationSelect to:', toolSelect.value);
                        destinationSelect.value = toolSelect.value;
                    }
                });
            }
            
            // Override the form submission in the reusable modal for RMA form page
            const movingPartModalElement = document.getElementById('addMovingPartModal');
            if (movingPartModalElement) {
                const form = movingPartModalElement.querySelector('form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault(); // Prevent default form submission
                        
                        const partName = document.getElementById('movingPartName').value.trim();
                        const fromToolId = document.getElementById('fromToolId').value;
                        const destinationSelects = document.querySelectorAll('#destinationContainerForm .destination-select');
                        const notes = document.getElementById('movingPartNotes').value.trim();
                        
                        // Validation
                        if (!partName) {
                            alert('Please enter a part name.');
                            return;
                        }
                        
                        if (!fromToolId) {
                            alert('Please select a source tool (From).');
                            return;
                        }
                        
                        // Get destination tool IDs
                        const destinationToolIds = [];
                        destinationSelects.forEach(select => {
                            if (select.value) {
                                destinationToolIds.push(select.value);
                            }
                        });
                        
                        if (destinationToolIds.length === 0) {
                            alert('Please select at least one destination tool (To).');
                            return;
                        }
                        
                        // For new RMAs (no ID yet), just add to the form as hidden inputs
                        const rmaIdInput = document.querySelector('input[name="id"]');
                        const rmaId = rmaIdInput ? rmaIdInput.value : null;
                        
                        if (!rmaId) {
                            // For new RMAs, store the moving parts data to be submitted with the form
                            addMovingPartToNewRmaForm(partName, fromToolId, destinationToolIds, notes);
                            
                            // Add visual row to the table
                            addMovingPartVisualRow(partName, fromToolId, destinationToolIds, notes);
                            
                            // Clear the modal form and close
                            clearMovingPartModal();
                        } else {
                            // For existing RMAs, submit to the server immediately
                            submitMovingPartToServer(rmaId, partName, fromToolId, destinationToolIds, notes);
                        }
                    });
                }
            }
            
            // Helper function to add moving part data to new RMA form
            function addMovingPartToNewRmaForm(partName, fromToolId, destinationToolIds, notes) {
                const formElement = document.getElementById('rmaForm');
                if (!formElement) return;
                
                // Count existing moving parts to get the index
                const existingInputs = formElement.querySelectorAll('input[name^="tempMovingParts["]');
                const index = Math.floor(existingInputs.length / 4); // 4 inputs per moving part
                
                // Create hidden inputs for the moving part data
                const hiddenInputs = [
                    { name: `tempMovingParts[${index}].partName`, value: partName },
                    { name: `tempMovingParts[${index}].fromToolId`, value: fromToolId },
                    { name: `tempMovingParts[${index}].destinationToolIds`, value: destinationToolIds.join(',') },
                    { name: `tempMovingParts[${index}].notes`, value: notes || '' }
                ];
                
                hiddenInputs.forEach(inputData => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = inputData.name;
                    input.value = inputData.value;
                    formElement.appendChild(input);
                });
            }
            
            // Helper function to add visual row to the table
            function addMovingPartVisualRow(partName, fromToolId, destinationToolIds, notes) {
                const tableBody = document.getElementById('moving-parts-table-body');
                if (!tableBody) return;
                
                const row = document.createElement('tr');
                
                // Get tool names for display
                const fromToolSelect = document.getElementById('fromToolId');
                const fromToolName = fromToolSelect.options[fromToolSelect.selectedIndex].text;
                
                const destinationNames = [];
                destinationToolIds.forEach(toolId => {
                    const allSelects = document.querySelectorAll('#destinationContainerForm .destination-select');
                    for (let select of allSelects) {
                        if (select.value === toolId) {
                            destinationNames.push(select.options[select.selectedIndex].text);
                            break;
                        }
                    }
                });
                
                row.innerHTML = `
                    <td>${partName}</td>
                    <td>${fromToolName}</td>
                    <td>${destinationNames.join(', ')}</td>
                    <td>${notes || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMovingPartRow(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            // Helper function to clear and close the modal
            function clearMovingPartModal() {
                document.getElementById('movingPartName').value = '';
                document.getElementById('fromToolId').value = '';
                document.querySelectorAll('#destinationContainerForm .destination-select').forEach(select => select.value = '');
                document.getElementById('movingPartNotes').value = '';
                
                const modalElement = document.getElementById('addMovingPartModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
            
            // Helper function to submit moving part to server for existing RMAs
            function submitMovingPartToServer(rmaId, partName, fromToolId, destinationToolIds, notes) {
                const formData = new FormData();
                formData.append('partName', partName);
                formData.append('fromToolId', fromToolId);
                destinationToolIds.forEach(id => formData.append('destinationToolIds', id));
                if (notes) formData.append('notes', notes);
                
                fetch(`/rma/${rmaId}/moving-parts/add`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Reload the page to show the updated moving parts
                        window.location.reload();
                    } else {
                        alert('Error adding moving part. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding moving part. Please try again.');
                });
            }
            
            // Global function to remove moving part rows (for new RMAs)
            window.removeMovingPartRow = function(button) {
                const row = button.closest('tr');
                const index = Array.from(row.parentNode.children).indexOf(row);
                
                // Remove the visual row
                row.remove();
                
                // Remove corresponding hidden inputs for new RMAs
                const formElement = document.getElementById('rmaForm');
                if (formElement) {
                    const inputsToRemove = formElement.querySelectorAll(`input[name^="tempMovingParts[${index}]"]`);
                    inputsToRemove.forEach(input => input.remove());
                    
                    // Reindex remaining inputs
                    const remainingInputs = formElement.querySelectorAll('input[name^="tempMovingParts["]');
                    const groupedInputs = {};
                    
                    remainingInputs.forEach(input => {
                        const match = input.name.match(/tempMovingParts\[(\d+)\]\.(.+)/);
                        if (match) {
                            const oldIndex = parseInt(match[1]);
                            const field = match[2];
                            if (!groupedInputs[oldIndex]) groupedInputs[oldIndex] = [];
                            groupedInputs[oldIndex].push({ input, field });
                        }
                    });
                    
                    // Remove all temp moving part inputs
                    remainingInputs.forEach(input => input.remove());
                    
                    // Re-add with correct indices
                    Object.keys(groupedInputs).sort((a, b) => parseInt(a) - parseInt(b)).forEach((oldIndex, newIndex) => {
                        groupedInputs[oldIndex].forEach(({ input, field }) => {
                            const newInput = document.createElement('input');
                            newInput.type = 'hidden';
                            newInput.name = `tempMovingParts[${newIndex}].${field}`;
                            newInput.value = input.value;
                            formElement.appendChild(newInput);
                        });
                    });
                }
            };
        });

        // Labor table functionality
        let laborRowCount = document.querySelectorAll('.labor-row').length;

        // Add labor row
        document.getElementById('addLaborRowBtn').addEventListener('click', function() {
            const tbody = document.getElementById('laborTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'labor-row';
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control" name="laborEntries[${laborRowCount}].description" placeholder="Labor description">
                </td>
                <td>
                    <input type="text" class="form-control" name="laborEntries[${laborRowCount}].technician" placeholder="Technician name">
                </td>
                <td>
                    <input type="number" class="form-control hours-input" name="laborEntries[${laborRowCount}].hours" step="0.01" min="0" placeholder="0.00">
                </td>
                <td>
                    <input type="date" class="form-control" name="laborEntries[${laborRowCount}].laborDate">
                </td>
                <td>
                    <input type="number" class="form-control price-input" name="laborEntries[${laborRowCount}].pricePerHour" step="0.01" min="0" placeholder="0.00">
                </td>
                <td>
                    <input type="text" class="form-control ext-cost" readonly placeholder="$0.00">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-labor-row">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            laborRowCount++;
            
            // Add event listeners for the new row
            addLaborRowEventListeners(newRow);
            updateRemoveButtonStates();
        });

        // Remove labor row
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-labor-row')) {
                const button = e.target.closest('.remove-labor-row');
                const row = button.closest('tr');
                row.remove();
                updateRemoveButtonStates();
                calculateTotalLaborCost();
                reindexLaborRows();
            }
        });

        // Update remove button states
        function updateRemoveButtonStates() {
            const removeButtons = document.querySelectorAll('.remove-labor-row');
            const hasMultipleRows = removeButtons.length > 1;
            removeButtons.forEach(button => {
                button.disabled = !hasMultipleRows;
            });
        }

        // Reindex labor rows after removal
        function reindexLaborRows() {
            const rows = document.querySelectorAll('.labor-row');
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input[name*="laborEntries"]');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    const newName = name.replace(/laborEntries\[\d+\]/, `laborEntries[${index}]`);
                    input.setAttribute('name', newName);
                });
            });
            laborRowCount = rows.length;
        }

        // Add event listeners for labor calculations
        function addLaborRowEventListeners(row) {
            const hoursInput = row.querySelector('.hours-input');
            const priceInput = row.querySelector('.price-input');
            const extCostInput = row.querySelector('.ext-cost');

            function calculateExtCost() {
                const hours = parseFloat(hoursInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const extCost = hours * price;
                extCostInput.value = '$' + extCost.toFixed(2);
                calculateTotalLaborCost();
            }

            hoursInput.addEventListener('input', calculateExtCost);
            priceInput.addEventListener('input', calculateExtCost);
        }

        // Calculate total labor cost
        function calculateTotalLaborCost() {
            let total = 0;
            document.querySelectorAll('.labor-row').forEach(row => {
                const hours = parseFloat(row.querySelector('.hours-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                total += hours * price;
            });
            document.getElementById('totalLaborCost').textContent = '$' + total.toFixed(2);
        }

        // Initialize event listeners for existing rows
        document.querySelectorAll('.labor-row').forEach(addLaborRowEventListeners);
        updateRemoveButtonStates();

        // Parts table functionality
        let partRowCount = document.querySelectorAll('.part-row').length;

        // Add part row
        document.getElementById('addPartBtn').addEventListener('click', function() {
            const tbody = document.getElementById('partsTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'part-row';
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control" name="partLineItems[${partRowCount}].partName" placeholder="Part Name">
                </td>
                <td>
                    <input type="text" class="form-control" name="partLineItems[${partRowCount}].partNumber" placeholder="Part Number">
                </td>
                <td>
                    <input type="text" class="form-control" name="partLineItems[${partRowCount}].productDescription" placeholder="Item Description">
                </td>
                <td>
                    <input type="number" class="form-control" name="partLineItems[${partRowCount}].quantity" value="1" min="1" placeholder="Qty">
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="partLineItems[${partRowCount}].replacementRequired">
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-part-row">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            partRowCount++;
            updateRemovePartButtonStates();
        });

        // Remove part row
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-part-row')) {
                const button = e.target.closest('.remove-part-row');
                const row = button.closest('tr');
                row.remove();
                updateRemovePartButtonStates();
                reindexPartRows();
            }
        });

        // Update remove button states for parts
        function updateRemovePartButtonStates() {
            const removeButtons = document.querySelectorAll('.remove-part-row');
            const hasMultipleRows = removeButtons.length > 1;
            removeButtons.forEach(button => {
                button.disabled = !hasMultipleRows;
            });
        }

        // Reindex part rows after removal
        function reindexPartRows() {
            const rows = document.querySelectorAll('.part-row');
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input[name*="partLineItems"]');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    const newName = name.replace(/partLineItems\[\d+\]/, `partLineItems[${index}]`);
                    input.setAttribute('name', newName);
                });
            });
            partRowCount = rows.length;
        }

        // Initialize parts functionality
        updateRemovePartButtonStates();
    </script>

    <!-- File Upload Management Script -->
    <script>
        // Default Written Date to today for new RMAs
        document.addEventListener('DOMContentLoaded', function() {
            const writtenDateInput = document.getElementById('writtenDate');
            if (writtenDateInput && !writtenDateInput.value) {
                // Set to today's date in YYYY-MM-DD format
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                writtenDateInput.value = year + '-' + month + '-' + day;
            }
        });

        // Staged files array (kept in memory until form submission)
        let stagedFiles = [];

        // Upload Excel Button Handler - triggers the hidden file input
        document.getElementById('uploadExcelBtn').addEventListener('click', function() {
            document.getElementById('excelFileInput').click();
        });

        // Upload Files Button Handler
        document.getElementById('uploadFilesBtn').addEventListener('click', function() {
            document.getElementById('fileUploadInput').click();
        });

        // Address preview logic (removed duplicate; handled in th:inline script above)

        // Files Selection Handler
        document.getElementById('fileUploadInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                // Add files to staged array
                files.forEach(file => {
                    const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    stagedFiles.push({
                        id: fileId,
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    });
                });
                
                // Update preview
                renderFilePreview();
                showNotification('Files Added', files.length + ' file(s) staged for upload.', 'success');
            }
            // Reset input so same file can be selected again
            e.target.value = '';
        });

        // Render File Preview
        function renderFilePreview() {
            const section = document.getElementById('filePreviewSection');
            const list = document.getElementById('filePreviewList');
            
            if (stagedFiles.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            stagedFiles.forEach(fileObj => {
                const fileIcon = getFileIcon(fileObj.name, fileObj.type);
                const fileSize = formatFileSize(fileObj.size);
                
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = '<div class="d-flex align-items-center">' +
                        '<i class="bi ' + fileIcon + ' fs-4 me-3"></i>' +
                        '<div>' +
                            '<div class="fw-bold">' + fileObj.name + '</div>' +
                            '<small class="text-muted">' + fileSize + '</small>' +
                        '</div>' +
                    '</div>' +
                    '<button type="button" class="btn btn-danger btn-sm" onclick="removeFile(\'' + fileObj.id + '\')">' +
                        '<i class="bi bi-trash"></i>' +
                    '</button>';
                list.appendChild(item);
            });
        }

        // Remove File from Staged List
        window.removeFile = function(fileId) {
            stagedFiles = stagedFiles.filter(f => f.id !== fileId);
            renderFilePreview();
            showNotification('File Removed', 'File removed from upload list.', 'info');
        };

        // Get File Icon Based on Type
        function getFileIcon(filename, mimeType) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext) || mimeType.startsWith('image/')) {
                return 'bi-file-earmark-image text-primary';
            } else if (ext === 'pdf') {
                return 'bi-file-earmark-pdf text-danger';
            } else if (['xls', 'xlsx'].includes(ext)) {
                return 'bi-file-earmark-excel text-success';
            } else if (['doc', 'docx'].includes(ext)) {
                return 'bi-file-earmark-word text-info';
            } else {
                return 'bi-file-earmark text-secondary';
            }
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Show Notification (Bootstrap Toast)
        function showNotification(title, message, type = 'info') {
            const toastHtml = '<div class="toast align-items-center text-bg-' + type + ' border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
                    '<div class="d-flex">' +
                        '<div class="toast-body">' +
                            '<strong>' + title + '</strong><br>' + message +
                        '</div>' +
                        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
                    '</div>' +
                '</div>';
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            const toastEl = document.body.lastElementChild;
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // Form Submit Handler - Attach Staged Files
        document.getElementById('rmaForm').addEventListener('submit', function(e) {
            if (stagedFiles.length > 0) {
                // Create a DataTransfer to add files to the hidden input
                const dataTransfer = new DataTransfer();
                stagedFiles.forEach(fileObj => {
                    dataTransfer.items.add(fileObj.file);
                });
                
                // Note: We'll need to handle this on the backend differently
                // For now, we'll just allow the form to submit
                // The files will be sent via a separate AJAX call after RMA creation
                
                console.log(stagedFiles.length + ' files ready to upload');
            }
        });
    </script>
</body>
</html> 
