<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/components/detail-page.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* RMA-specific enhancements to the detail page design */
        .rma-status-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rma-status-badge:hover {
            transform: scale(1.05);
        }
        
        .rma-priority-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rma-priority-badge:hover {
            transform: scale(1.05);
        }
        
        /* Inline editing styles */
        .rma-edit-mode {
            background: var(--bs-light);
            border: 2px solid var(--bs-primary);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        /* Dark mode support for editing highlight */
        [data-bs-theme="dark"] .rma-edit-mode {
            background: var(--bs-dark);
            border: 2px solid var(--bs-info);
        }
        
        /* Custom date table styling */
        .rma-date-table {
            table-layout: fixed;
            width: 100%;
        }
        
        .rma-date-table th {
            font-size: 0.75rem;
            text-align: center;
            width: 14.28%; /* For 7 columns */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .rma-date-table td {
            text-align: center;
            font-size: 0.85rem;
            vertical-align: middle;
            padding: 0.75rem 0.5rem;
        }
        
        /* Tool info styling */
        .rma-tool-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }
        
        /* Status select minimum width */
        #status-select {
            min-width: 200px !important;
        }
        
        @media (max-width: 1200px) {
            #status-select {
                min-width: 220px !important;
            }
        }
        
        @media (max-width: 992px) {
            #status-select {
                min-width: 240px !important;
            }
        }
        
        /* Excel preview modal styling */
        #excelPreviewContent table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        #excelPreviewContent th,
        #excelPreviewContent td {
            border: 1px solid #ccc;
            padding: 0.5rem 0.6rem;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
        }
        
        #excelPreviewContent thead th,
        #excelPreviewContent tbody tr:first-child td {
            background-color: #4a708b;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        #excelPreviewContent tbody td:first-child {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        #excelPreviewContent tbody tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        
        #excelPreviewContent tbody tr:nth-child(even) td:first-child {
            background-color: #f0f2f4;
        }
        
        #excelPreviewContent tbody tr:first-child td:first-child {
            background-color: #4a708b;
            color: white;
            font-weight: bold;
        }

        /* Location dropdown styling */
        .location-badge-wrapper {
            cursor: pointer;
        }
        .location-dropdown {
            z-index: 1060;
        }
        .location-dropdown .card {
            border: 1px solid var(--bs-border-color);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* Tool selection modal table styling */
        .tool-table-header {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: var(--bs-light) !important;
        }
        
        [data-bs-theme="dark"] .tool-table-header {
            background-color: var(--bs-dark) !important;
            border-color: var(--bs-border-color-translucent) !important;
        }
        
        .tool-item:hover {
            background-color: var(--bs-primary-bg-subtle) !important;
        }
        
        .tool-item.active {
            background-color: var(--bs-primary) !important;
            color: white !important;
        }
        
        .tool-item.active .badge {
            background-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container-fluid px-4 py-3">
        <!-- Modern Header Section -->
        <div class="detail-header detail-fade-in">
            <div class="d-flex justify-content-between align-items-start">
                                        <div>
                    <h1 class="mb-2">
                        <i class="bi bi-clipboard-data me-3"></i>
                        <span th:text="${rma.referenceNumber ?: 'New RMA'}">RMA Number</span>
                    </h1>
                    
                    <div class="detail-meta">
                        <!-- Status Badge -->
                        <span id="status-view-mode" th:if="${rma.status != null}" 
                              th:class="${'badge detail-status-badge rma-status-badge ' + 
                                                    (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                                    (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                                    (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                                    (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                                    (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                                    (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                  (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light text-dark')))))))}"
                              th:text="${rma.status?.displayName}"
                                                    onclick="enterStatusEditMode()"
                              title="Click to change status">Status</span>
                              
                        <!-- Priority Badge -->
                        <span id="priority-view-mode-container" th:if="${rma.priority != null}" 
                              th:class="${'badge detail-priority-badge rma-priority-badge border border-light ' + 
                                                                (rma.priority.name() == 'LOW' ? 'bg-info' : 
                                                                (rma.priority.name() == 'MEDIUM' ? 'bg-warning text-dark' : 
                                                                (rma.priority.name() == 'HIGH' ? 'bg-danger' : 
                                                                (rma.priority.name() == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light text-dark'))))}"
                              th:text="${rma.priority.displayName ?: rma.priority}"
                              onclick="enterPriorityEditMode()"
                              title="Click to change priority">Priority</span>
                              
                        <!-- Status Edit Mode (Hidden) -->
                        <span id="status-edit-mode" class="d-none">
                            <select id="status-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                <option th:each="statusOption : ${T(com.pcd.manager.model.RmaStatus).values()}"
                                        th:value="${statusOption}"
                                        th:text="${statusOption.displayName}"
                                        th:selected="${statusOption == rma.status}"></option>
                            </select>
                            <button type="button" class="btn btn-sm btn-success ms-1" onclick="saveStatus()">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="cancelStatusEdit()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </span>

                        <!-- Priority Edit Mode (Hidden) -->
                        <span id="priority-edit-mode-container" class="d-none">
                            <select id="priority-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                <option th:each="priorityOption : ${T(com.pcd.manager.model.RmaPriority).values()}"
                                        th:value="${priorityOption}"
                                        th:text="${priorityOption.displayName ?: priorityOption}"
                                        th:selected="${priorityOption == rma.priority}"></option>
                            </select>
                            <button type="button" class="btn btn-sm btn-success ms-1" onclick="savePriority()">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="cancelPriorityEdit()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </span>
                              
                        <!-- Location with dropdown -->
                        <span class="badge bg-secondary position-relative location-badge-wrapper">
                            <i class="bi bi-geo-alt me-1"></i>
                            <span id="locationDisplay" th:text="${rma.location != null ? rma.location.displayName : 'No location'}">Location</span>
                            <button type="button" class="btn btn-link p-0 ms-1 text-white" onclick="toggleLocationDropdown()" style="border: none; background: none;">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            
                            <!-- Location dropdown -->
                            <div id="locationDropdown" class="location-dropdown position-absolute top-100 start-0 mt-1 d-none">
                                <div class="card shadow-sm" style="min-width: 200px; z-index: 1050;">
                                    <div class="card-body p-2">
                                        <select id="locationSelect" class="form-select form-select-sm" onchange="changeLocation()">
                                            <option value="">-- Select Location --</option>
                                            <option th:each="location : ${locations}" 
                                                    th:value="${location.id}" 
                                                    th:text="${location.displayName}"
                                                    th:selected="${rma.location != null && rma.location.id == location.id}">Location</option>
                                        </select>
                                        <div class="d-flex gap-1 mt-2">
                                            <button type="button" class="btn btn-sm btn-success" onclick="saveLocationChange()">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelLocationChange()">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </span>
                                            </div>
                                        </div>

                <!-- Tool Information -->
                <div class="rma-tool-info">
                    <div th:if="${rma.tool != null}">
                        <!-- Icon and Tool Names - horizontal layout -->
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-tools fs-4 me-2"></i>
                            <a th:href="@{/tools/{id}(id=${rma.tool?.id})}" class="text-decoration-none me-2">
                                <span th:text="${rma.tool?.name}">Tool Name</span>
                            </a>
                            <span th:if="${rma.tool?.secondaryName}" class="text-muted me-2" th:text="${rma.tool.secondaryName}">Secondary Name</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openToolSelectionModal()">
                                <i class="bi bi-pencil"></i> Change Tool
                            </button>
                        </div>
                        
                        <!-- Type, Model, Serial below -->
                        <div class="small">
                            <span class="badge bg-light text-dark" th:text="${rma.tool?.toolType?.displayName ?: rma.tool?.toolType}">Type</span>
                            <span th:if="${rma.tool?.model1}" class="ms-2" th:text="'Model: ' + ${rma.tool.model1}">Model</span>
                            <span th:if="${rma.tool?.serialNumber1}" class="ms-2" th:text="'S/N: ' + ${rma.tool.serialNumber1}">Serial</span>
                        </div>
                    </div>
                    <div th:if="${rma.tool == null}" class="d-flex align-items-center">
                        <i class="bi bi-tools fs-4 me-2 text-muted"></i>
                        <span class="text-muted me-2">No tool assigned</span>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openToolSelectionModal()">
                            <i class="bi bi-plus"></i> Assign Tool
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                    <a th:href="@{/rma}" class="btn btn-secondary detail-action-btn">
                        <i class="bi bi-arrow-left"></i> Back to RMAs
                    </a>

                    <a th:href="@{/rma/{id}/excel(id=${rma.id})}" class="btn btn-success detail-action-btn">
                        <i class="bi bi-file-excel"></i> Export
                    </a>
                                        </div>
            </div>
                                    </div>
                                    
        <!-- Main Content Grid -->
        <div class="detail-main-grid">
            <!-- Basic Information Panel -->
            <div class="card h-100 detail-section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Basic Information
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enterHeaderEditMode()">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- View Mode -->
                    <div id="header-view-mode">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">RMA/SAP Number</small>
                                    <strong>
                                        <span id="viewReferenceNumber" th:text="${rma.referenceNumber ?: 'N/A'}">Reference Number</span>
                                    </strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Service Order</small>
                                    <strong id="viewServiceOrder" th:text="${rma.serviceOrder ?: 'N/A'}">Service Order</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Reason for Request</small>
                                    <strong id="viewReasonForRequest" th:text="${rma.reasonForRequest?.displayName ?: 'N/A'}">Reason</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">DSS Product Line</small>
                                    <strong id="viewDssProductLine" th:text="${rma.dssProductLine?.displayName ?: 'N/A'}">DSS Product Line</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">System Description</small>
                                    <strong id="viewSystemDescription" th:text="${rma.systemDescription?.displayName ?: 'N/A'}">System Description</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Technician</small>
                                    <strong id="viewTechnicianName" th:text="${rma.technician ?: 'Not assigned'}">Technician</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Mode -->
                    <div id="header-edit-mode" class="d-none rma-edit-mode">
                                    <form id="header-edit-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">RMA/SAP Number</label>
                                    <input type="text" class="form-control" name="referenceNumber" th:value="${rma.referenceNumber}" placeholder="Enter RMA or SAP number">
                                    <small class="form-text text-muted">Enter either RMA number or SAP notification number</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Service Order</label>
                                    <input type="text" class="form-control" name="serviceOrder" th:value="${rma.serviceOrder}" placeholder="Enter service order">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Reason for Request</label>
                                    <select class="form-select" name="reasonForRequest">
                                        <option value="">-- Select Reason --</option>
                                        <option th:each="reason : ${T(com.pcd.manager.model.RmaReasonForRequest).values()}" 
                                                th:value="${reason.name()}" 
                                                th:text="${reason.displayName}"
                                                th:selected="${rma.reasonForRequest != null && rma.reasonForRequest.name() == reason.name()}">
                                            Reason
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">DSS Product Line</label>
                                    <select class="form-select" name="dssProductLine">
                                        <option value="">-- Select Product Line --</option>
                                        <option th:each="productLine : ${T(com.pcd.manager.model.DssProductLine).values()}" 
                                                th:value="${productLine.name()}" 
                                                th:text="${productLine.displayName}"
                                                th:selected="${rma.dssProductLine != null && rma.dssProductLine.name() == productLine.name()}">
                                            Product Line
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">System Description</label>
                                    <select class="form-select" name="systemDescription">
                                        <option value="">-- Select System --</option>
                                        <option th:each="system : ${T(com.pcd.manager.model.SystemDescription).values()}" 
                                                th:value="${system.name()}" 
                                                th:text="${system.displayName}"
                                                th:selected="${rma.systemDescription != null && rma.systemDescription.name() == system.name()}">
                                            System
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Technician</label>
                                    <select class="form-select" name="technician">
                                        <option value="">-- Unassigned --</option>
                                        <option th:each="tech : ${technicians}" th:value="${tech.name}" th:text="${tech.name}" th:selected="${rma.technician != null && tech.name == rma.technician}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2">
                                <button type="button" class="btn btn-success detail-action-btn" onclick="saveHeaderChanges()">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-secondary detail-action-btn" onclick="cancelHeaderEditMode()">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                    </div>
                        </form>
                </div>
            </div>
            </div>

            <!-- Upload Files Panel -->
            <div class="card h-100 detail-section-card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-cloud-arrow-up me-2"></i>Upload New Files
                    </h6>
                </div>
            <div class="card-body">
                    <form th:action="@{/rma/{id}/upload-files(id=${rma.id})}" method="post" enctype="multipart/form-data" id="rmaFileUploadForm">
                        <div class="detail-upload-area" onclick="document.getElementById('rmaFileInput').click()">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <h6>Drag files here or click to browse</h6>
                            <p>Supports images and documents</p>
                        </div>
                        <input type="file" id="rmaFileInput" name="files" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" style="display: none;" multiple>
                        
                        <div id="rma-files-preview" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Selected Files</h6>
                                <button type="submit" class="btn btn-success detail-action-btn">
                                    <i class="bi bi-upload"></i> Upload
                                </button>
                            </div>
                            <div id="rma-file-list" class="small detail-text-muted"></div>
                        </div>
                    </form>
                                </div>
                                </div>
                            </div>

        <!-- Content Sections Grid (3x3) -->
        <div class="detail-sections-grid">
            <!-- Parts Information Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-boxes me-2"></i>Parts Information
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enableInlineEdit('parts-info')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <span class="badge bg-secondary" th:text="${rma.partLineItems != null ? rma.partLineItems.size() : 0}">0</span>
                        </div>
                                </div>
                    <div class="card-body">
                        <!-- View Mode -->
                        <div id="parts-info-view-mode">
                            <div th:if="${rma.partLineItems == null || rma.partLineItems.isEmpty()}" class="detail-empty-state">
                                <i class="bi bi-boxes"></i>
                                <p>No parts information available</p>
                            </div>
                            
                            <div th:if="${rma.partLineItems != null && !rma.partLineItems.isEmpty()}" class="table-responsive">
                                <table class="table table-striped detail-section-table">
                                    <thead>
                                        <tr>
                                            <th>Part Name</th>
                                            <th>Part #</th>
                                            <th>Desc.</th>
                                            <th>QTY</th>
                                            <th>Replace?</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="partItem : ${rma.partLineItems}">
                                            <td th:text="${partItem.partName ?: '-'}">Part Name</td>
                                            <td th:text="${partItem.partNumber ?: '-'}">Part Number</td>
                                            <td th:text="${partItem.productDescription ?: '-'}">Description</td>
                                            <td th:text="${partItem.quantity ?: '1'}">Quantity</td>
                                            <td>
                                                <span th:if="${partItem.replacementRequired}" class="badge bg-danger">Yes</span>
                                                <span th:if="${!partItem.replacementRequired}" class="badge bg-success">No</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div id="parts-info-edit-mode" class="d-none rma-edit-mode">
                            <form id="parts-info-form">
                                <div id="parts-edit-container">
                                    <!-- Dynamic parts will be added here -->
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addPartRow()">
                                        <i class="bi bi-plus"></i> Add Part
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-success detail-action-btn" onclick="savePartsInfo()">
                                            <i class="bi bi-check-lg"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-secondary detail-action-btn" onclick="cancelInlineEdit('parts-info')">
                                            <i class="bi bi-x-lg"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Problem Details Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle me-2"></i>Problem Details
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enableInlineEdit('problem-details')">
                            <i class="bi bi-pencil"></i>
                        </button>
                            </div>
                    <div class="card-body">
                        <!-- View Mode -->
                        <div id="problem-details-view-mode">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Who Discovered</small>
                                        <strong th:if="${rma.problemDiscoverer != null}" th:text="${rma.problemDiscoverer}">Who discovered</strong>
                                        <span class="detail-text-muted" th:if="${rma.problemDiscoverer == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">When Discovered</small>
                                        <strong th:if="${rma.problemDiscoveryDate != null}" th:text="${#temporals.format(rma.problemDiscoveryDate, 'MM/dd/yyyy')}">When discovered</strong>
                                        <span class="detail-text-muted" th:if="${rma.problemDiscoveryDate == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">What Happened</small>
                                        <p class="mb-0" th:if="${rma.whatHappened != null}" th:text="${rma.whatHappened}">What happened</p>
                                        <span class="detail-text-muted" th:if="${rma.whatHappened == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Why & How It Happened</small>
                                        <p class="mb-0" th:if="${rma.whyAndHowItHappened != null}" th:text="${rma.whyAndHowItHappened}">Why and how</p>
                                        <span class="detail-text-muted" th:if="${rma.whyAndHowItHappened == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">How Contained</small>
                                        <p class="mb-0" th:if="${rma.howContained != null}" th:text="${rma.howContained}">How contained</p>
                                        <span class="detail-text-muted" th:if="${rma.howContained == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Who Contained</small>
                                        <strong th:if="${rma.whoContained != null}" th:text="${rma.whoContained}">Who contained</strong>
                                        <span class="detail-text-muted" th:if="${rma.whoContained == null}">Not specified</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Root Cause</small>
                                        <p class="mb-0" th:if="${rma.rootCause != null}" th:text="${rma.rootCause}">Root cause</p>
                                        <span class="detail-text-muted" th:if="${rma.rootCause == null}">No root cause identified</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Resolution</small>
                                        <p class="mb-0" th:if="${rma.resolution != null}" th:text="${rma.resolution}">Resolution</p>
                                        <span class="detail-text-muted" th:if="${rma.resolution == null}">No resolution provided</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->  
                        <div id="problem-details-edit-mode" class="d-none rma-edit-mode">
                            <form id="problem-details-form">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Who Discovered</label>
                                        <input type="text" class="form-control" name="problemDiscoverer" th:value="${rma.problemDiscoverer}" placeholder="Who discovered the problem">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">When Discovered</label>
                                        <input type="date" class="form-control" name="problemDiscoveryDate" th:value="${rma.problemDiscoveryDate}">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">What Happened</label>
                                        <textarea class="form-control" name="whatHappened" rows="3" th:text="${rma.whatHappened}" placeholder="Describe what happened"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Why & How It Happened</label>
                                        <textarea class="form-control" name="whyAndHowItHappened" rows="3" th:text="${rma.whyAndHowItHappened}" placeholder="Explain why and how it happened"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">How Contained</label>
                                        <textarea class="form-control" name="howContained" rows="2" th:text="${rma.howContained}" placeholder="How was it contained"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Who Contained</label>
                                        <input type="text" class="form-control" name="whoContained" th:value="${rma.whoContained}" placeholder="Who contained it">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Root Cause</label>
                                        <textarea class="form-control" name="rootCause" rows="2" th:text="${rma.rootCause}" placeholder="Root cause analysis"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Resolution</label>
                                        <textarea class="form-control" name="resolution" rows="2" th:text="${rma.resolution}" placeholder="Resolution details"></textarea>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-success detail-action-btn" onclick="saveProblemDetails()">
                                        <i class="bi bi-check-lg"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary detail-action-btn" onclick="cancelInlineEdit('problem-details')">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                    </div>
                    </div>
                </div>

                <!-- Process Impact Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Process Impact
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enableInlineEdit('process-impact')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- View Mode -->
                        <div id="process-impact-view-mode">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Interruption to Flow</small>
                                        <div>
                                            <span th:if="${rma.interruptionToFlow}" class="badge bg-danger">Yes</span>
                                            <span th:if="${!rma.interruptionToFlow}" class="badge bg-success">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Interruption to Production</small>
                                        <div>
                                            <span th:if="${rma.interruptionToProduction}" class="badge bg-danger">Yes</span>
                                            <span th:if="${!rma.interruptionToProduction}" class="badge bg-success">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Downtime Hours</small>
                                        <strong th:text="${rma.downtimeHours != null ? rma.downtimeHours + ' hours' : '0 hours'}">0 hours</strong>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Exposed to Gas/Chemicals</small>
                                        <div>
                                            <span th:if="${rma.exposedToProcessGasOrChemicals}" class="badge bg-warning">Yes</span>
                                            <span th:if="${!rma.exposedToProcessGasOrChemicals}" class="badge bg-success">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Purged</small>
                                        <div>
                                            <span th:if="${rma.purged}" class="badge bg-success">Yes</span>
                                            <span th:if="${!rma.purged}" class="badge bg-warning">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Start-up/SO3 Complete</small>
                                        <div>
                                            <span th:if="${rma.startupSo3Complete}" class="badge bg-success">Yes</span>
                                            <span th:if="${!rma.startupSo3Complete}" class="badge bg-warning">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Failed on Install</small>
                                        <div>
                                            <span th:if="${rma.failedOnInstall}" class="badge bg-danger">Yes</span>
                                            <span th:if="${!rma.failedOnInstall}" class="badge bg-success">No</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex flex-column">
                                        <small class="detail-text-muted">Instructions for Exposed Component</small>
                                        <p class="mb-0" th:if="${rma.instructionsForExposedComponent != null}" th:text="${rma.instructionsForExposedComponent}">Instructions</p>
                                        <span class="detail-text-muted" th:if="${rma.instructionsForExposedComponent == null}">No instructions provided</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div id="process-impact-edit-mode" class="d-none rma-edit-mode">
                            <form id="process-impact-form">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Interruption to Flow</label>
                                        <select class="form-select" name="interruptionToFlow">
                                            <option value="false" th:selected="${!rma.interruptionToFlow}">No</option>
                                            <option value="true" th:selected="${rma.interruptionToFlow}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Interruption to Production</label>
                                        <select class="form-select" name="interruptionToProduction">
                                            <option value="false" th:selected="${!rma.interruptionToProduction}">No</option>
                                            <option value="true" th:selected="${rma.interruptionToProduction}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Downtime Hours</label>
                                        <input type="number" class="form-control" name="downtimeHours" th:value="${rma.downtimeHours}" min="0" step="0.5" placeholder="0">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Exposed to Gas/Chemicals</label>
                                        <select class="form-select" name="exposedToProcessGasOrChemicals">
                                            <option value="false" th:selected="${!rma.exposedToProcessGasOrChemicals}">No</option>
                                            <option value="true" th:selected="${rma.exposedToProcessGasOrChemicals}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Purged</label>
                                        <select class="form-select" name="purged">
                                            <option value="false" th:selected="${!rma.purged}">No</option>
                                            <option value="true" th:selected="${rma.purged}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Start-up/SO3 Complete</label>
                                        <select class="form-select" name="startupSo3Complete">
                                            <option value="false" th:selected="${!rma.startupSo3Complete}">No</option>
                                            <option value="true" th:selected="${rma.startupSo3Complete}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Failed on Install</label>
                                        <select class="form-select" name="failedOnInstall">
                                            <option value="false" th:selected="${!rma.failedOnInstall}">No</option>
                                            <option value="true" th:selected="${rma.failedOnInstall}">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Instructions for Exposed Component</label>
                                        <textarea class="form-control" name="instructionsForExposedComponent" rows="3" th:text="${rma.instructionsForExposedComponent}" placeholder="Enter instructions for exposed component"></textarea>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-success detail-action-btn" onclick="saveProcessImpact()">
                                        <i class="bi bi-check-lg"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary detail-action-btn" onclick="cancelInlineEdit('process-impact')">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moving Parts Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-arrow-left-right me-2"></i>Moving Parts
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" data-bs-toggle="modal" data-bs-target="#addMovingPartModal" th:if="${rma.tool != null}">
                                <i class="bi bi-plus"></i>
                                </button>
                            <span class="badge bg-secondary" th:text="${movingParts != null ? movingParts.size() : 0}">0</span>
                        </div>
                            </div>
                            <div class="card-body">
                        <div th:if="${movingParts == null || movingParts.isEmpty()}" class="detail-empty-state">
                            <i class="bi bi-arrow-left-right"></i>
                            <p>No moving parts recorded</p>
                                </div>
                        
                        <div th:if="${movingParts != null && !movingParts.isEmpty()}" class="table-responsive">
                            <table class="table table-striped detail-section-table">
                                        <thead>
                                            <tr>
                                                <th>Part Name</th>
                                                <th>Movement</th>
                                                <th>Notes</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="movingPart : ${movingParts}">
                                        <td th:text="${movingPart.partName}">Part Name</td>
                                                <td>
                                            <div class="small">
                                                        <!-- Show from tool -->
                                                        <span>
                                                            <a th:if="${movingPart.fromTool != null}" 
                                                               th:href="@{/tools/{id}(id=${movingPart.fromTool.id})}" 
                                                               th:text="${movingPart.fromTool.name}" 
                                                       class="text-decoration-none detail-text-primary">From Tool</a>
                                                    <span th:if="${movingPart.fromTool == null}" class="detail-text-muted">-</span>
                                                        </span>
                                                        
                                                        <!-- Show full destination chain with arrows -->
                                                <th:block th:if="${movingPartDestinationChains != null && movingPartDestinationChains[movingPart.id] != null and !movingPartDestinationChains[movingPart.id].empty}">
                                                            <th:block th:each="destTool, iterStat : ${movingPartDestinationChains[movingPart.id]}">
                                                                <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                                <a th:href="@{/tools/{id}(id=${destTool.id})}" 
                                                                   th:text="${destTool.name}" 
                                                           class="text-decoration-none detail-text-primary">Dest Tool</a>
                                                            </th:block>
                                                        </th:block>
                                                        
                                                        <!-- If no destinations at all -->
                                                <th:block th:if="${movingPartDestinationChains == null || movingPartDestinationChains[movingPart.id] == null or movingPartDestinationChains[movingPart.id].empty}">
                                                            <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                    <span class="detail-text-muted">No Destination</span>
                                                        </th:block>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span th:if="${movingPart.notes != null}" th:text="${movingPart.notes}">Notes</span>
                                            <span th:if="${movingPart.notes == null}" class="detail-text-muted">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(movingPart.moveDate, 'MM/dd/yy')}">01/01/23</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary moving-part-edit-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}"
                                                                th:data-from-tool-id="${movingPart.fromTool != null ? movingPart.fromTool.id : ''}"
                                                                th:data-to-tool-id="${movingPart.currentLocationToolId != null ? movingPart.currentLocationToolId : ''}"
                                                                th:data-destination-chain="${movingPart.destinationChain != null ? movingPart.destinationChain : ''}"
                                                                th:data-notes="${movingPart.notes != null ? movingPart.notes : ''}"
                                                                th:data-move-date="${#temporals.format(movingPart.moveDate, 'yyyy-MM-dd')}">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger moving-part-delete-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                            </tr>
                                        </tbody>
                                    </table>
                            </div>
                        </div>
                                      </div>
              </div>
              
            <!-- Customer Information Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>Customer Information
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enableInlineEdit('customer')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- View Mode -->
                        <div id="customer-view-mode">
                            <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Customer Name</small>
                                    <p class="mb-0" th:if="${rma.customerName != null}" th:text="${rma.customerName}">Customer name</p>
                                    <span class="detail-text-muted" th:if="${rma.customerName == null}">Not specified</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Attention</small>
                                    <p class="mb-0" th:if="${rma.attn != null}" th:text="${rma.attn}">Attention</p>
                                    <span class="detail-text-muted" th:if="${rma.attn == null}">Not specified</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Company Ship To:</small>
                                    <div th:if="${rma.companyShipToName != null}">
                                        <p class="mb-0" th:text="${rma.companyShipToName}">Company</p>
                                        <p class="mb-0" th:if="${rma.companyShipToAddress != null}" th:text="${rma.companyShipToAddress}">Address</p>
                                        <p class="mb-0" th:if="${rma.city != null or rma.state != null or rma.zipCode != null}">
                                            <span th:if="${rma.city != null}" th:text="${rma.city}">City</span><span th:if="${rma.city != null and rma.state != null}">, </span>
                                            <span th:if="${rma.state != null}" th:text="${rma.state}">State</span>
                                            <span th:if="${rma.zipCode != null}" th:text="' ' + ${rma.zipCode}">ZIP</span>
                                        </p>
                                    </div>
                                    <span class="detail-text-muted" th:if="${rma.companyShipToName == null}">No shipping address specified</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Contact Phone Number</small>
                                    <p class="mb-0" th:if="${rma.customerPhone != null}" th:text="${rma.customerPhone}">Contact phone</p>
                                    <span class="detail-text-muted" th:if="${rma.customerPhone == null}">Not specified</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Field Tech Name</small>
                                    <p class="mb-0" th:if="${rma.fieldTechName != null}" th:text="${rma.fieldTechName}">Field tech name</p>
                                    <span class="detail-text-muted" th:if="${rma.fieldTechName == null}">Not specified</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Field Tech Phone</small>
                                    <p class="mb-0" th:if="${rma.fieldTechPhone != null}" th:text="${rma.fieldTechPhone}">Field tech phone</p>
                                    <span class="detail-text-muted" th:if="${rma.fieldTechPhone == null}">Not specified</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column">
                                    <small class="detail-text-muted">Field Tech Email</small>
                                    <p class="mb-0" th:if="${rma.fieldTechEmail != null}" th:text="${rma.fieldTechEmail}">Field tech email</p>
                                    <span class="detail-text-muted" th:if="${rma.fieldTechEmail == null}">Not specified</span>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div id="customer-edit-mode" class="d-none rma-edit-mode">
                            <form id="customer-form">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Name</label>
                                        <input type="text" class="form-control" name="customerName" th:value="${rma.customerName}" placeholder="Enter customer name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Attention</label>
                                        <input type="text" class="form-control" name="attn" th:value="${rma.attn}" placeholder="Attention/Contact person">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Company Ship To Name</label>
                                        <input type="text" class="form-control" name="companyShipToName" th:value="${rma.companyShipToName}" placeholder="Company name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Ship To Address</label>
                                        <input type="text" class="form-control" name="companyShipToAddress" th:value="${rma.companyShipToAddress}" placeholder="Street address">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">City</label>
                                        <input type="text" class="form-control" name="city" th:value="${rma.city}" placeholder="City">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">State</label>
                                        <input type="text" class="form-control" name="state" th:value="${rma.state}" placeholder="State">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">ZIP Code</label>
                                        <input type="text" class="form-control" name="zipCode" th:value="${rma.zipCode}" placeholder="ZIP code">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Contact Phone Number</label>
                                        <input type="text" class="form-control" name="customerPhone" th:value="${rma.customerPhone}" placeholder="Phone number">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Field Tech Name</label>
                                        <input type="text" class="form-control" name="fieldTechName" th:value="${rma.fieldTechName}" placeholder="Field technician name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Field Tech Phone</label>
                                        <input type="text" class="form-control" name="fieldTechPhone" th:value="${rma.fieldTechPhone}" placeholder="Field tech phone">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Field Tech Email</label>
                                        <input type="email" class="form-control" name="fieldTechEmail" th:value="${rma.fieldTechEmail}" placeholder="Field tech email">
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-success detail-action-btn" onclick="saveCustomer()">
                                        <i class="bi bi-check-lg"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary detail-action-btn" onclick="cancelInlineEdit('customer')">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                            </div>
                        </div>
                        
            <!-- Important Dates Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar-event me-2"></i>Important Dates
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" onclick="enableInlineEdit('important-dates')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm rma-date-table">
                                <thead>
                                    <tr>
                                        <th>Written</th>
                                    <th>Number Provided</th>
                                    <th>Memo Emailed</th>
                                <th>Parts Received</th>
                            </tr>
                                </thead>
                                <tbody>
                            <tr>
                                    <td th:text="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td th:text="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td th:text="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td th:text="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'MM/dd/yy') : '-'}">-</td>
                            </tr>
                                </tbody>
                        </table>
                        
                        <table class="table table-sm rma-date-table mt-3">
                                    <thead>
                            <tr>
                                            <th>Parts Installed</th>
                                    <th>Parts Ready</th>
                                    <th>Parts Shipped</th>
                                    <th></th>
                            </tr>
                                    </thead>
                                    <tbody>
                            <tr>
                                    <td th:text="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td th:text="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td th:text="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'MM/dd/yy') : '-'}">-</td>
                                    <td></td>
                            </tr>
                                    </tbody>
                        </table>
                        </div>
                    </div>
                </div>
                
            <!-- Documents & Pictures Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-files me-2"></i>Documents & Pictures
                        </h6>
                        <span class="badge bg-secondary" th:text="${(rma.documents != null ? rma.documents.size() : 0) + (rma.pictures != null ? rma.pictures.size() : 0)}">0</span>
                    </div>
                    <div class="card-body">
                        <!-- Documents Section -->
                        <div th:if="${rma.documents != null && !rma.documents.isEmpty()}">
                            <h6 class="detail-text-muted mb-2">Documents</h6>
                            <div class="d-flex flex-column gap-2 mb-3">
                                <div class="d-flex align-items-center justify-content-between p-2 border rounded detail-interactive" th:each="doc : ${rma.documents}">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark-text me-2 detail-text-primary"></i>
                                        <span class="text-truncate" th:text="${doc.fileName}">document.pdf</span>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/uploads/' + ${doc.filePath}}" class="btn btn-outline-primary" target="_blank" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pictures Section -->
                        <div th:if="${rma.pictures != null && !rma.pictures.isEmpty()}">
                            <h6 class="detail-text-muted mb-2">Pictures</h6>
                            <div class="row g-2">
                                <div class="col-6" th:each="pic : ${rma.pictures}">
                                    <div class="card h-100 detail-clickable">
                                        <div class="card-body p-2 text-center">
                                            <img th:src="@{'/uploads/' + ${pic.filePath}}" class="img-fluid rounded" 
                                                 style="max-height: 120px; object-fit: cover; width: 100%;"
                                                 th:alt="${pic.fileName}">
                                        </div>
                                        <div class="card-footer p-2">
                                            <div class="btn-group btn-group-sm w-100">
                                                <a th:href="@{'/uploads/' + ${pic.filePath}}" class="btn btn-outline-primary" target="_blank" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-danger" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                                </div>
                                </div>
                            </div>
                                </div>

                        <!-- Empty State -->
                        <div th:if="${(rma.documents == null || rma.documents.isEmpty()) && (rma.pictures == null || rma.pictures.isEmpty())}" class="detail-empty-state">
                            <i class="bi bi-files"></i>
                            <p>No files uploaded yet</p>
                                </div>
                            </div>
                                        </div>
                                        </div>

            <!-- Comments Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-chat-dots me-2"></i>Comments
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" data-bs-toggle="modal" data-bs-target="#commentModal">
                                <i class="bi bi-plus"></i>
                            </button>
                            <span class="badge bg-secondary" th:text="${rmaComments != null ? rmaComments.size() : 0}">0</span>
                                    </div>
                                        </div>
                    <div class="card-body">
                        <div th:if="${rmaComments == null || rmaComments.isEmpty()}" class="detail-empty-state">
                            <i class="bi bi-chat-dots"></i>
                            <p>No comments yet</p>
                                        </div>
                        
                        <div th:if="${rmaComments != null && !rmaComments.isEmpty()}" class="d-flex flex-column gap-3">
                            <div class="border rounded p-3 detail-interactive" th:each="comment : ${rmaComments}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <strong class="detail-text-primary" th:text="${comment.user != null ? comment.user.name : 'Unknown'}">User</strong>
                                    <small class="detail-text-muted" th:text="${#temporals.format(comment.createdDate, 'MM/dd HH:mm')}">Date</small>
                                        </div>
                                <p class="mb-0" th:text="${comment.content}">Comment content</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                                    </div>

            <!-- Notes Section -->
            <div class="detail-section-fixed-height">
                <div class="card detail-section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-journal-text me-2"></i>Notes
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary detail-action-btn" data-bs-toggle="modal" data-bs-target="#notesModal">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div th:if="${rma.notes == null || rma.notes.isEmpty()}" class="detail-empty-state">
                            <i class="bi bi-journal-text"></i>
                            <p>No notes available</p>
                        </div>
                        
                        <div th:if="${rma.notes != null && !rma.notes.isEmpty()}" class="d-flex flex-column">
                            <div class="border rounded p-3 detail-interactive">
                                <p class="mb-0" th:text="${rma.notes}">Notes content</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Hidden RMA ID for JavaScript -->
    <input type="hidden" id="rmaPageEntityIdForJs" th:value="${rma.id}">
    


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                <div class="modal-body">
                    <p>How would you like to handle this file?</p>
                    <input type="hidden" id="fileIdToDelete">
                    <input type="hidden" id="fileTypeToDelete">
                    <input type="hidden" id="rmaIdForDelete">
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOnly" value="unlink" checked>
                        <label class="form-check-label" for="deleteOnly">
                            <strong>Unlink only:</strong> Remove only from this RMA, keep in other locations
                        </label>
                                            </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteEverywhere" value="delete">
                        <label class="form-check-label" for="deleteEverywhere">
                            <strong>Delete everywhere:</strong> Remove from all locations
                        </label>
                                        </div>
                                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
    
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transfer File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the RMA to transfer this file to:</p>
                    <form id="transferForm" action="/rma/file/transfer" method="post">
                        <input type="hidden" id="transferFileId" name="fileId">
                        <input type="hidden" id="transferFileType" name="fileType">
                        <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="targetRmaId" class="form-label">Target RMA</label>
                            <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                                <option value="">-- Select Target RMA --</option>
                                <!-- This will need to be populated from controller with available RMAs -->
                                <option th:each="otherRma : ${allRmas}" 
                                        th:if="${otherRma.id != rma.id}" 
                                        th:value="${otherRma.id}" 
                                        th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA-' + otherRma.id) + 
                                                (otherRma.customerName != null ? ' - ' + otherRma.customerName : '')}">
                                </option>
                            </select>
                        </div>
                                </form>
                            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
                                </div>
                                            </div>
                            </div>
                        </div>

    <!-- Unified Link File Modal (Copied from tools/details.html, ensure allRmas, allTools, allTrackTrends are available) -->
    <div class="modal fade" id="unifiedLinkFileModal" tabindex="-1" aria-labelledby="unifiedLinkFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="unifiedLinkFormRmaPage" th:action="@{/files/link-entity}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unifiedLinkFileModalLabelRmaPage">Link File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Link <strong id="unifiedLinkFileNameDisplayRmaPage">file_name_here</strong> to:</p>
                        
                        <input type="hidden" id="unifiedLinkFileIdInputRmaPage" name="fileId">
                        <input type="hidden" id="unifiedLinkFilePathInputRmaPage" name="filePath">
                        <input type="hidden" id="unifiedLinkFileTypeInputRmaPage" name="fileType">
                        <input type="hidden" id="unifiedLinkSourceEntityTypeInputRmaPage" name="sourceEntityType">
                        <input type="hidden" id="unifiedLinkSourceEntityIdInputRmaPage" name="sourceEntityId">
                        <input type="hidden" id="unifiedLinkOriginalFileNameInputRmaPage" name="originalFileName">

                        <div class="mb-3">
                            <label for="unifiedLinkTargetEntityTypeRmaPage" class="form-label">Link to Entity Type:</label>
                            <select id="unifiedLinkTargetEntityTypeRmaPage" name="targetEntityType" class="form-select" required>
                                <option value="">-- Select Entity Type --</option>
                                <option value="RMA">RMA</option>
                                <option value="TOOL">Tool</option>
                                <option value="TRACK_TREND">Track/Trend</option>
                            </select>
                </div>

                        <div id="unifiedLinkTargetRmaSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetRmaIdRmaPage" class="form-label">Select RMA:</label>
                            <select id="unifiedLinkTargetRmaIdRmaPage" name="targetRmaId" class="form-select">
                                <option value="">-- Select RMA --</option>
                                <th:block th:if="${allRmas != null}">
                                    <option th:each="rmaOption : ${allRmas}"
                                            th:if="${rmaOption.id != rma.id}" 
                                            th:value="${rmaOption.id}" 
                                            th:text="${(rmaOption.rmaNumber ?: ('RMA-' + rmaOption.id)) + (rmaOption.customerName != null ? ' - ' + rmaOption.customerName : '')}">
                                    </option>
                                </th:block>
                            </select>
                                    </div>

                        <div id="unifiedLinkTargetToolSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetToolIdRmaPage" class="form-label">Select Tool:</label>
                            <select id="unifiedLinkTargetToolIdRmaPage" name="targetToolId" class="form-select">
                                <option value="">-- Select Tool --</option>
                                <th:block th:if="${allTools != null}">
                                   <option th:each="toolOption : ${allTools}" 
                                           th:value="${toolOption.id}" 
                                           th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '')}">
                                   </option>
                               </th:block>
                            </select>
                                </div>

                        <div id="unifiedLinkTargetTrackTrendSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetTrackTrendIdRmaPage" class="form-label">Select Track/Trend:</label>
                            <select id="unifiedLinkTargetTrackTrendIdRmaPage" name="targetTrackTrendId" class="form-select">
                                <option value="">-- Select Track/Trend --</option>
                                 <th:block th:if="${allTrackTrends != null}"> <!-- Ensure allTrackTrends is passed to rma/view model -->
                                    <option th:each="tt : ${allTrackTrends}"
                                            th:value="${tt.id}"
                                            th:text="${tt.name + ' (' + #temporals.format(tt.startDate, 'yyyy-MM-dd') + ')'}"></option>
                                </th:block>
                            </select>
                            </div>
                                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmUnifiedLinkBtnRmaPage">Link File</button>
                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>
    <!-- End Unified Link File Modal -->

    <!-- Delete RMA Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this RMA?</p>
                    <p class="text-danger fw-bold">This action cannot be undone!</p>
                    <p th:if="${rma.referenceNumber != null && !rma.referenceNumber.empty}">
                        <strong>RMA/SAP Number:</strong> <span th:text="${rma.referenceNumber}"></span>
                    </p>
                    <p th:if="${rma.tool != null}">
                        <strong>Tool:</strong> <span th:text="${rma.tool?.name}"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/rma/{id}/delete(id=${rma.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
                    </div>
                </div>
                
    <!-- Comment Modal -->
    <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commentModalLabel">
                        <i class="bi bi-chat-dots me-2"></i>Add Comment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                <form th:action="@{/rma/{id}/post-comment(id=${rma.id})}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="commentContent" class="form-label">Comment</label>
                            <textarea class="form-control" id="commentContent" name="content" rows="4" required 
                                      placeholder="Enter your comment..."></textarea>
                                    </div>
                                        </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-2"></i>Post Comment
                        </button>
                    </div>
                </form>
                                        </div>
                                    </div>
                                </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel">
                        <i class="bi bi-journal-text me-2"></i>Add/Edit Notes
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/rma/{id}/update-notes(id=${rma.id})}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="notesContent" class="form-label">Notes</label>
                            <textarea class="form-control" id="notesContent" name="notes" rows="6" 
                                      placeholder="Enter notes..." th:text="${rma.notes}"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Save Notes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Moving Part Modal (Reusable Fragment) -->
    <div th:replace="~{fragments/moving-part-modal :: addMovingPartModal('addMovingPartModal', @{/rma/{id}/moving-parts/add(id=${rma.id})}, ${allTools}, 'destinationContainerRma', 'addDestinationBtnRma')}"></div>
    
    <!-- Edit Moving Part Modal -->
    <div class="modal fade" id="editMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editMovingPartForm" th:action="@{/rma/{id}/moving-parts/edit(id=${rma.id})}" method="post">
                    <input type="hidden" id="editMovingPartId" name="movingPartId" value="">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editPartName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="editPartName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSerialNumber" class="form-label">Serial Number:</label>
                            <input type="text" class="form-control" id="editSerialNumber" name="serialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editPartNumber" class="form-label">Part Number:</label>
                            <input type="text" class="form-control" id="editPartNumber" name="partNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editQuantity" class="form-label">Quantity:</label>
                            <input type="number" class="form-control" id="editQuantity" name="quantity" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="editFromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Edit Destination Tools Container -->
                            <div id="editDestinationContainer">
                                <div class="d-flex align-items-center mb-2 destination-row">
                                    <strong class="me-2">To:</strong>
                                    <select class="form-select destination-select" name="destinationToolIds" required>
                                        <option value="">Select destination tool...</option>
                                        <option th:each="toTool : ${allTools}"
                                                th:value="${toTool.id}" 
                                                th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}"
                                                th:selected="${rma.tool != null and toTool.id == rma.tool.id}">
                                            Tool Name
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination" style="display: none;">
                                        <i class="bi bi-dash"></i>
                                            </button>
                                </div>
                            </div>
                            
                            <!-- Add Destination Button for Edit -->
                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addDestinationBtnEdit">
                                    <i class="bi bi-plus"></i> Add Another Destination
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

    <!-- Picture View Modal -->
    <div class="modal fade" id="pictureModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">View Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                <div class="modal-body text-center">
                    <img id="modalPictureImg" src="" alt="RMA Picture" style="max-width: 100%; max-height: 80vh;">
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Preview Modal -->
    <div class="modal fade" id="excelPreviewModal" tabindex="-1" aria-labelledby="excelPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="excelPreviewModalLabel">Excel Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="excelPreviewContent" style="overflow-x: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/theme-toggle.js}"></script>
    <script th:inline="javascript">
        const rmaPageId = document.getElementById('rmaPageEntityIdForJs').value;
        
        // START: Generic Edit/Save/Cancel Logic (Modified for Header)
        function enterHeaderEditMode() {
            document.getElementById('header-view-mode').classList.add('d-none');
            document.getElementById('header-edit-mode').classList.remove('d-none');
            
            // The edit button is in the card header, we don't need to manage its visibility here
            // as the form takes over the entire card body

            // Form fields are automatically populated by th:value attributes in the HTML
            // No additional JavaScript population needed as Thymeleaf handles the initial values
        }

        function cancelHeaderEditMode() {
            document.getElementById('header-edit-mode').classList.add('d-none');
            document.getElementById('header-view-mode').classList.remove('d-none');
        }

        function saveHeaderChanges() {
            const form = document.getElementById('header-edit-form');
            const formData = new FormData(form);
            
            // For select elements, FormData might not pick up the selected value directly if not submitted traditionally.
            // It's safer to explicitly get values.
            const referenceNumber = form.elements['referenceNumber'].value;
            const serviceOrder = form.elements['serviceOrder'].value;
            const reasonForRequest = form.elements['reasonForRequest'].value;
            const dssProductLine = form.elements['dssProductLine'].value;
            const systemDescription = form.elements['systemDescription'].value;
            const technician = form.elements['technician'].value;

            const payload = new URLSearchParams();
            // Send the Basic Information fields
            payload.append('referenceNumber', referenceNumber);
            payload.append('serviceOrder', serviceOrder);
            payload.append('reasonForRequest', reasonForRequest);
            payload.append('dssProductLine', dssProductLine);
            payload.append('systemDescription', systemDescription);
            payload.append('technician', technician);

            fetch(`/rma/${rmaPageId}/update-header`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload.toString()
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update header') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update view mode elements with new data
                    const viewReferenceNumber = document.getElementById('viewReferenceNumber');
                    
                    // Update the reference number display (data.rmaNumber and data.sapNotificationNumber are the same value now)
                    if (viewReferenceNumber) {
                        viewReferenceNumber.textContent = data.rmaNumber || 'N/A';
                    }

                    // Update other information with error handling
                    try {
                        const viewServiceOrder = document.getElementById('viewServiceOrder');
                        const viewReasonForRequest = document.getElementById('viewReasonForRequest');
                        const viewDssProductLine = document.getElementById('viewDssProductLine');
                        const viewSystemDescription = document.getElementById('viewSystemDescription');
                        const viewTechnicianName = document.getElementById('viewTechnicianName');
                        
                        if (viewServiceOrder) viewServiceOrder.textContent = data.serviceOrder || 'N/A';
                        if (viewReasonForRequest) viewReasonForRequest.textContent = data.reasonForRequestDisplay || 'N/A';
                        if (viewDssProductLine) viewDssProductLine.textContent = data.dssProductLineDisplay || 'N/A';
                        if (viewSystemDescription) viewSystemDescription.textContent = data.systemDescriptionDisplay || 'N/A';
                        if (viewTechnicianName) viewTechnicianName.textContent = data.technicianName || 'Not assigned';
                        
                    } catch (error) {
                        console.warn('Some UI elements could not be updated:', error.message);
                    }

                    cancelHeaderEditMode(); // Switch back to view mode
                } else {
                    alert('Error updating header: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving header changes:', error);
                alert('Failed to save header changes: ' + error.message);
            });
        }
        // END: Generic Edit/Save/Cancel Logic

        function deleteDocumentFromData(element) {
            const documentId = element.getAttribute('data-document-id');
            if (confirm('Are you sure you want to delete this document?')) {
                fetch(`/rma/${rmaPageId}/documents/${documentId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete document');
                                }
                            })
                            .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete document');
                });
            }
        }

        function showPictureModal(pictureId) {
            try {
                const modalImg = document.getElementById('modalPictureImg');
                const imgElement = document.querySelector(`img[onclick*="${pictureId}"]`);
                if (imgElement) {
                    modalImg.src = imgElement.src;
                    const modal = new bootstrap.Modal(document.getElementById('pictureModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error showing picture modal:', error);
            }
        }

        function deletePictureFromData(element) {
            const pictureId = element.getAttribute('data-picture-id');
            if (confirm('Are you sure you want to delete this picture?')) {
                fetch(`/rma/${rmaPageId}/pictures/${pictureId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete picture');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete picture');
                });
            }
        }

        // Handle document upload form submission
        document.getElementById('uploadDocumentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
                
                // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
            .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    window.location.reload(); // Reload the page to show the new document
                    } else {
                    alert('Failed to upload document: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload document: ' + error.message);
            })
            .finally(() => {
                    // Restore button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle picture upload form submission
        document.getElementById('uploadPictureForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
            
            // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload(); // Reload the page to show the new pictures
                } else {
                    alert('Failed to upload pictures: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload pictures');
            })
            .finally(() => {
                // Reset button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle file input change - submit the forms directly 
        document.getElementById('pictureFile').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('uploadPictureForm').submit();
            }
        });

        document.getElementById('documentFile').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('uploadDocumentForm').submit();
            }
        });

        // START: Moving Part Modal JavaScript (Add Destination functionality)
        document.addEventListener('DOMContentLoaded', function() {
            // Add destination functionality for add modal
            const addBtn = document.getElementById('addDestinationBtnRma');
            if (addBtn) {
                addBtn.addEventListener('click', function() {
                    addDestinationRow('destinationContainerRma');
                });
            }
            
            // Remove destination functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-destination')) {
                    e.target.closest('.destination-row').remove();
                    updateRemoveButtons('destinationContainerRma');
                }
            });
        });
        
        function addDestinationRow(containerId) {
            const container = document.getElementById(containerId);
            const newRow = document.createElement('div');
            newRow.className = 'd-flex align-items-center mb-2 destination-row';
            
            const firstSelect = container.querySelector('.destination-select');
            const toolOptions = firstSelect.innerHTML;
            
            newRow.innerHTML = `
                <strong class="me-2">To:</strong>
                <select class="form-select destination-select" name="destinationToolIds" required>
                    ${toolOptions}
                </select>
                <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination">
                    <i class="bi bi-dash"></i>
                </button>
            `;
            
            container.appendChild(newRow);
            updateRemoveButtons(containerId);
        }
        
        function updateRemoveButtons(containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.destination-row');
            
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-destination');
                if (removeBtn) {
                    removeBtn.style.display = rows.length > 1 ? 'block' : 'none';
                }
            });
        }
        // END: Moving Part Modal JavaScript

        document.querySelectorAll('.moving-part-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const partName = this.getAttribute('data-part-name');
                const fromToolId = this.getAttribute('data-from-tool-id');
                const toToolId = this.getAttribute('data-to-tool-id');
                const destinationChain = this.getAttribute('data-destination-chain') || '';
                const notes = this.getAttribute('data-notes') || '';
                
                // Fill form fields with existing data
                document.getElementById('editMovingPartId').value = id;
                document.getElementById('editPartName').value = partName;
                document.getElementById('editFromToolId').value = fromToolId;
                document.getElementById('editNotes').value = notes;
            });
        });

        // Placeholder for Link Document Modal - Will be replaced by more specific logic below
        /* function openLinkDocumentModal(element) { ... } */

        // START: JavaScript for Unified Link File Modal on RMA View Page
        document.addEventListener('DOMContentLoaded', () => {
            const modalElement = document.getElementById('unifiedLinkFileModal');
            const modal = modalElement ? new bootstrap.Modal(modalElement) : null;
            if (!modal) {
                console.error('Unified Link File Modal not found on RMA page');
                return;
            }

            const form = document.getElementById('unifiedLinkFormRmaPage');
            const fileNameDisplay = document.getElementById('unifiedLinkFileNameDisplayRmaPage');
            const fileIdInput = document.getElementById('unifiedLinkFileIdInputRmaPage');
            const filePathInput = document.getElementById('unifiedLinkFilePathInputRmaPage');
            const fileTypeInput = document.getElementById('unifiedLinkFileTypeInputRmaPage');
            const sourceEntityTypeInput = document.getElementById('unifiedLinkSourceEntityTypeInputRmaPage');
            const sourceEntityIdInput = document.getElementById('unifiedLinkSourceEntityIdInputRmaPage');
            const originalFileNameInput = document.getElementById('unifiedLinkOriginalFileNameInputRmaPage');

            const targetEntityTypeSelect = document.getElementById('unifiedLinkTargetEntityTypeRmaPage');
            const targetRmaSection = document.getElementById('unifiedLinkTargetRmaSectionRmaPage');
            const targetToolSection = document.getElementById('unifiedLinkTargetToolSectionRmaPage');
            const targetTrackTrendSection = document.getElementById('unifiedLinkTargetTrackTrendSectionRmaPage');

            document.querySelectorAll('.unifiedLinkFileModalTriggerRmaPage').forEach(button => {
                button.addEventListener('click', function() {
                    fileNameDisplay.textContent = this.dataset.originalFileName || 'Selected File';
                    fileIdInput.value = this.dataset.fileId || '';
                    filePathInput.value = this.dataset.filePath || '';
                    fileTypeInput.value = this.dataset.fileType || '';
                    sourceEntityTypeInput.value = this.dataset.sourceEntityType || '';
                    sourceEntityIdInput.value = this.dataset.sourceEntityId || '';
                    originalFileNameInput.value = this.dataset.originalFileName || '';

                    // Reset and hide all target sections
                    targetEntityTypeSelect.value = '';
                    targetRmaSection.style.display = 'none';
                    targetToolSection.style.display = 'none';
                    targetTrackTrendSection.style.display = 'none';
                    document.getElementById('unifiedLinkTargetRmaIdRmaPage').value = '';
                    document.getElementById('unifiedLinkTargetToolIdRmaPage').value = '';
                    document.getElementById('unifiedLinkTargetTrackTrendIdRmaPage').value = '';

                    modal.show();
                });
            });

            targetEntityTypeSelect.addEventListener('change', function() {
                targetRmaSection.style.display = this.value === 'RMA' ? 'block' : 'none';
                targetToolSection.style.display = this.value === 'TOOL' ? 'block' : 'none';
                targetTrackTrendSection.style.display = this.value === 'TRACK_TREND' ? 'block' : 'none';
            });

            // Optional: Handle form submission if not already handled by standard form submit
            // If using AJAX for form submission, add that logic here.
            // For now, assuming standard form submission is okay.
        });
        // END: JavaScript for Unified Link File Modal on RMA View Page

        // START: JavaScript for Excel Preview
        async function previewExcelDocument(event) {
            event.preventDefault();
            const fileUrl = event.target.dataset.fileUrl;
            const modalElement = document.getElementById('excelPreviewModal');
            const modal = new bootstrap.Modal(modalElement);
            const contentDiv = document.getElementById('excelPreviewContent');
            const modalTitle = document.getElementById('excelPreviewModalLabel');

            contentDiv.innerHTML = '<p class="text-center">Loading preview...</p>';
            modalTitle.textContent = 'Excel Preview: ' + event.target.textContent;
            modal.show();

            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const htmlTable = XLSX.utils.sheet_to_html(worksheet);
                
                contentDiv.innerHTML = htmlTable;
                // Add some basic styling to the generated table
                const tableElement = contentDiv.querySelector('table');
                if (tableElement) {
                    tableElement.classList.add('table', 'table-bordered', 'table-sm');
                }
            } catch (error) {
                console.error('Error previewing Excel file:', error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Could not load preview. Is the file a valid Excel document?</p>';
            }
        }
        // END: JavaScript for Excel Preview

        // START: JavaScript for Editable Status
        function enterStatusEditMode() {
            document.getElementById('status-view-mode').classList.add('d-none');
            document.getElementById('status-edit-mode').classList.remove('d-none');
            // Potentially pre-select current status if needed, though th:selected should handle initial load
        }

        function cancelStatusEdit() {
            document.getElementById('status-edit-mode').classList.add('d-none');
            document.getElementById('status-view-mode').classList.remove('d-none');
        }

        function saveStatus() {
            const newStatus = document.getElementById('status-select').value;
            const rmaId = rmaPageId; // Assuming rmaPageId is globally available from hidden input

            fetch(`/rma/${rmaId}/update-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `newStatus=${encodeURIComponent(newStatus)}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update status') });
                }
                return response.json(); 
            })
            .then(data => {
                if (data.success) {
                    // Update the displayed status and badge class
                    const statusViewMode = document.getElementById('status-view-mode');
                    statusViewMode.textContent = data.newStatusDisplay;
                    
                    // Update badge class based on data.newStatus (enum name)
                    let badgeClass = 'badge detail-status-badge rma-status-badge ';
                    if (data.newStatus === 'RMA_WRITTEN_EMAILED') badgeClass += 'bg-primary';
                    else if (data.newStatus === 'NUMBER_PROVIDED') badgeClass += 'bg-info';
                    else if (data.newStatus === 'MEMO_EMAILED') badgeClass += 'bg-secondary';
                    else if (data.newStatus === 'RECEIVED_PARTS') badgeClass += 'bg-warning';
                    else if (data.newStatus === 'WAITING_CUSTOMER') badgeClass += 'bg-danger';
                    else if (data.newStatus === 'WAITING_FSE') badgeClass += 'bg-danger';
                    else if (data.newStatus === 'COMPLETED') badgeClass += 'bg-success';
                    else badgeClass += 'bg-light text-dark';
                    
                    statusViewMode.className = badgeClass;
                    cancelStatusEdit(); // Switch back to view mode
                } else {
                    alert('Error updating status: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving status:', error);
                alert('Failed to save status: ' + error.message);
            });
        }
        // END: JavaScript for Editable Status

        // START: JavaScript for Editable Priority
        function enterPriorityEditMode() {
            document.getElementById('priority-view-mode-container').classList.add('d-none');
            document.getElementById('priority-edit-mode-container').classList.remove('d-none');
        }

        function cancelPriorityEdit() {
            document.getElementById('priority-edit-mode-container').classList.add('d-none');
            document.getElementById('priority-view-mode-container').classList.remove('d-none');
        }

        function savePriority() {
            const newPriority = document.getElementById('priority-select').value;
            const rmaId = rmaPageId; // Assuming rmaPageId is globally available

            fetch(`/rma/${rmaId}/update-priority`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `newPriority=${encodeURIComponent(newPriority)}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update priority') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const priorityViewContainer = document.getElementById('priority-view-mode-container');
                    priorityViewContainer.textContent = data.newPriorityDisplay;

                    let badgeClass = 'badge detail-priority-badge rma-priority-badge border border-light ';
                    if (data.newPriority === 'LOW') badgeClass += 'bg-info';
                    else if (data.newPriority === 'MEDIUM') badgeClass += 'bg-warning text-dark';
                    else if (data.newPriority === 'HIGH') badgeClass += 'bg-danger';
                    else if (data.newPriority === 'URGENT') badgeClass += 'bg-danger text-uppercase';
                    else badgeClass += 'bg-light text-dark';
                    
                    priorityViewContainer.className = badgeClass;
                    cancelPriorityEdit();
                } else {
                    alert('Error updating priority: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving priority:', error);
                alert('Failed to save priority: ' + error.message);
            });
        }
        // END: JavaScript for Editable Priority

        function saveProblemDetails() {
            const form = document.getElementById('problem-details-form');
            const formData = new FormData(form);
            
            fetch(`/rma/${rmaPageId}/update-problem`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message || 'Failed to update problem details') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update the view mode with new values instead of reloading
                    updateProblemDetailsView(formData);
                    cancelInlineEdit('problem-details');
                } else {
                    alert('Error updating problem details: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving problem details:', error);
                alert('Error updating problem details: ' + error.message);
            });
        }

        function updateProblemDetailsView(formData) {
            // Update the view mode elements with the new values
            const updateElement = (selector, value, fallback = 'Not specified') => {
                const element = document.querySelector(selector);
                if (element) {
                    if (value && value.trim()) {
                        element.textContent = value.trim();
                        element.className = element.classList.contains('mb-0') ? 'mb-0' : '';
                    } else {
                        element.textContent = fallback;
                        element.className = 'detail-text-muted';
                    }
                }
            };

            // Update each field in the view mode
            updateElement('#problem-details-view-mode .col-md-6:nth-child(1) strong', formData.get('problemDiscoverer'));
            updateElement('#problem-details-view-mode .col-md-6:nth-child(1) span', formData.get('problemDiscoverer'), 'Not specified');
            
            // Format date if present
            const discoveryDate = formData.get('problemDiscoveryDate');
            if (discoveryDate) {
                const formatted = new Date(discoveryDate).toLocaleDateString('en-US');
                updateElement('#problem-details-view-mode .col-md-6:nth-child(2) strong', formatted);
            } else {
                updateElement('#problem-details-view-mode .col-md-6:nth-child(2) span', '', 'Not specified');
            }
            
            updateElement('#problem-details-view-mode .col-12:nth-child(3) p', formData.get('whatHappened'));
            updateElement('#problem-details-view-mode .col-12:nth-child(3) span', formData.get('whatHappened'), 'Not specified');
            
            updateElement('#problem-details-view-mode .col-12:nth-child(4) p', formData.get('whyAndHowItHappened'));
            updateElement('#problem-details-view-mode .col-12:nth-child(4) span', formData.get('whyAndHowItHappened'), 'Not specified');
            
            updateElement('#problem-details-view-mode .col-md-6:nth-child(5) p', formData.get('howContained'));
            updateElement('#problem-details-view-mode .col-md-6:nth-child(5) span', formData.get('howContained'), 'Not specified');
            
            updateElement('#problem-details-view-mode .col-md-6:nth-child(6) strong', formData.get('whoContained'));
            updateElement('#problem-details-view-mode .col-md-6:nth-child(6) span', formData.get('whoContained'), 'Not specified');
            
            updateElement('#problem-details-view-mode .col-md-6:nth-child(7) p', formData.get('rootCause'), 'No root cause identified');
            updateElement('#problem-details-view-mode .col-md-6:nth-child(8) p', formData.get('resolution'), 'No resolution provided');
        }

        function saveProcessImpact() {
            const form = document.getElementById('process-impact-form');
            const formData = new FormData(form);
            
            fetch(`/rma/${rmaPageId}/update-process-impact`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message || 'Failed to update process impact') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateProcessImpactView(formData);
                    cancelInlineEdit('process-impact');
                } else {
                    alert('Error updating process impact: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving process impact:', error);
                alert('Error updating process impact: ' + error.message);
            });
        }

        function updateProcessImpactView(formData) {
            // Update badge fields (Yes/No with colored badges)
            const updateBadge = (colIndex, value, yesClass = 'bg-danger', noClass = 'bg-success') => {
                const col = document.querySelector(`#process-impact-view-mode .col-md-6:nth-child(${colIndex}) div span.badge`);
                if (col) {
                    const isYes = value === 'true';
                    col.textContent = isYes ? 'Yes' : 'No';
                    col.className = `badge ${isYes ? yesClass : noClass}`;
                }
            };

            // Update text fields
            const updateText = (selector, value, fallback = 'Not specified') => {
                const element = document.querySelector(selector);
                if (element) {
                    if (value && value.trim()) {
                        element.textContent = value.trim();
                        element.className = element.classList.contains('mb-0') ? 'mb-0' : '';
                    } else {
                        element.textContent = fallback;
                        element.className = 'detail-text-muted';
                    }
                }
            };

            // Update all process impact fields with correct selectors
            // Col 1: Interruption to Flow (Yes=danger, No=success)
            updateBadge(1, formData.get('interruptionToFlow'), 'bg-danger', 'bg-success');
            
            // Col 2: Interruption to Production (Yes=danger, No=success)  
            updateBadge(2, formData.get('interruptionToProduction'), 'bg-danger', 'bg-success');
            
            // Col 3: Downtime Hours (strong text with " hours" suffix)
            const downtimeHours = formData.get('downtimeHours') || '0';
            const downtimeElement = document.querySelector('#process-impact-view-mode .col-md-6:nth-child(3) strong');
            if (downtimeElement) {
                downtimeElement.textContent = downtimeHours + ' hours';
            }
            
            // Col 4: Exposed to Gas/Chemicals (Yes=warning, No=success)
            updateBadge(4, formData.get('exposedToProcessGasOrChemicals'), 'bg-warning', 'bg-success');
            
            // Col 5: Purged (Yes=success, No=warning)
            updateBadge(5, formData.get('purged'), 'bg-success', 'bg-warning');
            
            // Col 6: Start-up/SO3 Complete (Yes=success, No=warning)
            updateBadge(6, formData.get('startupSo3Complete'), 'bg-success', 'bg-warning');
            
            // Col 7: Failed on Install (Yes=danger, No=success)
            updateBadge(7, formData.get('failedOnInstall'), 'bg-danger', 'bg-success');
            
            // Col 12: Instructions (paragraph text)
            const instructionsValue = formData.get('instructionsForExposedComponent');
            const instructionsP = document.querySelector('#process-impact-view-mode .col-12 p');
            const instructionsSpan = document.querySelector('#process-impact-view-mode .col-12 span');
            
            if (instructionsValue && instructionsValue.trim()) {
                if (instructionsP) {
                    instructionsP.textContent = instructionsValue.trim();
                    instructionsP.style.display = 'block';
                }
                if (instructionsSpan) instructionsSpan.style.display = 'none';
            } else {
                if (instructionsP) instructionsP.style.display = 'none';
                if (instructionsSpan) {
                    instructionsSpan.textContent = 'No instructions provided';
                    instructionsSpan.style.display = 'block';
                }
            }
        }

        function saveCustomer() {
            const form = document.getElementById('customer-form');
            const formData = new FormData(form);
            
            fetch(`/rma/${rmaPageId}/update-customer`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message || 'Failed to update customer information') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateCustomerView(formData);
                    cancelInlineEdit('customer');
                } else {
                    alert('Error updating customer information: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving customer information:', error);
                alert('Error updating customer information: ' + error.message);
            });
        }

        function updateCustomerView(formData) {
            const updateField = (selector, value, fallback = 'Not specified') => {
                const pElement = document.querySelector(`${selector} p`);
                const spanElement = document.querySelector(`${selector} span`);
                
                if (value && value.trim()) {
                    if (pElement) {
                        pElement.textContent = value.trim();
                        pElement.style.display = 'block';
                    }
                    if (spanElement) spanElement.style.display = 'none';
                } else {
                    if (pElement) pElement.style.display = 'none';
                    if (spanElement) {
                        spanElement.textContent = fallback;
                        spanElement.style.display = 'block';
                    }
                }
            };

            // Update all customer fields with specific selectors (avoid nth-child issues with mixed col classes)
            // Customer Name - first .col-md-6
            updateField('#customer-view-mode .col-md-6:nth-of-type(1)', formData.get('customerName'));
            
            // Attention - second .col-md-6
            updateField('#customer-view-mode .col-md-6:nth-of-type(2)', formData.get('attn'));
            
            // Company Ship To - .col-12 section (more complex)
            const companyContainer = document.querySelector('#customer-view-mode .col-12 .d-flex');
            const companyName = formData.get('companyShipToName');
            const address = formData.get('companyShipToAddress');
            const city = formData.get('city');
            const state = formData.get('state');
            const zipCode = formData.get('zipCode');
            
            if (companyContainer) {
                // Clear existing company content (keep the small label)
                const existingPs = companyContainer.querySelectorAll('p');
                const existingSpan = companyContainer.querySelector('span.detail-text-muted');
                existingPs.forEach(p => p.remove());
                if (existingSpan) existingSpan.remove();
                
                if (companyName && companyName.trim()) {
                    // Create company name paragraph
                    const nameP = document.createElement('p');
                    nameP.className = 'mb-0';
                    nameP.textContent = companyName.trim();
                    companyContainer.appendChild(nameP);
                    
                    // Create address paragraph if exists
                    if (address && address.trim()) {
                        const addrP = document.createElement('p');
                        addrP.className = 'mb-0';
                        addrP.textContent = address.trim();
                        companyContainer.appendChild(addrP);
                    }
                    
                    // Create city/state/zip paragraph if any exist
                    if (city || state || zipCode) {
                        const locationP = document.createElement('p');
                        locationP.className = 'mb-0';
                        let locationText = '';
                        if (city && city.trim()) locationText += city.trim();
                        if (city && city.trim() && state && state.trim()) locationText += ', ';
                        if (state && state.trim()) locationText += state.trim();
                        if (zipCode && zipCode.trim()) locationText += ' ' + zipCode.trim();
                        if (locationText) {
                            locationP.textContent = locationText;
                            companyContainer.appendChild(locationP);
                        }
                    }
                } else {
                    // No company info - show fallback
                    const noInfoSpan = document.createElement('span');
                    noInfoSpan.className = 'detail-text-muted';
                    noInfoSpan.textContent = 'No shipping address specified';
                    companyContainer.appendChild(noInfoSpan);
                }
            }
            
            // Contact Phone Number - use more specific selector
            const phoneContainer = Array.from(document.querySelectorAll('#customer-view-mode .col-md-6')).find(col => 
                col.querySelector('small')?.textContent?.includes('Contact Phone Number')
            );
            if (phoneContainer) {
                const phoneValue = formData.get('customerPhone');
                const pElement = phoneContainer.querySelector('p');
                const spanElement = phoneContainer.querySelector('span');
                
                if (phoneValue && phoneValue.trim()) {
                    if (pElement) {
                        pElement.textContent = phoneValue.trim();
                        pElement.style.display = 'block';
                    }
                    if (spanElement) spanElement.style.display = 'none';
                } else {
                    if (pElement) pElement.style.display = 'none';
                    if (spanElement) {
                        spanElement.textContent = 'Not specified';
                        spanElement.style.display = 'block';
                    }
                }
            }
            
            // Field Tech Name - fourth .col-md-6
            updateField('#customer-view-mode .col-md-6:nth-of-type(4)', formData.get('fieldTechName'));
            
            // Field Tech Phone - fifth .col-md-6
            updateField('#customer-view-mode .col-md-6:nth-of-type(5)', formData.get('fieldTechPhone'));
            
            // Field Tech Email - sixth .col-md-6
            updateField('#customer-view-mode .col-md-6:nth-of-type(6)', formData.get('fieldTechEmail'));
        }

        function savePartsInfo() {
            const form = document.getElementById('parts-info-form');
            const formData = new FormData(form);
            
            fetch(`/rma/${rmaPageId}/update-parts`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message || 'Failed to update parts') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Switch back to view mode (parts doesn't have separate view mode div)
                    cancelInlineEdit('parts-info');
                    
                    // Show success message
                    console.log('Parts updated successfully');
                    
                    // Reload page to show updated parts
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    throw new Error(data.message || 'Failed to update parts');
                }
            })
            .catch(error => {
                console.error('Error saving parts:', error);
                alert('Error updating parts: ' + error.message);
            });
        }

        let partRowIndex = 0;
        
        function initializePartsEdit() {
            const container = document.getElementById('parts-edit-container');
            container.innerHTML = ''; // Clear existing
            partRowIndex = 0;
            
            // Add header row
            const headerDiv = document.createElement('div');
            headerDiv.className = 'row mb-2';
            headerDiv.innerHTML = `
                <div class="col-md-2"><strong>Part Name</strong></div>
                <div class="col-md-3"><strong>Part Number</strong></div>
                <div class="col-md-3"><strong>Description</strong></div>
                <div class="col-md-1"><strong>Qty</strong></div>
                <div class="col-md-2"><strong>Replace?</strong></div>
                <div class="col-md-1"></div>
            `;
            container.appendChild(headerDiv);
            
            // Add existing parts as editable rows
            const existingParts = document.querySelectorAll('#parts-info-view-mode tbody tr');
            if (existingParts.length > 0) {
                existingParts.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    addPartRowWithData(
                        cells[0]?.textContent === '-' ? '' : cells[0]?.textContent || '',
                        cells[1]?.textContent === '-' ? '' : cells[1]?.textContent || '',
                        cells[2]?.textContent === '-' ? '' : cells[2]?.textContent || '',
                        cells[3]?.textContent || '1',
                        cells[4]?.querySelector('.badge')?.textContent === 'Yes'
                    );
                });
            } else {
                // Add at least one empty row
                addPartRow();
            }
        }
        
        function addPartRow() {
            const container = document.getElementById('parts-edit-container');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row mb-2 part-row';
            
            rowDiv.innerHTML = `
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][partName]" placeholder="Part Name">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][partNumber]" placeholder="Part Number">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][productDescription]" placeholder="Description">
                </div>
                <div class="col-md-1">
                    <input type="number" class="form-control form-control-sm" name="parts[${partRowIndex}][quantity]" value="1" min="1">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="parts[${partRowIndex}][replacementRequired]">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePartRow(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(rowDiv);
            partRowIndex++;
        }
        
        function addPartRowWithData(partName, partNumber, description, quantity, replacement) {
            const container = document.getElementById('parts-edit-container');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row mb-2 part-row';
            
            rowDiv.innerHTML = `
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][partName]" value="${partName}" placeholder="Part Name">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][partNumber]" value="${partNumber}" placeholder="Part Number">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" name="parts[${partRowIndex}][productDescription]" value="${description}" placeholder="Description">
                </div>
                <div class="col-md-1">
                    <input type="number" class="form-control form-control-sm" name="parts[${partRowIndex}][quantity]" value="${quantity}" min="1">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" name="parts[${partRowIndex}][replacementRequired]">
                        <option value="false" ${!replacement ? 'selected' : ''}>No</option>
                        <option value="true" ${replacement ? 'selected' : ''}>Yes</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePartRow(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(rowDiv);
            partRowIndex++;
        }
        
        function removePartRow(button) {
            button.closest('.part-row').remove();
        }

        function saveDates() {
            const form = document.getElementById('dates-form');
            const formData = new FormData(form);
            
            fetch(`/rma/${rmaPageId}/update-dates`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.message || 'Failed to update dates') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateDatesView(formData);
                    cancelInlineEdit('dates');
                } else {
                    alert('Error updating dates: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving dates:', error);
                alert('Error updating dates: ' + error.message);
            });
        }

        function updateDatesView(formData) {
            const updateDate = (selector, value) => {
                const element = document.querySelector(selector);
                if (element) {
                    if (value && value.trim()) {
                        const formatted = new Date(value).toLocaleDateString('en-US');
                        element.textContent = formatted;
                        element.className = element.classList.contains('mb-0') ? 'mb-0' : '';
                    } else {
                        element.textContent = 'Not set';
                        element.className = 'detail-text-muted';
                    }
                }
            };

            // Update date fields - these selectors will need to match the actual HTML structure
            updateDate('#dates-view-mode .col-md-4:nth-child(1) strong', formData.get('writtenDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(2) strong', formData.get('rmaNumberProvidedDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(3) strong', formData.get('shippingMemoEmailedDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(4) strong', formData.get('partsReceivedDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(5) strong', formData.get('installedPartsDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(6) strong', formData.get('failedPartsPackedDate'));
            updateDate('#dates-view-mode .col-md-4:nth-child(7) strong', formData.get('failedPartsShippedDate'));
        }

        // Generic section editing functionality
        function enableInlineEdit(sectionId) {
            const viewMode = document.getElementById(sectionId + '-view-mode');
            const editMode = document.getElementById(sectionId + '-edit-mode');
            
            if (viewMode && editMode) {
                // Handle special case for parts-info to initialize the parts editor
                if (sectionId === 'parts-info') {
                    initializePartsEdit();
                }
                
                // Show edit mode, hide view mode
                viewMode.classList.add('d-none');
                editMode.classList.remove('d-none');
                
                // Update buttons if they exist (some sections might not have them)
                const editBtn = document.querySelector('.edit-section-btn[data-section="' + sectionId + '"]');
                const saveBtn = document.querySelector('.save-section-btn[data-section="' + sectionId + '"]');
                const cancelBtn = document.querySelector('.cancel-section-btn[data-section="' + sectionId + '"]');
                
                if (editBtn) editBtn.classList.add('d-none');
                if (saveBtn) saveBtn.classList.remove('d-none');
                if (cancelBtn) cancelBtn.classList.remove('d-none');
            } else {
                // Fallback for sections without view/edit mode structure
                console.log('Section "' + sectionId + '" does not have view/edit mode structure yet');
                alert('Edit functionality for "' + sectionId + '" is not fully implemented yet. This will be available in a future update.');
            }
        }

        function cancelInlineEdit(sectionId) {
            const viewMode = document.getElementById(sectionId + '-view-mode');
            const editMode = document.getElementById(sectionId + '-edit-mode');
            
            if (viewMode && editMode) {
                viewMode.classList.remove('d-none');
                editMode.classList.add('d-none');
                
                // Update buttons
                const editBtn = document.querySelector('.edit-section-btn[data-section="' + sectionId + '"]');
                const saveBtn = document.querySelector('.save-section-btn[data-section="' + sectionId + '"]');
                const cancelBtn = document.querySelector('.cancel-section-btn[data-section="' + sectionId + '"]');
                
                if (editBtn) editBtn.classList.remove('d-none');
                if (saveBtn) saveBtn.classList.add('d-none');
                if (cancelBtn) cancelBtn.classList.add('d-none');
            }
        }

        function saveInlineEdit(sectionId, endpoint) {
            const form = document.getElementById(sectionId + '-form');
            if (!form) return;

            const formData = new FormData(form);
            
            fetch('/rma/' + rmaPageId + '/' + endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated data
                } else {
                    alert('Error updating ' + sectionId + ': ' + (data.message || 'Unknown error'));
                    cancelInlineEdit(sectionId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating ' + sectionId);
                cancelInlineEdit(sectionId);
            });
        }

        // Initialize section editing functionality
        function initializeSectionEditing() {
            // Generic handler for all edit buttons
            document.querySelectorAll('.edit-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section === 'header') {
                        enterHeaderEditMode();
                    } else {
                        enableInlineEdit(section);
                    }
                });
            });

            // Generic handler for all save buttons
            document.querySelectorAll('.save-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    let endpoint;
                    switch(section) {
                        case 'header': 
                            saveHeaderChanges(); 
                            return;
                        case 'process-impact': 
                            saveProcessImpact(); 
                            return;
                        case 'customer': 
                            saveCustomer(); 
                            return;
                        case 'dates': 
                            saveDates(); 
                            return;
                        case 'problem-details': 
                            saveProblemDetails(); 
                            return;
                        case 'parts-info': endpoint = 'update-parts'; break;
                        default: endpoint = 'update-' + section; break;
                    }
                    saveInlineEdit(section, endpoint);
                });
            });

            // Generic handler for all cancel buttons
            document.querySelectorAll('.cancel-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section === 'header') {
                        cancelHeaderEditMode();
                    } else {
                        cancelInlineEdit(section);
                    }
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSectionEditing();
        });
    </script>

    <!-- Tool Selection Modal -->
    <div class="modal fade" id="toolSelectionModal" tabindex="-1" aria-labelledby="toolSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="toolSelectionModalLabel">Select Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Search and Filter Controls -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="toolSearchInput" class="form-control" placeholder="Search tools by name, model, or serial..." oninput="filterTools()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select id="toolSortSelect" class="form-select" onchange="sortTools()">
                                <option value="alphabetical">Sort Alphabetically</option>
                                <option value="recent">Most Recently Edited</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="toolLocationFilter" class="form-select" onchange="filterTools()">
                                <option value="">All Locations</option>
                                <option th:each="location : ${locations}" 
                                        th:value="${location.displayName}" 
                                        th:text="${location.displayName}">Location</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tool Preview Card -->
                    <div id="toolPreviewCard" class="card mb-3 d-none">
                        <div class="card-header">
                            <h6 class="mb-0">Selected Tool Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong id="previewToolName">Tool Name</strong>
                                    <div id="previewToolSecondary" class="text-muted small"></div>
                                </div>
                                <div class="col-md-6">
                                    <div class="small">
                                        <div><strong>Type:</strong> <span id="previewToolType">-</span></div>
                                        <div><strong>Model:</strong> <span id="previewToolModel">-</span></div>
                                        <div><strong>Serial:</strong> <span id="previewToolSerial">-</span></div>
                                        <div><strong>Location:</strong> <span id="previewToolLocation">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tools List -->
                    <div id="toolsListContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- Table Header -->
                        <div class="tool-table-header d-flex align-items-center p-2 bg-light border-bottom fw-bold text-muted small">
                            <div style="flex: 2; min-width: 200px;">TOOL NAME</div>
                            <div style="flex: 1; min-width: 120px; text-align: center;">TYPE</div>
                            <div style="flex: 1; min-width: 120px; text-align: center;">MODEL</div>
                            <div style="flex: 1; min-width: 120px; text-align: center;">SERIAL NUMBER</div>
                            <div style="flex: 1; min-width: 100px; text-align: center;">LOCATION</div>
                        </div>
                        <div class="list-group" id="toolsList">
                            <!-- Tools will be populated here via JavaScript -->
                        </div>
                    </div>

                    <!-- No Results Message -->
                    <div id="noToolsMessage" class="text-center text-muted py-4 d-none">
                        <i class="bi bi-search fs-1"></i>
                        <p class="mt-2">No tools found matching your criteria.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmToolSelection" onclick="confirmToolSelection()" disabled>
                        <i class="bi bi-check-lg"></i> Select Tool
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Selection Modal JavaScript -->
    <script>
        let selectedToolId = null;
        let allToolsData = [];
        let filteredToolsData = [];

        // Location dropdown functions
        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            dropdown.classList.toggle('d-none');
        }

        function changeLocation() {
            // Auto-save functionality - remove this if you want manual save
            // saveLocationChange();
        }

        function saveLocationChange() {
            const select = document.getElementById('locationSelect');
            const selectedLocationId = select.value;
            const selectedLocationText = select.options[select.selectedIndex].text;

            const payload = new URLSearchParams();
            payload.append('locationId', selectedLocationId);

            fetch('/rma/' + rmaPageId + '/update-location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('locationDisplay').textContent = selectedLocationText || 'No location';
                    toggleLocationDropdown();
                } else {
                    alert('Error updating location: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating location');
            });
        }

        function cancelLocationChange() {
            toggleLocationDropdown();
        }

        // Tool selection modal functions
        function openToolSelectionModal() {
            selectedToolId = null;
            document.getElementById('confirmToolSelection').disabled = true;
            document.getElementById('toolPreviewCard').classList.add('d-none');
            
            // Load tools data
            loadToolsData();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('toolSelectionModal'));
            modal.show();
        }

        function loadToolsData() {
            fetch('/tools/api/list')
                .then(response => response.json())
                .then(data => {
                    allToolsData = data;
                    filteredToolsData = [...allToolsData];
                    renderToolsList();
                })
                .catch(error => {
                    console.error('Error loading tools:', error);
                    alert('Error loading tools data');
                });
        }

        function filterTools() {
            const searchTerm = document.getElementById('toolSearchInput').value.toLowerCase();
            const locationFilter = document.getElementById('toolLocationFilter').value;

            filteredToolsData = allToolsData.filter(tool => {
                const matchesSearch = !searchTerm || 
                    tool.name.toLowerCase().includes(searchTerm) ||
                    (tool.secondaryName && tool.secondaryName.toLowerCase().includes(searchTerm)) ||
                    (tool.model1 && tool.model1.toLowerCase().includes(searchTerm)) ||
                    (tool.serialNumber1 && tool.serialNumber1.toLowerCase().includes(searchTerm));

                const matchesLocation = !locationFilter || tool.locationName === locationFilter;

                return matchesSearch && matchesLocation;
            });

            renderToolsList();
        }

        function sortTools() {
            const sortBy = document.getElementById('toolSortSelect').value;

            if (sortBy === 'alphabetical') {
                filteredToolsData.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'recent') {
                filteredToolsData.sort((a, b) => {
                    const dateA = new Date(a.updatedAt || a.createdAt);
                    const dateB = new Date(b.updatedAt || b.createdAt);
                    return dateB - dateA; // Most recent first
                });
            }

            renderToolsList();
        }

        function renderToolsList() {
            const container = document.getElementById('toolsList');
            const noResultsMsg = document.getElementById('noToolsMessage');

            if (filteredToolsData.length === 0) {
                container.innerHTML = '';
                noResultsMsg.classList.remove('d-none');
                return;
            }

            noResultsMsg.classList.add('d-none');

            container.innerHTML = filteredToolsData.map(tool => `
                <div class="list-group-item list-group-item-action tool-item py-2" data-tool-id="${tool.id}" onclick="selectTool(${tool.id})">
                    <div class="d-flex align-items-center">
                        <div class="tool-name-col" style="flex: 2; min-width: 200px;">
                            <div class="fw-bold">${tool.name}</div>
                            ${tool.secondaryName ? `<div class="text-muted small">${tool.secondaryName}</div>` : ''}
                        </div>
                        <div class="tool-type-col" style="flex: 1; min-width: 120px; text-align: center;">
                            <span class="badge bg-light text-dark">${tool.toolType || '-'}</span>
                        </div>
                        <div class="tool-model-col" style="flex: 1; min-width: 120px; text-align: center;">
                            <span>${tool.model1 || '-'}</span>
                        </div>
                        <div class="tool-serial-col" style="flex: 1; min-width: 120px; text-align: center;">
                            <code class="small bg-light px-1">${tool.serialNumber1 || '-'}</code>
                        </div>
                        <div class="tool-location-col" style="flex: 1; min-width: 100px; text-align: center;">
                            <span class="badge bg-secondary small">${tool.locationName || 'Unknown'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectTool(toolId) {
            selectedToolId = toolId;
            const tool = allToolsData.find(t => t.id === toolId);

            // Update UI selection
            document.querySelectorAll('.tool-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tool-id="${toolId}"]`).classList.add('active');

            // Update preview
            if (tool) {
                document.getElementById('previewToolName').textContent = tool.name;
                document.getElementById('previewToolSecondary').textContent = tool.secondaryName || '';
                document.getElementById('previewToolType').textContent = tool.toolType || '-';
                document.getElementById('previewToolModel').textContent = tool.model1 || '-';
                document.getElementById('previewToolSerial').textContent = tool.serialNumber1 || '-';
                document.getElementById('previewToolLocation').textContent = tool.locationName || 'Unknown';
                
                document.getElementById('toolPreviewCard').classList.remove('d-none');
            }

            document.getElementById('confirmToolSelection').disabled = false;
        }

        function confirmToolSelection() {
            if (!selectedToolId) return;

            const payload = new URLSearchParams();
            payload.append('toolId', selectedToolId);

            fetch('/rma/' + rmaPageId + '/update-tool', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload page to show updated tool
                    bootstrap.Modal.getInstance(document.getElementById('toolSelectionModal')).hide();
                    location.reload();
                } else {
                    alert('Error updating tool: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating tool');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('locationDropdown');
            const wrapper = document.querySelector('.location-badge-wrapper');
            
            if (dropdown && !dropdown.classList.contains('d-none') && 
                !wrapper.contains(event.target)) {
                dropdown.classList.add('d-none');
            }
        });
    </script>
    
    <!-- Moving Part Modal JavaScript Fragment -->
    <div th:replace="~{fragments/moving-part-modal :: movingPartModalScript('destinationContainerRma', 'addDestinationBtnRma')}"></div>
</body>
</html>