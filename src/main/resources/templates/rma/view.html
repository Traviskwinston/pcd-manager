<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/dark-mode.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Comment styles */
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .comment-user {
            font-weight: bold;
        }
        .comment-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        .comment-content {
            white-space: pre-wrap;
        }
        /* New styles for collapsible sections */
        .collapse-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapse-header h5 {
            margin-bottom: 0;
        }
        .date-table {
            table-layout: fixed;
            width: 100%;
        }
        .date-table th {
            font-size: 0.85rem;
            text-align: center;
            width: 11.11%; /* For 9 columns */
        }
        .date-table td {
            text-align: center;
            font-size: 0.9rem;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        /* Styles for Excel Preview Modal Table */
        #excelPreviewContent table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem; /* Smaller font for more content visibility */
            margin-bottom: 1rem; /* Add some space below the table */
        }
        #excelPreviewContent th,
        #excelPreviewContent td {
            border: 1px solid #ccc; /* Slightly lighter border */
            padding: 0.5rem 0.6rem; /* Slightly increased padding */
            text-align: left;
            vertical-align: top;
            word-wrap: break-word; /* Ensure long words don't break layout */
        }
        /* Header Row Styling (for thead th or first row td) */
        #excelPreviewContent thead th,
        #excelPreviewContent tbody tr:first-child td {
            background-color: #4a708b; /* A slate blue color */
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        /* First column styling - for label-like cells */
        #excelPreviewContent tbody td:first-child {
            background-color: #f8f9fa; /* Light grey, similar to bootstrap's table-light */
            font-weight: 500; /* Slightly bolder for labels */
        }
        /* Zebra striping - ensure it doesn't override first column if first col is also even */
        #excelPreviewContent tbody tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        #excelPreviewContent tbody tr:nth-child(even) td:first-child {
            background-color: #f0f2f4; /* A slightly different shade for even row, first column */
        }
        /* Override for first row if it's styled as header, to avoid first-child td conflict */
        #excelPreviewContent tbody tr:first-child td:first-child {
            background-color: #4a708b; /* Match header color */
            color: white;
            font-weight: bold;
        }
        
        /* Status select minimum width to prevent text cutoff */
        #status-select {
            min-width: 200px !important; /* Extra room to ensure "Shipping Memo Emailed" is fully visible */
        }
        
        /* Additional width for smaller screens (like half-screen) */
        @media (max-width: 1200px) {
            #status-select {
                min-width: 220px !important; /* Even more room for constrained screens */
            }
        }
        
        @media (max-width: 992px) {
            #status-select {
                min-width: 240px !important; /* Maximum room for very constrained screens */
            }
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <h1>RMA Details</h1>
            </div>
            <div class="col text-end">
                <a th:href="@{/rma}" class="btn btn-outline-secondary me-2" title="Back to RMA List">
                    <i class="bi bi-list"></i>
                </a>
                <a th:href="@{/rma/edit/{id}(id=${rma.id})}" class="btn btn-outline-primary me-2" title="Edit RMA">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a th:href="@{/rma/{id}/excel(id=${rma.id})}" class="btn btn-success me-2">
                    <i class="bi bi-file-excel me-1"></i> Export to Excel
                </a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete RMA">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-start"> <!-- Outer flex -->
                            <div class="flex-grow-1 me-3"> <!-- Content block -->
                                <!-- View Mode for Header -->
                                <div id="header-view-mode">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <!-- Left Side: RMA/SAP Info -->
                                        <div>
                                            <h4 class="mb-0">
                                                <span>RMA/SAP #: </span>
                                                <span id="viewRmaNumber" th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}" th:text="${rma.rmaNumber}">RMA Number</span>
                                                <span id="viewRmaSapSeparator" th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty && rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}"> / </span>
                                                <span id="viewSapNumber" th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}" th:text="${rma.sapNotificationNumber}">SAP Number</span>
                                                <span id="viewRmaSapNa" th:if="${(rma.rmaNumber == null || rma.rmaNumber.empty) && (rma.sapNotificationNumber == null || rma.sapNotificationNumber.empty)}">N/A</span>
                                            </h4>
                                            <!-- Service Order Display -->
                                            <div th:if="${rma.serviceOrder != null && !rma.serviceOrder.empty}" class="small text-muted">
                                                Service Order #: <span id="viewServiceOrder" th:text="${rma.serviceOrder}"></span>
                                            </div>
                                            <!-- Additional Info Display -->
                                            <div class="small text-muted mt-1" 
                                                 th:if="${rma.reasonForRequest != null || rma.dssProductLine != null || rma.systemDescription != null}">
                                                <span th:if="${rma.reasonForRequest != null}">
                                                    <span id="viewReasonForRequest" th:text="${rma.reasonForRequest.displayName ?: rma.reasonForRequest}"></span>
                                                </span>
                                                <span class="viewReasonDssSeparator" th:if="${rma.reasonForRequest != null && (rma.dssProductLine != null || rma.systemDescription != null)}"> | </span>
                                                <span th:if="${rma.dssProductLine != null}">
                                                    <span id="viewDssProductLine" th:text="${rma.dssProductLine.displayName ?: rma.dssProductLine}"></span>
                                                </span>
                                                <span class="viewDssSystemSeparator" th:if="${rma.dssProductLine != null && rma.systemDescription != null}"> | </span>
                                                <span th:if="${rma.systemDescription != null}">
                                                    <span id="viewSystemDescription" th:text="${rma.systemDescription.displayName ?: rma.systemDescription}"></span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Status and Priority (Moved Here) -->
                                        <div class="align-self-start"> <!-- To align with other items if content height varies -->
                                            <div class="d-flex align-items-center flex-wrap">
                                                <!-- Status -->
                                                <span class="me-4">
                                                    <!-- View Mode for Status -->
                                                    <span id="status-view-mode" th:if="${rma.status != null}" th:class="${'badge rounded-pill fs-6 cursor-pointer ' + 
                                                    (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                                    (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                                    (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                                    (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                                    (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                                    (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                                    (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                                    onclick="enterStatusEditMode()"
                                                    title="Click to change status">
                                                    <span th:text="${rma.status?.displayName}">Status</span>
                                                    <i class="bi bi-chevron-down ms-1"></i>
                                                </span>
                                                
                                                <!-- Edit Mode for Status -->
                                                <span id="status-edit-mode" class="d-none">
                                                    <select id="status-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                                        <option th:each="statusOption : ${T(com.pcd.manager.model.RmaStatus).values()}"
                                                                th:value="${statusOption}"
                                                                th:text="${statusOption.displayName}"
                                                                th:selected="${statusOption == rma.status}"></option>
                                                    </select>
                                                    <button type="button" class="btn btn-sm btn-success ms-1" onclick="saveStatus()">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="cancelStatusEdit()">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </span>
                                                </span>
                                                
                                                <!-- Priority -->
                                                <span id="priority-view-mode-container" class="cursor-pointer" onclick="enterPriorityEditMode()" title="Click to change priority">
                                                    <span th:if="${rma.priority != null}" 
                                                          th:class="${'badge rounded-pill fs-6 border border-secondary-subtle ' + 
                                                                (rma.priority.name() == 'LOW' ? 'bg-info' : 
                                                                (rma.priority.name() == 'MEDIUM' ? 'bg-warning text-dark' : 
                                                                (rma.priority.name() == 'HIGH' ? 'bg-danger' : 
                                                                (rma.priority.name() == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light text-dark'))))}"
                                                          th:text="${rma.priority.displayName ?: rma.priority}">
                                                        Priority
                                                    </span>
                                                    <i class="bi bi-chevron-down ms-1 small"></i>
                                                </span>

                                                <span id="priority-edit-mode-container" class="d-none">
                                                    <select id="priority-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                                        <option th:each="priorityOption : ${T(com.pcd.manager.model.RmaPriority).values()}"
                                                                th:value="${priorityOption}"
                                                                th:text="${priorityOption.displayName ?: priorityOption}"
                                                                th:selected="${priorityOption == rma.priority}"></option>
                                                    </select>
                                                    <button type="button" class="btn btn-sm btn-success ms-1" onclick="savePriority()">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="cancelPriorityEdit()">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Middle-Right: Tool information -->
                                        <div class="text-center align-self-start">
                                            <div id="viewToolInfoContainer" th:if="${rma.tool != null}">
                                                <div> <!-- Main tool line -->
                                                    <i class="bi bi-tools me-1"></i>
                                                    <a id="viewToolLink" th:href="@{/tools/{id}(id=${rma.tool?.id})}" class="text-decoration-none">
                                                        <span id="viewToolName" th:text="${rma.tool?.name}" class="text-primary"></span>
                                                        <span id="viewToolSecondaryName" th:if="${rma.tool?.secondaryName != null}" th:text="${' (' + rma.tool.secondaryName + ')'}" class="text-muted small"></span>
                                                        <span id="viewToolTypeBadge" class="ms-1 badge bg-secondary" th:text="${rma.tool?.toolType?.displayName ?: rma.tool?.toolType}">Tool Type</span>
                                                    </a>
                                                </div>
                                                <!-- Additional Tool Details -->
                                                <div id="viewToolDetails" class="small text-muted" style="font-size: 0.8em; margin-top: 0px; line-height: 1.4;">
                                                    <span id="viewToolModelContainer" th:if="${rma.tool?.model1}" class="me-2">
                                                        Model: <strong id="viewToolModel1" th:text="${rma.tool.model1}"></strong>
                                                        <span id="viewToolModel2Separator" th:if="${rma.tool?.model2}"> / </span>
                                                        <strong id="viewToolModel2" th:if="${rma.tool?.model2}" th:text="${rma.tool.model2}"></strong>
                                                    </span>
                                                    <span id="viewToolSerialContainer" th:if="${rma.tool?.serialNumber1}" class="me-2">
                                                        <span id="viewToolSerialPipeSeparator" th:if="${rma.tool?.model1}">| </span>Serial: <strong id="viewToolSerialNumber1" th:text="${rma.tool.serialNumber1}"></strong>
                                                        <span id="viewToolSerial2Separator" th:if="${rma.tool?.serialNumber2}"> / </span>
                                                        <strong id="viewToolSerialNumber2" th:if="${rma.tool?.serialNumber2}" th:text="${rma.tool.serialNumber2}"></strong>
                                                    </span>
                                                    <span id="viewToolServiceContainer" th:if="${rma.tool?.chemicalGasService}">
                                                        <span id="viewToolServicePipeSeparator" th:if="${rma.tool?.model1 != null || rma.tool?.serialNumber1 != null}">| </span>Service: <strong id="viewToolChemicalGasService" th:text="${rma.tool.chemicalGasService}"></strong>
                                                    </span>
                                                </div>
                                            </div>
                                            <div id="viewNoToolSelected" th:unless="${rma.tool != null}" class="mt-1">
                                                <i class="bi bi-tools me-1 text-muted"></i> <span class="text-muted">No Tool selected</span>
                                            </div>
                                        </div>
                                        <!-- Original Right Side: Header Edit Buttons REMOVED from here -->
                                    </div>
                                    
                                    <!-- Location and Technician REMOVED FROM HERE -->
                                    
                                </div> <!-- End header-view-mode -->

                                <!-- Edit Mode for Header -->
                                <div id="header-edit-mode" class="d-none">
                                    <form id="header-edit-form">
                                        <div class="mb-3"> 
                                            <div class="row mb-2"> 
                                                <div class="col-md-3">
                                                    <label class="form-label fw-bold">RMA Number:</label>
                                                    <input type="text" class="form-control form-control-sm" name="rmaNumber" th:value="${rma.rmaNumber}" placeholder="Enter RMA number">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label fw-bold">SAP Number:</label>
                                                    <input type="text" class="form-control form-control-sm" name="sapNotificationNumber" th:value="${rma.sapNotificationNumber}" placeholder="Enter SAP number">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Tool:</label>
                                                    <select class="form-select form-select-sm" name="toolId">
                                                        <option value="">-- Select Tool --</option>
                                                        <option th:each="toolOption : ${allTools}"
                                                                th:value="${toolOption.id}"
                                                                th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '') + ' - ' + toolOption.toolType}"
                                                                th:selected="${rma.tool != null && toolOption.id == rma.tool.id}">
                                                            Tool Name
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row"> 
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Location:</label>
                                                    <select class="form-select form-select-sm" name="locationId">
                                                         <option value="">-- Select Location --</option>
                                                         <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc.displayName}" th:selected="${rma.location != null && loc.id == rma.location.id}"></option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Technician:</label>
                                                    <select class="form-select form-select-sm" name="technician">
                                                        <option value="">-- Unassigned --</option>
                                                        <option th:each="tech : ${technicians}" th:value="${tech.name}" th:text="${tech.name}" th:selected="${rma.technician != null && tech.name == rma.technician}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex align-items-center flex-wrap">
                                            <span class="me-4">
                                                <span th:if="${rma.status != null}" th:class="${'badge rounded-pill fs-6 ' +
                                                (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                                (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                                (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                                (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                                (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                                (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                                (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                                th:text="${rma.status?.displayName}">
                                                Status
                                            </span>
                                            </span>
                                            
                                            <span th:if="${rma.priority != null}" th:class="${'badge rounded-pill fs-6 border border-secondary-subtle ' + 
                                            (rma.priority.name() == 'LOW' ? 'bg-info' : 
                                            (rma.priority.name() == 'MEDIUM' ? 'bg-warning text-dark' : 
                                            (rma.priority.name() == 'HIGH' ? 'bg-danger' : 
                                            (rma.priority.name() == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light text-dark'))))}"
                                            th:text="${rma.priority.displayName ?: rma.priority}">
                                            Priority
                                        </span>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Location and Technician moved to a separate line (always visible part of content block) -->
                                <div class="small text-muted mt-2">
                                    <span>Location: <span id="viewLocationName" th:text="${rma.location != null ? rma.location.displayName : 'N/A'}"></span></span>
                                    <span class="ms-3">Technician: <span id="viewTechnicianName" th:text="${rma.technician != null ? rma.technician : 'Not assigned'}"></span></span>
                                </div>
                            </div> <!-- End Content block -->

                            <!-- Buttons block -->
                            <div class="ms-0"> 
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn me-2" data-section="header" onclick="enterHeaderEditMode()">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none me-2" data-section="header" onclick="saveHeaderChanges()">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none me-2" data-section="header" onclick="cancelHeaderEditMode()">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div> <!-- End Buttons block -->
                        </div> <!-- End Outer flex -->
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Process Impact Section -->
                <div class="row mb-4" id="process-impact-section-container">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Process Impact</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="process-impact">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="process-impact">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="process-impact">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        <!-- View Mode for Process Impact -->
                        <div id="process-impact-view-mode">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Interruption to Flow:</strong> 
                                    <span th:text="${rma.interruptionToFlow ? 'Yes' : 'No'}" th:class="${rma.interruptionToFlow ? 'text-danger fw-bold' : ''}"></span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Interruption to Production:</strong> 
                                    <span th:text="${rma.interruptionToProduction ? 'Yes' : 'No'}" th:class="${rma.interruptionToProduction ? 'text-danger fw-bold' : ''}"></span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Exposed to Gas/Chemicals:</strong> 
                                    <span th:text="${rma.exposedToProcessGasOrChemicals ? 'Yes' : 'No'}" th:class="${rma.exposedToProcessGasOrChemicals ? 'text-danger fw-bold' : ''}"></span>
                                </div>
                            </div>
                            <div th:if="${rma.exposedToProcessGasOrChemicals}" class="row mt-2">
                                <div class="col-md-4">
                                    <strong>Purged:</strong> 
                                    <span th:text="${rma.purged ? 'Yes' : 'No'}" th:class="${rma.purged ? 'text-success fw-bold' : 'text-warning fw-bold'}"></span>
                                </div>
                                <div class="col-md-8">
                                    <strong>Instructions for Exposed Component:</strong>
                                    <p class="mb-0" th:text="${rma.instructionsForExposedComponent ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>
                        <!-- Edit Mode for Process Impact (To be added later) -->
                        <div id="process-impact-edit-mode" class="d-none">
                            <p class="text-muted">(Edit mode for Process Impact will be here)</p>
                        </div>
                    </div>
                </div>

                <!-- 1. Parts Information First -->
                <!-- SECTION RE-ADDED START -->
                <div class="row mb-4" id="parts-section-container">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Parts Information</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="parts">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="parts">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="parts">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- View Mode for Parts -->
                        <div id="parts-view-mode">
                        <table class="table table-sm table-bordered" th:if="${rma.partLineItems != null and not #lists.isEmpty(rma.partLineItems)}">
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>Part #</th>
                                    <th>Description</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-center">Replacement</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${rma.partLineItems}">
                                    <td th:text="${item.partName}">Part Name</td>
                                    <td th:text="${item.partNumber}">Part number</td>
                                    <td th:text="${item.productDescription}">Description</td>
                                    <td class="text-center" th:text="${item.quantity}">Qty</td>
                                    <td class="text-center">
                                        <span th:if="${item.replacementRequired}" class="badge bg-success">Yes</span>
                                        <span th:unless="${item.replacementRequired}" class="badge bg-secondary">No</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <p th:if="${rma.partLineItems == null or #lists.isEmpty(rma.partLineItems)}" class="text-muted">(No parts associated)</p>
                        </div>
                        
                        <!-- Edit Mode for Parts -->
                        <div id="parts-edit-mode" class="d-none">
                            <form id="parts-edit-form">
                                <div id="parts-edit-container">
                                    <!-- Existing parts rendered by Thymeleaf -->
                                    <div class="part-edit-item mb-3" th:each="item, itemStat : ${rma.partLineItems}">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="form-label">Part Name</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].partName'" th:value="${item.partName}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Part #</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].partNumber'" th:value="${item.partNumber}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Description</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].productDescription'" th:value="${item.productDescription}">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">Qty</label>
                                                <input type="number" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].quantity'" th:value="${item.quantity}" min="1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Replacement</label>
                                                <select class="form-select" th:name="'partLineItems[' + ${itemStat.index} + '].replacementRequired'">
                                                    <option value="true" th:selected="${item.replacementRequired}">Yes</option>
                                                    <option value="false" th:selected="${!item.replacementRequired}">No</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-part-btn">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-success add-part-btn mt-2">
                                    <i class="bi bi-plus"></i> Add Part
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- SECTION RE-ADDED END -->
                
                <!-- 2. Moving Parts Below Parts Information -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Associated Moving Parts</h5>
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMovingPartModal" th:if="${rma.tool != null}" title="Add part movement related to the primary tool of this RMA">
                                    <i class="bi bi-plus-circle me-1"></i> Add Moving Part
                                </button>
                            </div>
                            <div class="card-body">
                                <div th:if="${movingParts == null || movingParts.empty}" class="alert alert-info">
                                    No moving parts have been recorded for this RMA.
                                </div>
                                <div th:if="${movingParts != null && !movingParts.empty}" class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Part Name</th>
                                                <th>Movement</th>
                                                <th>Notes</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="movingPart : ${movingParts}">
                                                <td th:text="${movingPart.partName}">Part A</td>
                                                <td>
                                                    <!-- Enhanced movement display with full destination chain -->
                                                    <div>
                                                        <!-- Show from tool -->
                                                        <span>
                                                            <a th:if="${movingPart.fromTool != null}" 
                                                               th:href="@{/tools/{id}(id=${movingPart.fromTool.id})}" 
                                                               th:text="${movingPart.fromTool.name}" 
                                                               class="text-decoration-none">From Tool</a>
                                                            <span th:if="${movingPart.fromTool == null}" class="text-muted">-</span>
                                                        </span>
                                                        
                                                        <!-- Show full destination chain with arrows -->
                                                        <th:block th:if="${movingPartDestinationChains[movingPart.id] != null and !movingPartDestinationChains[movingPart.id].empty}">
                                                            <th:block th:each="destTool, iterStat : ${movingPartDestinationChains[movingPart.id]}">
                                                                <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                                <a th:href="@{/tools/{id}(id=${destTool.id})}" 
                                                                   th:text="${destTool.name}" 
                                                                   class="text-decoration-none">Dest Tool</a>
                                                            </th:block>
                                                        </th:block>
                                                        
                                                        <!-- Fallback for single destination (backward compatibility) -->
                                                        <th:block th:if="${(movingPartDestinationChains[movingPart.id] == null or movingPartDestinationChains[movingPart.id].empty) and movingPart.toTool != null}">
                                                            <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                            <a th:href="@{/tools/{id}(id=${movingPart.toTool.id})}" 
                                                               th:text="${movingPart.toTool.name}" 
                                                               class="text-decoration-none">To Tool</a>
                                                        </th:block>
                                                        
                                                        <!-- If no destinations at all -->
                                                        <th:block th:if="${(movingPartDestinationChains[movingPart.id] == null or movingPartDestinationChains[movingPart.id].empty) and movingPart.toTool == null}">
                                                            <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                            <span class="text-muted">-</span>
                                                        </th:block>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span th:if="${movingPart.notes != null}" th:text="${movingPart.notes}">Notes</span>
                                                    <span th:if="${movingPart.notes == null}" class="text-muted">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(movingPart.moveDate, 'MM/dd/yy')}">01/01/23</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary moving-part-edit-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}"
                                                                th:data-from-tool-id="${movingPart.fromTool != null ? movingPart.fromTool.id : ''}"
                                                                th:data-to-tool-id="${movingPart.toTool != null ? movingPart.toTool.id : ''}"
                                                                th:data-destination-chain="${movingPart.destinationChain != null ? movingPart.destinationChain : ''}"
                                                                th:data-notes="${movingPart.notes != null ? movingPart.notes : ''}"
                                                                th:data-move-date="${#temporals.format(movingPart.moveDate, 'yyyy-MM-dd')}">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger moving-part-delete-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Problem Details Section -->
                <div class="row mb-4" id="problem-details-section-container">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Problem Details</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="problem-details">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="problem-details">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="problem-details">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        <!-- View Mode for Problem Details -->
                        <div id="problem-details-view-mode">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Who discovered the problem:</strong>
                                    <p th:text="${rma.problemDiscoverer ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                                <div class="col-md-6">
                                    <strong>When was it discovered:</strong>
                                    <p th:text="${rma.problemDiscoveryDate != null ? #temporals.format(rma.problemDiscoveryDate, 'MM/dd/yyyy') : 'N/A'}"></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <strong>What happened:</strong>
                                    <p th:text="${rma.whatHappened ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <strong>Why and how it happened:</strong>
                                    <p th:text="${rma.whyAndHowItHappened ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>How was it contained:</strong>
                                    <p th:text="${rma.howContained ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Who contained it:</strong>
                                    <p th:text="${rma.whoContained ?: 'N/A'}" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>
                        <!-- Edit Mode for Problem Details -->
                        <div id="problem-details-edit-mode" class="d-none">
                            <form id="problem-details-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Who discovered the problem:</label>
                                        <textarea class="form-control" name="problemDiscoverer" rows="3" th:text="${rma.problemDiscoverer}"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">When was it discovered:</label>
                                        <input type="date" class="form-control" name="problemDiscoveryDate" 
                                               th:value="${rma.problemDiscoveryDate != null ? #temporals.format(rma.problemDiscoveryDate, 'yyyy-MM-dd') : ''}">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">What happened:</label>
                                        <textarea class="form-control" name="whatHappened" rows="4" th:text="${rma.whatHappened}"></textarea>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Why and how it happened:</label>
                                        <textarea class="form-control" name="whyAndHowItHappened" rows="4" th:text="${rma.whyAndHowItHappened}"></textarea>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">How was it contained:</label>
                                        <textarea class="form-control" name="howContained" rows="3" th:text="${rma.howContained}"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Who contained it:</label>
                                        <textarea class="form-control" name="whoContained" rows="3" th:text="${rma.whoContained}"></textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Section -->
                <div class="row mb-4" id="customer-section-container">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Customer Information</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="customer">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="customer">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="customer">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        <!-- View Mode for Customer Information -->
                        <div id="customer-view-mode">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Customer Name:</strong>
                                    <p th:text="${rma.customerName ?: 'N/A'}"></p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Customer Contact:</strong>
                                    <p th:text="${rma.customerContact ?: 'N/A'}"></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Customer Phone:</strong>
                                    <p th:text="${rma.customerPhone ?: 'N/A'}"></p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Customer Email:</strong>
                                    <p th:text="${rma.customerEmail ?: 'N/A'}"></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <strong>Shipping Information:</strong>
                                    <div class="ps-3">
                                        <p><strong>Company:</strong> <span th:text="${rma.shippingCompany ?: 'N/A'}"></span></p>
                                        <p><strong>Address:</strong> <span th:text="${rma.shippingAddress ?: 'N/A'}"></span></p>
                                        <p><strong>City:</strong> <span th:text="${rma.shippingCity ?: 'N/A'}"></span></p>
                                        <p><strong>State:</strong> <span th:text="${rma.shippingState ?: 'N/A'}"></span></p>
                                        <p><strong>ZIP:</strong> <span th:text="${rma.shippingZip ?: 'N/A'}"></span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Sales Order:</strong>
                                    <p th:text="${rma.salesOrder ?: 'N/A'}"></p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Other Reference:</strong>
                                    <p th:text="${rma.otherReference ?: 'N/A'}"></p>
                                </div>
                            </div>
                        </div>
                        <!-- Edit Mode for Customer Information -->
                        <div id="customer-edit-mode" class="d-none">
                            <form id="customer-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Name:</label>
                                        <input type="text" class="form-control" name="customerName" th:value="${rma.customerName}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Contact:</label>
                                        <input type="text" class="form-control" name="customerContact" th:value="${rma.customerContact}">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Phone:</label>
                                        <input type="text" class="form-control" name="customerPhone" th:value="${rma.customerPhone}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Email:</label>
                                        <input type="email" class="form-control" name="customerEmail" th:value="${rma.customerEmail}">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Shipping Information:</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Company:</label>
                                                <input type="text" class="form-control" name="shippingCompany" th:value="${rma.shippingCompany}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Address:</label>
                                                <input type="text" class="form-control" name="shippingAddress" th:value="${rma.shippingAddress}">
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-4">
                                                <label class="form-label">City:</label>
                                                <input type="text" class="form-control" name="shippingCity" th:value="${rma.shippingCity}">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">State:</label>
                                                <input type="text" class="form-control" name="shippingState" th:value="${rma.shippingState}">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">ZIP:</label>
                                                <input type="text" class="form-control" name="shippingZip" th:value="${rma.shippingZip}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Sales Order:</label>
                                        <input type="text" class="form-control" name="salesOrder" th:value="${rma.salesOrder}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Other Reference:</label>
                                        <input type="text" class="form-control" name="otherReference" th:value="${rma.otherReference}">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Date table moved below Moving Parts with 7 columns -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Dates</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="dates">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="dates">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="dates">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- View Mode for Dates -->
                        <div id="dates-view-mode">
                            <table class="table table-bordered table-sm date-table">
                                <thead>
                                    <tr>
                                        <th>Written</th>
                                <th>RMA # Provided</th>
                                        <th>Shipping Memo</th>
                                <th>Parts Received</th>
                                <th>Parts Installed</th>
                                <th>Failed Packed</th>
                                        <th>Failed Shipped</th>
                            </tr>
                                </thead>
                                <tbody>
                            <tr>
                                        <td th:text="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                            </tr>
                                </tbody>
                        </table>
                    </div>
                        
                        <!-- Edit Mode for Dates -->
                        <div id="dates-edit-mode" class="d-none">
                            <form id="dates-edit-form">
                                <table class="table table-bordered table-sm date-table">
                                    <thead>
                            <tr>
                                            <th>Written</th>
                                            <th>RMA # Provided</th>
                                            <th>Shipping Memo</th>
                                            <th>Parts Received</th>
                                            <th>Parts Installed</th>
                                            <th>Failed Packed</th>
                                            <th>Failed Shipped</th>
                            </tr>
                                    </thead>
                                    <tbody>
                            <tr>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="writtenDate" 
                                                       th:value="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="rmaNumberProvidedDate" 
                                                       th:value="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="shippingMemoEmailedDate" 
                                                       th:value="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="partsReceivedDate" 
                                                       th:value="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="installedPartsDate" 
                                                       th:value="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="failedPartsPackedDate" 
                                                       th:value="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="failedPartsShippedDate" 
                                                       th:value="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'yyyy-MM-dd') : ''}">
                                </td>
                            </tr>
                                    </tbody>
                        </table>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Pictures Display Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Pictures</h5>
                                <form id="uploadPictureForm" th:action="@{/api/files/upload/{rmaId}(rmaId=${rma.id})}" method="post" enctype="multipart/form-data" class="mb-0">
                                    <input type="file" id="pictureFile" name="files" accept="image/*" style="display: none;" multiple>
                                    <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('pictureFile').click()">
                                        <i class="bi bi-upload me-1"></i> Upload Pictures
                                    </button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div th:if="${rma.pictures == null || rma.pictures.empty}" class="alert alert-info">
                                    No pictures have been uploaded for this RMA.
                                </div>
                                <div th:if="${rma.pictures != null && !rma.pictures.empty}" class="row g-3">
                                    <div th:each="picture : ${rma.pictures}" class="col-md-3 mb-3">
                                        <div class="card h-100">
                                            <img th:with="processedPath=${#strings.replace(picture.filePath, '\\\\', '/')}"
                                                 th:src="@{'/rma/files/' + ${processedPath}}"
                                                 class="card-img-top" 
                                                 alt="RMA Picture"
                                                 style="cursor: pointer; max-height: 200px; object-fit: cover;"
                                                 th:onclick="|showPictureModal(${picture.id})|">
                                            <div class="card-body">
                                                <p class="card-text small text-truncate" th:text="${picture.fileName}">filename.jpg</p>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:with="processedPath=${#strings.replace(picture.filePath, '\\\\', '/')}"
                                                       th:href="@{'/rma/files/' + ${processedPath}}"
                                                       class="btn btn-outline-primary" 
                                                       target="_blank" 
                                                       title="View">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger" 
                                                            th:data-picture-id="${picture.id}"
                                                            onclick="deletePictureFromData(this)" 
                                                            title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Display Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Documents</h5>
                                <form id="uploadDocumentForm" th:action="@{/api/files/upload/{rmaId}(rmaId=${rma.id})}" method="post" enctype="multipart/form-data" class="mb-0">
                                    <input type="file" id="documentFile" name="files" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" multiple>
                                    <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('documentFile').click()">
                                        <i class="bi bi-upload me-1"></i> Upload Documents
                                    </button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div th:if="${rma.documents == null || rma.documents.empty}" class="alert alert-info mb-0">
                                    No documents have been uploaded for this RMA.
                                </div>
                                <ul th:if="${rma.documents != null && !rma.documents.empty}" class="list-group list-group-flush">
                                    <li th:each="document : ${rma.documents}" class="list-group-item d-flex justify-content-between align-items-center">
                                        <th:block th:with="processedPath=${#strings.replace(document.filePath, '\\\\', '/')}, isExcel=${#strings.endsWith(document.fileName, '.xlsx') || #strings.endsWith(document.fileName, '.xls')}">
                                            <a th:if="${isExcel}" href="#" th:data-file-url="@{'/rma/files/' + ${processedPath}}" th:text="${document.fileName}" th:title="${'Preview ' + document.fileName}" style="word-break: break-all;" onclick="previewExcelDocument(event)">Document Name</a>
                                            <a th:unless="${isExcel}" th:href="@{'/rma/files/' + ${processedPath}}" th:text="${document.fileName}" target="_blank" th:title="${'View ' + document.fileName}" style="word-break: break-all;">Document Name</a>
                                            <div class="btn-group btn-group-sm ms-2 flex-shrink-0">
                                                <a th:href="@{'/rma/files/' + ${processedPath}}" class="btn btn-outline-secondary" target="_blank" th:download="${document.fileName}" title="Download">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-info unifiedLinkFileModalTriggerRmaPage"
                                                        th:data-file-id="${document.id}"
                                                        th:data-file-path="${document.filePath}"
                                                        th:data-file-type="'DOCUMENT'"
                                                        th:data-source-entity-type="'RMA'"
                                                        th:data-source-entity-id="${rma.id}"
                                                        th:data-original-file-name="${document.fileName}"
                                                        title="Link to another entity">
                                                    <i class="bi bi-link-45deg"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger"
                                                        th:data-document-id="${document.id}"
                                                        onclick="deleteDocumentFromData(this)"
                                                        title="Delete from this RMA">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </th:block>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Notes</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="notes">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="notes">
                                            <i class="bi bi-check-lg"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="notes">
                                            <i class="bi bi-x-lg"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="notes-view-mode">
                                    <p th:text="${rma.notes != null ? rma.notes : 'No notes available'}" class="mb-0">Notes</p>
                                </div>
                                <div id="notes-edit-mode" class="d-none">
                                    <form id="notes-edit-form">
                                        <textarea class="form-control" name="notes" rows="5" th:text="${rma.notes}" placeholder="Enter notes..."></textarea>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Comments</h5>
                            </div>
                            <div class="card-body">
                                <div class="comments-list mb-4">
                                    <div th:if="${#lists.isEmpty(comments)}" class="text-muted text-center py-3">
                                        No comments yet. Be the first to comment!
                                    </div>
                                    <div th:each="comment : ${comments}" class="comment">
                                        <div class="comment-header">
                                            <span class="comment-user" th:text="${comment.user != null ? comment.user.name : 'Unknown User'}">User Name</span>
                                            <span class="comment-date" th:text="${#temporals.format(comment.createdDate, 'MM/dd/yy HH:mm')}">Date</span>
                                        </div>
                                        <div class="comment-content" th:text="${comment.content}">
                                            Comment content goes here.
                                        </div>
                                    </div>
                                </div>

                                <hr th:if="${not #lists.isEmpty(comments)}"/>

                                <div>
                                    <form action="#" th:action="@{/rma/{id}/post-comment(id=${rma.id})}" method="post">
                                        <div class="form-group">
                                            <label for="commentContent" class="form-label">Add a comment:</label>
                                            <textarea class="form-control" id="commentContent" name="content" rows="3" required placeholder="Enter your comment here..."></textarea>
                                        </div>
                                        <div class="mt-2 text-end">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus-circle me-1"></i> Post Comment
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden RMA ID for JS -->
    <input type="hidden" id="rmaPageEntityIdForJs" th:value="${rma.id}">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/theme-toggle.js}"></script>
    
    <!-- Simple theme toggle for testing -->
    <script>
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            if (newTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
            
            localStorage.setItem('theme', newTheme);
        }
        
        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            
            const icon = document.getElementById('theme-icon');
            if (savedTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
        });
    </script>
    <script th:inline="javascript">
        const rmaPageId = document.getElementById('rmaPageEntityIdForJs').value;
        
        // START: Generic Edit/Save/Cancel Logic (Modified for Header)
        function enterHeaderEditMode() {
            document.getElementById('header-view-mode').classList.add('d-none');
            document.getElementById('header-edit-mode').classList.remove('d-none');
            
            // Show save/cancel, hide edit for header section
            document.querySelector('.edit-section-btn[data-section="header"]').classList.add('d-none');
            document.querySelector('.save-section-btn[data-section="header"]').classList.remove('d-none');
            document.querySelector('.cancel-section-btn[data-section="header"]').classList.remove('d-none');

            // Populate form fields from view mode (if needed, but th:value should handle initial load)
            // For example, if you needed to fetch fresh data or ensure consistency:
            document.querySelector('#header-edit-form [name="rmaNumber"]').value = document.getElementById('viewRmaNumber')?.textContent || '';
            document.querySelector('#header-edit-form [name="sapNotificationNumber"]').value = document.getElementById('viewSapNumber')?.textContent || '';
            // Tool, Location, Technician are selects, th:selected handles them.
            // You might need to find the selected tool's ID and set it if not already done by th:selected
             const currentToolId = /*[[${rma.tool?.id}]]*/ null;
             if (currentToolId) {
                 document.querySelector('#header-edit-form [name="toolId"]').value = currentToolId;
             }
             const currentLocationId = /*[[${rma.location?.id}]]*/ null;
             if (currentLocationId) {
                 document.querySelector('#header-edit-form [name="locationId"]').value = currentLocationId;
             }
             const currentTechnician = /*[[${rma.technician}]]*/ null;
             if (currentTechnician) {
                 document.querySelector('#header-edit-form [name="technician"]').value = currentTechnician;
             }
        }

        function cancelHeaderEditMode() {
            document.getElementById('header-edit-mode').classList.add('d-none');
            document.getElementById('header-view-mode').classList.remove('d-none');

            // Show edit, hide save/cancel for header section
            document.querySelector('.edit-section-btn[data-section="header"]').classList.remove('d-none');
            document.querySelector('.save-section-btn[data-section="header"]').classList.add('d-none');
            document.querySelector('.cancel-section-btn[data-section="header"]').classList.add('d-none');
        }

        function saveHeaderChanges() {
            const form = document.getElementById('header-edit-form');
            const formData = new FormData(form);
            
            // For select elements, FormData might not pick up the selected value directly if not submitted traditionally.
            // It's safer to explicitly get values.
            const rmaNumber = form.elements['rmaNumber'].value;
            const sapNotificationNumber = form.elements['sapNotificationNumber'].value;
            const toolId = form.elements['toolId'].value;
            const locationId = form.elements['locationId'].value;
            const technician = form.elements['technician'].value;

            const payload = new URLSearchParams();
            payload.append('rmaNumber', rmaNumber);
            payload.append('sapNotificationNumber', sapNotificationNumber);
            payload.append('toolId', toolId);
            payload.append('locationId', locationId);
            payload.append('technician', technician);

            fetch(`/rma/${rmaPageId}/update-header`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload.toString()
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update header') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update view mode elements with new data
                    const viewRmaNumber = document.getElementById('viewRmaNumber');
                    const viewSapNumber = document.getElementById('viewSapNumber');
                    const viewRmaSapSeparator = document.getElementById('viewRmaSapSeparator');
                    const viewRmaSapNa = document.getElementById('viewRmaSapNa');

                    if (data.rmaNumber) {
                        viewRmaNumber.textContent = data.rmaNumber;
                        viewRmaNumber.style.display = '';
                    } else {
                        viewRmaNumber.style.display = 'none';
                    }
                    if (data.sapNotificationNumber) {
                        viewSapNumber.textContent = data.sapNotificationNumber;
                        viewSapNumber.style.display = '';
                    } else {
                        viewSapNumber.style.display = 'none';
                    }

                    if (data.rmaNumber && data.sapNotificationNumber) {
                        viewRmaSapSeparator.style.display = '';
                    } else {
                        viewRmaSapSeparator.style.display = 'none';
                    }
                    
                    if (!data.rmaNumber && !data.sapNotificationNumber) {
                        viewRmaSapNa.style.display = '';
                    } else {
                        viewRmaSapNa.style.display = 'none';
                    }

                    // Update Tool Information
                    const toolInfoContainer = document.getElementById('viewToolInfoContainer');
                    const noToolSelected = document.getElementById('viewNoToolSelected');

                    if (data.toolId) {
                        toolInfoContainer.style.display = '';
                        noToolSelected.style.display = 'none';

                        document.getElementById('viewToolLink').href = `/tools/${data.toolId}`;
                        document.getElementById('viewToolName').textContent = data.toolName || '';
                        
                        const viewToolSecondaryName = document.getElementById('viewToolSecondaryName');
                        if (data.toolSecondaryName) {
                            viewToolSecondaryName.textContent = ` (${data.toolSecondaryName})`;
                            viewToolSecondaryName.style.display = '';
                        } else {
                            viewToolSecondaryName.style.display = 'none';
                        }
                        document.getElementById('viewToolTypeBadge').textContent = data.toolTypeDisplay || 'N/A';

                        // Additional Details
                        const viewToolDetails = document.getElementById('viewToolDetails');
                        const modelContainer = document.getElementById('viewToolModelContainer');
                        const serialContainer = document.getElementById('viewToolSerialContainer');
                        const serviceContainer = document.getElementById('viewToolServiceContainer');

                        if (data.toolModel1) {
                            modelContainer.style.display = '';
                            document.getElementById('viewToolModel1').textContent = data.toolModel1;
                            document.getElementById('viewToolModel2Separator').style.display = data.toolModel2 ? '' : 'none';
                            document.getElementById('viewToolModel2').textContent = data.toolModel2 || '';
                             document.getElementById('viewToolModel2').style.display = data.toolModel2 ? '' : 'none';
                        } else {
                            modelContainer.style.display = 'none';
                        }

                        if (data.toolSerialNumber1) {
                            serialContainer.style.display = '';
                            document.getElementById('viewToolSerialPipeSeparator').style.display = data.toolModel1 ? '' : 'none';
                            document.getElementById('viewToolSerialNumber1').textContent = data.toolSerialNumber1;
                            document.getElementById('viewToolSerial2Separator').style.display = data.toolSerialNumber2 ? '' : 'none';
                            document.getElementById('viewToolSerialNumber2').textContent = data.toolSerialNumber2 || '';
                            document.getElementById('viewToolSerialNumber2').style.display = data.toolSerialNumber2 ? '' : 'none';
                        } else {
                            serialContainer.style.display = 'none';
                        }
                        
                        if (data.toolChemicalGasService) {
                            serviceContainer.style.display = '';
                            document.getElementById('viewToolServicePipeSeparator').style.display = (data.toolModel1 || data.toolSerialNumber1) ? '' : 'none';
                            document.getElementById('viewToolChemicalGasService').textContent = data.toolChemicalGasService;
                        } else {
                            serviceContainer.style.display = 'none';
                        }
                        
                         if (!data.toolModel1 && !data.toolSerialNumber1 && !data.toolChemicalGasService) {
                            viewToolDetails.style.display = 'none';
                        } else {
                            viewToolDetails.style.display = '';
                        }

                    } else {
                        toolInfoContainer.style.display = 'none';
                        noToolSelected.style.display = '';
                    }

                    document.getElementById('viewLocationName').textContent = data.locationName || 'N/A';
                    document.getElementById('viewTechnicianName').textContent = data.technicianName || 'Not assigned';

                    cancelHeaderEditMode(); // Switch back to view mode
                } else {
                    alert('Error updating header: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving header changes:', error);
                alert('Failed to save header changes: ' + error.message);
            });
        }
        // END: Generic Edit/Save/Cancel Logic

        function deleteDocumentFromData(element) {
            const documentId = element.getAttribute('data-document-id');
            if (confirm('Are you sure you want to delete this document?')) {
                fetch(`/rma/${rmaPageId}/documents/${documentId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete document');
                                }
                            })
                            .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete document');
                });
            }
        }

        function showPictureModal(pictureId) {
            try {
                const modalImg = document.getElementById('modalPictureImg');
                const imgElement = document.querySelector(`img[onclick*="${pictureId}"]`);
                if (imgElement) {
                    modalImg.src = imgElement.src;
                    const modal = new bootstrap.Modal(document.getElementById('pictureModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error showing picture modal:', error);
            }
        }

        function deletePictureFromData(element) {
            const pictureId = element.getAttribute('data-picture-id');
            if (confirm('Are you sure you want to delete this picture?')) {
                fetch(`/rma/${rmaPageId}/pictures/${pictureId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete picture');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete picture');
                });
            }
        }

        // Handle document upload form submission
        document.getElementById('uploadDocumentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
                
                // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
            .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    window.location.reload(); // Reload the page to show the new document
                    } else {
                    alert('Failed to upload document: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload document: ' + error.message);
            })
            .finally(() => {
                    // Restore button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle picture upload form submission
        document.getElementById('uploadPictureForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
            
            // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload(); // Reload the page to show the new pictures
                } else {
                    alert('Failed to upload pictures: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload pictures');
            })
            .finally(() => {
                // Reset button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle file input change
        document.getElementById('pictureFile').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('uploadPictureForm').submit();
            }
        });

        document.querySelectorAll('.moving-part-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const partName = this.getAttribute('data-part-name');
                const fromToolId = this.getAttribute('data-from-tool-id');
                const toToolId = this.getAttribute('data-to-tool-id');
                const destinationChain = this.getAttribute('data-destination-chain') || '';
                const notes = this.getAttribute('data-notes') || '';
                
                // Fill form fields with existing data
                document.getElementById('editMovingPartId').value = id;
                document.getElementById('editPartName').value = partName;
                document.getElementById('editFromToolId').value = fromToolId;
                document.getElementById('editNotes').value = notes;
            });
        });

        // Placeholder for Link Document Modal - Will be replaced by more specific logic below
        /* function openLinkDocumentModal(element) { ... } */

        // START: JavaScript for Unified Link File Modal on RMA View Page
        document.addEventListener('DOMContentLoaded', () => {
            const modalElement = document.getElementById('unifiedLinkFileModal');
            const modal = modalElement ? new bootstrap.Modal(modalElement) : null;
            if (!modal) {
                console.error('Unified Link File Modal not found on RMA page');
                return;
            }

            const form = document.getElementById('unifiedLinkFormRmaPage');
            const fileNameDisplay = document.getElementById('unifiedLinkFileNameDisplayRmaPage');
            const fileIdInput = document.getElementById('unifiedLinkFileIdInputRmaPage');
            const filePathInput = document.getElementById('unifiedLinkFilePathInputRmaPage');
            const fileTypeInput = document.getElementById('unifiedLinkFileTypeInputRmaPage');
            const sourceEntityTypeInput = document.getElementById('unifiedLinkSourceEntityTypeInputRmaPage');
            const sourceEntityIdInput = document.getElementById('unifiedLinkSourceEntityIdInputRmaPage');
            const originalFileNameInput = document.getElementById('unifiedLinkOriginalFileNameInputRmaPage');

            const targetEntityTypeSelect = document.getElementById('unifiedLinkTargetEntityTypeRmaPage');
            const targetRmaSection = document.getElementById('unifiedLinkTargetRmaSectionRmaPage');
            const targetToolSection = document.getElementById('unifiedLinkTargetToolSectionRmaPage');
            const targetTrackTrendSection = document.getElementById('unifiedLinkTargetTrackTrendSectionRmaPage');

            document.querySelectorAll('.unifiedLinkFileModalTriggerRmaPage').forEach(button => {
                button.addEventListener('click', function() {
                    fileNameDisplay.textContent = this.dataset.originalFileName || 'Selected File';
                    fileIdInput.value = this.dataset.fileId || '';
                    filePathInput.value = this.dataset.filePath || '';
                    fileTypeInput.value = this.dataset.fileType || '';
                    sourceEntityTypeInput.value = this.dataset.sourceEntityType || '';
                    sourceEntityIdInput.value = this.dataset.sourceEntityId || '';
                    originalFileNameInput.value = this.dataset.originalFileName || '';

                    // Reset and hide all target sections
                    targetEntityTypeSelect.value = '';
                    targetRmaSection.style.display = 'none';
                    targetToolSection.style.display = 'none';
                    targetTrackTrendSection.style.display = 'none';
                    document.getElementById('unifiedLinkTargetRmaIdRmaPage').value = '';
                    document.getElementById('unifiedLinkTargetToolIdRmaPage').value = '';
                    document.getElementById('unifiedLinkTargetTrackTrendIdRmaPage').value = '';

                    modal.show();
                });
            });

            targetEntityTypeSelect.addEventListener('change', function() {
                targetRmaSection.style.display = this.value === 'RMA' ? 'block' : 'none';
                targetToolSection.style.display = this.value === 'TOOL' ? 'block' : 'none';
                targetTrackTrendSection.style.display = this.value === 'TRACK_TREND' ? 'block' : 'none';
            });

            // Optional: Handle form submission if not already handled by standard form submit
            // If using AJAX for form submission, add that logic here.
            // For now, assuming standard form submission is okay.
        });
        // END: JavaScript for Unified Link File Modal on RMA View Page

        // START: JavaScript for Excel Preview
        async function previewExcelDocument(event) {
            event.preventDefault();
            const fileUrl = event.target.dataset.fileUrl;
            const modalElement = document.getElementById('excelPreviewModal');
            const modal = new bootstrap.Modal(modalElement);
            const contentDiv = document.getElementById('excelPreviewContent');
            const modalTitle = document.getElementById('excelPreviewModalLabel');

            contentDiv.innerHTML = '<p class="text-center">Loading preview...</p>';
            modalTitle.textContent = 'Excel Preview: ' + event.target.textContent;
            modal.show();

            try {
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const htmlTable = XLSX.utils.sheet_to_html(worksheet);
                
                contentDiv.innerHTML = htmlTable;
                // Add some basic styling to the generated table
                const tableElement = contentDiv.querySelector('table');
                if (tableElement) {
                    tableElement.classList.add('table', 'table-bordered', 'table-sm');
                }
            } catch (error) {
                console.error('Error previewing Excel file:', error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Could not load preview. Is the file a valid Excel document?</p>';
            }
        }
        // END: JavaScript for Excel Preview

        // START: JavaScript for Editable Status
        function enterStatusEditMode() {
            document.getElementById('status-view-mode').classList.add('d-none');
            document.getElementById('status-edit-mode').classList.remove('d-none');
            // Potentially pre-select current status if needed, though th:selected should handle initial load
        }

        function cancelStatusEdit() {
            document.getElementById('status-edit-mode').classList.add('d-none');
            document.getElementById('status-view-mode').classList.remove('d-none');
        }

        function saveStatus() {
            const newStatus = document.getElementById('status-select').value;
            const rmaId = rmaPageId; // Assuming rmaPageId is globally available from hidden input

            fetch(`/rma/${rmaId}/update-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `newStatus=${encodeURIComponent(newStatus)}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update status') });
                }
                return response.json(); 
            })
            .then(data => {
                if (data.success) {
                    // Update the displayed status and badge class
                    const statusViewMode = document.getElementById('status-view-mode');
                    const statusSpan = statusViewMode.querySelector('span'); // The inner span that holds the text
                    statusSpan.textContent = data.newStatusDisplay;
                    
                    // Update badge class based on data.newStatus (enum name)
                    let badgeClass = 'bg-light text-dark'; // Default
                    if (data.newStatus === 'RMA_WRITTEN_EMAILED') badgeClass = 'bg-primary';
                    else if (data.newStatus === 'NUMBER_PROVIDED') badgeClass = 'bg-info';
                    else if (data.newStatus === 'MEMO_EMAILED') badgeClass = 'bg-secondary';
                    else if (data.newStatus === 'RECEIVED_PARTS') badgeClass = 'bg-warning text-dark';
                    else if (data.newStatus === 'WAITING_CUSTOMER') badgeClass = 'bg-danger';
                    else if (data.newStatus === 'WAITING_FSE') badgeClass = 'bg-danger';
                    else if (data.newStatus === 'COMPLETED') badgeClass = 'bg-success';
                    
                    statusViewMode.className = `badge rounded-pill fs-6 cursor-pointer ${badgeClass}`;
                    cancelStatusEdit(); // Switch back to view mode
                    // Consider a more subtle success indication if needed
                } else {
                    alert('Error updating status: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving status:', error);
                alert('Failed to save status: ' + error.message);
            });
        }
        // END: JavaScript for Editable Status

        // START: JavaScript for Editable Priority
        function enterPriorityEditMode() {
            document.getElementById('priority-view-mode-container').classList.add('d-none');
            document.getElementById('priority-edit-mode-container').classList.remove('d-none');
        }

        function cancelPriorityEdit() {
            document.getElementById('priority-edit-mode-container').classList.add('d-none');
            document.getElementById('priority-view-mode-container').classList.remove('d-none');
        }

        function savePriority() {
            const newPriority = document.getElementById('priority-select').value;
            const rmaId = rmaPageId; // Assuming rmaPageId is globally available

            fetch(`/rma/${rmaId}/update-priority`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `newPriority=${encodeURIComponent(newPriority)}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Failed to update priority') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const priorityViewContainer = document.getElementById('priority-view-mode-container');
                    const priorityBadge = priorityViewContainer.querySelector('span'); // The badge span
                    priorityBadge.textContent = data.newPriorityDisplay;

                    let badgeClass = 'bg-light text-dark'; // Default
                    if (data.newPriority === 'LOW') badgeClass = 'bg-info';
                    else if (data.newPriority === 'MEDIUM') badgeClass = 'bg-warning text-dark';
                    else if (data.newPriority === 'HIGH') badgeClass = 'bg-danger';
                    else if (data.newPriority === 'URGENT') badgeClass = 'bg-danger text-uppercase';
                    
                    priorityBadge.className = `badge rounded-pill fs-6 border border-secondary-subtle ${badgeClass}`;
                    cancelPriorityEdit();
                } else {
                    alert('Error updating priority: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving priority:', error);
                alert('Failed to save priority: ' + error.message);
            });
        }
        // END: JavaScript for Editable Priority

    </script>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you like to handle this file?</p>
                    <input type="hidden" id="fileIdToDelete">
                    <input type="hidden" id="fileTypeToDelete">
                    <input type="hidden" id="rmaIdForDelete">
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOnly" value="unlink" checked>
                        <label class="form-check-label" for="deleteOnly">
                            <strong>Unlink only:</strong> Remove only from this RMA, keep in other locations
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteEverywhere" value="delete">
                        <label class="form-check-label" for="deleteEverywhere">
                            <strong>Delete everywhere:</strong> Remove from all locations
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transfer File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the RMA to transfer this file to:</p>
                    <form id="transferForm" action="/rma/file/transfer" method="post">
                        <input type="hidden" id="transferFileId" name="fileId">
                        <input type="hidden" id="transferFileType" name="fileType">
                        <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="targetRmaId" class="form-label">Target RMA</label>
                            <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                                <option value="">-- Select Target RMA --</option>
                                <!-- This will need to be populated from controller with available RMAs -->
                                <option th:each="otherRma : ${allRmas}" 
                                        th:if="${otherRma.id != rma.id}" 
                                        th:value="${otherRma.id}" 
                                        th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA-' + otherRma.id) + 
                                                (otherRma.customerName != null ? ' - ' + otherRma.customerName : '')}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Link File Modal (Copied from tools/details.html, ensure allRmas, allTools, allTrackTrends are available) -->
    <div class="modal fade" id="unifiedLinkFileModal" tabindex="-1" aria-labelledby="unifiedLinkFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="unifiedLinkFormRmaPage" th:action="@{/files/link-entity}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unifiedLinkFileModalLabelRmaPage">Link File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Link <strong id="unifiedLinkFileNameDisplayRmaPage">file_name_here</strong> to:</p>
                        
                        <input type="hidden" id="unifiedLinkFileIdInputRmaPage" name="fileId">
                        <input type="hidden" id="unifiedLinkFilePathInputRmaPage" name="filePath">
                        <input type="hidden" id="unifiedLinkFileTypeInputRmaPage" name="fileType">
                        <input type="hidden" id="unifiedLinkSourceEntityTypeInputRmaPage" name="sourceEntityType">
                        <input type="hidden" id="unifiedLinkSourceEntityIdInputRmaPage" name="sourceEntityId">
                        <input type="hidden" id="unifiedLinkOriginalFileNameInputRmaPage" name="originalFileName">

                        <div class="mb-3">
                            <label for="unifiedLinkTargetEntityTypeRmaPage" class="form-label">Link to Entity Type:</label>
                            <select id="unifiedLinkTargetEntityTypeRmaPage" name="targetEntityType" class="form-select" required>
                                <option value="">-- Select Entity Type --</option>
                                <option value="RMA">RMA</option>
                                <option value="TOOL">Tool</option>
                                <option value="TRACK_TREND">Track/Trend</option>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetRmaSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetRmaIdRmaPage" class="form-label">Select RMA:</label>
                            <select id="unifiedLinkTargetRmaIdRmaPage" name="targetRmaId" class="form-select">
                                <option value="">-- Select RMA --</option>
                                <th:block th:if="${allRmas != null}">
                                    <option th:each="rmaOption : ${allRmas}"
                                            th:if="${rmaOption.id != rma.id}" 
                                            th:value="${rmaOption.id}" 
                                            th:text="${(rmaOption.rmaNumber ?: ('RMA-' + rmaOption.id)) + (rmaOption.customerName != null ? ' - ' + rmaOption.customerName : '')}">
                                    </option>
                                </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetToolSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetToolIdRmaPage" class="form-label">Select Tool:</label>
                            <select id="unifiedLinkTargetToolIdRmaPage" name="targetToolId" class="form-select">
                                <option value="">-- Select Tool --</option>
                                <th:block th:if="${allTools != null}">
                                   <option th:each="toolOption : ${allTools}" 
                                           th:value="${toolOption.id}" 
                                           th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '')}">
                                   </option>
                               </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetTrackTrendSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetTrackTrendIdRmaPage" class="form-label">Select Track/Trend:</label>
                            <select id="unifiedLinkTargetTrackTrendIdRmaPage" name="targetTrackTrendId" class="form-select">
                                <option value="">-- Select Track/Trend --</option>
                                 <th:block th:if="${allTrackTrends != null}"> <!-- Ensure allTrackTrends is passed to rma/view model -->
                                    <option th:each="tt : ${allTrackTrends}"
                                            th:value="${tt.id}"
                                            th:text="${tt.name + ' (' + #temporals.format(tt.startDate, 'yyyy-MM-dd') + ')'}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmUnifiedLinkBtnRmaPage">Link File</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Unified Link File Modal -->

    <!-- Delete RMA Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this RMA?</p>
                    <p class="text-danger fw-bold">This action cannot be undone!</p>
                    <p th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}">
                        <strong>RMA Number:</strong> <span th:text="${rma.rmaNumber}"></span>
                    </p>
                    <p th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                        <strong>SAP Number:</strong> <span th:text="${rma.sapNotificationNumber}"></span>
                    </p>
                    <p th:if="${rma.tool != null}">
                        <strong>Tool:</strong> <span th:text="${rma.tool?.name}"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/rma/{id}/delete(id=${rma.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Moving Part Modal -->
    <div class="modal fade" id="addMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/rma/{id}/moving-parts/add(id=${rma.id})}" method="post">
                    <input type="hidden" name="rmaId" th:value="${rma.id}">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="partName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="partName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label for="serialNumber" class="form-label">Serial Number:</label>
                            <input type="text" class="form-control" id="serialNumber" name="serialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="partNumber" class="form-label">Part Number:</label>
                            <input type="text" class="form-control" id="partNumber" name="partNumber">
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="fromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Destination Tools Container -->
                            <div id="destinationContainerRma">
                                <div class="d-flex align-items-center mb-2 destination-row">
                                    <strong class="me-2">To:</strong>
                                    <select class="form-select destination-select" name="destinationToolIds" required>
                                        <option value="">Select destination tool...</option>
                                        <option th:each="toTool : ${allTools}"
                                                th:value="${toTool.id}" 
                                                th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}"
                                                th:selected="${toTool != null && rma.tool != null && toTool.id == rma.tool.id}">
                                            Tool Name
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination" style="display: none;">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Add Destination Button -->
                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addDestinationBtnRma">
                                    <i class="bi bi-plus"></i> Add Another Destination
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Moving Part Modal -->
    <div class="modal fade" id="editMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editMovingPartForm" th:action="@{/rma/{id}/moving-parts/edit(id=${rma.id})}" method="post">
                    <input type="hidden" id="editMovingPartId" name="movingPartId" value="">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editPartName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="editPartName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSerialNumber" class="form-label">Serial Number:</label>
                            <input type="text" class="form-control" id="editSerialNumber" name="serialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editPartNumber" class="form-label">Part Number:</label>
                            <input type="text" class="form-control" id="editPartNumber" name="partNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editQuantity" class="form-label">Quantity:</label>
                            <input type="number" class="form-control" id="editQuantity" name="quantity" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="editFromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Edit Destination Tools Container -->
                            <div id="editDestinationContainer">
                                <div class="d-flex align-items-center mb-2 destination-row">
                                    <strong class="me-2">To:</strong>
                                    <select class="form-select destination-select" name="destinationToolIds" required>
                                        <option value="">Select destination tool...</option>
                                        <option th:each="toTool : ${allTools}"
                                                th:value="${toTool.id}" 
                                                th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}"
                                                th:selected="${rma.tool != null and toTool.id == rma.tool.id}">
                                            Tool Name
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination" style="display: none;">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Add Destination Button for Edit -->
                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addDestinationBtnEdit">
                                    <i class="bi bi-plus"></i> Add Another Destination
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Picture View Modal -->
    <div class="modal fade" id="pictureModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">View Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPictureImg" src="" alt="RMA Picture" style="max-width: 100%; max-height: 80vh;">
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Preview Modal -->
    <div class="modal fade" id="excelPreviewModal" tabindex="-1" aria-labelledby="excelPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="excelPreviewModalLabel">Excel Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="excelPreviewContent" style="overflow-x: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/theme-toggle.js}"></script>
    
        <!-- Complete JavaScript functionality for RMA detail page -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Get RMA ID from Thymeleaf
        var rmaId = /*[[${rma.id}]]*/ 0;
        
        // Theme toggle functionality
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            if (newTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
            
            // Save theme preference
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            
            const icon = document.getElementById('theme-icon');
            if (savedTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
        });

        // Status editing functionality
        function enterStatusEditMode() {
            document.getElementById('status-view-mode').classList.add('d-none');
            document.getElementById('status-edit-mode').classList.remove('d-none');
        }

        function cancelStatusEdit() {
            document.getElementById('status-view-mode').classList.remove('d-none');
            document.getElementById('status-edit-mode').classList.add('d-none');
        }

        function saveStatus() {
            const statusSelect = document.getElementById('status-select');
            const newStatus = statusSelect.value;
            
            fetch('/rma/' + rmaId + '/update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'status=' + encodeURIComponent(newStatus)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated status
                } else {
                    alert('Error updating status: ' + (data.message || 'Unknown error'));
                    cancelStatusEdit();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status');
                cancelStatusEdit();
            });
        }

        // Priority editing functionality
        function enterPriorityEditMode() {
            document.getElementById('priority-view-mode-container').classList.add('d-none');
            document.getElementById('priority-edit-mode').classList.remove('d-none');
        }

        function cancelPriorityEdit() {
            document.getElementById('priority-view-mode-container').classList.remove('d-none');
            document.getElementById('priority-edit-mode').classList.add('d-none');
        }

        function savePriority() {
            const prioritySelect = document.getElementById('priority-select');
            const newPriority = prioritySelect.value;
            
            fetch('/rma/' + rmaId + '/update-priority', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'priority=' + encodeURIComponent(newPriority)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated priority
                } else {
                    alert('Error updating priority: ' + (data.message || 'Unknown error'));
                    cancelPriorityEdit();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating priority');
                cancelPriorityEdit();
            });
        }

        // Inline editing functionality for various sections
        function enableInlineEdit(sectionId) {
            const viewMode = document.getElementById(sectionId + '-view-mode');
            const editMode = document.getElementById(sectionId + '-edit-mode');
            
            if (viewMode && editMode) {
                viewMode.classList.add('d-none');
                editMode.classList.remove('d-none');
            }
        }

        function cancelInlineEdit(sectionId) {
            const viewMode = document.getElementById(sectionId + '-view-mode');
            const editMode = document.getElementById(sectionId + '-edit-mode');
            
            if (viewMode && editMode) {
                viewMode.classList.remove('d-none');
                editMode.classList.add('d-none');
            }
        }

        function saveInlineEdit(sectionId, endpoint) {
            const form = document.getElementById(sectionId + '-form');
            if (!form) return;

            const formData = new FormData(form);
            
            fetch('/rma/' + rmaId + '/' + endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to show updated data
                } else {
                    alert('Error updating ' + sectionId + ': ' + (data.message || 'Unknown error'));
                    cancelInlineEdit(sectionId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating ' + sectionId);
                cancelInlineEdit(sectionId);
            });
        }

        // Moving parts functionality
        function editMovingPart(movingPartId, partName, serialNumber, partNumber, quantity, fromToolId, destinationToolIds, notes) {
            document.getElementById('editMovingPartId').value = movingPartId;
            document.getElementById('editPartName').value = partName || '';
            document.getElementById('editSerialNumber').value = serialNumber || '';
            document.getElementById('editPartNumber').value = partNumber || '';
            document.getElementById('editQuantity').value = quantity || '';
            document.getElementById('editFromToolId').value = fromToolId || '';
            document.getElementById('editNotes').value = notes || '';
            
            // Clear existing destination selects
            const container = document.getElementById('editDestinationContainer');
            container.innerHTML = '';
            
            // Add destination selects for each destination
            if (destinationToolIds && destinationToolIds.length > 0) {
                destinationToolIds.forEach((toolId, index) => {
                    addDestinationSelect('editDestinationContainer', 'addDestinationBtnEdit', toolId);
                });
            } else {
                addDestinationSelect('editDestinationContainer', 'addDestinationBtnEdit', '');
            }
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('editMovingPartModal')).show();
        }

        function deleteMovingPart(movingPartId, partName) {
            if (confirm('Are you sure you want to delete the moving part "' + partName + '"?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/rma/' + rmaId + '/moving-parts/' + movingPartId + '/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }
                 // Destination tool management for moving parts
        function addDestinationSelect(containerId, buttonId, selectedToolId = '') {
            const container = document.getElementById(containerId);
            const button = document.getElementById(buttonId);
            
            const destinationRow = document.createElement('div');
            destinationRow.className = 'd-flex align-items-center mb-2 destination-row';
            
            destinationRow.innerHTML = 
                '<strong class="me-2">To:</strong>' +
                '<select class="form-select destination-select" name="destinationToolIds" required>' +
                    '<option value="">Select destination tool...</option>' +
                    /*[[${allToolsOptions}]]*/ '' +
                '</select>' +
                '<button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination">' +
                    '<i class="bi bi-dash"></i>' +
                '</button>';
            
            container.appendChild(destinationRow);
            
            // Add event listener for remove button
            const removeBtn = destinationRow.querySelector('.remove-destination');
            removeBtn.addEventListener('click', function() {
                destinationRow.remove();
                updateRemoveButtons(containerId);
            });
            
            // Update remove button visibility
            updateRemoveButtons(containerId);
        }

        function updateRemoveButtons(containerId) {
            const container = document.getElementById(containerId);
            const rows = container.querySelectorAll('.destination-row');
            
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-destination');
                if (rows.length > 1) {
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        // Picture viewing functionality
        function viewPicture(imagePath) {
            document.getElementById('modalPictureImg').src = imagePath;
            new bootstrap.Modal(document.getElementById('pictureModal')).show();
        }

                 // Picture and document management functions
         function showPictureModal(pictureId) {
             // This function would show a picture modal - implementation depends on your picture data structure
             console.log('Show picture modal for ID:', pictureId);
         }

         function deletePictureFromData(button) {
             const pictureId = button.getAttribute('data-picture-id');
             if (confirm('Are you sure you want to delete this picture?')) {
                 // Implementation for deleting picture
                 console.log('Delete picture ID:', pictureId);
             }
         }

         function deleteDocumentFromData(button) {
             const documentId = button.getAttribute('data-document-id');
             if (confirm('Are you sure you want to delete this document?')) {
                 // Implementation for deleting document
                 console.log('Delete document ID:', documentId);
             }
         }

         function previewExcelDocument(event) {
             event.preventDefault();
             const fileUrl = event.target.getAttribute('data-file-url');
             previewExcel(fileUrl);
         }

         // Document functionality
         function previewExcel(filePath) {
            fetch(`/rma/files/${filePath}`)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const html = XLSX.utils.sheet_to_html(worksheet);
                    
                    document.getElementById('excelPreviewContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('excelPreviewModal')).show();
                })
                .catch(error => {
                    console.error('Error previewing Excel file:', error);
                    alert('Error previewing Excel file');
                });
        }

                 // Generic section editing functionality
         function enterEditMode(sectionId) {
             enableInlineEdit(sectionId);
         }

         function cancelEditMode(sectionId) {
             cancelInlineEdit(sectionId);
         }

         function saveChanges(sectionId, endpoint) {
             saveInlineEdit(sectionId, endpoint);
         }

         // Specific section handlers
         function enterHeaderEditMode() {
             enterEditMode('header');
         }

         function cancelHeaderEditMode() {
             cancelEditMode('header');
         }

         function saveHeaderChanges() {
             saveChanges('header', 'update-header');
         }

         // Add event listeners for all edit buttons
         function initializeSectionEditing() {
             // Generic handler for all edit buttons
             document.querySelectorAll('.edit-section-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     const section = this.getAttribute('data-section');
                     enableInlineEdit(section);
                 });
             });

             // Generic handler for all save buttons
             document.querySelectorAll('.save-section-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     const section = this.getAttribute('data-section');
                     let endpoint;
                     switch(section) {
                         case 'header': endpoint = 'update-header'; break;
                         case 'process-impact': endpoint = 'update-process-impact'; break;
                         case 'parts': endpoint = 'update-parts'; break;
                         case 'problem-details': endpoint = 'update-problem'; break;
                         case 'customer': endpoint = 'update-customer'; break;
                         case 'dates': endpoint = 'update-dates'; break;
                         default: endpoint = 'update-' + section; break;
                     }
                     saveInlineEdit(section, endpoint);
                 });
             });

             // Generic handler for all cancel buttons
             document.querySelectorAll('.cancel-section-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     const section = this.getAttribute('data-section');
                     cancelInlineEdit(section);
                 });
             });
         }

         // Initialize destination tool management
         document.addEventListener('DOMContentLoaded', function() {
             // Initialize section editing
             initializeSectionEditing();
            // Add destination button for new moving part modal
            const addDestinationBtnRma = document.getElementById('addDestinationBtnRma');
            if (addDestinationBtnRma) {
                addDestinationBtnRma.addEventListener('click', function() {
                    addDestinationSelect('destinationContainerRma', 'addDestinationBtnRma');
                });
            }
            
            // Add destination button for edit moving part modal
            const addDestinationBtnEdit = document.getElementById('addDestinationBtnEdit');
            if (addDestinationBtnEdit) {
                addDestinationBtnEdit.addEventListener('click', function() {
                    addDestinationSelect('editDestinationContainer', 'addDestinationBtnEdit');
                });
            }
            
                         // Initialize remove buttons for existing destination selects
             updateRemoveButtons('destinationContainerRma');
             updateRemoveButtons('editDestinationContainer');
         });
         /*]]>*/
     </script>
</body>
</html> 