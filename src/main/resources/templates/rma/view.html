<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Comment styles */
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .comment-user {
            font-weight: bold;
        }
        .comment-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        .comment-content {
            white-space: pre-wrap;
        }
        /* New styles for collapsible sections */
        .collapse-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapse-header h5 {
            margin-bottom: 0;
        }
        .date-table {
            table-layout: fixed;
            width: 100%;
        }
        .date-table th {
            font-size: 0.85rem;
            text-align: center;
            width: 11.11%; /* For 9 columns */
        }
        .date-table td {
            text-align: center;
            font-size: 0.9rem;
        }
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <h1>RMA Details</h1>
            </div>
            <div class="col text-end">
                <a th:href="@{/rma}" class="btn btn-outline-secondary me-2" title="Back to RMA List">
                    <i class="bi bi-list"></i>
                </a>
                <a th:href="@{/rma/edit/{id}(id=${rma.id})}" class="btn btn-outline-primary me-2" title="Edit RMA">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a th:href="@{/rma/{id}/excel(id=${rma.id})}" class="btn btn-success me-2">
                    <i class="bi bi-file-excel me-1"></i> Export to Excel
                </a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete RMA">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-12">
                        <!-- View Mode for Header -->
                        <div id="header-view-mode">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h4 class="mb-0">
                                    <span>RMA/SAP #: </span>
                                    <span th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}" th:text="${rma.rmaNumber}">RMA Number</span>
                                    <span th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty && rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                                        / 
                                    </span>
                                    <span th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}" th:text="${rma.sapNotificationNumber}">SAP Number</span>
                                    <span th:if="${(rma.rmaNumber == null || rma.rmaNumber.empty) && (rma.sapNotificationNumber == null || rma.sapNotificationNumber.empty)}">
                                        N/A
                                    </span>
                                    
                                    <!-- Tool information next to RMA number -->
                                    <span class="ms-3" th:if="${rma.tool != null}">
                                        <i class="bi bi-tools me-1"></i>
                                        <a th:href="@{/tools/{id}(id=${rma.tool?.id})}" class="text-decoration-none">
                                            <span th:text="${rma.tool?.name}" class="text-primary"></span>
                                            <span th:if="${rma.tool?.secondaryName != null}" th:text="${' (' + rma.tool.secondaryName + ')'}" class="text-muted small"></span>
                                            <span class="ms-1 badge bg-secondary" th:text="${rma.tool?.toolType}">Tool Type</span>
                                        </a>
                                    </span>
                                    <span class="ms-3 text-muted" th:unless="${rma.tool != null}">
                                        <i class="bi bi-tools me-1"></i> No Tool selected
                                    </span>
                                </h4>
                                
                                <!-- Header Edit Buttons -->
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn me-2" data-section="header">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success save-section-btn d-none me-2" data-section="header">
                                        <i class="bi bi-check-lg"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none me-2" data-section="header">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Status and Priority in view mode -->
                            <div class="d-flex align-items-center flex-wrap">
                                <!-- Status moved next to Tool with bigger display -->
                                <span class="me-4">
                                    <!-- View Mode for Status -->
                                    <span id="status-view-mode" th:if="${rma.status != null}" th:class="${'badge rounded-pill fs-6 cursor-pointer ' + 
                                    (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                    (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                    (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                    (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                    (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                    (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                    (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                    onclick="enterStatusEditMode()"
                                    title="Click to change status">
                                    <span th:text="${rma.status?.displayName}">Status</span>
                                    <i class="bi bi-chevron-down ms-1"></i>
                                </span>
                                
                                <!-- Edit Mode for Status -->
                                <span id="status-edit-mode" class="d-none">
                                    <select id="status-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                        <option th:each="statusOption : ${T(com.pcd.manager.model.RmaStatus).values()}"
                                                th:value="${statusOption}"
                                                th:text="${statusOption.displayName}"
                                                th:selected="${statusOption == rma.status}"></option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-success ms-1" onclick="saveStatus()">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="cancelStatusEdit()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </span>
                                </span>
                                
                                <span th:if="${rma.priority != null}" th:class="${'badge rounded-pill fs-6 ' + 
                                (rma.priority == 'LOW' ? 'bg-info' : 
                                (rma.priority == 'MEDIUM' ? 'bg-warning' : 
                                (rma.priority == 'HIGH' ? 'bg-danger' : 
                                (rma.priority == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light'))))}"
                                th:text="${rma.priority}">
                                Priority
                            </span>
                            </div>
                        </div>
                        
                        <!-- Edit Mode for Header -->
                        <div id="header-edit-mode" class="d-none">
                            <form id="header-edit-form">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="flex-grow-1 me-3">
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <label class="form-label fw-bold">RMA Number:</label>
                                                <input type="text" class="form-control" name="rmaNumber" th:value="${rma.rmaNumber}" placeholder="Enter RMA number">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-bold">SAP Number:</label>
                                                <input type="text" class="form-control" name="sapNotificationNumber" th:value="${rma.sapNotificationNumber}" placeholder="Enter SAP number">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold">Tool:</label>
                                                <select class="form-select" name="toolId">
                                                    <option value="">-- Select Tool --</option>
                                                    <option th:each="toolOption : ${allTools}"
                                                            th:value="${toolOption.id}" 
                                                            th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '') + ' - ' + toolOption.toolType}"
                                                            th:selected="${toolOption != null && rma.tool != null && toolOption.id == rma.tool.id}">
                                                        Tool Name
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Header Edit Buttons -->
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-sm btn-success save-section-btn me-2" data-section="header">
                                            <i class="bi bi-check-lg"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary cancel-section-btn me-2" data-section="header">
                                            <i class="bi bi-x-lg"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Status and Priority in edit mode (read-only display) -->
                                <div class="d-flex align-items-center flex-wrap">
                                    <span class="me-4">
                                        <span th:if="${rma.status != null}" th:class="${'badge rounded-pill fs-6 ' + 
                                        (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                        (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                        (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                        (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                        (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                        (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                        (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                        th:text="${rma.status?.displayName}">
                                        Status
                                    </span>
                                    </span>
                                    
                                    <span th:if="${rma.priority != null}" th:class="${'badge rounded-pill fs-6 ' + 
                                    (rma.priority == 'LOW' ? 'bg-info' : 
                                    (rma.priority == 'MEDIUM' ? 'bg-warning' : 
                                    (rma.priority == 'HIGH' ? 'bg-danger' : 
                                    (rma.priority == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light'))))}"
                                    th:text="${rma.priority}">
                                    Priority
                                </span>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Location and Technician moved to a separate line -->
                        <div class="small text-muted mt-2">
                            <span>Location: <span th:text="${rma.location != null ? rma.location.displayName : 'N/A'}"></span></span>
                            <span class="ms-3">Technician: <span th:text="${rma.technician != null ? rma.technician : 'Not assigned'}"></span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- 1. Parts Information First -->
                <!-- SECTION RE-ADDED START -->
                <div class="row mb-4" id="parts-section-container">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Parts Information</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="parts">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="parts">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="parts">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- View Mode for Parts -->
                        <div id="parts-view-mode">
                        <table class="table table-sm table-bordered" th:if="${rma.partLineItems != null and not #lists.isEmpty(rma.partLineItems)}">
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>Part #</th>
                                    <th>Description</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-center">Replacement</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${rma.partLineItems}">
                                    <td th:text="${item.partName}">Part Name</td>
                                    <td th:text="${item.partNumber}">Part number</td>
                                    <td th:text="${item.productDescription}">Description</td>
                                    <td class="text-center" th:text="${item.quantity}">Qty</td>
                                    <td class="text-center">
                                        <span th:if="${item.replacementRequired}" class="badge bg-success">Yes</span>
                                        <span th:unless="${item.replacementRequired}" class="badge bg-secondary">No</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <p th:if="${rma.partLineItems == null or #lists.isEmpty(rma.partLineItems)}" class="text-muted">(No parts associated)</p>
                        </div>
                        
                        <!-- Edit Mode for Parts -->
                        <div id="parts-edit-mode" class="d-none">
                            <form id="parts-edit-form">
                                <div id="parts-edit-container">
                                    <!-- Existing parts rendered by Thymeleaf -->
                                    <div class="part-edit-item mb-3" th:each="item, itemStat : ${rma.partLineItems}">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="form-label">Part Name</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].partName'" th:value="${item.partName}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Part #</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].partNumber'" th:value="${item.partNumber}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Description</label>
                                                <input type="text" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].productDescription'" th:value="${item.productDescription}">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">Qty</label>
                                                <input type="number" class="form-control" th:name="'partLineItems[' + ${itemStat.index} + '].quantity'" th:value="${item.quantity}" min="1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Replacement</label>
                                                <select class="form-select" th:name="'partLineItems[' + ${itemStat.index} + '].replacementRequired'">
                                                    <option value="true" th:selected="${item.replacementRequired}">Yes</option>
                                                    <option value="false" th:selected="${!item.replacementRequired}">No</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-part-btn">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-success add-part-btn mt-2">
                                    <i class="bi bi-plus"></i> Add Part
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- SECTION RE-ADDED END -->
                
                <!-- 2. Moving Parts Below Parts Information -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Associated Moving Parts</h5>
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMovingPartModal" th:if="${rma.tool != null}" title="Add part movement related to the primary tool of this RMA">
                                    <i class="bi bi-plus-circle me-1"></i> Add Moving Part
                                </button>
                            </div>
                            <div class="card-body">
                                <div th:if="${movingParts == null || movingParts.empty}" class="alert alert-info">
                                    No moving parts have been recorded for this RMA.
                                </div>
                                <div th:if="${movingParts != null && !movingParts.empty}" class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Part Name</th>
                                                <th>Serial Number</th>
                                                <th>Part Number</th>
                                                <th>Quantity</th>
                                                <th>Movement</th>
                                                <th>Notes</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="movingPart : ${movingParts}">
                                                <td th:text="${movingPart.partName}">Part A</td>
                                                <td th:text="${movingPart.serialNumber}">Serial Number</td>
                                                <td th:text="${movingPart.partNumber}">Part Number</td>
                                                <td th:text="${movingPart.quantity}">Quantity</td>
                                                <td>
                                                    <!-- Enhanced movement display with full destination chain -->
                                                    <div>
                                                        <!-- Show from tool -->
                                                        <span>
                                                            <a th:if="${movingPart.fromTool != null}" 
                                                               th:href="@{/tools/{id}(id=${movingPart.fromTool.id})}" 
                                                               th:text="${movingPart.fromTool.name}" 
                                                               class="text-decoration-none">From Tool</a>
                                                            <span th:if="${movingPart.fromTool == null}" class="text-muted">-</span>
                                                        </span>
                                                        
                                                        <!-- Show full destination chain with arrows -->
                                                        <th:block th:if="${movingPartDestinationChains[movingPart.id] != null and !movingPartDestinationChains[movingPart.id].empty}">
                                                            <th:block th:each="destTool, iterStat : ${movingPartDestinationChains[movingPart.id]}">
                                                                <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                                <a th:href="@{/tools/{id}(id=${destTool.id})}" 
                                                                   th:text="${destTool.name}" 
                                                                   class="text-decoration-none">Dest Tool</a>
                                                            </th:block>
                                                        </th:block>
                                                        
                                                        <!-- Fallback for single destination (backward compatibility) -->
                                                        <th:block th:if="${(movingPartDestinationChains[movingPart.id] == null or movingPartDestinationChains[movingPart.id].empty) and movingPart.toTool != null}">
                                                            <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                            <a th:href="@{/tools/{id}(id=${movingPart.toTool.id})}" 
                                                               th:text="${movingPart.toTool.name}" 
                                                               class="text-decoration-none">To Tool</a>
                                                        </th:block>
                                                        
                                                        <!-- If no destinations at all -->
                                                        <th:block th:if="${(movingPartDestinationChains[movingPart.id] == null or movingPartDestinationChains[movingPart.id].empty) and movingPart.toTool == null}">
                                                            <i class="bi bi-arrow-right text-primary mx-2"></i>
                                                            <span class="text-muted">-</span>
                                                        </th:block>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span th:if="${movingPart.notes != null}" th:text="${movingPart.notes}">Notes</span>
                                                    <span th:if="${movingPart.notes == null}" class="text-muted">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(movingPart.moveDate, 'MM/dd/yy')}">01/01/23</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary moving-part-edit-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}"
                                                                th:data-from-tool-id="${movingPart.fromTool != null ? movingPart.fromTool.id : ''}"
                                                                th:data-to-tool-id="${movingPart.toTool != null ? movingPart.toTool.id : ''}"
                                                                th:data-destination-chain="${movingPart.destinationChain != null ? movingPart.destinationChain : ''}"
                                                                th:data-serial-number="${movingPart.serialNumber != null ? movingPart.serialNumber : ''}"
                                                                th:data-part-number="${movingPart.partNumber != null ? movingPart.partNumber : ''}"
                                                                th:data-quantity="${movingPart.quantity != null ? movingPart.quantity : ''}"
                                                                th:data-notes="${movingPart.notes != null ? movingPart.notes : ''}"
                                                                th:data-move-date="${#temporals.format(movingPart.moveDate, 'yyyy-MM-dd')}">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger moving-part-delete-btn"
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Date table moved below Moving Parts with 7 columns -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Dates</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="dates">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="dates">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="dates">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </div>
                        
                        <!-- View Mode for Dates -->
                        <div id="dates-view-mode">
                            <table class="table table-bordered table-sm date-table">
                                <thead>
                                    <tr>
                                        <th>Written</th>
                                <th>RMA # Provided</th>
                                        <th>Shipping Memo</th>
                                <th>Parts Received</th>
                                <th>Parts Installed</th>
                                <th>Failed Packed</th>
                                        <th>Failed Shipped</th>
                            </tr>
                                </thead>
                                <tbody>
                            <tr>
                                        <td th:text="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                                        <td th:text="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'MM/dd/yy') : 'N/A'}">MM/DD/YY</td>
                            </tr>
                                </tbody>
                        </table>
                    </div>
                        
                        <!-- Edit Mode for Dates -->
                        <div id="dates-edit-mode" class="d-none">
                            <form id="dates-edit-form">
                                <table class="table table-bordered table-sm date-table">
                                    <thead>
                            <tr>
                                            <th>Written</th>
                                            <th>RMA # Provided</th>
                                            <th>Shipping Memo</th>
                                            <th>Parts Received</th>
                                            <th>Parts Installed</th>
                                            <th>Failed Packed</th>
                                            <th>Failed Shipped</th>
                            </tr>
                                    </thead>
                                    <tbody>
                            <tr>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="writtenDate" 
                                                       th:value="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="rmaNumberProvidedDate" 
                                                       th:value="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="shippingMemoEmailedDate" 
                                                       th:value="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="partsReceivedDate" 
                                                       th:value="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="installedPartsDate" 
                                                       th:value="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="failedPartsPackedDate" 
                                                       th:value="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'yyyy-MM-dd') : ''}">
                                            </td>
                                            <td>
                                                <input type="date" class="form-control form-control-sm" name="failedPartsShippedDate" 
                                                       th:value="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'yyyy-MM-dd') : ''}">
                                </td>
                            </tr>
                                    </tbody>
                        </table>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Pictures Display Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Pictures</h5>
                                <form id="uploadPictureForm" th:action="@{/api/files/upload/{rmaId}(rmaId=${rma.id})}" method="post" enctype="multipart/form-data" class="mb-0">
                                    <input type="file" id="pictureFile" name="files" accept="image/*" style="display: none;" multiple>
                                    <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('pictureFile').click()">
                                        <i class="bi bi-upload me-1"></i> Upload Pictures
                                    </button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div th:if="${rma.pictures == null || rma.pictures.empty}" class="alert alert-info">
                                    No pictures have been uploaded for this RMA.
                                </div>
                                <div th:if="${rma.pictures != null && !rma.pictures.empty}" class="row g-3">
                                    <div th:each="picture : ${rma.pictures}" class="col-md-3 mb-3">
                                        <div class="card h-100">
                                            <img th:with="processedPath=${#strings.replace(picture.filePath, '\\\\', '/')}"
                                                 th:src="@{'/rma/files/' + ${processedPath}}"
                                                 class="card-img-top" 
                                                 alt="RMA Picture"
                                                 style="cursor: pointer; max-height: 200px; object-fit: cover;"
                                                 th:onclick="|showPictureModal(${picture.id})|">
                                            <div class="card-body">
                                                <p class="card-text small text-truncate" th:text="${picture.fileName}">filename.jpg</p>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:with="processedPath=${#strings.replace(picture.filePath, '\\\\', '/')}"
                                                       th:href="@{'/rma/files/' + ${processedPath}}"
                                                       class="btn btn-outline-primary" 
                                                       target="_blank" 
                                                       title="View">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger" 
                                                            th:data-picture-id="${picture.id}"
                                                            onclick="deletePictureFromData(this)" 
                                                            title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Display Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Documents</h5>
                                <form id="uploadDocumentForm" th:action="@{/api/files/upload/{rmaId}(rmaId=${rma.id})}" method="post" enctype="multipart/form-data" class="mb-0">
                                    <input type="file" id="documentFile" name="files" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" multiple>
                                    <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('documentFile').click()">
                                        <i class="bi bi-upload me-1"></i> Upload Documents
                                    </button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div th:if="${rma.documents == null || rma.documents.empty}" class="alert alert-info">
                                    No documents have been uploaded for this RMA.
                                </div>
                                <div th:if="${rma.documents != null && !rma.documents.empty}" class="row g-3">
                                    <div th:each="document : ${rma.documents}" class="col-md-4">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <p class="card-text small text-truncate" th:text="${document.fileName}">filename.pdf</p>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:href="@{/rma/files/{path}(path=${#strings.replace(document.filePath, '\\', '/')})}" 
                                                       class="btn btn-outline-primary" 
                                                       target="_blank" 
                                                       title="View">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger" 
                                                            th:data-document-id="${document.id}"
                                                            onclick="deleteDocumentFromData(this)" 
                                                            title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Notes</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-section-btn" data-section="notes">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success save-section-btn d-none" data-section="notes">
                                            <i class="bi bi-check-lg"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary cancel-section-btn d-none" data-section="notes">
                                            <i class="bi bi-x-lg"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="notes-view-mode">
                                    <p th:text="${rma.notes != null ? rma.notes : 'No notes available'}" class="mb-0">Notes</p>
                                </div>
                                <div id="notes-edit-mode" class="d-none">
                                    <form id="notes-edit-form">
                                        <textarea class="form-control" name="notes" rows="5" th:text="${rma.notes}" placeholder="Enter notes..."></textarea>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Comments</h5>
                            </div>
                            <div class="card-body">
                                <div class="comments-list mb-4">
                                    <div th:if="${#lists.isEmpty(comments)}" class="text-muted text-center py-3">
                                        No comments yet. Be the first to comment!
                                    </div>
                                    <div th:each="comment : ${comments}" class="comment">
                                        <div class="comment-header">
                                            <span class="comment-user" th:text="${comment.user != null ? comment.user.name : 'Unknown User'}">User Name</span>
                                            <span class="comment-date" th:text="${#temporals.format(comment.createdDate, 'MM/dd/yy HH:mm')}">Date</span>
                                        </div>
                                        <div class="comment-content" th:text="${comment.content}">
                                            Comment content goes here.
                                        </div>
                                    </div>
                                </div>

                                <hr th:if="${not #lists.isEmpty(comments)}"/>

                                <div>
                                    <form action="#" th:action="@{/rma/{id}/post-comment(id=${rma.id})}" method="post">
                                        <div class="form-group">
                                            <label for="commentContent" class="form-label">Add a comment:</label>
                                            <textarea class="form-control" id="commentContent" name="content" rows="3" required placeholder="Enter your comment here..."></textarea>
                                        </div>
                                        <div class="mt-2 text-end">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus-circle me-1"></i> Post Comment
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden RMA ID for JS -->
    <input type="hidden" id="rmaPageEntityIdForJs" th:value="${rma.id}">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const rmaPageId = document.getElementById('rmaPageEntityIdForJs').value;
        
        function deleteDocumentFromData(element) {
            const documentId = element.getAttribute('data-document-id');
            if (confirm('Are you sure you want to delete this document?')) {
                fetch(`/rma/${rmaPageId}/documents/${documentId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete document');
                                }
                            })
                            .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete document');
                });
            }
        }

        function showPictureModal(pictureId) {
            try {
                const modalImg = document.getElementById('modalPictureImg');
                const imgElement = document.querySelector(`img[onclick*="${pictureId}"]`);
                if (imgElement) {
                    modalImg.src = imgElement.src;
                    const modal = new bootstrap.Modal(document.getElementById('pictureModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error showing picture modal:', error);
            }
        }

        function deletePictureFromData(element) {
            const pictureId = element.getAttribute('data-picture-id');
            if (confirm('Are you sure you want to delete this picture?')) {
                fetch(`/rma/${rmaPageId}/pictures/${pictureId}/delete`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete picture');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete picture');
                });
            }
        }

        // Handle document upload form submission
        document.getElementById('uploadDocumentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
                
                // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
            .then(response => response.json())
                .then(data => {
                    if (data.success) {
                    window.location.reload(); // Reload the page to show the new document
                    } else {
                    alert('Failed to upload document: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload document: ' + error.message);
            })
            .finally(() => {
                    // Restore button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle picture upload form submission
        document.getElementById('uploadPictureForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadButton = this.querySelector('button');
            const originalButtonHtml = uploadButton.innerHTML;
            
            // Show loading state
            uploadButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Uploading...';
            uploadButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload(); // Reload the page to show the new pictures
                } else {
                    alert('Failed to upload pictures: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to upload pictures');
            })
            .finally(() => {
                // Reset button state
                uploadButton.innerHTML = originalButtonHtml;
                uploadButton.disabled = false;
            });
        });

        // Handle file input change
        document.getElementById('pictureFile').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('uploadPictureForm').submit();
            }
        });

        document.querySelectorAll('.moving-part-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const partName = this.getAttribute('data-part-name');
                const fromToolId = this.getAttribute('data-from-tool-id');
                const toToolId = this.getAttribute('data-to-tool-id');
                const destinationChain = this.getAttribute('data-destination-chain') || '';
                const serialNumber = this.getAttribute('data-serial-number') || '';
                const partNumber = this.getAttribute('data-part-number') || '';
                const quantity = this.getAttribute('data-quantity') || '';
                const notes = this.getAttribute('data-notes') || '';
                
                // Fill form fields with existing data
                document.getElementById('editMovingPartId').value = id;
                document.getElementById('editPartName').value = partName;
                document.getElementById('editFromToolId').value = fromToolId;
                document.getElementById('editSerialNumber').value = serialNumber;
                document.getElementById('editPartNumber').value = partNumber;
                document.getElementById('editQuantity').value = quantity;
                document.getElementById('editNotes').value = notes;
            });
        });
    </script>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you like to handle this file?</p>
                    <input type="hidden" id="fileIdToDelete">
                    <input type="hidden" id="fileTypeToDelete">
                    <input type="hidden" id="rmaIdForDelete">
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOnly" value="unlink" checked>
                        <label class="form-check-label" for="deleteOnly">
                            <strong>Unlink only:</strong> Remove only from this RMA, keep in other locations
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteEverywhere" value="delete">
                        <label class="form-check-label" for="deleteEverywhere">
                            <strong>Delete everywhere:</strong> Remove from all locations
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transfer File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the RMA to transfer this file to:</p>
                    <form id="transferForm" action="/rma/file/transfer" method="post">
                        <input type="hidden" id="transferFileId" name="fileId">
                        <input type="hidden" id="transferFileType" name="fileType">
                        <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="targetRmaId" class="form-label">Target RMA</label>
                            <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                                <option value="">-- Select Target RMA --</option>
                                <!-- This will need to be populated from controller with available RMAs -->
                                <option th:each="otherRma : ${allRmas}" 
                                        th:if="${otherRma.id != rma.id}" 
                                        th:value="${otherRma.id}" 
                                        th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA-' + otherRma.id) + 
                                                (otherRma.customerName != null ? ' - ' + otherRma.customerName : '')}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Link File Modal (Copied from tools/details.html, ensure allRmas, allTools, allTrackTrends are available) -->
    <div class="modal fade" id="unifiedLinkFileModal" tabindex="-1" aria-labelledby="unifiedLinkFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="unifiedLinkFormRmaPage" th:action="@{/files/link-entity}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unifiedLinkFileModalLabelRmaPage">Link File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Link <strong id="unifiedLinkFileNameDisplayRmaPage">file_name_here</strong> to:</p>
                        
                        <input type="hidden" id="unifiedLinkFileIdInputRmaPage" name="fileId">
                        <input type="hidden" id="unifiedLinkFilePathInputRmaPage" name="filePath">
                        <input type="hidden" id="unifiedLinkFileTypeInputRmaPage" name="fileType">
                        <input type="hidden" id="unifiedLinkSourceEntityTypeInputRmaPage" name="sourceEntityType">
                        <input type="hidden" id="unifiedLinkSourceEntityIdInputRmaPage" name="sourceEntityId">
                        <input type="hidden" id="unifiedLinkOriginalFileNameInputRmaPage" name="originalFileName">

                        <div class="mb-3">
                            <label for="unifiedLinkTargetEntityTypeRmaPage" class="form-label">Link to Entity Type:</label>
                            <select id="unifiedLinkTargetEntityTypeRmaPage" name="targetEntityType" class="form-select" required>
                                <option value="">-- Select Entity Type --</option>
                                <option value="RMA">RMA</option>
                                <option value="TOOL">Tool</option>
                                <option value="TRACK_TREND">Track/Trend</option>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetRmaSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetRmaIdRmaPage" class="form-label">Select RMA:</label>
                            <select id="unifiedLinkTargetRmaIdRmaPage" name="targetRmaId" class="form-select">
                                <option value="">-- Select RMA --</option>
                                <th:block th:if="${allRmas != null}">
                                    <option th:each="rmaOption : ${allRmas}"
                                            th:if="${rmaOption.id != rma.id}" 
                                            th:value="${rmaOption.id}" 
                                            th:text="${(rmaOption.rmaNumber ?: ('RMA-' + rmaOption.id)) + (rmaOption.customerName != null ? ' - ' + rmaOption.customerName : '')}">
                                    </option>
                                </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetToolSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetToolIdRmaPage" class="form-label">Select Tool:</label>
                            <select id="unifiedLinkTargetToolIdRmaPage" name="targetToolId" class="form-select">
                                <option value="">-- Select Tool --</option>
                                <th:block th:if="${allTools != null}">
                                   <option th:each="toolOption : ${allTools}" 
                                           th:value="${toolOption.id}" 
                                           th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '')}">
                                   </option>
                               </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetTrackTrendSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetTrackTrendIdRmaPage" class="form-label">Select Track/Trend:</label>
                            <select id="unifiedLinkTargetTrackTrendIdRmaPage" name="targetTrackTrendId" class="form-select">
                                <option value="">-- Select Track/Trend --</option>
                                 <th:block th:if="${allTrackTrends != null}"> <!-- Ensure allTrackTrends is passed to rma/view model -->
                                    <option th:each="tt : ${allTrackTrends}"
                                            th:value="${tt.id}"
                                            th:text="${tt.name + ' (' + #temporals.format(tt.startDate, 'yyyy-MM-dd') + ')'}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmUnifiedLinkBtnRmaPage">Link File</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Unified Link File Modal -->

    <!-- Delete RMA Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this RMA?</p>
                    <p class="text-danger fw-bold">This action cannot be undone!</p>
                    <p th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}">
                        <strong>RMA Number:</strong> <span th:text="${rma.rmaNumber}"></span>
                    </p>
                    <p th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                        <strong>SAP Number:</strong> <span th:text="${rma.sapNotificationNumber}"></span>
                    </p>
                    <p th:if="${rma.tool != null}">
                        <strong>Tool:</strong> <span th:text="${rma.tool?.name}"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/rma/delete/{id}(id=${rma.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Moving Part Modal -->
    <div class="modal fade" id="addMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/rma/{id}/moving-parts/add(id=${rma.id})}" method="post">
                    <input type="hidden" name="rmaId" th:value="${rma.id}">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="partName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="partName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label for="serialNumber" class="form-label">Serial Number:</label>
                            <input type="text" class="form-control" id="serialNumber" name="serialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="partNumber" class="form-label">Part Number:</label>
                            <input type="text" class="form-control" id="partNumber" name="partNumber">
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="fromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Destination Tools Container -->
                            <div id="destinationContainerRma">
                                <div class="d-flex align-items-center mb-2 destination-row">
                                    <strong class="me-2">To:</strong>
                                    <select class="form-select destination-select" name="destinationToolIds" required>
                                        <option value="">Select destination tool...</option>
                                        <option th:each="toTool : ${allTools}"
                                                th:value="${toTool.id}" 
                                                th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}"
                                                th:selected="${toTool != null && rma.tool != null && toTool.id == rma.tool.id}">
                                            Tool Name
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination" style="display: none;">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Add Destination Button -->
                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addDestinationBtnRma">
                                    <i class="bi bi-plus"></i> Add Another Destination
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Moving Part Modal -->
    <div class="modal fade" id="editMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editMovingPartForm" th:action="@{/rma/{id}/moving-parts/edit(id=${rma.id})}" method="post">
                    <input type="hidden" id="editMovingPartId" name="movingPartId" value="">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editPartName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="editPartName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSerialNumber" class="form-label">Serial Number:</label>
                            <input type="text" class="form-control" id="editSerialNumber" name="serialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editPartNumber" class="form-label">Part Number:</label>
                            <input type="text" class="form-control" id="editPartNumber" name="partNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editQuantity" class="form-label">Quantity:</label>
                            <input type="number" class="form-control" id="editQuantity" name="quantity" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="editFromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            
                            <!-- Edit Destination Tools Container -->
                            <div id="editDestinationContainer">
                                <div class="d-flex align-items-center mb-2 destination-row">
                                    <strong class="me-2">To:</strong>
                                    <select class="form-select destination-select" name="destinationToolIds" required>
                                        <option value="">Select destination tool...</option>
                                        <option th:each="toTool : ${allTools}"
                                                th:value="${toTool.id}" 
                                                th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}"
                                                th:selected="${rma.tool != null and toTool.id == rma.tool.id}">
                                            Tool Name
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-destination" style="display: none;">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Add Destination Button for Edit -->
                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-outline-success btn-sm" id="addDestinationBtnEdit">
                                    <i class="bi bi-plus"></i> Add Another Destination
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Picture View Modal -->
    <div class="modal fade" id="pictureModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">View Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPictureImg" src="" alt="RMA Picture" style="max-width: 100%; max-height: 80vh;">
                </div>
            </div>
        </div>
    </div>
</body>
</html> 