<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Comment styles */
        .comment {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        .comment:last-child {
            border-bottom: none;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .comment-user {
            font-weight: bold;
        }
        .comment-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        .comment-content {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <h1>RMA Details</h1>
            </div>
            <div class="col text-end">
                <a th:href="@{/rma}" class="btn btn-outline-secondary me-2" title="Back to RMA Matrix">
                    <i class="bi bi-grid-3x3-gap-fill"></i>
                </a>
                <a th:href="@{/rma/edit/{id}(id=${rma.id})}" class="btn btn-outline-primary me-2" title="Edit RMA">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a th:href="@{/rma/{id}/excel(id=${rma.id})}" class="btn btn-success me-2">
                    <i class="bi bi-file-excel me-1"></i> Export to Excel
                </a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete RMA">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col">
                        <h4>
                            <span th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}">
                                RMA: <span th:text="${rma.rmaNumber}">RMA Number</span>
                            </span>
                            <span th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty && rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                                / 
                            </span>
                            <span th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                                SAP: <span th:text="${rma.sapNotificationNumber}">SAP Number</span>
                            </span>
                            <span th:if="${(rma.rmaNumber == null || rma.rmaNumber.empty) && (rma.sapNotificationNumber == null || rma.sapNotificationNumber.empty)}">
                                RMA Details
                            </span>
                        </h4>
                    </div>
                    <div class="col text-end">
                        <div class="mb-1">
                            <span th:if="${rma.status != null}" th:class="${'badge rounded-pill ' + 
                                (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                th:text="${rma.status?.displayName}">
                                Status
                            </span>
                            <span th:if="${rma.priority != null}" th:class="${'ms-2 badge rounded-pill ' + 
                                (rma.priority == 'LOW' ? 'bg-info' : 
                                (rma.priority == 'MEDIUM' ? 'bg-warning' : 
                                (rma.priority == 'HIGH' ? 'bg-danger' : 
                                (rma.priority == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light'))))}"
                                th:text="${rma.priority}">
                                Priority
                            </span>
                        </div>
                        <div class="small text-muted">
                            <div>Location: <span th:text="${rma.location != null ? rma.location.displayName : 'N/A'}"></span></div>
                            <div>Technician: <span th:text="${rma.technician != null ? rma.technician : 'Not assigned'}"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Customer Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:30%">Customer</th>
                                <td th:text="${rma.customerName}">Customer name</td>
                            </tr>
                            <tr>
                                <th>Company Ship To Name</th>
                                <td th:text="${rma.companyShipToName}">Ship to name</td>
                            </tr>
                            <tr>
                                <th>Ship To Address</th>
                                <td>
                                    <div th:text="${rma.companyShipToAddress}">Address</div>
                                    <div th:if="${rma.city != null || rma.state != null || rma.zipCode != null}">
                                        <span th:text="${rma.city}"></span>,
                                        <span th:text="${rma.state}"></span>
                                        <span th:text="${rma.zipCode}"></span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Attn</th>
                                <td th:text="${rma.attn}">Attention</td>
                            </tr>
                            <tr>
                                <th>Contact</th>
                                <td th:text="${rma.customerContact}">Contact name</td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td th:text="${rma.customerPhone}">Phone number</td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td th:text="${rma.customerEmail}">Email</td>
                            </tr>
                            <tr>
                                <th>Sales Order</th>
                                <td th:text="${rma.salesOrder}">Sales order</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Parts Information</h5>
                        <!-- Table to display part line items -->
                        <table class="table table-sm table-bordered" th:if="${rma.partLineItems != null and not #lists.isEmpty(rma.partLineItems)}">
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>Part #</th>
                                    <th>Description</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-center">Replacement</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${rma.partLineItems}">
                                    <td th:text="${item.partName}">Part Name</td>
                                    <td th:text="${item.partNumber}">Part number</td>
                                    <td th:text="${item.productDescription}">Description</td>
                                    <td class="text-center" th:text="${item.quantity}">Qty</td>
                                    <td class="text-center">
                                        <span th:if="${item.replacementRequired}" class="badge bg-success">Yes</span>
                                        <span th:unless="${item.replacementRequired}" class="badge bg-secondary">No</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <p th:if="${rma.partLineItems == null or #lists.isEmpty(rma.partLineItems)}" class="text-muted">(No parts associated)</p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <h5>Dates</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:40%">Received</th>
                                <td th:text="${rma.receivedDate != null ? #temporals.format(rma.receivedDate, 'yyyy-MM-dd') : 'N/A'}">Received date</td>
                            </tr>
                            <tr>
                                <th>Written</th>
                                <td th:text="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'yyyy-MM-dd') : 'N/A'}">Written date</td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td th:text="${rma.createdDate != null ? #temporals.format(rma.createdDate, 'yyyy-MM-dd') : 'N/A'}">Created date</td>
                            </tr>
                            <tr>
                                <th>RMA # Provided</th>
                                <td th:text="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'yyyy-MM-dd') : 'N/A'}">RMA # Provided date</td>
                            </tr>
                            <tr>
                                <th>Memo Emailed</th>
                                <td th:text="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'yyyy-MM-dd') : 'N/A'}">Memo Emailed date</td>
                            </tr>
                            <tr>
                                <th>Parts Received</th>
                                <td th:text="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'yyyy-MM-dd') : 'N/A'}">Parts Received date</td>
                            </tr>
                            <tr>
                                <th>Parts Installed</th>
                                <td th:text="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'yyyy-MM-dd') : 'N/A'}">Parts Installed date</td>
                            </tr>
                            <tr>
                                <th>Failed Packed</th>
                                <td th:text="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'yyyy-MM-dd') : 'N/A'}">Failed Packed date</td>
                            </tr>
                            <tr>
                                <th>Failed Shipped</th>
                                <td th:text="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'yyyy-MM-dd') : 'N/A'}">Failed Shipped date</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-8">
                        <h5>Assignment</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:20%">Location</th>
                                <td th:text="${rma.location != null ? rma.location.displayName : 'N/A'}">Location</td>
                            </tr>
                            <tr>
                                <th>Technician</th>
                                <td th:text="${rma.technician != null ? rma.technician : 'Not assigned'}">Technician</td>
                            </tr>
                            <tr>
                                <th>Tool</th>
                                <td>
                                    <a th:if="${rma.tool != null}" th:href="@{/tools/{id}(id=${rma.tool.id})}" class="text-decoration-none">
                                        <span th:text="${rma.tool.name}" class="text-primary"></span>
                                        <span th:if="${rma.tool.secondaryName != null}" th:text="${' (' + rma.tool.secondaryName + ')'}" class="text-muted small"></span>
                                        <span class="ms-2 badge bg-secondary" th:text="${rma.tool.toolType}">Tool Type</span>
                                    </a>
                                    <span th:unless="${rma.tool != null}" class="text-muted">No tool associated</span>
                                </td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.chemicalGasService != null}">
                                <th>Chemical/Gas Service</th>
                                <td th:text="${rma.tool.chemicalGasService}">Chemical/Gas Service</td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.commissionDate != null}">
                                <th>Commission Date</th>
                                <td th:text="${#temporals.format(rma.tool.commissionDate, 'yyyy-MM-dd')}">Commission Date</td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.startUpSl03Date != null}">
                                <th>Start-Up/SL03 Date</th>
                                <td th:text="${#temporals.format(rma.tool.startUpSl03Date, 'yyyy-MM-dd')}">Start-Up/SL03 Date</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Problem Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:40%">1. Who Discovered:</th>
                                                <td th:text="${rma.problemDiscoverer != null ? rma.problemDiscoverer : 'N/A'}">Not provided</td>
                                            </tr>
                                            <tr>
                                                <th>2. When Discovered:</th>
                                                <td th:text="${rma.problemDiscoveryDate != null ? #temporals.format(rma.problemDiscoveryDate, 'yyyy-MM-dd') : 'N/A'}">Not provided</td>
                                            </tr>
                                            <tr>
                                                <th>3. What Happened:</th>
                                                <td th:text="${rma.whatHappened != null ? rma.whatHappened : 'N/A'}">Not provided</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:40%">4. Why and How:</th>
                                                <td th:text="${rma.whyAndHowItHappened != null ? rma.whyAndHowItHappened : 'N/A'}">Not provided</td>
                                            </tr>
                                            <tr>
                                                <th>5. How Contained:</th>
                                                <td th:text="${rma.howContained != null ? rma.howContained : 'N/A'}">Not provided</td>
                                            </tr>
                                            <tr>
                                                <th>6. Who Contained:</th>
                                                <td th:text="${rma.whoContained != null ? rma.whoContained : 'N/A'}">Not provided</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Root Cause</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.rootCause != null ? rma.rootCause : 'Not yet determined'}" class="mb-0">Root cause</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resolution</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.resolution != null ? rma.resolution : 'Not yet resolved'}" class="mb-0">Resolution</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Notes</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.notes != null ? rma.notes : 'No notes available'}" class="mb-0">Notes</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Comments</h5>
                            </div>
                            <div class="card-body">
                                <!-- Add Comment Form -->
                                <div class="mb-4">
                                    <form action="#" th:action="@{/rma/{id}/post-comment(id=${rma.id})}" method="post">
                                        <div class="form-group">
                                            <label for="commentContent" class="form-label">Add a comment:</label>
                                            <textarea class="form-control" id="commentContent" name="content" rows="3" required placeholder="Enter your comment here..."></textarea>
                                        </div>
                                        <div class="mt-2 text-end">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-plus-circle me-1"></i> Post Comment
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <hr/>
                                
                                <!-- Comments List -->
                                <div class="comments-list">
                                    <div th:if="${#lists.isEmpty(comments)}" class="text-muted text-center py-3">
                                        No comments yet. Be the first to comment!
                                    </div>
                                    
                                    <div th:each="comment : ${comments}" class="comment">
                                        <div class="comment-header">
                                            <span class="comment-user" th:text="${comment.user != null ? comment.user.name : 'Unknown User'}">User Name</span>
                                            <span class="comment-date" th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}">Date</span>
                                        </div>
                                        <div class="comment-content" th:text="${comment.content}">
                                            Comment content goes here.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Process Impact Information Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Process Impact Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:50%">Interruption to Flow</th>
                                                <td>
                                                    <span th:if="${rma.interruptionToFlow}" class="badge bg-danger">Yes</span>
                                                    <span th:unless="${rma.interruptionToFlow}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Interruption to Production</th>
                                                <td>
                                                    <span th:if="${rma.interruptionToProduction}" class="badge bg-danger">Yes</span>
                                                    <span th:unless="${rma.interruptionToProduction}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Downtime (Hrs)</th>
                                                <td th:text="${rma.downtimeHours != null ? rma.downtimeHours : '0.0'}">0.0</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:50%">Exposed to Process Gas/Chemicals</th>
                                                <td>
                                                    <span th:if="${rma.exposedToProcessGasOrChemicals}" class="badge bg-warning">Yes</span>
                                                    <span th:unless="${rma.exposedToProcessGasOrChemicals}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Purged</th>
                                                <td>
                                                    <span th:if="${rma.purged}" class="badge bg-info">Yes</span>
                                                    <span th:unless="${rma.purged}" class="badge bg-secondary">No</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3" th:if="${rma.instructionsForExposedComponent != null && !rma.instructionsForExposedComponent.isEmpty()}">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Instructions for Exposed Component</h6>
                                            </div>
                                            <div class="card-body">
                                                <p th:text="${rma.instructionsForExposedComponent}" class="mb-0">Instructions</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Moving Parts Section - Updated for RMA Details -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Associated Moving Parts</h5>
                                <!-- TODO: The Add Moving Part button/modal needs to be updated to correctly associate with the RMA -->
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMovingPartModal" th:if="${rma.tool != null}" title="Add part movement related to the primary tool of this RMA">
                                    <i class="bi bi-plus-circle me-1"></i> Add Part Movement (for Tool)
                                </button>
                            </div>
                            <div class="card-body">
                                <div th:if="${movingParts == null || movingParts.empty}" class="alert alert-info">
                                    No moving parts have been recorded for this RMA.
                                </div>
                                <div th:if="${movingParts != null && !movingParts.empty}" class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Part Name</th>
                                                <th>Movement</th>
                                                <th>Notes</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="movingPart : ${movingParts}">
                                                <td th:text="${movingPart.partName}">Part A</td>
                                                <td>
                                                    <a th:if="${movingPart.fromTool != null}" th:href="@{/tools/{id}(id=${movingPart.fromTool.id})}" th:text="${movingPart.fromTool.name}" class="text-decoration-none"></a>
                                                    <span th:unless="${movingPart.fromTool != null}">N/A</span>
                                                    <i class="bi bi-arrow-right text-success mx-1"></i>
                                                    <a th:if="${movingPart.toTool != null}" th:href="@{/tools/{id}(id=${movingPart.toTool.id})}" th:text="${movingPart.toTool.name}" class="text-decoration-none"></a>
                                                    <span th:unless="${movingPart.toTool != null}">N/A</span>
                                                </td>
                                                <td>
                                                    <span th:if="${movingPart.notes != null}" th:text="${movingPart.notes}">Notes</span>
                                                    <span th:if="${movingPart.notes == null}" class="text-muted">-</span>
                                                </td>
                                                <td th:text="${#temporals.format(movingPart.moveDate, 'MMM dd, yyyy')}">Jan 1, 2023</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <!-- TODO: Edit/Delete actions need to be verified/updated for RMA context -->
                                                        <button type="button" class="btn btn-sm btn-outline-secondary edit-moving-part-btn"
                                                                data-bs-toggle="modal" data-bs-target="#editMovingPartModal"
                                                                th:if="${rma.tool != null}" 
                                                                th:data-id="${movingPart.id}"
                                                                th:data-part-name="${movingPart.partName}"
                                                                th:data-from-tool-id="${movingPart.fromTool != null ? movingPart.fromTool.id : ''}"
                                                                th:data-to-tool-id="${movingPart.toTool != null ? movingPart.toTool.id : ''}"
                                                                th:data-notes="${movingPart.notes}"
                                                                title="Edit part movement (related to tool)">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-info unified-link-trigger-btn ms-1"
                                                                data-bs-toggle="modal" data-bs-target="#unifiedLinkFileModal"
                                                                th:data-source-entity-id="${movingPart.id}"
                                                                th:data-source-entity-type="'MOVING_PART'"
                                                                th:data-file-name="${movingPart.partName + ' (Movement ID: ' + movingPart.id + ')'}"
                                                                th:data-file-type="'MOVING_PART_RECORD'"
                                                                title="Link this Moving Part record">
                                                            <i class="bi bi-link-45deg"></i>
                                                        </button>
                                                        <form th:if="${rma.tool != null}" th:action="@{/tools/{toolId}/moving-parts/{movingPartId}/delete(toolId=${rma.tool.id}, movingPartId=${movingPart.id})}" 
                                                              method="post" class="ms-1">
                                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                                    onclick="return confirm('Are you sure you want to delete this moving part record (from tool)?')"
                                                                    title="Delete part movement (from tool)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Documents Section -->
                <div class="row mt-4" th:if="${rma.documents != null and not rma.documents.empty}">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Documents</h5>
                            </div>
                            <div class="card-body">
                                <!-- Debug info to see document paths (hidden) -->
                                <div class="alert alert-info small mb-3" style="display: none;">
                                    <p><strong>Debug Info:</strong> Document paths from database</p>
                                    <ul class="mb-0">
                                        <li th:each="doc : ${rma.documents}" th:text="${doc.fileName + ' ➡ ' + doc.filePath}">document.fileName → document.filePath</li>
                                    </ul>
                                </div>
                                
                                <div class="list-group">
                                    <div class="list-group-item d-flex align-items-center" th:each="document : ${rma.documents}">
                                        <!-- Document Name -->
                                        <div class="flex-grow-1" style="width: 40%">
                                            <i class="bi bi-file-earmark-text me-2"></i>
                                            <span th:text="${document.fileName}">Document Name</span>
                                            <span class="small text-muted ms-2" 
                                                  th:text="${document.fileSize != null ? '(' + (document.fileSize / 1024) + ' KB)' : ''}">Size</span>
                                        </div>
                                        
                                        <!-- Tags -->
                                        <div style="width: 40%">
                                            <span class="badge bg-secondary me-1" th:if="${rma.tool != null}" 
                                                  th:text="${'Tool: ' + rma.tool.name}">Tool</span>
                                            <span class="badge bg-info me-1" th:if="${rma.rmaNumber != null}"
                                                  th:text="${'RMA: ' + rma.rmaNumber}">RMA</span>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="ms-auto">
                                            <div class="btn-group">
                                                <a th:href="@{'/rma/files/' + ${document.filePath}}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary" 
                                                   title="View">
                                                    <i class="bi bi-eye-fill"></i>
                                                </a>
                                                <a th:href="@{'/rma/files/' + ${document.filePath}}" 
                                                   download 
                                                   class="btn btn-sm btn-outline-secondary" 
                                                   title="Download">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger delete-file-btn"
                                                        title="Delete"
                                                        th:data-id="${document.id}"
                                                        data-type="document"
                                                        th:data-rma-id="${rma.id}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteConfirmModal">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning transfer-btn"
                                                        title="Transfer"
                                                        th:data-id="${document.id}"
                                                        data-type="document"
                                                        th:data-rma-id="${rma.id}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#transferModal">
                                                    <i class="bi bi-arrow-right-square-fill"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-info link-btn"
                                                        title="Link"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#unifiedLinkFileModal" 
                                                        th:data-file-id="${document.id}"             <!-- Using document.id as fileId -->
                                                        th:data-file-path="${document.filePath}" 
                                                        th:data-file-name="${document.fileName}"
                                                        th:data-file-type="'document'"
                                                        th:data-source-entity-type="'RMA'"
                                                        th:data-source-entity-id="${rma.id}">
                                                    <i class="bi bi-link-45deg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Documents Section -->

                <!-- Pictures Section -->
                <div class="row mt-4" th:if="${rma.pictures != null and not rma.pictures.empty}">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Pictures</h5>
                            </div>
                            <div class="card-body">
                                <!-- Debug info to see picture paths (hidden) -->
                                <div class="alert alert-info small mb-3" style="display: none;">
                                    <p><strong>Debug Info:</strong> Picture paths from database</p>
                                    <ul class="mb-0">
                                        <li th:each="picture : ${rma.pictures}" th:text="${picture.fileName + ' ➡ ' + picture.filePath}">picture.fileName → picture.filePath</li>
                                    </ul>
                                    <hr />
                                    <button id="btnCheckFiles" class="btn btn-sm btn-secondary mt-2">Check File Existence</button>
                                    <div id="fileCheckResults" class="mt-2"></div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-3" th:each="picture : ${rma.pictures}">
                                        <div class="card h-100 shadow-sm">
                                            <div class="card-header p-2">
                                                <!-- Tags -->
                                                <span class="badge bg-secondary me-1" th:if="${rma.tool != null}" 
                                                      th:text="${'Tool: ' + rma.tool.name}">Tool</span>
                                                <span class="badge bg-info" th:if="${rma.rmaNumber != null}"
                                                      th:text="${'RMA: ' + rma.rmaNumber}">RMA</span>
                                            </div>
                                            <div class="card-img-top text-center p-2" style="height: 150px;">
                                                <!-- Direct URL to the image using stored filePath -->
                                                <img th:src="@{'/rma/files/' + ${picture.filePath}}" 
                                                     th:alt="${picture.fileName}" 
                                                     class="img-fluid rounded" 
                                                     style="max-height: 100%; max-width: 100%; object-fit: contain; cursor: pointer;"
                                                     data-bs-toggle="modal" 
                                                     data-bs-target="#imageModal"
                                                     th:data-bs-img-src="@{'/rma/files/' + ${picture.filePath}}"
                                                     th:data-bs-img-title="${picture.fileName}"
                                                     th:data-path="${picture.filePath}"
                                                     onerror="handleImageError(this);"
                                                     />
                                            </div>
                                            <div class="card-footer p-1 text-center bg-light">
                                                <small class="text-muted" th:text="${#strings.length(picture.fileName) > 20 ? #strings.substring(picture.fileName, 0, 17) + '...' : picture.fileName}">Filename</small>
                                                
                                                <!-- Action buttons -->
                                                <div class="d-flex gap-1 justify-content-center mt-1">
                                                    <a th:href="@{'/rma/files/' + ${picture.filePath}}" 
                                                       target="_blank" 
                                                       class="btn btn-sm btn-outline-primary" 
                                                       title="View">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </a>
                                                    <a th:href="@{'/rma/files/' + ${picture.filePath}}" 
                                                       download 
                                                       class="btn btn-sm btn-outline-secondary" 
                                                       title="Download">
                                                        <i class="bi bi-download"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger delete-file-btn"
                                                            title="Delete"
                                                            th:data-id="${picture.id}"
                                                            data-type="picture"
                                                            th:data-rma-id="${rma.id}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#deleteConfirmModal">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-warning transfer-btn"
                                                            title="Transfer"
                                                            th:data-id="${picture.id}"
                                                            data-type="picture"
                                                            th:data-rma-id="${rma.id}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#transferModal">
                                                        <i class="bi bi-arrow-right-square-fill"></i>
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-info link-btn"
                                                            title="Link"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#unifiedLinkFileModal" 
                                                            th:data-file-id="${picture.id}"             <!-- Using picture.id as fileId -->
                                                            th:data-file-path="${picture.filePath}"
                                                            th:data-file-name="${picture.fileName}"
                                                            th:data-file-type="'picture'"
                                                            th:data-source-entity-type="'RMA'"
                                                            th:data-source-entity-id="${rma.id}">
                                                        <i class="bi bi-link-45deg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Pictures Section -->

                <!-- Image Modal for enlarged view -->
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="modalImage" src="" alt="Full size image" class="img-fluid">
                            </div>
                            <div class="modal-footer">
                                <a id="downloadLink" href="" class="btn btn-primary" download>Download</a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="card-footer text-end">
                <span class="text-muted" th:if="${rma.id != null}">RMA ID: <span th:text="${rma.id}"></span></span>
            </div>
        </div>
    </div>
    
    <!-- Hidden RMA ID for JS -->
    <input type="hidden" id="rmaPageEntityIdForJs" th:value="${rma.id}">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set up image modal functionality
            const imageModal = document.getElementById('imageModal');
            if (imageModal) {
                imageModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imgSrc = button.getAttribute('data-bs-img-src');
                    const imgTitle = button.getAttribute('data-bs-img-title');
                    
                    const modalImage = document.getElementById('modalImage');
                    const modalTitle = imageModal.querySelector('.modal-title');
                    const downloadLink = document.getElementById('downloadLink');
                    
                    modalImage.src = imgSrc;
                    modalTitle.textContent = imgTitle || 'Image Preview';
                    downloadLink.href = imgSrc;
                    downloadLink.setAttribute('download', imgTitle || 'image');
                });
                
                // Remove any duplicate error messages that might be added by the onerror event
                const cleanupDuplicateErrors = function() {
                    document.querySelectorAll('.card-img-top').forEach(container => {
                        const errorDivs = container.querySelectorAll('div.text-center.text-muted');
                        if (errorDivs.length > 1) {
                            // Keep only the first error message
                            for (let i = 1; i < errorDivs.length; i++) {
                                container.removeChild(errorDivs[i]);
                            }
                        }
                    });
                };
                
                // Run cleanup once after page load
                setTimeout(cleanupDuplicateErrors, 500);
            }
            
            // Set up the file check button
            const btnCheckFiles = document.getElementById('btnCheckFiles');
            const fileCheckResults = document.getElementById('fileCheckResults');
            
            if (btnCheckFiles && fileCheckResults) {
                btnCheckFiles.addEventListener('click', function() {
                    fileCheckResults.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Checking files...';
                    
                    // Get all image paths
                    const imagePaths = [];
                    document.querySelectorAll('img[data-path]').forEach(img => {
                        const path = img.getAttribute('data-path');
                        if (path) {
                            imagePaths.push(path);
                        }
                    });
                    
                    if (imagePaths.length === 0) {
                        fileCheckResults.innerHTML = '<div class="alert alert-warning">No file paths found to check</div>';
                        return;
                    }
                    
                    // Create a results table
                    let resultsHtml = '<table class="table table-sm table-bordered mt-2">';
                    resultsHtml += '<thead><tr><th>Path</th><th>Status</th></tr></thead><tbody>';
                    
                    // Check each path
                    let completedChecks = 0;
                    imagePaths.forEach(path => {
                        fetch(`/rma/api/file-exists?path=${encodeURIComponent(path)}`)
                            .then(response => response.json())
                            .then(data => {
                                const exists = data.exists;
                                const status = exists 
                                    ? '<span class="text-success">Exists</span>' 
                                    : '<span class="text-danger">Not found</span>';
                                    
                                resultsHtml += `<tr>
                                    <td class="small">${path}</td>
                                    <td>${status}</td>
                                </tr>`;
                                
                                completedChecks++;
                                if (completedChecks === imagePaths.length) {
                                    resultsHtml += '</tbody></table>';
                                    fileCheckResults.innerHTML = resultsHtml;
                                }
                            })
                            .catch(error => {
                                resultsHtml += `<tr>
                                    <td class="small">${path}</td>
                                    <td><span class="text-danger">Error: ${error.message}</span></td>
                                </tr>`;
                                
                                completedChecks++;
                                if (completedChecks === imagePaths.length) {
                                    resultsHtml += '</tbody></table>';
                                    fileCheckResults.innerHTML = resultsHtml;
                                }
                            });
                    });
                });
            }
            
            // Initialize popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            })
            
            // Handle delete button clicks
            document.querySelectorAll('.delete-file-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Store file data in the modal for deletion
                    const fileId = this.getAttribute('data-id');
                    const fileType = this.getAttribute('data-type');
                    const rmaId = this.getAttribute('data-rma-id');
                    
                    document.getElementById('fileIdToDelete').value = fileId;
                    document.getElementById('fileTypeToDelete').value = fileType;
                    document.getElementById('rmaIdForDelete').value = rmaId;
                });
            });
            
            // Handle transfer button clicks
            document.querySelectorAll('.transfer-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Store file data in the modal for transfer
                    const fileId = this.getAttribute('data-id');
                    const fileType = this.getAttribute('data-type');
                    const rmaId = this.getAttribute('data-rma-id');
                    
                    document.getElementById('transferFileId').value = fileId;
                    document.getElementById('transferFileType').value = fileType;
                    document.getElementById('sourceRmaId').value = rmaId;
                    
                    // Update modal title based on file type
                    const modalTitle = document.getElementById('transferModalLabel');
                    modalTitle.textContent = `Transfer ${fileType.charAt(0).toUpperCase() + fileType.slice(1)}`;
                });
            });
            
            // Moving Parts Edit button handlers
            document.querySelectorAll('.edit-moving-part-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const partName = this.getAttribute('data-part-name');
                    const fromToolId = this.getAttribute('data-from-tool-id');
                    const toToolId = this.getAttribute('data-to-tool-id');
                    const notes = this.getAttribute('data-notes') || '';
                    
                    // Update form action URL
                    const form = document.getElementById('editMovingPartForm');
                    form.action = form.action.replace('/0/', '/' + id + '/');
                    
                    // Fill form fields with existing data
                    document.getElementById('editMovingPartId').value = id;
                    document.getElementById('editPartName').value = partName;
                    document.getElementById('editFromToolId').value = fromToolId;
                    document.getElementById('editToToolId').value = toToolId;
                    document.getElementById('editNotes').value = notes;
                });
            });

            // --- Unified Link File Modal Logic for RMA Page ---
            const unifiedLinkFileModalRmaPage = document.getElementById('unifiedLinkFileModal'); 
            if (unifiedLinkFileModalRmaPage) {
                const rmaIdElement = document.getElementById('rmaPageEntityIdForJs');
                let rmaPageIdForJs = null;
                if (rmaIdElement) {
                    rmaPageIdForJs = rmaIdElement.value;
                    console.log("Unified Link Modal (RMA Page): RMA ID for page context found:", rmaPageIdForJs);
                } else {
                    console.error("CRITICAL ERROR: Hidden input with id='rmaPageEntityIdForJs' not found. Linking will likely fail for sourceEntityId.");
                    alert("Page Error: RMA ID context is missing. Please contact support or refresh.");
                }

                const unifiedLinkTargetEntityTypeRmaPage = document.getElementById('unifiedLinkTargetEntityTypeRmaPage');
                const unifiedLinkTargetRmaSectionRmaPage = document.getElementById('unifiedLinkTargetRmaSectionRmaPage');
                const unifiedLinkTargetToolSectionRmaPage = document.getElementById('unifiedLinkTargetToolSectionRmaPage');
                const unifiedLinkTargetTrackTrendSectionRmaPage = document.getElementById('unifiedLinkTargetTrackTrendSectionRmaPage');

                document.querySelectorAll('.link-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        // Determine pageRmaId at the moment of click, in case it wasn't ready at page load for some reason
                        const currentPageRmaId = rmaPageIdForJs || (document.getElementById('rmaPageEntityIdForJs') ? document.getElementById('rmaPageEntityIdForJs').value : null);
                        console.log("Link button clicked on RMA page. Page RMA ID:", currentPageRmaId);
                        if (!currentPageRmaId) {
                            alert("Cannot proceed: Page RMA ID is missing. Please refresh.");
                            return;
                        }

                        const itemFileType = this.dataset.fileType; // 'document', 'picture', or 'MOVING_PART_RECORD'
                        const buttonSourceEntityType = this.dataset.sourceEntityType; // 'RMA' (for doc/pic) or 'MOVING_PART'
                        const buttonSourceEntityId = this.dataset.sourceEntityId; // rma.id (for doc/pic buttons) or movingPart.id (for MP buttons)
                        
                        let itemIdToLink = this.dataset.fileId || ''; // For RmaDocument/RmaPicture, this is their ID
                        let itemFilePath = this.dataset.filePath || '';
                        let itemDisplayName = this.dataset.fileName || 'Selected Item';
                        // The controller's sourceEntityType should be the type of the page we are on ('RMA') for redirection
                        let controllerSourceEntityType = 'RMA';
                        // The controller's sourceEntityId should be the ID of the page we are on (rma.id)
                        let controllerSourceEntityId = currentPageRmaId;

                        console.log("RMA Link button clicked:", this.dataset);
                        console.log("Item File Type:", itemFileType, "Button Source Entity Type:", buttonSourceEntityType, "Button Source Entity ID:", buttonSourceEntityId);
                        console.log("Initial itemDisplayName from data-file-name:", this.dataset.fileName);

                        if (itemFileType === 'MOVING_PART_RECORD') {
                            itemIdToLink = buttonSourceEntityId; // This IS the movingPart.id
                            itemFilePath = ''; 
                            // itemDisplayName is already set
                            // controllerSourceEntityType remains 'RMA' (page context)
                            // controllerSourceEntityId remains rma.id (page context)
                        } else { // 'document' or 'picture' from RMA
                            // itemIdToLink is already this.dataset.fileId (RmaDocument/Picture ID)
                            // itemFilePath is already this.dataset.filePath
                            // controllerSourceEntityType remains 'RMA'
                            // controllerSourceEntityId remains rma.id
                        }

                        document.getElementById('unifiedLinkFileIdInputRmaPage').value = itemIdToLink; 
                        document.getElementById('unifiedLinkFilePathInputRmaPage').value = itemFilePath;
                        document.getElementById('unifiedLinkOriginalFileNameInputRmaPage').value = itemDisplayName;
                        document.getElementById('unifiedLinkFileTypeInputRmaPage').value = itemFileType;
                        document.getElementById('unifiedLinkSourceEntityTypeInputRmaPage').value = controllerSourceEntityType; 
                        document.getElementById('unifiedLinkSourceEntityIdInputRmaPage').value = controllerSourceEntityId; 
                        document.getElementById('unifiedLinkFileNameDisplayRmaPage').textContent = itemDisplayName;
                        console.log("RMA Modal populated. FileNameDisplay:", itemDisplayName, "FileIdInput:", itemIdToLink, "SourceEntityIdInput:", controllerSourceEntityId);
                        
                        // Reset target selection
                        unifiedLinkTargetEntityTypeRmaPage.value = '';
                        unifiedLinkTargetRmaSectionRmaPage.style.display = 'none';
                        document.getElementById('unifiedLinkTargetRmaIdRmaPage').value = '';
                        unifiedLinkTargetToolSectionRmaPage.style.display = 'none';
                        document.getElementById('unifiedLinkTargetToolIdRmaPage').value = '';
                        unifiedLinkTargetTrackTrendSectionRmaPage.style.display = 'none';
                        document.getElementById('unifiedLinkTargetTrackTrendIdRmaPage').value = '';
                    });
                });

                unifiedLinkTargetEntityTypeRmaPage.addEventListener('change', function() {
                    unifiedLinkTargetRmaSectionRmaPage.style.display = this.value === 'RMA' ? 'block' : 'none';
                    unifiedLinkTargetToolSectionRmaPage.style.display = this.value === 'TOOL' ? 'block' : 'none';
                    unifiedLinkTargetTrackTrendSectionRmaPage.style.display = this.value === 'TRACK_TREND' ? 'block' : 'none';
                });
                
                const unifiedLinkFormRmaPage = document.getElementById('unifiedLinkFormRmaPage');
                if(unifiedLinkFormRmaPage) {
                    unifiedLinkFormRmaPage.addEventListener('submit', function(event) {
                        const targetType = unifiedLinkTargetEntityTypeRmaPage.value;
                        let targetId = '';
                        if (targetType === 'RMA') targetId = document.getElementById('unifiedLinkTargetRmaIdRmaPage').value;
                        else if (targetType === 'TOOL') targetId = document.getElementById('unifiedLinkTargetToolIdRmaPage').value;
                        else if (targetType === 'TRACK_TREND') targetId = document.getElementById('unifiedLinkTargetTrackTrendIdRmaPage').value;

                        if (!targetType || !targetId) {
                            alert('Please select both an entity type and a specific entity to link to.');
                            event.preventDefault(); 
                        }
                    });
                }
            }
            // --- End Unified Link File Modal Logic for RMA Page ---
        });
        
        // Function to handle image loading errors
        function handleImageError(imageElement) {
            // Prevent infinite recursion
            imageElement.onerror = null;
            
            // Get file path for debugging
            const filePath = imageElement.getAttribute('data-path') || 'Unknown path';
            
            // Hide the broken image
            imageElement.style.display = 'none';
            
            // Replace with error message
            const errorHtml = `
                <div class='text-center text-muted'>
                    <i class='bi bi-exclamation-triangle'></i>
                    <br>Image not found
                    <br><small class="text-danger">${filePath}</small>
                </div>`;
            
            imageElement.parentNode.innerHTML += errorHtml;
            
            // Log the error to console
            console.error('Failed to load image:', filePath);
            
            return true;
        }
    </script>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you like to handle this file?</p>
                    <input type="hidden" id="fileIdToDelete">
                    <input type="hidden" id="fileTypeToDelete">
                    <input type="hidden" id="rmaIdForDelete">
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOnly" value="unlink" checked>
                        <label class="form-check-label" for="deleteOnly">
                            <strong>Unlink only:</strong> Remove only from this RMA, keep in other locations
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteEverywhere" value="delete">
                        <label class="form-check-label" for="deleteEverywhere">
                            <strong>Delete everywhere:</strong> Remove from all locations
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transfer File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the RMA to transfer this file to:</p>
                    <form id="transferForm" action="/rma/file/transfer" method="post">
                        <input type="hidden" id="transferFileId" name="fileId">
                        <input type="hidden" id="transferFileType" name="fileType">
                        <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="targetRmaId" class="form-label">Target RMA</label>
                            <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                                <option value="">-- Select Target RMA --</option>
                                <!-- This will need to be populated from controller with available RMAs -->
                                <option th:each="otherRma : ${allRmas}" 
                                        th:if="${otherRma.id != rma.id}" 
                                        th:value="${otherRma.id}" 
                                        th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA-' + otherRma.id) + 
                                                (otherRma.customerName != null ? ' - ' + otherRma.customerName : '')}">
                                    RMA Number - Customer
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Link File Modal (Copied from tools/details.html, ensure allRmas, allTools, allTrackTrends are available) -->
    <div class="modal fade" id="unifiedLinkFileModal" tabindex="-1" aria-labelledby="unifiedLinkFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="unifiedLinkFormRmaPage" th:action="@{/files/link-entity}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unifiedLinkFileModalLabelRmaPage">Link File</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Link <strong id="unifiedLinkFileNameDisplayRmaPage">file_name_here</strong> to:</p>
                        
                        <input type="hidden" id="unifiedLinkFileIdInputRmaPage" name="fileId">
                        <input type="hidden" id="unifiedLinkFilePathInputRmaPage" name="filePath">
                        <input type="hidden" id="unifiedLinkFileTypeInputRmaPage" name="fileType">
                        <input type="hidden" id="unifiedLinkSourceEntityTypeInputRmaPage" name="sourceEntityType">
                        <input type="hidden" id="unifiedLinkSourceEntityIdInputRmaPage" name="sourceEntityId">
                        <input type="hidden" id="unifiedLinkOriginalFileNameInputRmaPage" name="originalFileName">

                        <div class="mb-3">
                            <label for="unifiedLinkTargetEntityTypeRmaPage" class="form-label">Link to Entity Type:</label>
                            <select id="unifiedLinkTargetEntityTypeRmaPage" name="targetEntityType" class="form-select" required>
                                <option value="">-- Select Entity Type --</option>
                                <option value="RMA">RMA</option>
                                <option value="TOOL">Tool</option>
                                <option value="TRACK_TREND">Track/Trend</option>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetRmaSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetRmaIdRmaPage" class="form-label">Select RMA:</label>
                            <select id="unifiedLinkTargetRmaIdRmaPage" name="targetRmaId" class="form-select">
                                <option value="">-- Select RMA --</option>
                                <th:block th:if="${allRmas != null}">
                                    <option th:each="rmaOption : ${allRmas}"
                                            th:if="${rmaOption.id != rma.id}" 
                                            th:value="${rmaOption.id}" 
                                            th:text="${(rmaOption.rmaNumber ?: ('RMA-' + rmaOption.id)) + (rmaOption.customerName != null ? ' - ' + rmaOption.customerName : '')}">
                                    </option>
                                </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetToolSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetToolIdRmaPage" class="form-label">Select Tool:</label>
                            <select id="unifiedLinkTargetToolIdRmaPage" name="targetToolId" class="form-select">
                                <option value="">-- Select Tool --</option>
                                <th:block th:if="${allTools != null}">
                                   <option th:each="toolOption : ${allTools}" 
                                           th:value="${toolOption.id}" 
                                           th:text="${toolOption.name + (toolOption.secondaryName != null ? ' (' + toolOption.secondaryName + ')' : '')}">
                                   </option>
                               </th:block>
                            </select>
                        </div>

                        <div id="unifiedLinkTargetTrackTrendSectionRmaPage" class="mb-3" style="display: none;">
                            <label for="unifiedLinkTargetTrackTrendIdRmaPage" class="form-label">Select Track/Trend:</label>
                            <select id="unifiedLinkTargetTrackTrendIdRmaPage" name="targetTrackTrendId" class="form-select">
                                <option value="">-- Select Track/Trend --</option>
                                 <th:block th:if="${allTrackTrends != null}"> <!-- Ensure allTrackTrends is passed to rma/view model -->
                                    <option th:each="tt : ${allTrackTrends}"
                                            th:value="${tt.id}"
                                            th:text="${tt.name + ' (' + #temporals.format(tt.startDate, 'yyyy-MM-dd') + ')'}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmUnifiedLinkBtnRmaPage">Link File</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- End Unified Link File Modal -->

    <!-- Delete RMA Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this RMA?</p>
                    <p class="text-danger fw-bold">This action cannot be undone!</p>
                    <p th:if="${rma.rmaNumber != null && !rma.rmaNumber.empty}">
                        <strong>RMA Number:</strong> <span th:text="${rma.rmaNumber}"></span>
                    </p>
                    <p th:if="${rma.sapNotificationNumber != null && !rma.sapNotificationNumber.empty}">
                        <strong>SAP Number:</strong> <span th:text="${rma.sapNotificationNumber}"></span>
                    </p>
                    <p th:if="${rma.tool != null}">
                        <strong>Tool:</strong> <span th:text="${rma.tool.name}"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/rma/delete/{id}(id=${rma.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Moving Part Modal -->
    <div class="modal fade" id="addMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/tools/{id}/moving-parts/add(id=${rma.tool.id})}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="partName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="partName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="fromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}"
                                            th:selected="${fromTool.id == rma.tool.id}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2">To:</strong>
                                <select class="form-select" id="toToolId" name="toToolId" required>
                                    <option value="">Select destination tool...</option>
                                    <option th:each="toTool : ${allTools}"
                                            th:value="${toTool.id}" 
                                            th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Moving Part Modal -->
    <div class="modal fade" id="editMovingPartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editMovingPartForm" th:action="@{/tools/{id}/moving-parts/0/edit(id=${rma.tool.id})}" method="post">
                    <input type="hidden" id="editMovingPartId" name="movingPartId" value="">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Moving Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editPartName" class="form-label">Part Name:</label>
                            <input type="text" class="form-control" id="editPartName" name="partName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Movement:</label>
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">From:</strong>
                                <select class="form-select" id="editFromToolId" name="fromToolId" required>
                                    <option value="">Select source tool...</option>
                                    <option th:each="fromTool : ${allTools}"
                                            th:value="${fromTool.id}" 
                                            th:text="${fromTool.name + (fromTool.secondaryName != null ? ' (' + fromTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2">To:</strong>
                                <select class="form-select" id="editToToolId" name="toToolId" required>
                                    <option value="">Select destination tool...</option>
                                    <option th:each="toTool : ${allTools}"
                                            th:value="${toTool.id}" 
                                            th:text="${toTool.name + (toTool.secondaryName != null ? ' (' + toTool.secondaryName + ')' : '')}">
                                        Tool Name
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes:</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html> 