<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-size: 0.9rem; /* Slightly smaller base font for compactness */
        }
        .table-compact th, .table-compact td {
            padding: 0.4rem 0.3rem; /* Reduced padding */
            font-size: 0.85rem; /* Smaller font in table */
            vertical-align: middle;
        }
        .table-compact th {
            white-space: normal; /* Allow header text to wrap */
            text-align: center;
        }
        .table-compact td {
             white-space: nowrap; /* Keep cell content on one line initially */
             overflow: hidden;
             text-overflow: ellipsis; /* Add ellipsis for overflowed content */
             max-width: 150px; /* Adjust as needed, especially for parts/comments */
             text-align: center; /* Center align data cells by default */
        }
        .table-compact td.allow-wrap {
            white-space: normal;
            word-break: break-word;
            text-align: left; /* Override to left-align for wrapped content */
        }

        .info-icon-interactive {
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #0d6efd; /* Bootstrap primary blue */
        }
        .info-icon-interactive:hover {
            transform: scale(1.2);
        }
        
        /* Popover for Problem Description */
        .problem-popover-icon {
            cursor: pointer;
            color: #17a2b8; /* Bootstrap info color */
        }
        .popover-header {
            font-size: 1rem;
            font-weight: bold;
        }
        .popover-body {
            font-size: 0.85rem;
        }
        .popover-body strong {
            display: inline-block;
            width: 100px; /* Adjust as needed */
        }
        .action-icon {
            font-size: 1.2rem;
            text-decoration: none;
        }
        .status-badge {
            font-size: 0.9rem !important; /* Larger than default badge font */
        }
        
        /* Moving Parts icon styling */
        .moving-parts-icon {
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #0d6efd; /* Bootstrap primary blue */
            color: white;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 0.9rem;
        }
        .moving-parts-icon:hover {
            transform: scale(1.1);
            background-color: #0b5ed7; /* Darker blue on hover */
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container-fluid mt-4">
        <div class="row mb-3 align-items-center">
            <div class="col">
                <h1 class="display-5">RMA List</h1>
            </div>
            <div class="col text-end">
                <a th:href="@{/rma/new}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> New RMA
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4>Manage RMAs</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-compact">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Tool</th>
                                <th style="width: 5%;">Parts</th>
                                <th style="width: 10%;">RMA Number</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 7%;">Written</th>
                                <th style="width: 7%;">RMA #<br>Provided</th>
                                <th style="width: 7%;">Shipping<br>Memo</th>
                                <th style="width: 6%;">Parts<br>Received</th>
                                <th style="width: 6%;">Parts<br>Installed</th>
                                <th style="width: 6%;">Failed Parts<br>Ready</th>
                                <th style="width: 6%;">Failed Parts<br>Shipped</th>
                                <th style="width: 7%;">Moving Parts</th>
                                <th style="width: 7%;">Comments</th>
                                <th style="width: 3%;"></th> <!-- View Action -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="rma : ${rmas}" th:object="${rma}">
                                <!-- Tool -->
                                <td>
                                    <a th:if="*{tool != null}" th:href="@{/tools/{id}(id=*{tool.id})}" th:text="*{tool.name}" class="text-decoration-hover-underline"></a>
                                    <span th:if="*{tool == null}">N/A</span>
                                    <span th:if="*{tool != null}">
                                        <i class="bi bi-info-circle-fill problem-popover-icon ms-1"
                                           data-bs-toggle="popover"
                                           data-bs-placement="right"
                                           data-bs-trigger="hover focus click"
                                           data-bs-html="true"
                                           th:data-bs-title="*{tool.name}"
                                           th:data-bs-content="|*{tool.toolType ?: 'Unknown Type'}*{tool.model1 != null ? '<br>Model: ' + tool.model1 : ''}*{tool.serialNumber1 != null ? '<br>Serial: ' + tool.serialNumber1 : ''}|">
                                        </i>
                                    </span>
                                </td>
                                <!-- Parts -->
                                <td class="allow-wrap">
                                    <span th:if="${#lists.isEmpty(rma.partLineItems)}">N/A</span>
                                    <ul th:unless="${#lists.isEmpty(rma.partLineItems)}" class="list-unstyled mb-0" style="font-size: 0.9em;">
                                        <li th:each="item : *{partLineItems}" th:text="${item.partName ?: item.partNumber ?: item.productDescription}"></li>
                                    </ul>
                                </td>
                                <!-- RMA Number & Problem Description Popover -->
                                <td>
                                    <a th:href="@{/rma/{id}(id=*{id})}"
                                       th:text="*{rmaNumber != null and rmaNumber != '' ? rmaNumber : (sapNotificationNumber != null and sapNotificationNumber != '' ? sapNotificationNumber : 'N/A')}"
                                       class="text-decoration-hover-underline"></a>
                                    <i class="bi bi-info-circle-fill problem-popover-icon ms-1"
                                       data-bs-toggle="popover"
                                       data-bs-placement="right"
                                       data-bs-trigger="hover focus click"
                                       data-bs-html="true"
                                       th:attr="data-bs-title='Problem Details for ' + (*{rmaNumber} != null ? *{rmaNumber} : 'N/A'),
                                                data-bs-content='<strong>Who:</strong> ' + (*{problemDiscoverer} ?: 'N/A') + '<br>' +
                                                                '<strong>When:</strong> ' + (*{problemDiscoveryDate != null ? #temporals.format(problemDiscoveryDate, 'MM/dd/yy') : 'N/A'}) + '<br>' +
                                                                '<strong>What:</strong> ' + (*{whatHappened} ?: 'N/A') + '<br>' +
                                                                '<strong>Why:</strong> ' + (*{whyAndHowItHappened} ?: 'N/A') + '<br>' +
                                                                '<strong>How:</strong> ' + (*{howContained} ?: 'N/A') + '<br>' +
                                                                '<strong>By:</strong> ' + (*{whoContained} ?: 'N/A')"></i>
                                </td>
                                <!-- Status -->
                                <td class="text-center">
                                    <span th:if="*{status != null}" th:switch="*{status.name()}">
                                        <span th:case="'RMA_WRITTEN_EMAILED'" class="badge rounded-pill bg-primary status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'NUMBER_PROVIDED'" class="badge rounded-pill bg-info status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'MEMO_EMAILED'" class="badge rounded-pill bg-secondary status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'RECEIVED_PARTS'" class="badge rounded-pill bg-warning text-dark status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'WAITING_CUSTOMER'" class="badge rounded-pill bg-danger status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'WAITING_FSE'" class="badge rounded-pill bg-danger status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'COMPLETED'" class="badge rounded-pill bg-success status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="*" class="badge rounded-pill bg-light text-dark status-badge" th:text="*{status.displayName}"></span>
                                    </span>
                                    <span th:if="*{status == null}" class="badge rounded-pill bg-light text-dark status-badge">N/A</span>
                                </td>
                                <!-- Written Date -->
                                <td th:text="*{writtenDate != null ? #temporals.format(writtenDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- RMA # Provided Date -->
                                <td th:text="*{rmaNumberProvidedDate != null ? #temporals.format(rmaNumberProvidedDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- Shipping Memo Emailed Date -->
                                <td th:text="*{shippingMemoEmailedDate != null ? #temporals.format(shippingMemoEmailedDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- Parts Received Date -->
                                <td th:text="*{partsReceivedDate != null ? #temporals.format(partsReceivedDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- Parts Installed Date -->
                                <td th:text="*{installedPartsDate != null ? #temporals.format(installedPartsDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- Failed Parts Packed Date (as Failed Parts Ready) -->
                                <td th:text="*{failedPartsPackedDate != null ? #temporals.format(failedPartsPackedDate, 'MM/dd/yy') : 'N/A'}"></td>
                                <!-- Failed Parts Shipped Date -->
                                <td th:text="*{failedPartsShippedDate != null ? #temporals.format(failedPartsShippedDate, 'MM/dd/yy') : 'N/A'}"></td>
                                
                                <!-- Moving Parts -->
                                <td class="text-center">
                                    <span th:if="${movingPartsMap != null and movingPartsMap.containsKey(rma.id) and not #lists.isEmpty(movingPartsMap[rma.id])}">
                                        <i class="bi bi-arrow-left-right moving-parts-icon"
                                           data-bs-toggle="popover"
                                           data-bs-placement="left"
                                           data-bs-trigger="hover focus click"
                                           data-bs-html="true"
                                           th:attr="data-bs-title='Moving Parts (' + ${#lists.size(movingPartsMap[rma.id])} + ')'"
                                           th:data-bs-content="${#strings.listJoin(movingPartsMap[rma.id].![
                                               '<div><strong>' + (partName ?: 'Unknown Part') + '</strong><br>' +
                                               (fromTool != null ? fromTool.name : 'No Tool') + ' → ' +
                                               (hasDestinationChain() ? 
                                                   'Multiple Destinations' :
                                                   (toTool != null ? toTool.name : 'No Tool')
                                               ) + '</div>'
                                           ], '<hr style=&quot;margin: 8px 0;&quot;>')}"
                                        ></i>
                                    </span>
                                    <span th:if="${movingPartsMap == null or !movingPartsMap.containsKey(rma.id) or #lists.isEmpty(movingPartsMap[rma.id])}">
                                        <i class="bi bi-arrow-left-right text-muted"></i> <!-- Greyed out icon -->
                                    </span>
                                </td>

                                <!-- Comments -->
                                <td class="text-center">
                                    <!-- Always show comment icon -->
                                    <i th:class="${'bi bi-chat-dots-fill ' + (not #lists.isEmpty(rma.comments) ? 'info-icon-interactive' : 'text-muted')}"
                                       th:if="${not #lists.isEmpty(rma.comments)}"
                                       data-bs-toggle="popover"
                                       data-bs-placement="left"
                                       data-bs-trigger="hover focus click"
                                       data-bs-html="true"
                                       th:attr="data-bs-title='Comments (' + ${#lists.size(rma.comments)} + ')'"
                                       th:data-bs-content="${#strings.listJoin(rma.comments.![
                                           '<div class=&quot;mb-2&quot;><small class=&quot;text-muted&quot;>' + 
                                           #temporals.format(createdDate, 'MM/dd/yy HH:mm') + 
                                           (user != null ? ' by ' + (user.name ?: 'Unknown') : '') + 
                                           '</small><br/>' + 
                                           (content ?: 'No content') + '</div>'
                                       ], '<hr class=&quot;my-1&quot;/>')}"
                                    ></i>
                                    
                                    <!-- Greyed out icon when no comments -->
                                    <i th:if="${#lists.isEmpty(rma.comments)}" 
                                       class="bi bi-chat-dots text-muted">
                                    </i>
                                    
                                    <!-- Comment count -->
                                    <span th:text="${#lists.size(rma.comments)}" class="ms-1 small"></span>
                                </td>
                                <!-- View Action -->
                                <td class="text-center">
                                    <a th:href="@{/rma/{id}(id=*{id})}" class="action-icon" title="View RMA">
                                        <i class="bi bi-eye-fill"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap Popovers
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {
                sanitize: false, // Allow HTML in content
                fallbackPlacements: ['left', 'top', 'bottom'],
                container: 'body' // Added to help with potential positioning/event issues
            });
                });
                
        // Close popovers when clicking outside
        document.addEventListener('click', function (event) {
            popoverList.forEach(function (popover) {
                var triggerElement = popover._element;
                var popoverId = triggerElement.getAttribute('aria-describedby');
                var popoverElement = popoverId ? document.getElementById(popoverId) : null;
                
                var isClickInsideTrigger = triggerElement.contains(event.target);
                var isClickInsidePopover = popoverElement ? popoverElement.contains(event.target) : false;
            
                // Hide popover if clicking outside both trigger and popover content
                // This works for all trigger types including "hover focus click"
                if (!isClickInsideTrigger && !isClickInsidePopover) {
                    popover.hide();
                }
            });
        });
                
        // REMOVE custom tooltip JavaScript functions as they are no longer used.
        // function showRmaTooltip(element, id, type) { ... }
        // function hideRmaTooltip(element) { ... }
        // function toggleRmaTooltipPin(element, id, type) { ... }

    </script>
</body>
</html> 