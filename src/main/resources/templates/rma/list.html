<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Data Table Component CSS -->
    <link th:href="@{/css/components/data-table.css}" rel="stylesheet">
    <link th:href="@{/dark-mode.css}" rel="stylesheet">
    <style>
        .content-area {
            font-size: 0.9rem;
        }

        /* Popover for Problem Description */
        .problem-popover-icon {
            cursor: pointer;
            color: #17a2b8; /* Bootstrap info color */
        }
        .popover-header {
            font-size: 1rem;
            font-weight: bold;
        }
        .popover-body {
            font-size: 0.85rem;
        }
        .popover-body strong {
            display: inline-block;
            width: 100px;
        }
        .status-badge {
            font-size: 0.9rem !important;
        }
        
        /* Moving Parts icon styling */
        .moving-parts-icon {
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #0d6efd; /* Bootstrap primary blue */
            color: white;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 0.9rem;
        }
        .moving-parts-icon:hover {
            transform: scale(1.1);
            background-color: #0b5ed7; /* Darker blue on hover */
        }
        
        /* RMA-specific sorting arrows using Bootstrap icons */
        .sort-arrows {
            margin-left: 4px;
            display: inline-flex;
            flex-direction: column;
            line-height: 0.6;
            flex-shrink: 0;
        }
        
        /* RMA-specific status filter dropdown */
        .status-filter-header .dropdown-toggle {
            border: none;
            padding: 2px 6px;
        }
        .status-filter-header .dropdown-toggle:focus {
            box-shadow: none;
        }
        
        /* Fixed square status count badges */
        .status-count-square {
            width: 28px;
            height: 20px;
            min-width: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        /* Status filter item layout */
        .status-filter-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            min-height: 32px;
            padding: 4px 0;
        }
        
        .status-filter-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        /* Ensure minimum height for RMA list to prevent cutoff */
        .rma-table-container {
            min-height: 600px;
        }
        
        .card-body {
            min-height: 500px;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container-fluid mt-4 content-area">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-clipboard-list me-2"></i>
                    RMA Management
                </h2>
            </div>
            <div>
                <a th:href="@{/rma/new}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    New RMA
                </a>
            </div>
        </div>

        <!-- Data Table Container -->
        <div class="data-table-container">
            
            <!-- Search Controls -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="rmaSearchInput"
                            placeholder="Search by tool, parts, or part number..."
                            aria-label="Search">
                        <button 
                            class="btn btn-outline-secondary" 
                            type="button" 
                            id="clearSearch"
                            title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Responsive Table Container -->
                        <div class="data-table-responsive table-responsive rma-table-container" id="rma-table-container">
                <table class="table table-striped data-table-compact">
                        <thead>
                            <tr>
                                <th style="width: 15%;" class="sortable-header" data-sort="tool">
                                    <div class="header-content">
                                        <span class="header-text">Tool</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 12%;">Parts</th>
                                <th style="width: 12%;" class="sortable-header" data-sort="rma-number">
                                    <div class="header-content">
                                        <span class="header-text">RMA Number</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 12%;" class="status-filter-header">
                                    Status
                                    <div class="dropdown d-inline-block ms-1">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-funnel"></i>
                                        </button>
                                        <ul class="dropdown-menu p-2" aria-labelledby="statusFilterDropdown" style="min-width: 280px;">
                                            <li class="dropdown-item-text">
                                                <small class="text-muted">Filter by Status:</small>
                                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="showAllStatuses">Show All</button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-primary status-count-square status-count" data-status="RMA_WRITTEN_EMAILED">0</span>
                                                        <span>RMA Written - Emailed</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="RMA_WRITTEN_EMAILED" id="status-RMA_WRITTEN_EMAILED" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-info status-count-square status-count" data-status="NUMBER_PROVIDED">0</span>
                                                        <span>RMA Number Provided</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="NUMBER_PROVIDED" id="status-NUMBER_PROVIDED" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-secondary status-count-square status-count" data-status="MEMO_EMAILED">0</span>
                                                        <span>Shipping Memo Emailed</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="MEMO_EMAILED" id="status-MEMO_EMAILED" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-warning text-dark status-count-square status-count" data-status="RECEIVED_PARTS">0</span>
                                                        <span>Received Parts</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="RECEIVED_PARTS" id="status-RECEIVED_PARTS" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-danger status-count-square status-count" data-status="WAITING_CUSTOMER">0</span>
                                                        <span>Waiting on Customer</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="WAITING_CUSTOMER" id="status-WAITING_CUSTOMER" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-danger status-count-square status-count" data-status="WAITING_FSE">0</span>
                                                        <span>Waiting on FSE</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="WAITING_FSE" id="status-WAITING_FSE" checked>
                                                </div>
                                            </li>
                                            <li class="dropdown-item-text">
                                                <div class="status-filter-item">
                                                    <div class="status-filter-left">
                                                        <span class="badge bg-success status-count-square status-count" data-status="COMPLETED">0</span>
                                                        <span>Completed</span>
                                                    </div>
                                                    <input class="form-check-input status-filter" type="checkbox" value="COMPLETED" id="status-COMPLETED" checked>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="written-date">
                                    <div class="header-content">
                                        <span class="header-text">Written</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="rma-provided-date">
                                    <div class="header-content">
                                        <span class="header-text">RMA # Provided</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="shipping-memo-date">
                                    <div class="header-content">
                                        <span class="header-text">Shipping Memo</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="parts-received-date">
                                    <div class="header-content">
                                        <span class="header-text">Parts Received</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="parts-installed-date">
                                    <div class="header-content">
                                        <span class="header-text">Parts Installed</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="failed-parts-ready-date">
                                    <div class="header-content">
                                        <span class="header-text">Failed Parts Ready</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 8%;" class="sortable-header" data-sort="failed-parts-shipped-date">
                                    <div class="header-content">
                                        <span class="header-text">Failed Parts Shipped</span>
                                        <span class="sort-arrows">
                                            <i class="bi bi-caret-up sort-up"></i>
                                            <i class="bi bi-caret-down sort-down"></i>
                                        </span>
                                    </div>
                                </th>
                                <th style="width: 5%;">Moving Parts</th>
                                <th style="width: 5%;">Comments</th>
                                <th style="width: 3%;"></th> <!-- View Action -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="rma : ${rmas}" th:object="${rma}" class="data-table-row rma-row"
                                th:attr="data-tool=*{tool != null ? tool.name : ''},
                                         data-parts=${#strings.listJoin(rma.partLineItems.![partName ?: partNumber ?: productDescription], ' ')},
                                         data-part-numbers=${#strings.listJoin(rma.partLineItems.![partNumber], ' ')},
                                         data-rma-number=*{rmaNumber ?: sapNotificationNumber ?: ''},
                                         data-status=*{status != null ? status.name() : ''},
                                         data-written-date=*{writtenDate != null ? #temporals.format(writtenDate, 'yyyy-MM-dd') : ''},
                                         data-rma-provided-date=*{rmaNumberProvidedDate != null ? #temporals.format(rmaNumberProvidedDate, 'yyyy-MM-dd') : ''},
                                         data-shipping-memo-date=*{shippingMemoEmailedDate != null ? #temporals.format(shippingMemoEmailedDate, 'yyyy-MM-dd') : ''},
                                         data-parts-received-date=*{partsReceivedDate != null ? #temporals.format(partsReceivedDate, 'yyyy-MM-dd') : ''},
                                         data-parts-installed-date=*{installedPartsDate != null ? #temporals.format(installedPartsDate, 'yyyy-MM-dd') : ''},
                                         data-failed-parts-ready-date=*{failedPartsPackedDate != null ? #temporals.format(failedPartsPackedDate, 'yyyy-MM-dd') : ''},
                                         data-failed-parts-shipped-date=*{failedPartsShippedDate != null ? #temporals.format(failedPartsShippedDate, 'yyyy-MM-dd') : ''}">
                                <!-- Tool -->
                                <td>
                                    <a th:if="*{tool != null}" th:href="@{/tools/{id}(id=*{tool.id})}" th:text="*{tool.name}" class="text-decoration-hover-underline"></a>
                                    <span th:if="*{tool == null}">N/A</span>
                                    <span th:if="*{tool != null}">
                                        <i class="bi bi-info-circle-fill problem-popover-icon ms-1"
                                           data-bs-toggle="popover"
                                           data-bs-placement="right"
                                           data-bs-trigger="hover focus click"
                                           data-bs-html="true"
                                           th:data-bs-title="*{tool.name}"
                                           th:data-bs-content="|*{tool.toolType ?: 'Unknown Type'}*{tool.model1 != null ? '<br>Model: ' + tool.model1 : ''}*{tool.serialNumber1 != null ? '<br>Serial: ' + tool.serialNumber1 : ''}|">
                                        </i>
                                    </span>
                                </td>
                                <!-- Parts -->
                                <td class="allow-wrap">
                                    <span th:if="${#lists.isEmpty(rma.partLineItems)}">N/A</span>
                                    <ul th:unless="${#lists.isEmpty(rma.partLineItems)}" class="list-unstyled mb-0" style="font-size: 0.9em;">
                                        <li th:each="item : *{partLineItems}" th:text="${item.partName ?: item.partNumber ?: item.productDescription}"></li>
                                    </ul>
                                </td>
                                <!-- RMA Number & Problem Description Popover -->
                                <td>
                                    <a th:href="@{/rma/{id}(id=*{id})}"
                                       th:text="*{rmaNumber != null and rmaNumber != '' ? rmaNumber : (sapNotificationNumber != null and sapNotificationNumber != '' ? sapNotificationNumber : 'N/A')}"
                                       class="text-decoration-hover-underline"></a>
                                    <i class="bi bi-info-circle-fill problem-popover-icon ms-1"
                                       data-bs-toggle="popover"
                                       data-bs-placement="right"
                                       data-bs-trigger="hover focus click"
                                       data-bs-html="true"
                                       th:attr="data-bs-title='Problem Details for ' + (*{rmaNumber} != null ? *{rmaNumber} : '-'),
                                                data-bs-content='<strong>Who:</strong> ' + (*{problemDiscoverer} ?: '-') + '<br>' +
                                                                '<strong>When:</strong> ' + (*{problemDiscoveryDate != null ? #temporals.format(problemDiscoveryDate, 'MM/dd/yy') : '-'}) + '<br>' +
                                                                '<strong>What:</strong> ' + (*{whatHappened} ?: '-') + '<br>' +
                                                                '<strong>Why:</strong> ' + (*{whyAndHowItHappened} ?: '-') + '<br>' +
                                                                '<strong>How:</strong> ' + (*{howContained} ?: '-') + '<br>' +
                                                                '<strong>By:</strong> ' + (*{whoContained} ?: '-')"></i>
                                </td>
                                <!-- Status -->
                                <td class="text-center">
                                    <span th:if="*{status != null}" th:switch="*{status.name()}">
                                        <span th:case="'RMA_WRITTEN_EMAILED'" class="badge rounded-pill bg-primary status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'NUMBER_PROVIDED'" class="badge rounded-pill bg-info status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'MEMO_EMAILED'" class="badge rounded-pill bg-secondary status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'RECEIVED_PARTS'" class="badge rounded-pill bg-warning text-dark status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'WAITING_CUSTOMER'" class="badge rounded-pill bg-danger status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'WAITING_FSE'" class="badge rounded-pill bg-danger status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="'COMPLETED'" class="badge rounded-pill bg-success status-badge" th:text="*{status.displayName}"></span>
                                        <span th:case="*" class="badge rounded-pill bg-light text-dark status-badge" th:text="*{status.displayName}"></span>
                                    </span>
                                    <span th:if="*{status == null}" class="badge rounded-pill bg-light text-dark status-badge">N/A</span>
                                </td>
                                <!-- Written Date -->
                                <td th:text="*{writtenDate != null ? #temporals.format(writtenDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- RMA # Provided Date -->
                                <td th:text="*{rmaNumberProvidedDate != null ? #temporals.format(rmaNumberProvidedDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- Shipping Memo Emailed Date -->
                                <td th:text="*{shippingMemoEmailedDate != null ? #temporals.format(shippingMemoEmailedDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- Parts Received Date -->
                                <td th:text="*{partsReceivedDate != null ? #temporals.format(partsReceivedDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- Parts Installed Date -->
                                <td th:text="*{installedPartsDate != null ? #temporals.format(installedPartsDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- Failed Parts Packed Date (as Failed Parts Ready) -->
                                <td th:text="*{failedPartsPackedDate != null ? #temporals.format(failedPartsPackedDate, 'MM/dd/yy') : '-'}"></td>
                                <!-- Failed Parts Shipped Date -->
                                <td th:text="*{failedPartsShippedDate != null ? #temporals.format(failedPartsShippedDate, 'MM/dd/yy') : '-'}"></td>
                                
                                <!-- Moving Parts -->
                                <td class="text-center">
                                    <span th:if="${movingPartsMap != null and movingPartsMap.containsKey(rma.id) and not #lists.isEmpty(movingPartsMap[rma.id])}">
                                        <i class="bi bi-arrow-left-right moving-parts-icon"
                                           data-bs-toggle="popover"
                                           data-bs-placement="left"
                                           data-bs-trigger="hover focus click"
                                           data-bs-html="true"
                                           th:attr="data-bs-title='Moving Parts (' + ${#lists.size(movingPartsMap[rma.id])} + ')'"
                                           th:data-bs-content="${#strings.listJoin(movingPartsMap[rma.id].![
                                               '<div><strong>' + (partName ?: 'Unknown Part') + '</strong><br>' +
                                               (fromTool != null ? fromTool.name : 'No Tool') + ' â†’ ' +
                                               (hasDestinationChain() ? 
                                                   'Multiple Destinations' :
                                                   (toTool != null ? toTool.name : 'No Tool')
                                               ) + '</div>'
                                           ], '<hr style=&quot;margin: 8px 0;&quot;>')}"
                                        ></i>
                                    </span>
                                    <span th:if="${movingPartsMap == null or !movingPartsMap.containsKey(rma.id) or #lists.isEmpty(movingPartsMap[rma.id])}">
                                        <i class="bi bi-arrow-left-right text-muted"></i> <!-- Greyed out icon -->
                                    </span>
                                </td>

                                <!-- Comments -->
                                <td class="text-center">
                                    <!-- Always show comment icon -->
                                    <i th:class="${'bi bi-chat-dots-fill ' + (not #lists.isEmpty(rma.comments) ? 'info-icon-interactive' : 'text-muted')}"
                                       th:if="${not #lists.isEmpty(rma.comments)}"
                                       data-bs-toggle="popover"
                                       data-bs-placement="left"
                                       data-bs-trigger="hover focus click"
                                       data-bs-html="true"
                                       th:attr="data-bs-title='Comments (' + ${#lists.size(rma.comments)} + ')'"
                                       th:data-bs-content="${#strings.listJoin(rma.comments.![
                                           '<div class=&quot;mb-2&quot;><small class=&quot;text-muted&quot;>' + 
                                           #temporals.format(createdDate, 'MM/dd/yy HH:mm') + 
                                           (user != null ? ' by ' + (user.name ?: 'Unknown') : '') + 
                                           '</small><br/>' + 
                                           (content ?: 'No content') + '</div>'
                                       ], '<hr class=&quot;my-1&quot;/>')}"
                                    ></i>
                                    
                                    <!-- Greyed out icon when no comments -->
                                    <i th:if="${#lists.isEmpty(rma.comments)}" 
                                       class="bi bi-chat-dots text-muted">
                                    </i>
                                    
                                    <!-- Comment count -->
                                    <span th:text="${#lists.size(rma.comments)}" class="ms-1 small"></span>
                                </td>
                                <!-- View Action -->
                                <td class="text-center">
                                    <a th:href="@{/rma/{id}(id=*{id})}" class="action-icon" title="View RMA">
                                        <i class="bi bi-eye-fill"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Results summary -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small class="text-muted">
                            Showing <span id="rma-count">0</span> 
                            <span id="rma-count-text">RMAs</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap Popovers
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {
                sanitize: false, // Allow HTML in content
                fallbackPlacements: ['left', 'top', 'bottom'],
                container: 'body' // Added to help with potential positioning/event issues
            });
        });
                
        // Close popovers when clicking outside
        document.addEventListener('click', function (event) {
            popoverList.forEach(function (popover) {
                var triggerElement = popover._element;
                var popoverId = triggerElement.getAttribute('aria-describedby');
                var popoverElement = popoverId ? document.getElementById(popoverId) : null;
                
                var isClickInsideTrigger = triggerElement.contains(event.target);
                var isClickInsidePopover = popoverElement ? popoverElement.contains(event.target) : false;
            
                // Hide popover if clicking outside both trigger and popover content
                if (!isClickInsideTrigger && !isClickInsidePopover) {
                    popover.hide();
                }
            });
        });

        // RMA Management functionality
        class RMAManager {
            constructor() {
                this.currentSort = null;
                this.sortDirection = 'asc';
                this.currentSearch = '';
                this.visibleStatuses = new Set(['RMA_WRITTEN_EMAILED', 'NUMBER_PROVIDED', 'MEMO_EMAILED', 'RECEIVED_PARTS', 'WAITING_CUSTOMER', 'WAITING_FSE', 'COMPLETED']);
                this.totalStatusCounts = {}; // Track total counts across all RMAs
                
                this.init();
                this.calculateTotalStatusCounts();
                this.updateStatusCounts();
                this.updateRmaCount();
            }

            init() {
                // Search functionality
                const searchInput = document.getElementById('rmaSearchInput');
                const clearSearchButton = document.getElementById('clearSearch');
                
                searchInput.addEventListener('input', (e) => {
                    this.currentSearch = e.target.value.toLowerCase();
                    this.filterTable();
                });
                
                clearSearchButton.addEventListener('click', () => {
                    searchInput.value = '';
                    this.currentSearch = '';
                    this.filterTable();
                });

                // Sorting functionality
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        // Ignore clicks on dropdowns or their children
                        if (e.target.closest('[data-bs-toggle="dropdown"]') || 
                            e.target.closest('.dropdown') || 
                            e.target.closest('.dropdown-menu')) {
                            return; // Don't handle sort for dropdown clicks
                        }
                        
                        const sortType = header.getAttribute('data-sort');
                        this.handleSort(sortType, header);
                    });
                });

                // Status filtering
                document.querySelectorAll('.status-filter').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const status = e.target.value;
                        if (e.target.checked) {
                            this.visibleStatuses.add(status);
                        } else {
                            // Prevent unchecking all statuses (keep at least one visible)
                            if (this.visibleStatuses.size === 1) {
                                e.preventDefault();
                                e.target.checked = true;
                                return;
                            }
                            this.visibleStatuses.delete(status);
                        }
                        this.filterTable();
                    });
                });

                // Show All button
                const showAllButton = document.getElementById('showAllStatuses');
                if (showAllButton) {
                    showAllButton.addEventListener('click', () => {
                        // Check all checkboxes
                        document.querySelectorAll('.status-filter').forEach(checkbox => {
                            checkbox.checked = true;
                            this.visibleStatuses.add(checkbox.value);
                        });
                        this.filterTable();
                    });
                }
            }

            handleSort(sortType, header) {
                // Remove sort classes from all headers
                document.querySelectorAll('.sortable-header').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });

                // Determine sort direction
                if (this.currentSort === sortType) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortDirection = 'asc';
                }
                
                this.currentSort = sortType;
                header.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

                this.sortTable(sortType, this.sortDirection);
            }

            sortTable(sortType, direction) {
                const tbody = document.querySelector('tbody');
                const rows = Array.from(document.querySelectorAll('.rma-row'));

                rows.sort((a, b) => {
                    let aVal, bVal;

                    switch (sortType) {
                        case 'tool':
                            aVal = a.getAttribute('data-tool') || '';
                            bVal = b.getAttribute('data-tool') || '';
                            break;
                        case 'rma-number':
                            aVal = a.getAttribute('data-rma-number') || '';
                            bVal = b.getAttribute('data-rma-number') || '';
                            break;
                        case 'written-date':
                        case 'rma-provided-date':
                        case 'shipping-memo-date':
                        case 'parts-received-date':
                        case 'parts-installed-date':
                        case 'failed-parts-ready-date':
                        case 'failed-parts-shipped-date':
                            aVal = a.getAttribute(`data-${sortType}`) || '';
                            bVal = b.getAttribute(`data-${sortType}`) || '';
                            // Convert to date for comparison, empty dates go to end
                            aVal = aVal ? new Date(aVal) : new Date('9999-12-31');
                            bVal = bVal ? new Date(bVal) : new Date('9999-12-31');
                            break;
                        default:
                            return 0;
                    }

                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                        return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                });

                // Clear and re-append sorted rows
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            }

            filterTable() {
                const rows = document.querySelectorAll('.rma-row');
                
                rows.forEach(row => {
                    const tool = row.getAttribute('data-tool').toLowerCase();
                    const parts = row.getAttribute('data-parts').toLowerCase();
                    const partNumbers = row.getAttribute('data-part-numbers').toLowerCase();
                    const rmaNumber = row.getAttribute('data-rma-number').toLowerCase();
                    const status = row.getAttribute('data-status');

                    // Check search criteria
                    const matchesSearch = !this.currentSearch || 
                        tool.includes(this.currentSearch) || 
                        parts.includes(this.currentSearch) || 
                        partNumbers.includes(this.currentSearch) ||
                        rmaNumber.includes(this.currentSearch);

                    // Check status filter
                    const matchesStatus = this.visibleStatuses.has(status);

                    if (matchesSearch && matchesStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                this.updateStatusCounts();
                this.updateRmaCount();
            }

            updateRmaCount() {
                const visibleRows = document.querySelectorAll('.rma-row:not([style*="display: none"])');
                const count = visibleRows.length;
                document.getElementById('rma-count').textContent = count;
                document.getElementById('rma-count-text').textContent = count === 1 ? 'RMA' : 'RMAs';
            }

            calculateTotalStatusCounts() {
                // Count all RMAs by status (regardless of filters)
                document.querySelectorAll('.rma-row').forEach(row => {
                    const status = row.getAttribute('data-status');
                    if (status) {
                        this.totalStatusCounts[status] = (this.totalStatusCounts[status] || 0) + 1;
                    }
                });
            }

            updateStatusCounts() {
                // Always show total counts, not filtered counts
                // This ensures counts don't disappear when everything is unchecked
                document.querySelectorAll('.status-count').forEach(badge => {
                    const status = badge.getAttribute('data-status');
                    badge.textContent = this.totalStatusCounts[status] || 0;
                });
            }
        }

        // Initialize RMA Manager when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new RMAManager();
            
            // Enhanced horizontal scrolling functionality
            const tableContainer = document.querySelector('.rma-table-container');
            
            if (tableContainer) {
                // Shift + mouse wheel for horizontal scrolling
                tableContainer.addEventListener('wheel', function(e) {
                    if (e.shiftKey) {
                        e.preventDefault();
                        tableContainer.scrollLeft += e.deltaY;
                    }
                });
                
                // Click and drag to scroll horizontally
                let isDown = false;
                let startX;
                let scrollLeft;
                let hasDragged = false;
                
                tableContainer.addEventListener('mousedown', function(e) {
                    // Only start drag if clicking on the container itself, not interactive elements
                    if (e.target.closest('a, button, input, .dropdown, [data-bs-toggle]')) {
                        return;
                    }
                    
                    isDown = true;
                    hasDragged = false;
                    tableContainer.classList.add('dragging');
                    startX = e.pageX - tableContainer.offsetLeft;
                    scrollLeft = tableContainer.scrollLeft;
                });
                
                tableContainer.addEventListener('mouseleave', function() {
                    isDown = false;
                    tableContainer.classList.remove('dragging');
                    // Reset drag flag after a short delay
                    setTimeout(() => { hasDragged = false; }, 100);
                });
                
                tableContainer.addEventListener('mouseup', function() {
                    isDown = false;
                    tableContainer.classList.remove('dragging');
                    // Reset drag flag after a short delay to allow click detection
                    setTimeout(() => { hasDragged = false; }, 100);
                });
                
                tableContainer.addEventListener('mousemove', function(e) {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - tableContainer.offsetLeft;
                    const walk = (x - startX) * 2; // Scroll speed multiplier
                    
                    // Mark as dragged if mouse moved more than 5 pixels
                    if (Math.abs(walk) > 5) {
                        hasDragged = true;
                    }
                    
                    tableContainer.scrollLeft = scrollLeft - walk;
                });
                
                // Keyboard arrow keys for horizontal scrolling
                document.addEventListener('keydown', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    if (e.key === 'ArrowLeft' && e.shiftKey) {
                        e.preventDefault();
                        tableContainer.scrollLeft -= 50;
                    } else if (e.key === 'ArrowRight' && e.shiftKey) {
                        e.preventDefault();
                        tableContainer.scrollLeft += 50;
                                         }
                 });
                 
                                 // Clickable table rows
                const rmaRows = document.querySelectorAll('.rma-row');
                rmaRows.forEach(row => {
                    row.addEventListener('click', function(e) {
                        // Don't navigate if we just finished dragging
                        if (hasDragged) {
                            return;
                        }
                        
                        // Don't navigate if clicking on interactive elements
                        if (e.target.closest('a, button, input, .dropdown, [data-bs-toggle], .moving-parts-icon, .problem-popover-icon, .info-icon-interactive')) {
                            return;
                        }
                        
                        // Get the RMA ID from the view action link
                        const viewLink = row.querySelector('a[href*="/rma/"]');
                        if (viewLink) {
                            const href = viewLink.getAttribute('href');
                            if (href) {
                                window.location.href = href;
                            }
                        }
                    });
                });
             }
        });
    </script>
    
    <!-- Bootstrap JavaScript - MUST load before theme toggle for dropdowns to work -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Theme Toggle JavaScript -->
    <script th:src="@{/js/theme-toggle.js}"></script>
    
        <!-- Dropdown fix for RMA page -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fix dropdown functionality on this page
            const statusDropdown = document.getElementById('statusFilterDropdown');
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (statusDropdown) {
                statusDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const dropdownInstance = bootstrap.Dropdown.getInstance(statusDropdown) || new bootstrap.Dropdown(statusDropdown);
                    dropdownInstance.toggle();
                });
            }
            
            if (profileDropdown) {
                profileDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const dropdownInstance = bootstrap.Dropdown.getInstance(profileDropdown) || new bootstrap.Dropdown(profileDropdown);
                    dropdownInstance.toggle();
                });
            }
        });
    </script>
</body>
</html> 