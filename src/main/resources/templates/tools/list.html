<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools List</title>
    <!-- Immediate theme application to prevent flash -->
    <script th:src="@{/js/theme-instant.js}"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/components/data-table.css}">
    <style>
        /* Info icon styles for notes - matching RMA comments */
        .info-icon-interactive {
            cursor: pointer;
            transition: transform 0.2s;
            color: #0d6efd !important; /* Bootstrap primary color */
        }
        
        .info-icon-interactive:hover {
            transform: scale(1.1);
            color: #0a58ca !important; /* Darker blue on hover */
        }
        
        /* Table compact styling handled by data-table.css */
        
        /* Tools specific table container */
        .tools-table-container {
            min-height: 600px;
        }
        
        /* Enable horizontal scrolling - match RMA approach */
        .tools-table-container {
            min-height: 600px;
        }
        
        /* Column min-widths to prevent squishing - match RMA approach */
        .tools-name-column {
            min-width: 300px !important;
            width: 25% !important;
        }
        
        .tools-type-column {
            min-width: 120px !important;
            width: 12% !important;
        }
        
        .tools-serial-column {
            min-width: 180px !important;
            width: 18% !important;
        }
        
        .tools-model-column {
            min-width: 140px !important;
            width: 12% !important;
        }
        
        .tools-location-column {
            min-width: 120px !important;
            width: 12% !important;
        }
        
        .tools-status-column {
            min-width: 120px !important;
            width: 10% !important;
        }
        
        .tools-count-column {
            min-width: 80px !important;
            width: 7% !important;
        }
        
        .tools-technicians-column {
            min-width: 140px !important;
            width: 14% !important;
        }
        
        .tools-date-column {
            min-width: 160px !important;
            width: 15% !important;
            text-align: center;
        }

        /* Clickable row styling */
        .clickable-row {
            cursor: pointer;
        }
        
        .clickable-row:hover {
            background-color: rgba(0,123,255,0.1);
        }
        
        /* Prevent row click when dragging */
        .dragging {
            pointer-events: none;
        }
        
        /* Drag cursor feedback */
        .tools-table-container:hover {
            cursor: grab;
        }
        
        /* When dragging, show grabbing cursor everywhere */
        .tools-dragging,
        .tools-dragging *,
        .tools-dragging .clickable-row,
        .tools-dragging .clickable-row *,
        .tools-dragging td,
        .tools-dragging th {
            cursor: grabbing !important;
        }
        
        /* Override grab cursor for interactive elements when not dragging */
        .tools-table-container:hover .sortable-header,
        .tools-table-container:hover .clickable-row a,
        .tools-table-container:hover .clickable-row button,
        .tools-table-container:hover .clickable-row input,
        .tools-table-container:hover .clickable-row [data-bs-toggle],
        .tools-table-container:hover .clickable-row .dropdown,
        .tools-table-container:hover .clickable-row .info-icon-interactive {
            cursor: pointer !important;
        }

        /* Custom table striping that works with dynamic sorting/filtering */
        .table-stripe-even td {
            background-color: var(--bs-table-striped-bg) !important;
        }
        
        .table-stripe-odd td {
            background-color: var(--bs-table-bg) !important;
        }
        
        /* Dark mode support for custom striping */
        [data-bs-theme="dark"] .table-stripe-even td {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }
        
        [data-bs-theme="dark"] .table-stripe-odd td {
            background-color: var(--bs-table-bg) !important;
        }
        
        /* Hover effects that work with custom striping */
        .table-stripe-even:hover td,
        .table-stripe-odd:hover td {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }

        /* Status filter styling (copied from RMA) */
        .status-filter-header .dropdown-toggle {
            border: none;
            padding: 2px 6px;
        }
        .status-filter-header .dropdown-toggle:focus {
            box-shadow: none;
        }
        .status-badge {
            font-size: 0.75rem !important;
        }
        
        .status-count-square {
            display: inline-block;
            min-width: 20px;
            padding: 2px 4px;
            font-size: 0.75em;
            text-align: center;
            border-radius: 3px;
            margin-right: 8px;
        }
        .status-filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            width: 100%;
        }
        .status-filter-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        /* Location filter styling */
        .location-filter-header .dropdown-toggle {
            border: none;
            padding: 2px 6px;
        }
        .location-filter-header .dropdown-toggle:focus {
            box-shadow: none;
        }
        
        .location-count-square {
            display: inline-block;
            min-width: 20px;
            padding: 2px 4px;
            font-size: 0.75em;
            text-align: center;
            border-radius: 3px;
            margin-right: 8px;
        }
        .location-filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            width: 100%;
        }
        .location-filter-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        /* Type filter styling */
        .type-filter-header .dropdown-toggle {
            border: none;
            padding: 2px 6px;
        }
        .type-filter-header .dropdown-toggle:focus {
            box-shadow: none;
        }
        
        .type-count-square {
            display: inline-block;
            min-width: 20px;
            padding: 2px 4px;
            font-size: 0.75em;
            text-align: center;
            border-radius: 3px;
            margin-right: 8px;
        }
        .type-filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            width: 100%;
        }
        .type-filter-left {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        /* Checklist Popover Styling */
        .checklist-popover {
            max-width: 300px;
            font-size: 0.875rem;
        }
        
        /* Document/Picture Popover Styling */
        .popover-body .badge {
            font-size: 0.6em !important;
            margin-top: 2px;
        }
        
        .docs-pics-popover {
            min-width: 200px;
            font-size: 0.875rem;
        }
        
        .docs-pics-popover .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .checklist-item-popup {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .checklist-item-name {
            display: flex;
            align-items: center;
        }
        
        .checklist-item-date {
            color: #6c757d;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .checklist-item-popup:last-child {
            border-bottom: none;
        }
        
        .checklist-item-popup i {
            margin-right: 8px;
            font-size: 0.9rem;
        }
        
        .checklist-item-popup .text-success {
            color: #28a745 !important;
        }
        
        .checklist-item-popup .text-muted {
            color: #6c757d !important;
        }
        
        /* Status badge hover effect */
        .status-badge:hover {
            opacity: 0.8;
            cursor: pointer;
        }
        
        /* Dark Mode Popover Arrows - Simple color overrides only */
        [data-bs-theme="dark"] .popover {
            background-color: #495057;
            border-color: #6c757d;
        }

        [data-bs-theme="dark"] .popover-header {
            background-color: #6c757d;
            border-bottom-color: #6c757d;
            color: #f8f9fa;
        }

        [data-bs-theme="dark"] .popover-body {
            background-color: #495057;
            color: #f8f9fa;
        }


    </style>
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('tools')}"></div>
    
    <div class="container-fluid mt-4 content-area">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-tools me-2"></i>
                    Tools Management
                </h2>
            </div>
            <div>
                <a th:href="@{/tools/new}" class="btn btn-primary me-2">
                    <i class="fas fa-plus me-1"></i>
                    New Tool
                </a>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadToolsModal">
                    <i class="fas fa-upload me-1"></i>
                    Upload Tools
                </button>
            </div>
        </div>

        <!-- Data Table Container -->
        <div class="data-table-container">
            
            <!-- Search Controls -->
            <div class="row mb-3 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="toolsSearchInput"
                            placeholder="Search by tool name, type, serial number, model, technicians, or notes..."
                            aria-label="Search">
                        <button 
                            class="btn btn-outline-secondary" 
                            type="button" 
                            id="clearSearch"
                            title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <small class="text-muted" id="resultsSummary">
                        Showing <span id="visibleCount" th:text="${#lists.size(tools)}">0</span> of <span id="totalCount" th:text="${#lists.size(tools)}">0</span> tools
                    </small>
                </div>
            </div>

            <!-- Empty State -->
            <div th:if="${tools.empty}" class="data-table-empty-state text-center py-5">
                <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Tools Found</h4>
                <p class="text-muted">Get started by creating your first tool.</p>
                <a th:href="@{/tools/new}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    Create Tool
                </a>
            </div>

            <!-- Responsive Table Container -->
            <div th:if="${!tools.empty}" class="data-table-responsive table-responsive tools-table-container" id="tools-table-container">
                <table class="table data-table-compact">
                    <thead>
                        <tr>
                            <th class="sortable-header tools-name-column" data-sort="name" style="text-align: left;">
                                <div class="header-content">
                                    <span class="header-text">Tool Name</span>
                                    <span class="sort-arrows">
                                        <i class="bi bi-caret-up sort-up"></i>
                                        <i class="bi bi-caret-down sort-down"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="type-filter-header filter-header tools-type-column">
                                Type
                                <div class="dropdown d-inline-block ms-1">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="typeFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                    <ul class="dropdown-menu p-2" aria-labelledby="typeFilterDropdown" style="min-width: 250px;">
                                        <li class="dropdown-item-text">
                                            <small class="text-muted">Filter by Type:</small>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="showAllTypes">Show All</button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-item-text" th:each="type : ${T(com.pcd.manager.model.Tool.ToolType).values()}">
                                            <div class="type-filter-item">
                                                <div class="type-filter-left">
                                                    <span class="badge bg-primary type-count-square type-count" th:data-type="${type.name()}">0</span>
                                                    <span th:text="${type.displayName}">Type Name</span>
                                                </div>
                                                <input class="form-check-input type-filter" type="checkbox" th:value="${type.name()}" th:id="'type-' + ${type.name()}" checked>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </th>
                            <th class="sortable-header tools-serial-column" data-sort="serialNumber" style="text-align: left;">
                                <div class="header-content">
                                    <span class="header-text">Serial Number</span>
                                    <span class="sort-arrows">
                                        <i class="bi bi-caret-up sort-up"></i>
                                        <i class="bi bi-caret-down sort-down"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="sortable-header tools-model-column" data-sort="model" style="text-align: left;">
                                <div class="header-content">
                                    <span class="header-text">Model</span>
                                    <span class="sort-arrows">
                                        <i class="bi bi-caret-up sort-up"></i>
                                        <i class="bi bi-caret-down sort-down"></i>
                                    </span>
                                </div>
                            </th>
                            <th class="location-filter-header filter-header tools-location-column">
                                Location
                                <div class="dropdown d-inline-block ms-1">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="locationFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                    <ul class="dropdown-menu p-2" aria-labelledby="locationFilterDropdown" style="min-width: 250px;">
                                        <li class="dropdown-item-text">
                                            <small class="text-muted">Filter by Location:</small>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="showAllLocations">Show All</button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-item-text" th:each="location : ${locations}">
                                            <div class="location-filter-item">
                                                <div class="location-filter-left">
                                                    <span class="badge bg-info location-count-square location-count" th:data-location="${location.displayName ?: location.name}">0</span>
                                                    <span th:text="${location.displayName}">Location Name</span>
                                                </div>
                                                <input class="form-check-input location-filter" type="checkbox" th:value="${location.displayName ?: location.name}" th:id="'location-' + ${location.id}" 
                                                       th:checked="${currentUser != null && currentUser.activeSite != null && (currentUser.activeSite.displayName ?: currentUser.activeSite.name) == (location.displayName ?: location.name)}">
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </th>
                            <th class="status-filter-header filter-header tools-status-column">
                                Status
                                <div class="dropdown d-inline-block ms-1">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                    <ul class="dropdown-menu p-2" aria-labelledby="statusFilterDropdown" style="min-width: 250px;">
                                        <li class="dropdown-item-text">
                                            <small class="text-muted">Filter by Status:</small>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="showAllStatuses">Show All</button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-item-text">
                                            <div class="status-filter-item">
                                                <div class="status-filter-left">
                                                    <span class="badge bg-secondary status-count-square status-count" data-status="NOT_STARTED">0</span>
                                                    <span>Not Started</span>
                                                </div>
                                                <input class="form-check-input status-filter" type="checkbox" value="NOT_STARTED" id="status-NOT_STARTED" checked>
                                            </div>
                                        </li>
                                        <li class="dropdown-item-text">
                                            <div class="status-filter-item">
                                                <div class="status-filter-left">
                                                    <span class="badge bg-primary status-count-square status-count" data-status="IN_PROGRESS">0</span>
                                                    <span>In Progress</span>
                                                </div>
                                                <input class="form-check-input status-filter" type="checkbox" value="IN_PROGRESS" id="status-IN_PROGRESS" checked>
                                            </div>
                                        </li>
                                        <li class="dropdown-item-text">
                                            <div class="status-filter-item">
                                                <div class="status-filter-left">
                                                    <span class="badge bg-success status-count-square status-count" data-status="COMPLETED">0</span>
                                                    <span>Completed</span>
                                                </div>
                                                <input class="form-check-input status-filter" type="checkbox" value="COMPLETED" id="status-COMPLETED" checked>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </th>
                                                            <th class="tools-count-column" style="display: none;">Moving Parts</th>
                                <th class="tools-count-column">RMAs</th>
                                <th class="tools-count-column">Track/Trends</th>
                                <th class="tools-count-column">Passdown</th>
                                <th class="tools-count-column">Comments</th>
                                <th class="tools-count-column">Docs/Pics</th>
                                <th class="tools-technicians-column">Technicians</th>
                                <th class="sortable-header tools-date-column" data-sort="last-modified">
                                    Last Modified
                                    <span class="sort-icons">
                                        <i class="bi bi-caret-up sort-up"></i>
                                        <i class="bi bi-caret-down sort-down"></i>
                                    </span>
                                </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="tool : ${tools}" class="data-table-row tool-row clickable-row"
                            th:attr="data-tool-id=${tool.id},
                                     data-name=${tool.name + (tool.secondaryName != null ? ' (' + tool.secondaryName + ')' : '')},
                                     data-serial-number=${(tool.serialNumber1 != null ? tool.serialNumber1 : '') + (tool.serialNumber2 != null ? (tool.serialNumber1 != null ? '/' : '') + tool.serialNumber2 : '')},
                                     data-model=${(tool.model1 != null ? tool.model1 : '') + (tool.model2 != null ? (tool.model1 != null ? '/' : '') + tool.model2 : '')},
                                     data-tool-type=${tool.toolType != null ? tool.toolType : 'Not specified'},
                                     data-status=${tool.status != null ? tool.status.name() : 'NOT_STARTED'},
                                     data-location-name=${tool.locationName != null ? tool.locationName : 'Unknown Location'},
                                     data-technicians=${#strings.listJoin(tool.currentTechnicians.![name], ' ')},
                                     data-notes=${tool.notes != null ? tool.notes : ''},
                                     data-docs-count=${tool.documentPaths != null ? #lists.size(tool.documentPaths) : 0},
                                     data-pics-count=${(tool.picturePaths != null ? #lists.size(tool.picturePaths) : 0) + (tool.pictures != null ? #lists.size(tool.pictures) : 0)},
                                     data-last-modified=${tool.updatedAt != null ? #temporals.format(tool.updatedAt, 'yyyy-MM-dd HH:mm') : ''},
                                     data-created-at=${tool.createdAt != null ? #temporals.format(tool.createdAt, 'yyyy-MM-dd HH:mm') : ''}">
                            <td style="text-align: left;">
                                <strong th:text="${tool.name}">Tool Name</strong>
                                <span th:if="${tool.secondaryName != null}" 
                                      class="text-muted ms-1" 
                                      th:text="'(' + ${tool.secondaryName} + ')'"></span>

                            </td>
                            <td style="text-align: left;">
                                <span th:if="${tool.toolType != null}" th:text="${tool.toolType}">Tool Type</span>
                                <span th:if="${tool.toolType == null}" class="text-muted">-</span>
                            </td>
                            <td style="text-align: left;">
                                <span th:if="${tool.serialNumber1 != null}" th:text="${tool.serialNumber1}">Serial Number 1</span><span th:if="${tool.serialNumber1 != null and tool.serialNumber2 != null}">/</span><span th:if="${tool.serialNumber2 != null}" th:text="${tool.serialNumber2}">Serial Number 2</span>
                                <span th:if="${tool.serialNumber1 == null and tool.serialNumber2 == null}" class="text-muted">-</span>
                            </td>
                            <td style="text-align: left;">
                                <span th:if="${tool.model1 != null}" th:text="${tool.model1}">Model 1</span><span th:if="${tool.model1 != null and tool.model2 != null}">/</span><span th:if="${tool.model2 != null}" th:text="${tool.model2}">Model 2</span>
                                <span th:if="${tool.model1 == null and tool.model2 == null}" class="text-muted">-</span>
                            </td>
                            <td style="text-align: left;">
                                                            <span th:text="${tool.locationName ?: 'Unknown Location'}">Location</span>
                            </td>
                            <td class="text-center">
                                <span th:if="${tool.status != null}" th:switch="${tool.status.name()}">
                                    <span th:case="'NOT_STARTED'" class="badge rounded-pill bg-secondary status-badge info-icon-interactive" 
                                          data-bs-toggle="popover"
                                          data-bs-placement="left"
                                          data-bs-trigger="hover focus click"
                                          data-bs-html="true"
                                          data-bs-title="Tool Checklist"
                                          th:data-bs-content="'<div class=&quot;checklist-popover&quot;>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.commissionCompleted} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Commission</span>' + (${tool.commissionDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.commissionDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.preSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> PreSL1</span>' + (${tool.preSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.preSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.sl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SL1</span>' + (${tool.sl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.sl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPreSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Pre SL1</span>' + (${tool.mechanicalPreSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPreSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPostSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Post SL1</span>' + (${tool.mechanicalPostSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPostSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificInputFunctionalityTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Input Functionality</span>' + (${tool.specificInputFunctionalityDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificInputFunctionalityDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.modesOfOperationTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Operation Modes</span>' + (${tool.modesOfOperationDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.modesOfOperationDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificSoosTestsed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SOOs Tested</span>' + (${tool.specificSoosDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificSoosDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.fieldServiceReportUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Field Service Report</span>' + (${tool.fieldServiceReportDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.fieldServiceReportDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.certificateOfApprovalUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Certificate of Approval</span>' + (${tool.certificateOfApprovalDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.certificateOfApprovalDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.turnedOverToCustomer} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Turned Over to Customer</span>' + (${tool.turnedOverToCustomerDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.turnedOverToCustomerDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.startUpSl03Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Start-Up/SL03</span>' + (${tool.startUpSl03Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.startUpSl03Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '</div>'"
                                          onclick="event.stopPropagation();"
                                          th:text="'Not Started'"></span>
                                    <span th:case="'IN_PROGRESS'" class="badge rounded-pill bg-primary status-badge info-icon-interactive"
                                          data-bs-toggle="popover"
                                          data-bs-placement="left"
                                          data-bs-trigger="hover focus click"
                                          data-bs-html="true"
                                          data-bs-title="Tool Checklist"
                                          th:data-bs-content="'<div class=&quot;checklist-popover&quot;>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.commissionCompleted} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Commission</span>' + (${tool.commissionDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.commissionDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.preSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> PreSL1</span>' + (${tool.preSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.preSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.sl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SL1</span>' + (${tool.sl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.sl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPreSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Pre SL1</span>' + (${tool.mechanicalPreSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPreSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPostSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Post SL1</span>' + (${tool.mechanicalPostSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPostSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificInputFunctionalityTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Input Functionality</span>' + (${tool.specificInputFunctionalityDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificInputFunctionalityDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.modesOfOperationTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Operation Modes</span>' + (${tool.modesOfOperationDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.modesOfOperationDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificSoosTestsed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SOOs Tested</span>' + (${tool.specificSoosDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificSoosDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.fieldServiceReportUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Field Service Report</span>' + (${tool.fieldServiceReportDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.fieldServiceReportDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.certificateOfApprovalUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Certificate of Approval</span>' + (${tool.certificateOfApprovalDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.certificateOfApprovalDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.turnedOverToCustomer} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Turned Over to Customer</span>' + (${tool.turnedOverToCustomerDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.turnedOverToCustomerDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.startUpSl03Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Start-Up/SL03</span>' + (${tool.startUpSl03Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.startUpSl03Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '</div>'"
                                          onclick="event.stopPropagation();"
                                          th:text="'In Progress'"></span>
                                    <span th:case="'COMPLETED'" class="badge rounded-pill bg-success status-badge info-icon-interactive"
                                          data-bs-toggle="popover"
                                          data-bs-placement="left"
                                          data-bs-trigger="hover focus click"
                                          data-bs-html="true"
                                          data-bs-title="Tool Checklist"
                                          th:data-bs-content="'<div class=&quot;checklist-popover&quot;>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.commissionCompleted} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Commission</span>' + (${tool.commissionDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.commissionDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.preSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> PreSL1</span>' + (${tool.preSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.preSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.sl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SL1</span>' + (${tool.sl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.sl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPreSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Pre SL1</span>' + (${tool.mechanicalPreSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPreSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.mechanicalPostSl1Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Mechanical: Post SL1</span>' + (${tool.mechanicalPostSl1Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.mechanicalPostSl1Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificInputFunctionalityTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Input Functionality</span>' + (${tool.specificInputFunctionalityDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificInputFunctionalityDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.modesOfOperationTested} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Operation Modes</span>' + (${tool.modesOfOperationDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.modesOfOperationDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.specificSoosTestsed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> SOOs Tested</span>' + (${tool.specificSoosDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.specificSoosDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.fieldServiceReportUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Field Service Report</span>' + (${tool.fieldServiceReportDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.fieldServiceReportDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.certificateOfApprovalUploaded} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Certificate of Approval</span>' + (${tool.certificateOfApprovalDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.certificateOfApprovalDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.turnedOverToCustomer} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Turned Over to Customer</span>' + (${tool.turnedOverToCustomerDate != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.turnedOverToCustomerDate, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '<div class=&quot;checklist-item-popup&quot;><span class=&quot;checklist-item-name&quot;><i class=&quot;bi ' + (${tool.startUpSl03Completed} ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted') + '&quot;></i> Start-Up/SL03</span>' + (${tool.startUpSl03Date != null} ? '<span class=&quot;checklist-item-date&quot;>' + ${#temporals.format(tool.startUpSl03Date, 'MMM dd, yyyy')} + '</span>' : '') + '</div>' +
                                            '</div>'"
                                          onclick="event.stopPropagation();"
                                          th:text="'Completed'"></span>
                                    <span th:case="*" class="badge rounded-pill bg-light text-dark status-badge" th:text="${tool.status.name().replace('_',' ')}"></span>
                                </span>
                                <span th:if="${tool.status == null}" class="badge rounded-pill bg-light text-dark status-badge">N/A</span>
                            </td>
                                        <td class="text-center" style="display: none;">
                <!-- Interactive Moving Parts icon when moving parts exist -->
                <i th:class="${'bi bi-arrows-move ' + (toolMovingPartsMap != null and toolMovingPartsMap[tool.id] != null and not #lists.isEmpty(toolMovingPartsMap[tool.id]) ? 'info-icon-interactive' : 'text-muted')}"
                   th:if="${toolMovingPartsMap != null and toolMovingPartsMap[tool.id] != null and not #lists.isEmpty(toolMovingPartsMap[tool.id])}"
                   data-bs-toggle="popover"
                   data-bs-placement="left"
                   data-bs-trigger="hover focus click"
                   data-bs-html="true"
                   th:attr="data-bs-title='Moving Parts (' + ${#lists.size(toolMovingPartsMap[tool.id])} + ')'"
                   th:data-bs-content="${#strings.listJoin(toolMovingPartsMap[tool.id].![
                       '<div class=&quot;mb-2&quot;>' + 
                       '<div class=&quot;mb-1&quot;><strong>' + partName + '</strong></div>' +
                       '<small class=&quot;text-muted&quot;>' + 
                       '<a href=&quot;/moving-parts/' + id + '&quot; class=&quot;text-decoration-none&quot; onclick=&quot;event.stopPropagation();&quot;>' +
                       (moveDate != null ? #temporals.format(moveDate, 'MM/dd/yy HH:mm') : id) + '</a>' + 
                       '<br/>' + 
                       (fromTool != null ? 'From: ' + fromTool.name : '') + 
                       (fromTool != null and destinationChain != null and !destinationChain.isEmpty() ? ' → Destinations' : '') + 
                       '</small></div>'
                   ], '<hr class=&quot;my-1&quot;/>')}"
                   onclick="event.stopPropagation();">
                </i>
                
                <!-- Greyed out icon when no moving parts -->
                <i th:if="${toolMovingPartsMap == null or toolMovingPartsMap[tool.id] == null or #lists.isEmpty(toolMovingPartsMap[tool.id])}" 
                   class="bi bi-arrows-move text-muted">
                </i>
                
                <!-- Moving Parts count -->
                <span th:text="${toolMovingPartsMap != null and toolMovingPartsMap[tool.id] != null ? #lists.size(toolMovingPartsMap[tool.id]) : 0}" class="ms-1 small"></span>
            </td>
                            <td class="text-center">
                                <!-- Interactive RMA icon when RMAs exist -->
                                <i th:class="${'bi bi-clipboard-data-fill ' + (toolRmasMap[tool.id] != null and not #lists.isEmpty(toolRmasMap[tool.id]) ? 'info-icon-interactive' : 'text-muted')}"
                                   th:if="${toolRmasMap[tool.id] != null and not #lists.isEmpty(toolRmasMap[tool.id])}"
                                   data-bs-toggle="popover"
                                   data-bs-placement="left"
                                   data-bs-trigger="hover focus click"
                                   data-bs-html="true"
                                   th:attr="data-bs-title='RMAs (' + ${#lists.size(toolRmasMap[tool.id])} + ')'"
                                   th:data-bs-content="${#strings.listJoin(toolRmasMap[tool.id].![
                                       '<div class=&quot;mb-2&quot;><small class=&quot;text-muted&quot;>' + 
                                       '<a href=&quot;/rma/' + get('id') + '&quot; class=&quot;text-decoration-none&quot; onclick=&quot;event.stopPropagation();&quot;>' +
                                       (get('rmaNumber') != null ? get('rmaNumber') : get('id')) + '</a> ' +
                                       '<i class=&quot;bi bi-info-circle-fill ms-1 text-primary rma-problem-icon&quot; ' +
                                       'data-rma-id=&quot;' + get('id') + '&quot; ' +
                                       'data-bs-title=&quot;Problem Details&quot; ' +
                                       'style=&quot;cursor: pointer; font-size: 0.8em;&quot; ' +
                                       'onclick=&quot;event.stopPropagation();&quot;></i> ' +
                                       '<span class=&quot;badge bg-' + 
                                       (get('status').name() == 'COMPLETED' ? 'success' : 
                                        get('status').name() == 'IN_PROGRESS' ? 'primary' : 
                                        get('status').name() == 'SHIPPED' ? 'info' : 'secondary') + 
                                       '&quot;>' + get('status').name().replace('_', ' ') + '</span>' +
                                       '</small></div>'
                                   ], '<hr class=&quot;my-1&quot;/>')}"
                                   onclick="event.stopPropagation();">
                                </i>
                                
                                <!-- Greyed out icon when no RMAs -->
                                <i th:if="${toolRmasMap[tool.id] == null or #lists.isEmpty(toolRmasMap[tool.id])}" 
                                   class="bi bi-clipboard-data text-muted">
                                </i>
                                
                                <!-- RMA count -->
                                <span th:text="${toolRmasMap[tool.id] != null ? #lists.size(toolRmasMap[tool.id]) : 0}" class="ms-1 small"></span>
                            </td>
                            <td class="text-center">
                                <!-- Track/Trends icon and count -->
                                <th:block th:if="${toolTrackTrendsMap != null and toolTrackTrendsMap[tool.id] != null and not #lists.isEmpty(toolTrackTrendsMap[tool.id])}">
                                    <i class="bi bi-graph-up-arrow info-icon-interactive"
                                       data-bs-toggle="popover"
                                       data-bs-placement="left"
                                       data-bs-trigger="hover focus click"
                                       data-bs-html="true"
                                       th:attr="data-bs-title='Track/Trends (' + ${#lists.size(toolTrackTrendsMap[tool.id])} + ')'"
                                       th:data-bs-content="${#strings.listJoin(toolTrackTrendsMap[tool.id].![
                                           '<a href=&quot;/tracktrend/' + get('id') + '&quot; class=&quot;text-decoration-none d-block mb-1&quot; onclick=&quot;event.stopPropagation();&quot;>' +
                                           get('name') + '</a>'
                                       ], '')}"
                                       onclick="event.stopPropagation();">
                                    </i>
                                    <span th:text="${#lists.size(toolTrackTrendsMap[tool.id])}" class="ms-1 small"></span>
                                </th:block>
                                
                                <!-- Greyed out icon when no Track/Trends -->
                                <th:block th:unless="${toolTrackTrendsMap != null and toolTrackTrendsMap[tool.id] != null and not #lists.isEmpty(toolTrackTrendsMap[tool.id])}">
                                    <i class="bi bi-graph-up text-muted"></i>
                                    <span class="ms-1 small">0</span>
                                </th:block>
                            </td>
                            <td class="text-center">
                                <!-- Interactive Passdown icon when passdowns exist -->
                                <i th:class="${'bi bi-journal-text ' + (toolPassdownsMap[tool.id] != null and not #lists.isEmpty(toolPassdownsMap[tool.id]) ? 'info-icon-interactive' : 'text-muted')}"
                                   th:if="${toolPassdownsMap[tool.id] != null and not #lists.isEmpty(toolPassdownsMap[tool.id])}"
                                   data-bs-toggle="popover"
                                   data-bs-placement="left"
                                   data-bs-trigger="hover focus click"
                                   data-bs-html="true"
                                   th:attr="data-bs-title='Passdowns (' + ${#lists.size(toolPassdownsMap[tool.id])} + ')'"
                                   th:data-bs-content="${#strings.listJoin(toolPassdownsMap[tool.id].![
                                       '<div class=&quot;mb-2&quot;>' + 
                                       (get('comment') != null ? '<div class=&quot;mb-1&quot;>' + get('comment') + '</div>' : '') +
                                       '<small class=&quot;text-muted&quot;>' + 
                                       '<a href=&quot;/passdowns/' + get('id') + '&quot; class=&quot;text-decoration-none&quot; onclick=&quot;event.stopPropagation();&quot;>' +
                                       (get('date') != null ? #temporals.format(get('date'), 'MM/dd/yy') : get('id')) + '</a>' + 
                                       (get('userName') != null ? ' by ' + get('userName') : '') + 
                                       '</small></div>'
                                   ], '<hr class=&quot;my-1&quot;/>')}"
                                   onclick="event.stopPropagation();">
                                </i>
                                
                                <!-- Greyed out icon when no passdowns -->
                                <i th:if="${toolPassdownsMap[tool.id] == null or #lists.isEmpty(toolPassdownsMap[tool.id])}" 
                                   class="bi bi-journal-text text-muted">
                                </i>
                                
                                <!-- Passdown count -->
                                <span th:text="${toolPassdownsMap[tool.id] != null ? #lists.size(toolPassdownsMap[tool.id]) : 0}" class="ms-1 small"></span>
                            </td>
                            <td class="text-center">
                                <!-- Interactive comments icon when comments exist -->
                                <i th:class="${'bi bi-chat-dots-fill ' + (toolCommentsMap[tool.id] != null and not #lists.isEmpty(toolCommentsMap[tool.id]) ? 'info-icon-interactive' : 'text-muted')}"
                                   th:if="${toolCommentsMap[tool.id] != null and not #lists.isEmpty(toolCommentsMap[tool.id])}"
                                   data-bs-toggle="popover"
                                   data-bs-placement="left"
                                   data-bs-trigger="hover focus click"
                                   data-bs-html="true"
                                   th:attr="data-bs-title='Comments (' + ${#lists.size(toolCommentsMap[tool.id])} + ')'"
                                   th:data-bs-content="${#strings.listJoin(toolCommentsMap[tool.id].![
                                       '<div class=&quot;mb-2&quot;><small class=&quot;text-muted&quot;>' + 
                                       #temporals.format(get('createdDate'), 'MM/dd/yy HH:mm') + 
                                       (get('userName') != null ? ' by ' + get('userName') : '') + 
                                       '</small><br/>' + 
                                       (get('content') != null ? get('content') : 'No content') + '</div>'
                                   ], '<hr class=&quot;my-1&quot;/>')}"
                                   onclick="event.stopPropagation();">
                                </i>
                                
                                <!-- Greyed out icon when no comments -->
                                <i th:if="${toolCommentsMap[tool.id] == null or #lists.isEmpty(toolCommentsMap[tool.id])}" 
                                   class="bi bi-chat-dots text-muted">
                                </i>
                                
                                <!-- Comment count -->
                                <span th:text="${toolCommentsMap[tool.id] != null ? #lists.size(toolCommentsMap[tool.id]) : 0}" class="ms-1 small"></span>
                            </td>
                            <td class="text-center">
                                <!-- Interactive Docs/Pics icon when documents or pictures exist -->
                                <i th:class="${'bi bi-file-earmark-text ' + ((tool.documentPaths != null and not #lists.isEmpty(tool.documentPaths)) or (tool.picturePaths != null and not #lists.isEmpty(tool.picturePaths)) or (tool.pictures != null and not #lists.isEmpty(tool.pictures)) ? 'info-icon-interactive' : 'text-muted')}"
                                   th:if="${(tool.documentPaths != null and not #lists.isEmpty(tool.documentPaths)) or (tool.picturePaths != null and not #lists.isEmpty(tool.picturePaths)) or (tool.pictures != null and not #lists.isEmpty(tool.pictures))}"
                                   data-bs-toggle="popover"
                                   data-bs-placement="left"
                                   data-bs-trigger="hover focus click"
                                   data-bs-html="true"
                                   th:attr="data-bs-title='Documents & Pictures (' + ${(tool.documentPaths != null ? #lists.size(tool.documentPaths) : 0) + (tool.picturePaths != null ? #lists.size(tool.picturePaths) : 0) + (tool.pictures != null ? #lists.size(tool.pictures) : 0)} + ')'"
                                   data-tool-docs-pics="true"
                                   onclick="event.stopPropagation();">
                                </i>
                                
                                <!-- Greyed out icon when no documents or pictures -->
                                <i th:if="${(tool.documentPaths == null or #lists.isEmpty(tool.documentPaths)) and (tool.picturePaths == null or #lists.isEmpty(tool.picturePaths)) and (tool.pictures == null or #lists.isEmpty(tool.pictures))}" 
                                   class="bi bi-file-earmark-text text-muted">
                                </i>
                                
                                <!-- Docs/Pics count -->
                                <span th:text="${(tool.documentPaths != null ? #lists.size(tool.documentPaths) : 0) + (tool.picturePaths != null ? #lists.size(tool.picturePaths) : 0) + (tool.pictures != null ? #lists.size(tool.pictures) : 0)}" class="ms-1 small"></span>
                            </td>
                            <td>
                                <span th:if="${!tool.currentTechnicians.empty}" th:text="${#strings.listJoin(tool.currentTechnicians.![name], ', ')}">Technicians</span>
                                <span th:if="${tool.currentTechnicians.empty}" class="text-muted">-</span>
                            </td>
                            <td class="text-center">
                                <span th:if="${tool.updatedAt != null}" class="small">
                                    <span th:text="${#temporals.format(tool.updatedAt, 'MMM dd, yyyy')}">Date</span>
                                    <span th:text="${#temporals.format(tool.updatedAt, 'h:mm a')}" class="text-muted ms-1">Time</span>
                                </span>
                                <span th:if="${tool.updatedAt == null}" class="text-muted small">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- No Tools Found Message -->
                <div id="noToolsFound" class="text-center py-5" style="display: none;">
                    <div class="d-flex flex-column align-items-center">
                        <i class="bi bi-tools text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-muted mb-2">No Tools Found</h4>
                        <p class="text-muted">No tools match the current filters. Try adjusting your search criteria or filters.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/theme-toggle.js}"></script>
    <script th:src="@{/js/components/data-table.js}"></script>
    <script>
        // Tools Management functionality (copied from RMA approach)
        class ToolsManager {
            constructor() {
                this.currentSort = null;
                this.sortDirection = 'asc';
                this.currentSearch = '';
                this.visibleStatuses = new Set(['NOT_STARTED', 'IN_PROGRESS', 'COMPLETED']);
                this.visibleLocations = new Set(); // Will be populated from checkboxes
                this.visibleTypes = new Set(['CHEMBLEND', 'SLURRY']); // Track visible tool types
                this.totalStatusCounts = {}; // Track total counts across all tools
                this.totalLocationCounts = {}; // Track total counts by location
                this.totalTypeCounts = {}; // Track total counts by type
                
                this.init();
                this.initSorting();
                this.calculateTotalStatusCounts();
                this.calculateTotalLocationCounts();
                this.calculateTotalTypeCounts();
                this.initializeLocationFilter();
                this.updateStatusCounts();
                this.updateLocationCounts();
                this.updateTypeCounts();
                this.updateToolsCount();
                
                // Apply initial row striping
                this.reapplyRowStripes();
                
                // DEBUG: Show what data-status values actually exist

            }

            init() {
                // Search functionality
                const searchInput = document.getElementById('toolsSearchInput');
                const clearSearchButton = document.getElementById('clearSearch');
                
                searchInput.addEventListener('input', (e) => {
                    this.currentSearch = e.target.value.toLowerCase();
                    this.filterTable();
                });
                
                clearSearchButton.addEventListener('click', () => {
                    searchInput.value = '';
                    this.currentSearch = '';
                    this.filterTable();
                });

                // Status filtering
                document.querySelectorAll('.status-filter').forEach(checkbox => {
                    console.log('🔧 Found status filter checkbox:', checkbox.value);
                    checkbox.addEventListener('change', (e) => {
                        const status = e.target.value;
                        console.log(`🔧 Checkbox ${status} changed to:`, e.target.checked);
                        if (e.target.checked) {
                            this.visibleStatuses.add(status);
                        } else {
                            // Prevent unchecking all statuses (keep at least one visible)
                            if (this.visibleStatuses.size === 1) {
                                console.log('🚫 Cannot uncheck all statuses');
                                e.preventDefault();
                                e.target.checked = true;
                                return;
                            }
                            this.visibleStatuses.delete(status);
                        }
                        console.log('🔧 Visible statuses now:', Array.from(this.visibleStatuses));
                        this.filterTable();
                    });
                });

                // Show All button
                const showAllButton = document.getElementById('showAllStatuses');
                if (showAllButton) {
                    showAllButton.addEventListener('click', () => {
                        // Check all checkboxes
                        document.querySelectorAll('.status-filter').forEach(checkbox => {
                            checkbox.checked = true;
                            this.visibleStatuses.add(checkbox.value);
                        });
                        this.filterTable();
                    });
                }

                // Location filtering
                document.querySelectorAll('.location-filter').forEach(checkbox => {
                    console.log('🏢 Found location filter checkbox:', checkbox.value);
                    checkbox.addEventListener('change', (e) => {
                        const locationId = e.target.value;
                        if (e.target.checked) {
                            this.visibleLocations.add(locationId);
                        } else {
                            this.visibleLocations.delete(locationId);
                        }
                        this.filterTable();
                    });
                });

                // Show All Locations button
                const showAllLocationsButton = document.getElementById('showAllLocations');
                if (showAllLocationsButton) {
                    showAllLocationsButton.addEventListener('click', () => {
                        // Check all location checkboxes
                        document.querySelectorAll('.location-filter').forEach(checkbox => {
                            checkbox.checked = true;
                            this.visibleLocations.add(checkbox.value);
                        });
                        this.filterTable();
                    });
                }

                // Type filtering
                document.querySelectorAll('.type-filter').forEach(checkbox => {
                    console.log('🔧 Found type filter checkbox:', checkbox.value);
                    checkbox.addEventListener('change', (e) => {
                        const toolType = e.target.value;
                        console.log(`🔧 Type checkbox ${toolType} changed to:`, e.target.checked);
                        if (e.target.checked) {
                            this.visibleTypes.add(toolType);
                        } else {
                            // Prevent unchecking all types (keep at least one visible)
                            if (this.visibleTypes.size === 1) {
                                console.log('🚫 Cannot uncheck all types');
                                e.preventDefault();
                                e.target.checked = true;
                                return;
                            }
                            this.visibleTypes.delete(toolType);
                        }
                        console.log('🔧 Visible types now:', Array.from(this.visibleTypes));
                        this.filterTable();
                    });
                });

                // Show All Types button
                const showAllTypesButton = document.getElementById('showAllTypes');
                if (showAllTypesButton) {
                    showAllTypesButton.addEventListener('click', () => {
                        // Check all type checkboxes
                        document.querySelectorAll('.type-filter').forEach(checkbox => {
                            checkbox.checked = true;
                            this.visibleTypes.add(checkbox.value);
                        });
                        this.filterTable();
                    });
                }
            }

            filterTable() {
                const rows = document.querySelectorAll('.tool-row');

                
                let visibleCount = 0;
                rows.forEach(row => {
                    const name = (row.getAttribute('data-name') || '').toLowerCase();
                    const serialNumber = (row.getAttribute('data-serial-number') || '').toLowerCase();
                    const model = (row.getAttribute('data-model') || '').toLowerCase();
                    const toolType = (row.getAttribute('data-tool-type') || '').toLowerCase();
                    const technicians = (row.getAttribute('data-technicians') || '').toLowerCase();
                    const notes = (row.getAttribute('data-notes') || '').toLowerCase();
                    const status = row.getAttribute('data-status') || 'NOT_STARTED';

                    // Check search criteria
                    const matchesSearch = !this.currentSearch || 
                        name.includes(this.currentSearch) || 
                        serialNumber.includes(this.currentSearch) || 
                        model.includes(this.currentSearch) ||
                        toolType.includes(this.currentSearch) ||
                        technicians.includes(this.currentSearch) ||
                        notes.includes(this.currentSearch);

                    // Check status filter
                    const matchesStatus = this.visibleStatuses.has(status);
                    
                    // Check location filter
                    const locationName = row.getAttribute('data-location-name') || '';
                    const matchesLocation = this.visibleLocations.size === 0 || this.visibleLocations.has(locationName);

                    // Check type filter
                    const toolTypeValue = row.getAttribute('data-tool-type') || '';
                    const matchesType = this.visibleTypes.has(toolTypeValue);

                    if (matchesSearch && matchesStatus && matchesLocation && matchesType) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });


                this.updateStatusCounts();
                this.updateLocationCounts();
                this.updateTypeCounts();
                this.updateToolsCount();
                
                // Reapply alternating row colors after filtering
                this.reapplyRowStripes();
            }

            updateToolsCount() {
                const visibleRows = document.querySelectorAll('.tool-row:not([style*="display: none"])');
                const count = visibleRows.length;
                const visibleCountSpan = document.getElementById('visibleCount');
                const totalCountSpan = document.getElementById('totalCount');
                const noToolsFound = document.getElementById('noToolsFound');
                const toolsTable = document.querySelector('.tools-table-container table');
                
                if (visibleCountSpan) visibleCountSpan.textContent = count;
                if (totalCountSpan) totalCountSpan.textContent = document.querySelectorAll('.tool-row').length;
                
                // Show/hide no tools found message - but keep table visible
                if (count === 0) {
                    if (noToolsFound) noToolsFound.style.display = 'block';
                } else {
                    if (noToolsFound) noToolsFound.style.display = 'none';
                }
            }

            calculateTotalStatusCounts() {
                // Count all tools by status (regardless of filters)
                document.querySelectorAll('.tool-row').forEach(row => {
                    const status = row.getAttribute('data-status') || 'NOT_STARTED';
                    if (status) {
                        this.totalStatusCounts[status] = (this.totalStatusCounts[status] || 0) + 1;
                    }
                });
            }

            updateStatusCounts() {
                // Always show total counts, not filtered counts
                // This ensures counts don't disappear when everything is unchecked
                document.querySelectorAll('.status-count').forEach(badge => {
                    const status = badge.getAttribute('data-status');
                    badge.textContent = this.totalStatusCounts[status] || 0;
                });
            }

            initializeLocationFilter() {
                // Initialize visible locations with checked checkboxes (current user's location by default)
                document.querySelectorAll('.location-filter').forEach(checkbox => {
                    if (checkbox.checked) {
                        this.visibleLocations.add(checkbox.value);
                    }
                });
                
                // Apply initial filtering based on checked locations
                this.filterTable();
            }

            calculateTotalLocationCounts() {
                // Count all tools by location (regardless of filters)
                document.querySelectorAll('.tool-row').forEach(row => {
                    const locationName = row.getAttribute('data-location-name') || 'Unknown Location';
                    if (locationName) {
                        this.totalLocationCounts[locationName] = (this.totalLocationCounts[locationName] || 0) + 1;
                    }
                });
            }

            updateLocationCounts() {
                // Always show total counts, not filtered counts
                document.querySelectorAll('.location-count').forEach(badge => {
                    const locationDisplayName = badge.getAttribute('data-location');
                    // Count tools that match this display name in their data-location-name
                    let count = 0;
                    document.querySelectorAll('.tool-row').forEach(row => {
                        const toolLocationName = row.getAttribute('data-location-name') || '';
                        // Match if the tool's location name equals the badge's display name
                        if (toolLocationName === locationDisplayName) {
                            count++;
                        }
                    });
                    badge.textContent = count;
                });
            }

            calculateTotalTypeCounts() {
                // Count all tools by type (regardless of filters)
                document.querySelectorAll('.tool-row').forEach(row => {
                    const toolType = row.getAttribute('data-tool-type') || '';
                    if (toolType) {
                        this.totalTypeCounts[toolType] = (this.totalTypeCounts[toolType] || 0) + 1;
                    }
                });
            }

            updateTypeCounts() {
                // Always show total counts, not filtered counts
                document.querySelectorAll('.type-count').forEach(badge => {
                    const toolType = badge.getAttribute('data-type');
                    badge.textContent = this.totalTypeCounts[toolType] || 0;
                });
            }

            initSorting() {
                // Add click handlers to sortable headers
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        // Ignore clicks on dropdowns or their children
                        if (e.target.closest('[data-bs-toggle="dropdown"]') || 
                            e.target.closest('.dropdown') || 
                            e.target.closest('.dropdown-menu')) {
                            return;
                        }
                        
                        const sortType = header.getAttribute('data-sort');
                        this.handleSort(sortType, header);
                    });
                });
            }

            handleSort(sortType, header) {
                // Remove sort classes from all headers
                document.querySelectorAll('.sortable-header').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });

                // Determine sort direction
                if (this.currentSort === sortType) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortDirection = 'asc';
                }

                this.currentSort = sortType;
                header.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

                this.sortTable(sortType, this.sortDirection);
            }

            sortTable(sortType, direction) {
                const tbody = document.querySelector('.tools-table-container tbody');
                const rows = Array.from(document.querySelectorAll('.tool-row'));

                rows.sort((a, b) => {
                    let aVal = '';
                    let bVal = '';

                    // Get values based on sort type
                    switch(sortType) {
                        case 'name':
                            aVal = a.getAttribute('data-name') || '';
                            bVal = b.getAttribute('data-name') || '';
                            break;
                        case 'serialNumber':
                            aVal = a.getAttribute('data-serial-number') || '';
                            bVal = b.getAttribute('data-serial-number') || '';
                            break;
                        case 'model':
                            aVal = a.getAttribute('data-model') || '';
                            bVal = b.getAttribute('data-model') || '';
                            break;
                        default:
                            aVal = a.getAttribute(`data-${sortType}`) || '';
                            bVal = b.getAttribute(`data-${sortType}`) || '';
                    }

                    // Handle date sorting
                    if (sortType.includes('date') || sortType === 'last-modified') {
                        aVal = aVal ? new Date(aVal) : new Date('9999-12-31');
                        bVal = bVal ? new Date(bVal) : new Date('9999-12-31');
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }

                    // String sorting (case insensitive)
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                });

                // Re-append sorted rows
                if (tbody) {
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                }
                
                // Reapply alternating row colors after sorting
                this.reapplyRowStripes();
            }

            reapplyRowStripes() {
                // Get all tool rows (both visible and hidden)
                const allRows = document.querySelectorAll('.tool-row');
                let visibleRowIndex = 0;
                
                allRows.forEach(row => {
                    // Remove existing stripe classes
                    row.classList.remove('table-stripe-even', 'table-stripe-odd');
                    
                    // Only apply stripes to visible rows
                    if (row.style.display !== 'none') {
                        if (visibleRowIndex % 2 === 0) {
                            row.classList.add('table-stripe-even');
                        } else {
                            row.classList.add('table-stripe-odd');
                        }
                        visibleRowIndex++;
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Tools Manager
            new ToolsManager();

            // Initialize Bootstrap Popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                // Special handling for docs/pics popovers
                if (popoverTriggerEl.hasAttribute('data-tool-docs-pics')) {
                    return new bootstrap.Popover(popoverTriggerEl, {
                        sanitize: false,
                        fallbackPlacements: ['left', 'top', 'bottom'],
                        container: 'body',
                        content: function() {
                            return generateDocsListContent(popoverTriggerEl);
                        }
                    });
                } else {
                    return new bootstrap.Popover(popoverTriggerEl, {
                        sanitize: false, // Allow HTML in content
                        fallbackPlacements: ['left', 'top', 'bottom'],
                        container: 'body' // Added to help with potential positioning/event issues
                    });
                }
            });
            
            // Function to generate docs/pics popover content
            function generateDocsListContent(triggerElement) {
                const toolRow = triggerElement.closest('tr');
                const toolId = toolRow.getAttribute('data-tool-id');
                const docsCount = parseInt(toolRow.getAttribute('data-docs-count') || '0');
                const picsCount = parseInt(toolRow.getAttribute('data-pics-count') || '0');
                const toolName = toolRow.getAttribute('data-name');
                
                let content = '<div class="docs-pics-popover">';
                
                if (docsCount > 0 || picsCount > 0) {
                    content += `<div class="mb-2"><strong>${toolName}</strong></div>`;
                    
                    if (docsCount > 0) {
                        content += `<div class="mb-1">`;
                        content += `<i class="bi bi-file-earmark-text me-2 text-primary"></i>`;
                        content += `<strong>Documents:</strong> ${docsCount}`;
                        content += `</div>`;
                    }
                    
                    if (picsCount > 0) {
                        content += `<div class="mb-1">`;
                        content += `<i class="bi bi-image me-2 text-success"></i>`;
                        content += `<strong>Pictures:</strong> ${picsCount}`;
                        content += `</div>`;
                    }
                    
                    content += '<hr class="my-2">';
                    content += `<div class="text-center">`;
                    content += `<a href="/tools/${toolId}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">`;
                    content += `<i class="bi bi-eye me-1"></i>View Details`;
                    content += `</a>`;
                    content += `</div>`;
                } else {
                    content += '<div class="text-muted text-center">';
                    content += '<i class="bi bi-file-earmark-x fs-4 mb-2"></i>';
                    content += '<div>No documents or pictures</div>';
                    content += '</div>';
                }
                
                content += '</div>';
                return content;
            }

            // Track currently pinned popovers
            var currentlyPinnedPopover = null;
                    
            // Handle popover clicks to manage pinning
            popoverTriggerList.forEach(function (triggerEl) {
                triggerEl.addEventListener('click', function (event) {
                    var clickedPopover = popoverList.find(function (popover) {
                        return popover._element === triggerEl;
                    });
                    
                    // If there's a currently pinned popover and it's different from the clicked one
                    if (currentlyPinnedPopover && currentlyPinnedPopover !== clickedPopover) {
                        currentlyPinnedPopover.hide();
                    }
                    
                    // Update the currently pinned popover
                    setTimeout(function () {
                        var popoverId = triggerEl.getAttribute('aria-describedby');
                        if (popoverId && document.getElementById(popoverId)) {
                            currentlyPinnedPopover = clickedPopover;
                        } else {
                            if (currentlyPinnedPopover === clickedPopover) {
                                currentlyPinnedPopover = null;
                            }
                        }
                    }, 100);
                });
            });
                    
            // Close popovers when clicking outside (but don't interfere with dropdowns)
            document.addEventListener('click', function (event) {
                // Don't interfere with dropdown functionality
                if (event.target.closest('[data-bs-toggle="dropdown"]') || 
                    event.target.closest('.dropdown-menu')) {
                    return;
                }
                
                popoverList.forEach(function (popover) {
                    var triggerElement = popover._element;
                    var popoverId = triggerElement.getAttribute('aria-describedby');
                    var popoverElement = popoverId ? document.getElementById(popoverId) : null;
                    
                    var isClickInsideTrigger = triggerElement.contains(event.target);
                    var isClickInsidePopover = popoverElement ? popoverElement.contains(event.target) : false;
                
                    // Hide popover if clicking outside both trigger and popover content
                    if (!isClickInsideTrigger && !isClickInsidePopover) {
                        popover.hide();
                        // Clear pinned state if this was the pinned popover
                        if (currentlyPinnedPopover === popover) {
                            currentlyPinnedPopover = null;
                        }
                    }
                });
            });

            // Handle RMA problem details icons in popovers (hover-based, non-interfering)
            document.addEventListener('mouseenter', function(e) {
                if (e.target.classList.contains('rma-problem-icon')) {
                    const rmaId = e.target.getAttribute('data-rma-id');
                    if (!rmaId) return;
                    
                    // Check if popover already exists
                    let existingPopover = bootstrap.Popover.getInstance(e.target);
                    if (existingPopover) {
                        return; // Already has popover, let it handle hover
                    }
                    
                    // Fetch problem details and create hover popover
                    fetch(`/rma/${rmaId}/problem-details`)
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('Failed to load problem details');
                        })
                        .then(data => {
                            const formattedDetails = formatProblemDetailsForPopover(data.problemDetails);
                            
                            // Create hover-triggered popover that doesn't interfere with others
                            const popover = new bootstrap.Popover(e.target, {
                                html: true,
                                placement: 'right',
                                trigger: 'hover',
                                title: 'Problem Details',
                                content: formattedDetails,
                                sanitize: false,
                                fallbackPlacements: ['left', 'top', 'bottom'],
                                container: 'body',
                                delay: { show: 300, hide: 100 } // Slight delay to prevent flicker
                            });
                            
                            // Show immediately since we're already hovering
                            popover.show();
                        })
                        .catch(error => {
                            console.error('Error loading problem details:', error);
                        });
                }
            }, true); // Use capture phase to catch events in nested popovers

            // Handle clickable rows with improved drag detection
            // Simple drag to scroll functionality
            const table = document.querySelector('.tools-table-container');
            let isDragging = false;
            let startX = 0;
            let scrollStart = 0;
            let hasMoved = false;
            
            // Make drag state accessible globally
            window.toolsTableDragging = false;
            
            // Add drag functionality to all table rows
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.addEventListener('mousedown', function(e) {
                    // Skip if clicking on links, buttons, etc.
                    if (e.target.closest('a, button, input, [data-bs-toggle]')) {
                        return;
                    }
                    
                    isDragging = true;
                    hasMoved = false;
                    startX = e.clientX;
                    scrollStart = table.scrollLeft;
                    
                    // Add dragging visual feedback
                    document.body.classList.add('tools-dragging');
                    
                    e.preventDefault();
                });
            });
            
            // Handle mouse move for dragging
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                
                // Mark as moved if dragged more than 5 pixels
                if (Math.abs(deltaX) > 5) {
                    hasMoved = true;
                    window.toolsTableDragging = true;
                }
                
                // Scroll the table
                table.scrollLeft = scrollStart - deltaX;
                
                e.preventDefault();
            });
            
            // Handle mouse up to end dragging
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    
                    // Remove dragging visual feedback
                    document.body.classList.remove('tools-dragging');
                    
                    // Reset drag flag after delay to prevent immediate clicks
                    setTimeout(() => {
                        window.toolsTableDragging = false;
                    }, 100);
                }
            });

            // Initialize clickable table rows
            initializeClickableRows();
            
            // Make type filter rows clickable to toggle checkboxes
            document.querySelectorAll('.type-filter-item').forEach(function(item) {
                item.style.cursor = 'pointer';
                item.addEventListener('click', function(e) {
                    // Don't trigger if clicking directly on the checkbox
                    if (e.target.type === 'checkbox') {
                        return;
                    }
                    
                    // Find the checkbox within this item
                    const checkbox = item.querySelector('.type-filter');
                    if (checkbox) {
                        // Toggle the checkbox
                        checkbox.checked = !checkbox.checked;
                        
                        // Trigger the change event to update the filtering
                        const event = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(event);
                    }
                });
            });
        });
        
        // Function to initialize clickable table rows - copied from RMA
        function initializeClickableRows() {
            const toolRows = document.querySelectorAll('.clickable-row');
            toolRows.forEach(row => {
                // Check if already has click handler to avoid duplicates
                if (row.hasAttribute('data-click-initialized')) {
                    return;
                }
                
                row.setAttribute('data-click-initialized', 'true');
                                row.addEventListener('click', function(e) {
                    // Don't navigate if we just finished dragging
                    if (window.toolsTableDragging) {
                        return;
                    }
                    
                    // Don't navigate if clicking on interactive elements
                    if (e.target.closest('a, button, input, .dropdown, [data-bs-toggle], .info-icon-interactive')) {
                        return;
                    }
                    
                    // Get the tool ID from the row's data attribute
                    const toolId = row.getAttribute('data-tool-id');
                    
                    if (toolId) {
                        window.location.href = `/tools/${toolId}`;
                    }
                });
             });
         }
    </script>

    <!-- Upload Tools Modal -->
    <div class="modal fade" id="uploadToolsModal" tabindex="-1" aria-labelledby="uploadToolsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadToolsModalLabel">
                        <i class="fas fa-upload me-2"></i>
                        Bulk Tool Upload
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Professional Explanation -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>How the Tool Upload Process Works</h6>
                        <p class="mb-2">This feature allows you to efficiently import multiple tools at once using a standardized Excel template:</p>
                        <ol class="mb-2">
                            <li><strong>Download Template:</strong> Use the download button below to get the pre-formatted Excel template</li>
                            <li><strong>Fill Out Data:</strong> Enter tool information in the designated columns with the exact headers shown</li>
                            <li><strong>Upload File:</strong> Select your completed Excel file using the upload button</li>
                            <li><strong>Automatic Processing:</strong> The system validates format and creates tool records automatically</li>
                        </ol>
                        <p class="mb-0"><strong>Note:</strong> The Excel file must contain the exact column headers as specified in the template for successful processing.</p>
                    </div>

                    <!-- Required Format Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Required Excel Format</h6>
                        </div>
                        <div class="card-body">
                            <p>Your Excel file must have these exact column headers in the first row:</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><span class="badge bg-primary me-2">A</span><code>Tool Name</code></li>
                                        <li><span class="badge bg-primary me-2">B</span><code>Tool Name 2</code></li>
                                        <li><span class="badge bg-primary me-2">C</span><code>Type</code></li>
                                        <li><span class="badge bg-primary me-2">D</span><code>Model Number 1</code></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><span class="badge bg-primary me-2">E</span><code>Model Number 2</code></li>
                                        <li><span class="badge bg-primary me-2">F</span><code>Serial Number 1</code></li>
                                        <li><span class="badge bg-primary me-2">G</span><code>Serial Number 2</code></li>
                                        <li><span class="badge bg-primary me-2">H</span><code>Location</code></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-3 mb-0">
                                <small><i class="fas fa-exclamation-triangle me-1"></i>Headers are case-sensitive and must match exactly as shown above.</small>
                            </div>
                            
                            <!-- Location Format Information -->
                            <div class="mt-3">
                                <h6><i class="fas fa-map-marker-alt me-2"></i>Location Column Format</h6>
                                <p class="mb-2">The Location column (H) supports flexible matching for the following formats:</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Arizona Locations:</strong>
                                        <ul class="small">
                                            <li>Arizona Fab 52</li>
                                            <li>AZ F52</li>
                                            <li>AZ52</li>
                                            <li>AZF52</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>New Mexico Locations:</strong>
                                        <ul class="small">
                                            <li>New Mexico Fab 11</li>
                                            <li>NM F11</li>
                                            <li>NM11</li>
                                            <li>NMF11</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Ireland Locations:</strong>
                                        <ul class="small">
                                            <li>Ireland Fab 24</li>
                                            <li>IE F24</li>
                                            <li>IE24</li>
                                            <li>IEF24</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2">
                                    <small><i class="fas fa-info-circle me-1"></i>Location matching is case-insensitive and flexible. If no match is found, the default location will be used.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <a href="/tools/reference-documents/AllToolsModelSerialBlank.xlsx" 
                                   class="btn btn-outline-primary" 
                                   download="ToolUploadTemplate.xlsx">
                                    <i class="fas fa-download me-2"></i>
                                    Download Excel Template
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <input type="file" 
                                       id="toolsExcelFile" 
                                       accept=".xlsx,.xls" 
                                       style="display: none;">
                                <button type="button" 
                                        class="btn btn-success" 
                                        onclick="document.getElementById('toolsExcelFile').click()">
                                    <i class="fas fa-file-excel me-2"></i>
                                    Select Excel File to Upload
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Status -->
                    <div id="uploadStatus" class="mt-3" style="display: none;"></div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Resolution Modal -->
    <style>
        /* Duplicate item highlighting */
        .duplicate-item .text-changed {
            background-color: rgba(253, 126, 20, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 3px solid #fd7e14;
        }
        
        .duplicate-item .text-added {
            background-color: rgba(40, 167, 69, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 3px solid #28a745;
        }
        
        .duplicate-item .text-missing {
            background-color: rgba(220, 53, 69, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 3px solid #dc3545;
        }
        
        /* Exact match highlighting */
        .duplicate-item.exact-match {
            border-color: #28a745;
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .duplicate-item.exact-match .card-header {
            background-color: rgba(40, 167, 69, 0.1);
            border-bottom: 1px solid #28a745;
        }
        
        .tool-comparison {
            font-size: 0.9rem;
        }
        
        /* Theme-appropriate colors */
        .duplicate-item .card-header {
            background-color: var(--bs-secondary-bg);
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .duplicates-container {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: var(--bs-body-bg);
        }
        
        .duplicate-item .card {
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
        }
        
        .duplicate-item .card-body {
            background-color: var(--bs-body-bg);
        }
        
        /* Collapse button styling */
        .collapse-toggle {
            background: none;
            border: none;
            color: var(--bs-body-color);
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        
        .collapse-toggle:hover {
            color: var(--bs-primary);
            background-color: var(--bs-secondary-bg);
        }
        
        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .collapse-toggle:not(.collapsed) {
            transform: rotate(0deg);
        }
        
        .btn-check:checked + .btn-outline-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        
        .btn-check:checked + .btn-outline-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }
        
        /* Extra small buttons for more compact layout */
        .btn-xs {
            padding: 0.125rem 0.25rem;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        

    </style>
    
    <div class="modal fade" id="duplicateResolutionModal" tabindex="-1" aria-labelledby="duplicateResolutionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicateResolutionModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        Duplicate Tools Detected
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        We found <span id="duplicateCount">0</span> potential duplicate(s) in your Excel file. 
                        Please review and choose whether to <strong>skip</strong> or <strong>overwrite</strong> each duplicate.
                        <strong>Overwrite is selected by default.</strong>
                        
                        <!-- Color Legend Information -->
                        <div class="mt-3 small">
                            <div class="row">
                                <div class="col-md-4">
                                    <span class="d-inline-block me-2" style="width: 16px; height: 12px; background-color: rgba(253, 126, 20, 0.6); border-left: 3px solid #fd7e14; border-radius: 3px;"></span>
                                    <strong>Orange:</strong> Changed field values
                                </div>
                                <div class="col-md-4">
                                    <span class="d-inline-block me-2" style="width: 16px; height: 12px; background-color: rgba(40, 167, 69, 0.6); border-left: 3px solid #28a745; border-radius: 3px;"></span>
                                    <strong>Green:</strong> New values being added
                                </div>
                                <div class="col-md-4">
                                    <span class="d-inline-block me-2" style="width: 16px; height: 12px; background-color: rgba(220, 53, 69, 0.6); border-left: 3px solid #dc3545; border-radius: 3px;"></span>
                                    <strong>Red:</strong> Won't migrate (data missing)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Control Bar -->
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <!-- Bulk Selection Controls -->
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllDuplicateActions('overwrite')">
                                <i class="fas fa-check-double me-1"></i>Overwrite All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllDuplicateActions('skip')">
                                <i class="fas fa-times me-1"></i>Skip All
                            </button>
                        </div>
                        
                        <!-- Collapse/Expand All -->
                        <div>
                            <button type="button" class="btn btn-outline-info btn-sm" id="collapseExpandAllBtn" onclick="toggleAllCollapses()">
                                <i class="fas fa-compress-alt me-1"></i>Collapse All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Duplicates List -->
                    <div id="duplicatesList" class="duplicates-container" style="max-height: 600px; overflow-y: auto;">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="processDuplicateResolutions()">
                        <i class="fas fa-upload me-2"></i>Process Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Upload JavaScript -->
    <script>
        // Global variables for the upload process
        let currentAnalysisData = null;

        document.getElementById('toolsExcelFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show upload progress
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = uploadProgress.querySelector('.progress-bar');

            uploadStatus.style.display = 'block';
            uploadProgress.style.display = 'block';
            uploadStatus.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Analyzing Excel file for duplicates...</div>';
            progressBar.style.width = '30%';

            // Create FormData
            const formData = new FormData();
            formData.append('file', file);

            // First, analyze file for duplicates
            fetch('/tools/analyze-excel', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                progressBar.style.width = '70%';
                return response.json();
            })
            .then(data => {
                progressBar.style.width = '100%';
                currentAnalysisData = data;
                
                if (data.success) {
                    if (data.duplicateCount > 0) {
                        // Show duplicate resolution modal
                        showDuplicateResolutionModal(data);
                        
                        uploadStatus.innerHTML = `
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Found ${data.duplicateCount} duplicate(s). Please review and resolve conflicts.
                            </div>
                        `;
                    } else {
                        // No duplicates, process directly
                        uploadStatus.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Processing Excel file...</div>';
                        processFinalUpload(data.validRows, []);
                    }
                } else {
                    uploadStatus.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${data.error || 'Analysis failed. Please check your file format and try again.'}
                        </div>
                    `;
                }
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                }, 2000);
            })
            .catch(error => {
                console.error('Error analyzing file:', error);
                uploadStatus.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Network error occurred. Please try again.
                    </div>
                `;
                uploadProgress.style.display = 'none';
            });
        });

        function showDuplicateResolutionModal(data) {
            const modal = new bootstrap.Modal(document.getElementById('duplicateResolutionModal'));
            
            // Update duplicate count
            document.getElementById('duplicateCount').textContent = data.duplicateCount;
            
            // Populate duplicates list
            const duplicatesList = document.getElementById('duplicatesList');
            duplicatesList.innerHTML = '';
            
            data.duplicates.forEach((duplicate, index) => {
                const duplicateElement = createDuplicateElement(duplicate, index);
                duplicatesList.appendChild(duplicateElement);
            });
            
            // Initialize collapse event listeners after modal is shown
            modal._element.addEventListener('shown.bs.modal', function () {
                // Add event listeners to collapse elements to update the toggle all button
                const collapseElements = document.querySelectorAll('.duplicate-item .collapse');
                collapseElements.forEach(el => {
                    el.addEventListener('shown.bs.collapse', updateToggleAllButton);
                    el.addEventListener('hidden.bs.collapse', updateToggleAllButton);
                });
            });
            
            modal.show();
        }

        function createDuplicateElement(duplicate, index) {
            const div = document.createElement('div');
            div.className = 'card mb-3 duplicate-item';
            div.setAttribute('data-index', index);
            
            const existing = duplicate.existing;
            const newData = duplicate.new;
            const differences = duplicate.differences;
            const existingLocation = existing.location || 'No location';
            
            // Check if this is an exact match
            const isExactMatch = isDataExactMatch(existing, newData);
            if (isExactMatch) {
                div.classList.add('exact-match');
            }
            
            div.innerHTML = `
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <button class="collapse-toggle collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#duplicateCollapse${index}" aria-expanded="false" 
                                    aria-controls="duplicateCollapse${index}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-tools me-1"></i>
                                    <strong>Row ${newData.rowNumber}:</strong> "${newData.toolName}"${isExactMatch ? ' <span class="badge bg-success">Exact Match</span>' : ''}
                                </div>
                                <div class="text-muted small">
                                    Matches: ${existing.toolName} in ${existingLocation}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group float-end" role="group">
                                <input type="radio" class="btn-check" name="action_${index}" id="overwrite_${index}" value="overwrite" checked>
                                <label class="btn btn-outline-warning btn-xs" for="overwrite_${index}">
                                    <i class="fas fa-edit"></i> Overwrite
                                </label>
                                
                                <input type="radio" class="btn-check" name="action_${index}" id="skip_${index}" value="skip">
                                <label class="btn btn-outline-secondary btn-xs" for="skip_${index}">
                                    <i class="fas fa-times"></i> Skip
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapse" id="duplicateCollapse${index}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-database me-2"></i>Existing Tool</h6>
                                ${createToolComparisonHtml(existing, differences, 'existing', newData)}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="fas fa-file-excel me-2"></i>Excel Data</h6>
                                ${createToolComparisonHtml(newData, differences, 'new', existing)}
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Duplicate Reason(s):</strong> ${duplicate.duplicateReasons.join(', ')}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function isDataExactMatch(existing, newData) {
            const fields = [
                'toolName', 'toolName2', 'type', 'modelNumber1', 'modelNumber2', 
                'serialNumber1', 'serialNumber2', 'location'
            ];
            
            return fields.every(field => {
                const existingValue = normalizeFieldValue(existing[field]);
                const newValue = normalizeFieldValue(newData[field]);
                
                // Special case for type - case insensitive comparison
                if (field === 'type') {
                    return existingValue.toLowerCase() === newValue.toLowerCase();
                }
                
                return existingValue === newValue;
            });
        }
        
        function normalizeFieldValue(value) {
            if (value === null || value === undefined || value === '') {
                return '(empty)';
            }
            return String(value).trim();
        }
        
        function getFieldHighlightType(existingValue, newValue, fieldKey) {
            const normalizedExisting = normalizeFieldValue(existingValue);
            const normalizedNew = normalizeFieldValue(newValue);
            
            // Special case for type - case insensitive comparison
            if (fieldKey === 'type') {
                if (normalizedExisting.toLowerCase() === normalizedNew.toLowerCase()) {
                    return 'none'; // No highlighting for case-insensitive matches
                }
            } else {
                if (normalizedExisting === normalizedNew) {
                    return 'none'; // No highlighting for exact matches
                }
            }
            
            // Data won't migrate (existing has data, new is empty)
            if (normalizedExisting !== '(empty)' && normalizedNew === '(empty)') {
                return 'missing';
            }
            
            // New data being added (existing is empty, new has data)
            if (normalizedExisting === '(empty)' && normalizedNew !== '(empty)') {
                return 'added';
            }
            
            // Data is being changed (both have data but different)
            if (normalizedExisting !== '(empty)' && normalizedNew !== '(empty)') {
                return 'changed';
            }
            
            return 'none';
        }

        function createToolComparisonHtml(data, differences, side, existingData = null) {
            const fields = [
                { key: 'toolName', label: 'Tool Name' },
                { key: 'toolName2', label: 'Tool Name 2' },
                { key: 'type', label: 'Type' },
                { key: 'modelNumber1', label: 'Model 1' },
                { key: 'modelNumber2', label: 'Model 2' },
                { key: 'serialNumber1', label: 'Serial 1' },
                { key: 'serialNumber2', label: 'Serial 2' },
                { key: 'location', label: 'Location' }
            ];
            
            let html = '<div class="tool-comparison">';
            
            fields.forEach(field => {
                const value = normalizeFieldValue(data[field.key]);
                let cssClass = '';
                
                if (side === 'new' && existingData) {
                    // For new side, show what's being added, changed, or missing
                    const existingValue = existingData[field.key];
                    const highlightType = getFieldHighlightType(existingValue, data[field.key], field.key);
                    
                    switch (highlightType) {
                        case 'added':
                            cssClass = 'text-added fw-bold';
                            break;
                        case 'changed':
                            cssClass = 'text-changed fw-bold';
                            break;
                        case 'missing':
                            cssClass = 'text-missing fw-bold';
                            break;
                    }
                }
                
                html += `
                    <div class="mb-1">
                        <small class="text-muted">${field.label}:</small>
                        <div class="${cssClass}">${value}</div>
                    </div>
                `;
            });
            
            // Add additional existing tool info
            if (side === 'existing') {
                if (data.status) {
                    html += `
                        <div class="mb-1">
                            <small class="text-muted">Status:</small>
                            <div>${data.status}</div>
                        </div>
                    `;
                }
                if (data.setDate) {
                    html += `
                        <div class="mb-1">
                            <small class="text-muted">Set Date:</small>
                            <div>${data.setDate}</div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }

        function selectAllDuplicateActions(action) {
            const radioInputs = document.querySelectorAll(`input[type="radio"][value="${action}"]`);
            radioInputs.forEach(input => {
                input.checked = true;
            });
        }

        function toggleAllCollapses() {
            const collapseElements = document.querySelectorAll('.duplicate-item .collapse');
            const collapseButtons = document.querySelectorAll('.collapse-toggle');
            const toggleButton = document.getElementById('collapseExpandAllBtn');
            
            // Check if any are expanded
            const anyExpanded = Array.from(collapseElements).some(el => el.classList.contains('show'));
            
            if (anyExpanded) {
                // Collapse all
                collapseElements.forEach(el => {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el);
                    bsCollapse.hide();
                });
                collapseButtons.forEach(btn => btn.classList.add('collapsed'));
                toggleButton.innerHTML = '<i class="fas fa-expand-alt me-1"></i>Expand All';
            } else {
                // Expand all
                collapseElements.forEach(el => {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el);
                    bsCollapse.show();
                });
                collapseButtons.forEach(btn => btn.classList.remove('collapsed'));
                toggleButton.innerHTML = '<i class="fas fa-compress-alt me-1"></i>Collapse All';
            }
        }

        function updateToggleAllButton() {
            const collapseElements = document.querySelectorAll('.duplicate-item .collapse');
            const toggleButton = document.getElementById('collapseExpandAllBtn');
            
            if (!collapseElements.length || !toggleButton) return;
            
            const anyExpanded = Array.from(collapseElements).some(el => el.classList.contains('show'));
            
            if (anyExpanded) {
                toggleButton.innerHTML = '<i class="fas fa-compress-alt me-1"></i>Collapse All';
            } else {
                toggleButton.innerHTML = '<i class="fas fa-expand-alt me-1"></i>Expand All';
            }
        }

        function processDuplicateResolutions() {
            if (!currentAnalysisData) {
                alert('No analysis data available. Please restart the upload process.');
                return;
            }
            
            // Collect user choices
            const duplicateResolutions = [];
            const duplicateItems = document.querySelectorAll('.duplicate-item');
            
            duplicateItems.forEach((item, index) => {
                const actionInput = item.querySelector(`input[name="action_${index}"]:checked`);
                const action = actionInput ? actionInput.value : 'skip';
                
                const originalDuplicate = currentAnalysisData.duplicates[index];
                duplicateResolutions.push({
                    existingToolId: originalDuplicate.existingToolId,
                    action: action,
                    new: originalDuplicate.new
                });
            });
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('duplicateResolutionModal'));
            modal.hide();
            
            // Process the final upload
            processFinalUpload(currentAnalysisData.validRows, duplicateResolutions);
        }

        function processFinalUpload(validRows, duplicateResolutions) {
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = uploadProgress.querySelector('.progress-bar');
            
            uploadStatus.style.display = 'block';
            uploadProgress.style.display = 'block';
            uploadStatus.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Creating and updating tools...</div>';
            progressBar.style.width = '30%';
            
            const requestData = {
                validRows: validRows,
                duplicateResolutions: duplicateResolutions
            };
            
            fetch('/tools/process-excel-with-duplicates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                progressBar.style.width = '70%';
                return response.json();
            })
            .then(data => {
                progressBar.style.width = '100%';
                
                if (data.success) {
                    let message = `Successfully processed ${data.totalProcessed} tools! `;
                    if (data.toolsCreated > 0) message += `Created: ${data.toolsCreated}. `;
                    if (data.toolsUpdated > 0) message += `Updated: ${data.toolsUpdated}. `;
                    if (data.toolsSkipped > 0) message += `Skipped: ${data.toolsSkipped}. `;
                    
                    uploadStatus.innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            ${message}
                            <a href="#" onclick="location.reload()" class="alert-link">Refresh page to see changes.</a>
                        </div>
                    `;
                    
                    // Show audit messages if any
                    if (data.auditMessages && data.auditMessages.length > 0) {
                        const auditDiv = document.createElement('div');
                        auditDiv.className = 'alert alert-info mt-2';
                        auditDiv.innerHTML = '<strong>Changes made:</strong><ul class="mb-0">' + 
                            data.auditMessages.map(msg => `<li>${msg}</li>`).join('') + '</ul>';
                        uploadStatus.appendChild(auditDiv);
                    }
                    
                    // Reset file input
                    document.getElementById('toolsExcelFile').value = '';
                    
                    // Auto-refresh after 5 seconds
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    uploadStatus.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${data.error || 'Upload failed. Please try again.'}
                        </div>
                    `;
                }
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Error processing upload:', error);
                uploadStatus.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Network error occurred. Please try again.
                    </div>
                `;
                uploadProgress.style.display = 'none';
            });
        }

        // Format problem details for popover display
        function formatProblemDetailsForPopover(problemDetails) {
            if (!problemDetails) return '<p class="text-muted">No problem details available</p>';
            
            let content = '<div class="problem-details-popover">';
            
            if (problemDetails.whatHappened) {
                content += `<div class="mb-2"><strong>What:</strong><br/>${problemDetails.whatHappened}</div>`;
            }
            if (problemDetails.whoContained) {
                content += `<div class="mb-2"><strong>Who:</strong><br/>${problemDetails.whoContained}</div>`;
            }
            if (problemDetails.whenContained) {
                content += `<div class="mb-2"><strong>When:</strong><br/>${problemDetails.whenContained}</div>`;
            }
            if (problemDetails.whereContained) {
                content += `<div class="mb-2"><strong>Where:</strong><br/>${problemDetails.whereContained}</div>`;
            }
            if (problemDetails.whyContained) {
                content += `<div class="mb-2"><strong>Why:</strong><br/>${problemDetails.whyContained}</div>`;
            }
            if (problemDetails.howContained) {
                content += `<div class="mb-2"><strong>How:</strong><br/>${problemDetails.howContained}</div>`;
            }
            
            content += '</div>';
            return content;
        }
    </script>
</body>
</html>