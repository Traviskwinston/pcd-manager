<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCD Manager - RMA Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div th:replace="~{fragments/navigation :: navbar('rma')}"></div>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col">
                <h1>RMA Details</h1>
            </div>
            <div class="col text-end">
                <a th:href="@{/rma}" class="btn btn-secondary me-2">Back to RMA Matrix</a>
                <a th:href="@{/rma/edit/{id}(id=${rma.id})}" class="btn btn-primary me-2">Edit RMA</a>
                <a th:href="@{/rma/{id}/excel(id=${rma.id})}" class="btn btn-success me-2">
                    <i class="bi bi-file-excel"></i> Export to Excel
                </a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    Delete RMA
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col">
                        <h4 th:text="${'RMA: ' + rma.rmaNumber}">RMA Number</h4>
                    </div>
                    <div class="col text-end">
                        <div class="mb-1">
                            <span th:if="${rma.status != null}" th:class="${'badge rounded-pill ' + 
                                (rma.status.name() == 'RMA_WRITTEN_EMAILED' ? 'bg-primary' : 
                                (rma.status.name() == 'NUMBER_PROVIDED' ? 'bg-info' : 
                                (rma.status.name() == 'MEMO_EMAILED' ? 'bg-secondary' :
                                (rma.status.name() == 'RECEIVED_PARTS' ? 'bg-warning' : 
                                (rma.status.name() == 'WAITING_CUSTOMER' ? 'bg-danger' : 
                                (rma.status.name() == 'WAITING_FSE' ? 'bg-danger' : 
                                (rma.status.name() == 'COMPLETED' ? 'bg-success' : 'bg-light')))))))}"
                                th:text="${rma.status?.displayName}">
                                Status
                            </span>
                            <span th:if="${rma.priority != null}" th:class="${'ms-2 badge rounded-pill ' + 
                                (rma.priority == 'LOW' ? 'bg-info' : 
                                (rma.priority == 'MEDIUM' ? 'bg-warning' : 
                                (rma.priority == 'HIGH' ? 'bg-danger' : 
                                (rma.priority == 'URGENT' ? 'bg-danger text-uppercase' : 'bg-light'))))}"
                                th:text="${rma.priority}">
                                Priority
                            </span>
                        </div>
                        <div class="small text-muted">
                            <div>Location: <span th:text="${rma.location != null ? rma.location.displayName : 'N/A'}"></span></div>
                            <div>Technician: <span th:text="${rma.technician != null ? rma.technician : 'Not assigned'}"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Customer Information</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:30%">Customer</th>
                                <td th:text="${rma.customerName}">Customer name</td>
                            </tr>
                            <tr>
                                <th>Company Ship To Name</th>
                                <td th:text="${rma.companyShipToName}">Ship to name</td>
                            </tr>
                            <tr>
                                <th>Ship To Address</th>
                                <td>
                                    <div th:text="${rma.companyShipToAddress}">Address</div>
                                    <div th:if="${rma.city != null || rma.state != null || rma.zipCode != null}">
                                        <span th:text="${rma.city}"></span>,
                                        <span th:text="${rma.state}"></span>
                                        <span th:text="${rma.zipCode}"></span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Attn</th>
                                <td th:text="${rma.attn}">Attention</td>
                            </tr>
                            <tr>
                                <th>Contact</th>
                                <td th:text="${rma.customerContact}">Contact name</td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td th:text="${rma.customerPhone}">Phone number</td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td th:text="${rma.customerEmail}">Email</td>
                            </tr>
                            <tr>
                                <th>Sales Order</th>
                                <td th:text="${rma.salesOrder}">Sales order</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Parts Information</h5>
                        <!-- Table to display part line items -->
                        <table class="table table-sm table-bordered" th:if="${rma.partLineItems != null and not #lists.isEmpty(rma.partLineItems)}">
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>Part #</th>
                                    <th>Description</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-center">Replacement</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${rma.partLineItems}">
                                    <td th:text="${item.partName}">Part Name</td>
                                    <td th:text="${item.partNumber}">Part number</td>
                                    <td th:text="${item.productDescription}">Description</td>
                                    <td class="text-center" th:text="${item.quantity}">Qty</td>
                                    <td class="text-center">
                                        <span th:if="${item.replacementRequired}" class="badge bg-success">Yes</span>
                                        <span th:unless="${item.replacementRequired}" class="badge bg-secondary">No</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <p th:if="${rma.partLineItems == null or #lists.isEmpty(rma.partLineItems)}" class="text-muted">(No parts associated)</p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <h5>Dates</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:40%">Received</th>
                                <td th:text="${rma.receivedDate != null ? #temporals.format(rma.receivedDate, 'yyyy-MM-dd') : 'N/A'}">Received date</td>
                            </tr>
                            <tr>
                                <th>Written</th>
                                <td th:text="${rma.writtenDate != null ? #temporals.format(rma.writtenDate, 'yyyy-MM-dd') : 'N/A'}">Written date</td>
                            </tr>
                            <tr>
                                <th>Created</th>
                                <td th:text="${rma.createdDate != null ? #temporals.format(rma.createdDate, 'yyyy-MM-dd') : 'N/A'}">Created date</td>
                            </tr>
                            <tr>
                                <th>RMA # Provided</th>
                                <td th:text="${rma.rmaNumberProvidedDate != null ? #temporals.format(rma.rmaNumberProvidedDate, 'yyyy-MM-dd') : 'N/A'}">RMA # Provided date</td>
                            </tr>
                            <tr>
                                <th>Memo Emailed</th>
                                <td th:text="${rma.shippingMemoEmailedDate != null ? #temporals.format(rma.shippingMemoEmailedDate, 'yyyy-MM-dd') : 'N/A'}">Memo Emailed date</td>
                            </tr>
                            <tr>
                                <th>Parts Received</th>
                                <td th:text="${rma.partsReceivedDate != null ? #temporals.format(rma.partsReceivedDate, 'yyyy-MM-dd') : 'N/A'}">Parts Received date</td>
                            </tr>
                            <tr>
                                <th>Parts Installed</th>
                                <td th:text="${rma.installedPartsDate != null ? #temporals.format(rma.installedPartsDate, 'yyyy-MM-dd') : 'N/A'}">Parts Installed date</td>
                            </tr>
                            <tr>
                                <th>Failed Packed</th>
                                <td th:text="${rma.failedPartsPackedDate != null ? #temporals.format(rma.failedPartsPackedDate, 'yyyy-MM-dd') : 'N/A'}">Failed Packed date</td>
                            </tr>
                            <tr>
                                <th>Failed Shipped</th>
                                <td th:text="${rma.failedPartsShippedDate != null ? #temporals.format(rma.failedPartsShippedDate, 'yyyy-MM-dd') : 'N/A'}">Failed Shipped date</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-8">
                        <h5>Assignment</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th style="width:20%">Location</th>
                                <td th:text="${rma.location != null ? rma.location.displayName : 'N/A'}">Location</td>
                            </tr>
                            <tr>
                                <th>Technician</th>
                                <td th:text="${rma.technician != null ? rma.technician : 'Not assigned'}">Technician</td>
                            </tr>
                            <tr>
                                <th>Tool</th>
                                <td>
                                    <a th:if="${rma.tool != null}" th:href="@{/tools/{id}(id=${rma.tool.id})}" class="text-decoration-none">
                                        <span th:text="${rma.tool.name}" class="text-primary"></span>
                                        <span th:if="${rma.tool.secondaryName != null}" th:text="${' (' + rma.tool.secondaryName + ')'}" class="text-muted small"></span>
                                        <span class="ms-2 badge bg-secondary" th:text="${rma.tool.toolType}">Tool Type</span>
                                    </a>
                                    <span th:unless="${rma.tool != null}" class="text-muted">No tool associated</span>
                                </td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.chemicalGasService != null}">
                                <th>Chemical/Gas Service</th>
                                <td th:text="${rma.tool.chemicalGasService}">Chemical/Gas Service</td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.commissionDate != null}">
                                <th>Commission Date</th>
                                <td th:text="${#temporals.format(rma.tool.commissionDate, 'yyyy-MM-dd')}">Commission Date</td>
                            </tr>
                            <tr th:if="${rma.tool != null && rma.tool.startUpSl03Date != null}">
                                <th>Start-Up/SL03 Date</th>
                                <td th:text="${#temporals.format(rma.tool.startUpSl03Date, 'yyyy-MM-dd')}">Start-Up/SL03 Date</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Description</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.description != null ? rma.description : 'No description provided'}" class="mb-0">Description</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Root Cause</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.rootCause != null ? rma.rootCause : 'Not yet determined'}" class="mb-0">Root cause</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resolution</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.resolution != null ? rma.resolution : 'Not yet resolved'}" class="mb-0">Resolution</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Notes</h5>
                            </div>
                            <div class="card-body">
                                <p th:text="${rma.notes != null ? rma.notes : 'No notes available'}" class="mb-0">Notes</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Process Impact Information Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Process Impact Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:50%">Interruption to Flow</th>
                                                <td>
                                                    <span th:if="${rma.interruptionToFlow}" class="badge bg-danger">Yes</span>
                                                    <span th:unless="${rma.interruptionToFlow}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Interruption to Production</th>
                                                <td>
                                                    <span th:if="${rma.interruptionToProduction}" class="badge bg-danger">Yes</span>
                                                    <span th:unless="${rma.interruptionToProduction}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Downtime (Hrs)</th>
                                                <td th:text="${rma.downtimeHours != null ? rma.downtimeHours : '0.0'}">0.0</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th style="width:50%">Exposed to Process Gas/Chemicals</th>
                                                <td>
                                                    <span th:if="${rma.exposedToProcessGasOrChemicals}" class="badge bg-warning">Yes</span>
                                                    <span th:unless="${rma.exposedToProcessGasOrChemicals}" class="badge bg-success">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Purged</th>
                                                <td>
                                                    <span th:if="${rma.purged}" class="badge bg-info">Yes</span>
                                                    <span th:unless="${rma.purged}" class="badge bg-secondary">No</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3" th:if="${rma.instructionsForExposedComponent != null && !rma.instructionsForExposedComponent.isEmpty()}">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Instructions for Exposed Component</h6>
                                            </div>
                                            <div class="card-body">
                                                <p th:text="${rma.instructionsForExposedComponent}" class="mb-0">Instructions</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Documents Section -->
                <div class="row mt-4" th:if="${rma.documents != null and not rma.documents.empty}">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Documents</h5>
                            </div>
                            <div class="card-body">
                                <!-- Debug info to see document paths (hidden) -->
                                <div class="alert alert-info small mb-3" style="display: none;">
                                    <p><strong>Debug Info:</strong> Document paths from database</p>
                                    <ul class="mb-0">
                                        <li th:each="doc : ${rma.documents}" th:text="${doc.fileName + ' ➡ ' + doc.filePath}">document.fileName → document.filePath</li>
                                    </ul>
                                </div>
                                
                                <div class="list-group">
                                    <div class="list-group-item d-flex align-items-center" th:each="document : ${rma.documents}">
                                        <!-- Document Name -->
                                        <div class="flex-grow-1" style="width: 40%">
                                            <i class="bi bi-file-earmark-text me-2"></i>
                                            <span th:text="${document.fileName}">Document Name</span>
                                            <span class="small text-muted ms-2" 
                                                  th:text="${document.fileSize != null ? '(' + (document.fileSize / 1024) + ' KB)' : ''}">Size</span>
                                        </div>
                                        
                                        <!-- Tags -->
                                        <div style="width: 40%">
                                            <span class="badge bg-secondary me-1" th:if="${rma.tool != null}" 
                                                  th:text="${'Tool: ' + rma.tool.name}">Tool</span>
                                            <span class="badge bg-info me-1" th:if="${rma.rmaNumber != null}"
                                                  th:text="${'RMA: ' + rma.rmaNumber}">RMA</span>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="ms-auto">
                                            <div class="btn-group">
                                                <a th:href="@{'/rma/files/' + ${document.filePath}}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary" 
                                                   title="View">
                                                    <i class="bi bi-eye-fill"></i>
                                                </a>
                                                <a th:href="@{'/rma/files/' + ${document.filePath}}" 
                                                   download 
                                                   class="btn btn-sm btn-outline-secondary" 
                                                   title="Download">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger delete-file-btn"
                                                        title="Delete"
                                                        th:data-id="${document.id}"
                                                        data-type="document"
                                                        th:data-rma-id="${rma.id}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteConfirmModal">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning transfer-btn"
                                                        title="Transfer"
                                                        th:data-id="${document.id}"
                                                        data-type="document"
                                                        th:data-rma-id="${rma.id}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#transferModal">
                                                    <i class="bi bi-arrow-right-square-fill"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-info link-btn"
                                                        title="Link"
                                                        th:data-id="${document.id}"
                                                        data-type="document"
                                                        th:data-rma-id="${rma.id}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#linkModal">
                                                    <i class="bi bi-link-45deg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Documents Section -->

                <!-- Pictures Section -->
                <div class="row mt-4" th:if="${rma.pictures != null and not rma.pictures.empty}">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Pictures</h5>
                            </div>
                            <div class="card-body">
                                <!-- Debug info to see picture paths (hidden) -->
                                <div class="alert alert-info small mb-3" style="display: none;">
                                    <p><strong>Debug Info:</strong> Picture paths from database</p>
                                    <ul class="mb-0">
                                        <li th:each="picture : ${rma.pictures}" th:text="${picture.fileName + ' ➡ ' + picture.filePath}">picture.fileName → picture.filePath</li>
                                    </ul>
                                    <hr />
                                    <button id="btnCheckFiles" class="btn btn-sm btn-secondary mt-2">Check File Existence</button>
                                    <div id="fileCheckResults" class="mt-2"></div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3 mb-3" th:each="picture : ${rma.pictures}">
                                        <div class="card h-100 shadow-sm">
                                            <div class="card-header p-2">
                                                <!-- Tags -->
                                                <span class="badge bg-secondary me-1" th:if="${rma.tool != null}" 
                                                      th:text="${'Tool: ' + rma.tool.name}">Tool</span>
                                                <span class="badge bg-info" th:if="${rma.rmaNumber != null}"
                                                      th:text="${'RMA: ' + rma.rmaNumber}">RMA</span>
                                            </div>
                                            <div class="card-img-top text-center p-2" style="height: 150px;">
                                                <!-- Direct URL to the image using stored filePath -->
                                                <img th:src="@{'/rma/files/' + ${picture.filePath}}" 
                                                     th:alt="${picture.fileName}" 
                                                     class="img-fluid rounded" 
                                                     style="max-height: 100%; max-width: 100%; object-fit: contain; cursor: pointer;"
                                                     data-bs-toggle="modal" 
                                                     data-bs-target="#imageModal"
                                                     th:data-bs-img-src="@{'/rma/files/' + ${picture.filePath}}"
                                                     th:data-bs-img-title="${picture.fileName}"
                                                     th:data-path="${picture.filePath}"
                                                     onerror="handleImageError(this);"
                                                     />
                                            </div>
                                            <div class="card-footer p-1 text-center bg-light">
                                                <small class="text-muted" th:text="${#strings.length(picture.fileName) > 20 ? #strings.substring(picture.fileName, 0, 17) + '...' : picture.fileName}">Filename</small>
                                                
                                                <!-- Action buttons -->
                                                <div class="d-flex gap-1 justify-content-center mt-1">
                                                    <a th:href="@{'/rma/files/' + ${picture.filePath}}" 
                                                       target="_blank" 
                                                       class="btn btn-sm btn-outline-primary" 
                                                       title="View">
                                                        <i class="bi bi-eye-fill"></i>
                                                    </a>
                                                    <a th:href="@{'/rma/files/' + ${picture.filePath}}" 
                                                       download 
                                                       class="btn btn-sm btn-outline-secondary" 
                                                       title="Download">
                                                        <i class="bi bi-download"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger delete-file-btn"
                                                            title="Delete"
                                                            th:data-id="${picture.id}"
                                                            data-type="picture"
                                                            th:data-rma-id="${rma.id}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#deleteConfirmModal">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-warning transfer-btn"
                                                            title="Transfer"
                                                            th:data-id="${picture.id}"
                                                            data-type="picture"
                                                            th:data-rma-id="${rma.id}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#transferModal">
                                                        <i class="bi bi-arrow-right-square-fill"></i>
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-info link-btn"
                                                            title="Link"
                                                            th:data-id="${picture.id}"
                                                            data-type="picture"
                                                            th:data-rma-id="${rma.id}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#linkModal">
                                                        <i class="bi bi-link-45deg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Pictures Section -->

                <!-- Image Modal for enlarged view -->
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="modalImage" src="" alt="Full size image" class="img-fluid">
                            </div>
                            <div class="modal-footer">
                                <a id="downloadLink" href="" class="btn btn-primary" download>Download</a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="card-footer text-end">
                <span class="text-muted" th:if="${rma.id != null}">RMA ID: <span th:text="${rma.id}"></span></span>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set up image modal functionality
            const imageModal = document.getElementById('imageModal');
            if (imageModal) {
                imageModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imgSrc = button.getAttribute('data-bs-img-src');
                    const imgTitle = button.getAttribute('data-bs-img-title');
                    
                    const modalImage = document.getElementById('modalImage');
                    const modalTitle = imageModal.querySelector('.modal-title');
                    const downloadLink = document.getElementById('downloadLink');
                    
                    modalImage.src = imgSrc;
                    modalTitle.textContent = imgTitle || 'Image Preview';
                    downloadLink.href = imgSrc;
                    downloadLink.setAttribute('download', imgTitle || 'image');
                });
                
                // Remove any duplicate error messages that might be added by the onerror event
                const cleanupDuplicateErrors = function() {
                    document.querySelectorAll('.card-img-top').forEach(container => {
                        const errorDivs = container.querySelectorAll('div.text-center.text-muted');
                        if (errorDivs.length > 1) {
                            // Keep only the first error message
                            for (let i = 1; i < errorDivs.length; i++) {
                                container.removeChild(errorDivs[i]);
                            }
                        }
                    });
                };
                
                // Run cleanup once after page load
                setTimeout(cleanupDuplicateErrors, 500);
            }
            
            // Set up the file check button
            const btnCheckFiles = document.getElementById('btnCheckFiles');
            const fileCheckResults = document.getElementById('fileCheckResults');
            
            if (btnCheckFiles && fileCheckResults) {
                btnCheckFiles.addEventListener('click', function() {
                    fileCheckResults.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Checking files...';
                    
                    // Get all image paths
                    const imagePaths = [];
                    document.querySelectorAll('img[data-path]').forEach(img => {
                        const path = img.getAttribute('data-path');
                        if (path) {
                            imagePaths.push(path);
                        }
                    });
                    
                    if (imagePaths.length === 0) {
                        fileCheckResults.innerHTML = '<div class="alert alert-warning">No file paths found to check</div>';
                        return;
                    }
                    
                    // Create a results table
                    let resultsHtml = '<table class="table table-sm table-bordered mt-2">';
                    resultsHtml += '<thead><tr><th>Path</th><th>Status</th></tr></thead><tbody>';
                    
                    // Check each path
                    let completedChecks = 0;
                    imagePaths.forEach(path => {
                        fetch(`/rma/api/file-exists?path=${encodeURIComponent(path)}`)
                            .then(response => response.json())
                            .then(data => {
                                const exists = data.exists;
                                const status = exists 
                                    ? '<span class="text-success">Exists</span>' 
                                    : '<span class="text-danger">Not found</span>';
                                    
                                resultsHtml += `<tr>
                                    <td class="small">${path}</td>
                                    <td>${status}</td>
                                </tr>`;
                                
                                completedChecks++;
                                if (completedChecks === imagePaths.length) {
                                    resultsHtml += '</tbody></table>';
                                    fileCheckResults.innerHTML = resultsHtml;
                                }
                            })
                            .catch(error => {
                                resultsHtml += `<tr>
                                    <td class="small">${path}</td>
                                    <td><span class="text-danger">Error: ${error.message}</span></td>
                                </tr>`;
                                
                                completedChecks++;
                                if (completedChecks === imagePaths.length) {
                                    resultsHtml += '</tbody></table>';
                                    fileCheckResults.innerHTML = resultsHtml;
                                }
                            });
                    });
                });
            }
            
            // Initialize popovers
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            })
            
            // Handle delete button clicks
            document.querySelectorAll('.delete-file-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Store file data in the modal for deletion
                    const fileId = this.getAttribute('data-id');
                    const fileType = this.getAttribute('data-type');
                    const rmaId = this.getAttribute('data-rma-id');
                    
                    document.getElementById('fileIdToDelete').value = fileId;
                    document.getElementById('fileTypeToDelete').value = fileType;
                    document.getElementById('rmaIdForDelete').value = rmaId;
                });
            });
            
            // Handle transfer button clicks
            document.querySelectorAll('.transfer-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Store file data in the modal for transfer
                    const fileId = this.getAttribute('data-id');
                    const fileType = this.getAttribute('data-type');
                    const rmaId = this.getAttribute('data-rma-id');
                    
                    document.getElementById('transferFileId').value = fileId;
                    document.getElementById('transferFileType').value = fileType;
                    document.getElementById('sourceRmaId').value = rmaId;
                    
                    // Update modal title based on file type
                    const modalTitle = document.getElementById('transferModalLabel');
                    modalTitle.textContent = `Transfer ${fileType.charAt(0).toUpperCase() + fileType.slice(1)}`;
                });
            });
            
            // Handle link button clicks
            document.querySelectorAll('.link-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Store file data in the modal for linking
                    const fileId = this.getAttribute('data-id');
                    const fileType = this.getAttribute('data-type');
                    const rmaId = this.getAttribute('data-rma-id');
                    
                    document.getElementById('linkFileId').value = fileId;
                    document.getElementById('linkFileType').value = fileType;
                    document.getElementById('linkSourceRmaId').value = rmaId;
                    
                    // Update modal title based on file type
                    const modalTitle = document.getElementById('linkModalLabel');
                    modalTitle.textContent = `Link ${fileType.charAt(0).toUpperCase() + fileType.slice(1)}`;
                });
            });
            
            // Toggle sections in link modal based on target selection
            document.getElementById('linkTarget').addEventListener('change', function() {
                const toolSection = document.getElementById('toolLinkSection');
                const passdownSection = document.getElementById('passdownLinkSection');
                
                if (this.value === 'tool') {
                    toolSection.style.display = 'block';
                    passdownSection.style.display = 'none';
                } else if (this.value === 'passdown') {
                    toolSection.style.display = 'none';
                    passdownSection.style.display = 'block';
                }
            });
            
            // Handle confirm link action
            document.getElementById('confirmLinkBtn').addEventListener('click', function() {
                const form = document.getElementById('linkForm');
                const linkTarget = document.getElementById('linkTarget').value;
                
                // Validation based on selected target
                let isValid = true;
                let errorMessage = '';
                
                if (linkTarget === 'tool') {
                    const toolId = document.getElementById('linkToolId').value;
                    if (!toolId) {
                        isValid = false;
                        errorMessage = 'Please select a tool to link to';
                    }
                } else if (linkTarget === 'passdown') {
                    const passdownId = document.getElementById('linkPassdownId').value;
                    if (!passdownId) {
                        isValid = false;
                        errorMessage = 'Please select a passdown to link to';
                    }
                }
                
                if (!isValid) {
                    alert(errorMessage);
                    return;
                }
                
                // Submit the form
                form.submit();
            });
            
            // Handle confirm transfer action
            document.getElementById('confirmTransferBtn').addEventListener('click', function() {
                const form = document.getElementById('transferForm');
                
                // Check if a target RMA is selected
                const targetRmaId = document.getElementById('targetRmaId').value;
                if (!targetRmaId) {
                    alert('Please select a target RMA to transfer to');
                    return;
                }
                
                // Submit the form
                form.submit();
            });
            
            // Handle confirm delete action
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const fileId = document.getElementById('fileIdToDelete').value;
                const fileType = document.getElementById('fileTypeToDelete').value;
                const rmaId = document.getElementById('rmaIdForDelete').value;
                const deleteOption = document.querySelector('input[name="deleteOption"]:checked').value;
                
                if (fileId && fileType && rmaId) {
                    // Create and submit form for deletion
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/rma/file/delete';
                    
                    const idInput = document.createElement('input');
                    idInput.type = 'hidden';
                    idInput.name = 'fileId';
                    idInput.value = fileId;
                    
                    const typeInput = document.createElement('input');
                    typeInput.type = 'hidden';
                    typeInput.name = 'fileType';
                    typeInput.value = fileType;
                    
                    const rmaInput = document.createElement('input');
                    rmaInput.type = 'hidden';
                    rmaInput.name = 'rmaId';
                    rmaInput.value = rmaId;
                    
                    const optionInput = document.createElement('input');
                    optionInput.type = 'hidden';
                    optionInput.name = 'deleteOption';
                    optionInput.value = deleteOption;
                    
                    form.appendChild(idInput);
                    form.appendChild(typeInput);
                    form.appendChild(rmaInput);
                    form.appendChild(optionInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
        
        // Function to handle image loading errors
        function handleImageError(imageElement) {
            // Prevent infinite recursion
            imageElement.onerror = null;
            
            // Get file path for debugging
            const filePath = imageElement.getAttribute('data-path') || 'Unknown path';
            
            // Hide the broken image
            imageElement.style.display = 'none';
            
            // Replace with error message
            const errorHtml = `
                <div class='text-center text-muted'>
                    <i class='bi bi-exclamation-triangle'></i>
                    <br>Image not found
                    <br><small class="text-danger">${filePath}</small>
                </div>`;
            
            imageElement.parentNode.innerHTML += errorHtml;
            
            // Log the error to console
            console.error('Failed to load image:', filePath);
            
            return true;
        }
    </script>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>How would you like to handle this file?</p>
                    <input type="hidden" id="fileIdToDelete">
                    <input type="hidden" id="fileTypeToDelete">
                    <input type="hidden" id="rmaIdForDelete">
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOnly" value="unlink" checked>
                        <label class="form-check-label" for="deleteOnly">
                            <strong>Unlink only:</strong> Remove only from this RMA, keep in other locations
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteEverywhere" value="delete">
                        <label class="form-check-label" for="deleteEverywhere">
                            <strong>Delete everywhere:</strong> Remove from all locations
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transfer File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the RMA to transfer this file to:</p>
                    <form id="transferForm" action="/rma/file/transfer" method="post">
                        <input type="hidden" id="transferFileId" name="fileId">
                        <input type="hidden" id="transferFileType" name="fileType">
                        <input type="hidden" id="sourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="targetRmaId" class="form-label">Target RMA</label>
                            <select id="targetRmaId" name="targetRmaId" class="form-select" required>
                                <option value="">-- Select Target RMA --</option>
                                <!-- This will need to be populated from controller with available RMAs -->
                                <option th:each="otherRma : ${allRmas}" 
                                        th:if="${otherRma.id != rma.id}" 
                                        th:value="${otherRma.id}" 
                                        th:text="${(otherRma.rmaNumber != null ? otherRma.rmaNumber : 'RMA-' + otherRma.id) + 
                                                (otherRma.customerName != null ? ' - ' + otherRma.customerName : '')}">
                                    RMA Number - Customer
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="linkModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="linkModalLabel">Link File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select where to link this file:</p>
                    <form id="linkForm" action="/rma/file/link" method="post">
                        <input type="hidden" id="linkFileId" name="fileId">
                        <input type="hidden" id="linkFileType" name="fileType">
                        <input type="hidden" id="linkSourceRmaId" name="sourceRmaId" th:value="${rma.id}">
                        
                        <div class="mb-3">
                            <label for="linkTarget" class="form-label">Link to:</label>
                            <select id="linkTarget" name="linkTarget" class="form-select" required>
                                <option value="tool">Tool</option>
                                <option value="passdown">Passdown</option>
                            </select>
                        </div>
                        
                        <div id="toolLinkSection" class="mb-3">
                            <label for="linkToolId" class="form-label">Select Tool:</label>
                            <select id="linkToolId" name="linkToolId" class="form-select">
                                <option value="">-- Select Tool --</option>
                                <option th:each="tool : ${allTools}" 
                                        th:value="${tool.id}" 
                                        th:text="${tool.name + (tool.secondaryName != null ? ' (' + tool.secondaryName + ')' : '')}">
                                    Tool Name
                                </option>
                            </select>
                        </div>
                        
                        <div id="passdownLinkSection" class="mb-3" style="display: none;">
                            <label for="linkPassdownId" class="form-label">Select Passdown:</label>
                            <select id="linkPassdownId" name="linkPassdownId" class="form-select">
                                <option value="">-- Select Passdown --</option>
                                <option th:each="passdown : ${recentPassdowns}" 
                                        th:value="${passdown.id}" 
                                        th:text="${#temporals.format(passdown.date, 'MM/dd/yyyy') + 
                                                 (passdown.user != null ? ' by ' + passdown.user.name : '')}">
                                    Date - User
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmLinkBtn">Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete RMA Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this RMA?</p>
                    <p class="text-danger fw-bold">This action cannot be undone!</p>
                    <p>RMA Number: <span class="fw-bold" th:text="${rma.rmaNumber != null ? rma.rmaNumber : 'N/A'}"></span></p>
                    <p th:if="${rma.tool != null}">Tool: <span class="fw-bold" th:text="${rma.tool.name}"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/rma/delete/{id}(id=${rma.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 